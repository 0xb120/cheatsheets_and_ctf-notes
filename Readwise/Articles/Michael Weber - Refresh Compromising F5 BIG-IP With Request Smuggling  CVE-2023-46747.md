---
author: Michael Weber
aliases:
  - "Refresh: Compromising F5 BIG-IP With Request Smuggling | CVE-2023-46747"
tags:
  - readwise/articles
  - tomcat
url: https://www.praetorian.com/blog/refresh-compromising-f5-big-ip-with-request-smuggling-cve-2023-46747/
date: 2024-08-20
---
# Refresh: Compromising F5 BIG-IP With Request Smuggling | CVE-2023-46747

![rw-book-cover](https://www.praetorian.com/wp-content/uploads/2023/10/Vulnerability-Research-at-Praetorian-Labs.png)

## Highlights


> authentication bypass issue that led to complete compromise of an F5 system with the Traffic Management User Interface (TMUI) exposed. The bypass was assigned [CVE-2023-46747](https://www.cve.org/CVERecord?id=CVE-2023-46747), and is closely related to [CVE-2022-26377](https://www.cve.org/CVERecord?id=CVE-2022-26377).
> [View Highlight](https://read.readwise.io/read/01hea8d2ekk1x13sb80ennv3g2)



> the F5 vulnerability was also a request smuggling issue.
> [View Highlight](https://read.readwise.io/read/01hea8d8yg99gzvj196tw55z60)



> proof of concept on Github
> [View Highlight](https://read.readwise.io/read/01hea8br3e5vapsjccj3nfbmgs)



> We deployed a default F5 installation using a cheap [AWS Marketplace template](https://aws.amazon.com/marketplace/pp/prodview-lphsy6izllsmq?sr=0-1&ref_=beagle&applicationId=AWSMPContessa) and began identifying components on the server.
> [View Highlight](https://read.readwise.io/read/01hea8j0s3mkb9a2ey05q0pz3t)



> We knew from the previously discussed F5 vulnerabilities from 2020 and 2022 that a discrepancy in the way that frontend and backend systems interpreted a request was likely to result in an authentication bypass issue.
> [View Highlight](https://read.readwise.io/read/01hea8m91e8ba5298myg5c9jvg)



> One of CVE-2022-26377’s original reporters wrote an [excellent blog post](https://ricterz-me.translate.goog/posts/2022-03-03-a-new-attack-method-ajp-request-smuggling.txt?_x_tr_sl=auto&_x_tr_tl=en&_x_tr_hl=en&_x_tr_pto=wapp) describing the straightforward exploitation of the vulnerability.
> [View Highlight](https://read.readwise.io/read/01hea8n9bays8kfz51rdr0epqb)



> A look at `/usr/share/tomcat/conf/server.xml` confirmed the usage of an AJP connector on Tomcat,
> [View Highlight](https://read.readwise.io/read/01hea8pmq8rkt0bzd11s1av8p5)



> At a glance it appeared that hitting any `/tmui/` URL would be sufficient to trigger AJP smuggling.
> [View Highlight](https://read.readwise.io/read/01hea932e5k8vrbwby8dgs46ka)



> we took the example AJP payload implementation from [RicterZ’s blog post](https://ricterz-me.translate.goog/posts/2022-03-03-a-new-attack-method-ajp-request-smuggling.txt?_x_tr_sl=auto&_x_tr_tl=en&_x_tr_hl=en&_x_tr_pto=wapp)  and pointed it at a URL we knew would be publicly exposed–the login page.
> [View Highlight](https://read.readwise.io/read/01hea93cddchdc1f5q0bavf0m7)



> $ curl -k -i http://our.f5.ami.ip:8443/tmui/login.jsp -H 'Transfer-Encoding: chunked, chunked' --data-binary @raw.dat
> [View Highlight](https://read.readwise.io/read/01hea951vxzwqw809c8thpm97v)



> Interestingly enough, after a few curl requests, we occasionally would receive 404 Not Found responses instead of the expected login page.
> [View Highlight](https://read.readwise.io/read/01hea95ya8wmphss70wc01v6md)



> By default the F5-BIGIP does not run a ROOT webapp, so the system returned a 404 instead. By explicitly creating a file at /usr/share/tomcat/webapps/ROOT/WEB-INF/web.xml, we were able to trigger the GhostCat LFI.
> [View Highlight](https://read.readwise.io/read/01hea97yq6ng1qeym3gtm40z2f)



> So what exactly can we do with the ability to send arbitrary AJP packets? The Tomcat AJP connector is one mechanism for directing web request content to backend Java servlets. These servlets contain the conventional backend processing logic.
> [View Highlight](https://read.readwise.io/read/01hea9qarcfte3jkef6rb87qvd)



> If we could smuggle completely arbitrary data as AJP packets this would give us the ability to invoke arbitrary servlets with entirely arbitrary content.
> [View Highlight](https://read.readwise.io/read/01hea9qxky2va64axxj4jfvyfa)



> First, POST requests needed to be exactly 0x204 bytes (518).
> [View Highlight](https://read.readwise.io/read/01hea9r3jd3w4dbr1xz1xvxjhg)



> Next, we could not actually send any POST body content with the smuggled request.
> [View Highlight](https://read.readwise.io/read/01hea9rcx2eme6jzt0qhydhftg)



> Finally, we could only route to endpoints in the “/tmui” API.
> [View Highlight](https://read.readwise.io/read/01hea9rnf138h4x3tx38ksg1ze)



> While we identified some interesting attack surface, such as potential paths to some classic Java deserialization attacks, the lack of ability to send a POST body prevented us from reaching those code paths
> [View Highlight](https://read.readwise.io/read/01hea9s671yttt56mr4hw5vg9e)



> Eventually, we realized it might be easier to simply create a user for ourselves.
> [View Highlight](https://read.readwise.io/read/01hea9sfjt56635pnwxak1jrk6)



> We verified that the request created a new administrator user on the backend, and sent another one to make sure it was the only request required (it was). However, we noticed a few important attributes that would preclude us from replicating and smuggling that same request to the backend. First, the content itself is sent as a POST body and the smuggled AJP request will not send POST body content properly. Second, the request included a Cookie that was set after we logged in to the application, so somehow we would need to determine if there is another way to authenticate to the relevant part of the code without that Cookie. Finally, the POST body Content-Length is 1726 bytes, which is much greater than our strict 518 byte requirement
> [View Highlight](https://read.readwise.io/read/01hea9vn9d40wbzwzqmsbsp2fw)



> sending the POST body content as request query parameters worked and addressed the first of the three issues.
> [View Highlight](https://read.readwise.io/read/01heaa5gayb96gbty0va54pvhg)



> So to create the user successfully we simply added a “REMOTEROLE” header with value “0” to the smuggled AJP request
> [View Highlight](https://read.readwise.io/read/01heaa9asgjd1x8q5axnn875ys)



> We started stripping out a few parameters like “exit_button_before” and “enableObjList” at a time. After removing them, we resent the request and checked that it still created a new user. And then we repeated the process again and again.
> [View Highlight](https://read.readwise.io/read/01heaaah1nbndkrh2esas2y64g)



> After sending the smuggled request to create valid administrator credentials, we could authenticate to the F5 system using the standard authentication flow and run arbitrary commands through the “mgmt” API.
> [View Highlight](https://read.readwise.io/read/01heaabfzpr1qyde6h2y80a341)

