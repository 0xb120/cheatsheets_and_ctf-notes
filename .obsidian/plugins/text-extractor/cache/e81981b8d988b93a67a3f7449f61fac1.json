{"path":"zzz_res/attachments/annotated-OWASP_Code_Review_Guide_v2.pdf","text":"CODE REVIEW GUIDE RELEASE Creative Commons (CC) Attribution Free Version at: https://www.owasp.org Project leaders: Larry Conklin and Gary Robinson 2.0 1 Foreword Acknowledgements 1 3 6 85 Introduction How To Use The Code Review Guide 2 Code Review Do’s And Dont’s Code Review Checklist Threat Modeling Example Code Crawling 192 196 200 206 3 A1 Injection A2 Broken Authentication And Session Management A3 Cross-Site Scripting (XSS) A4 Insecure Direct Object Reference A5 Security Misconfiguration A6 Sensitive Data Exposure A7 Missing Function Level Access Control A8 Cross-Site Request Forgery (CSRF) A9 Using Components With Know Vulnerabilities A10 Unvalidated Redirects And Forwards 43 58 70 77 82 117 133 139 146 149 Technical Reference For Secure Code Review Appendix 4 HTML5 Same Origin Policy Reviewing Logging Code Error Handling Reviewing Security Alerts Review For Active Defence Race Conditions Buffer Overruns Client Side JavaScript 154 158 160 163 175 178 181 183 188 Secure Code Review Methodology 9 20 Introduction 2 1 3Code Review Guide Foreword - By Eoin Keary By Eoin Keary, Long Serving OWASP Global Board Member TheaOWASPaCodeaReviewaguideawasaoriginallyabornafromathea OWASPaTestingaGuideoaInitiallyacodeareviewawasacoveredainathea TestingaGuidemaasaitaseemedalikeaaagoodaideaaatatheatimeoaHowevn ermatheatopicaofasecurityacodeareviewaisatooabigaandaevolvedaintoa itsaownastandnaloneaguideo IastartedatheaCodeaReviewaProjectainasqqwoaThisacurrentaeditiona wasastartedainaAprilasqrtaviaatheaOWASPaProjectaRebootainitian tiveaandaaagrantafromatheaUnitedaStatesaDepartmentaofaHomen landaSecurityo TheaOWASPaCodeaReviewateamaconsistsaofaaasmallmabutatalentedma groupaofavolunteersawhoashouldareallyagetaoutamoreaoftenoaaThea volunteersahaveaexperienceaandaaadriveaforatheabestapracticesa inasecureacodeareviewainaaavarietyaofaorganizationsmafromasmalla startnupsatoasomeaofathealargestasoftwareadevelopmentaorganin zationsainatheaworldo Itaisacommonaknowledgeathatamoreasecureasoftwareacanabeapron ducedaandadevelopedainaaamoreacostaeffectiveawayawhenabugsa areadetectedaearlyaonainatheasystemsadevelopmentalifecycleoaOrn ganizationsawithaaaproperacodeareviewafunctionaintegratedaintoa thea softwarea developmenta lifecyclea iSDLCja produceda remarkn ablyabetteracodeafromaaasecurityastandpointoaToaputaitasimplya“Wea can’tahackaourselvesasecure”oaAttackersahaveamoreatimeatoafinda vulnerabilitiesaonaaasystemathanatheatimeaallocatedatoaaadefendn eroaHackingaourawayasecureaamountsatoaanaunevenabattlefieldma asymmetricawarfaremaandaaalosingabattleo Bya necessityma thisa guidea doesa nota covera alla programminga lann guagesoaItamainlyafocusesaonaCdpoNETaandaJavamabutaincludesaCp CllmaPHPaandaotheralanguagesawhereapossibleoaHowevermathea techniquesaadvocatedainatheabookacanabeaeasilyaadaptedatoaaln mostaanyacodeaenvironmentoaFortunatelyaioraunfortunatelyjmathea securitya flawsa ina weba applicationsa area remarkablya consistenta acrossaprogrammingalanguageso Eoin Keary, June 2017 FOREWORD1 4 Acknowledgements APPRECIATION TO UNITED STATES DEPARTMENT OF HOMELAND SECURITY FEEDBACK OWASPacommunityaandaCodeaReviewaGuideaprojectaleadersawishatoaexpressesaitsadeepaapn preciationatoaUnitedaStatesaDepartmentaofaHomelandaSecurityaforahelpingamakeathisabooka possibleabyafundsaprovidedatoaOWASPathruaaagrantoaOWASPacontinuesabeatoatheapreeminenta organizationaforafreeaunbiasedpunfrettedaapplicationasecurityoa Weahaveaseenaaadisturbingariseainathreatsaandaattacksaonacommunityainstitutionsathruaapplin cationavulnerabilitiesmaonlyabyajoiningaforcesmaandawithaunfrettedainformationacanaweahelpa turnabackatheatideatheseathreatsoaTheaworldanowarunsaonasoftwareaandathatasoftwareaneedsa toabeatrustaworthyoaOuradeepestaappreciationaandathanksatoaDHSaforahelpingaandainasharinga inathisagoalo IfayouahaveaanyafeedbackaforatheaOWASPaCodeaReviewateammaandporafindaanyamistakesaora improvementsainathisaCodeaReviewaGuideapleaseacontactausaat– owasp-codereview-project@owasp.org 5Acknowledgements ACKNOWLEDGEMENTS Content Contributors LarryaConklin GaryaRobinson JohannaaCuriel EoinaKeary IslamaAzeddineaMennouchi AbbasaNaderi CarlosaPantelides MichaelaHidalgo Reviewers AlisonaShubert FernandoaGalves SytzeavanaKoningsveld CarolynaCohen HelenaGao JanaMasztal DavidaLi LawrenceaJaTimmins KwokaCheng KenaProle DavidaD’Amico RobertaFerris LennyaHalseth KennethaFoaBelva VERSION 2.0, 2017 Project Leaders LarryaConklin GaryaRobinson Project Leader EoinaKeary Content Contributors JenelleaChapman AndrewavanaderaStock PaoloaPerego DavidaLowry DavidaRook DinisaCruz JeffaWilliams Reviewers JeffaWilliams RahinaJina VERSION 1.0, 2007 6 WelcomeatoatheasecondaeditionaofatheaOWASPaCodeaReviewaGuideaProjectoaTheasecondaeditionabringsathea successfulaOWASPaCodeaReviewaGuideaupatoadateawithacurrentathreatsaandacountermeasuresoaThisavern sionaalsoaincludesanewacontentareflectingatheaOWASPacommunities’aexperiencesaofasecureacodeareviewa bestapracticeso INTRODUCTION CONTENTS TheaSecondaEditionaofatheaCodeaReviewaGuideahasabeenadevelopedatoaadviseasoftwareadevelopersaanda managementaonatheabestapracticesainasecureacodeareviewmaandahowaitacanabeausedawithinaaasecureasoftn warea developmenta lifencyclea iSnSDLCjoa aThea guidea beginsa witha sectionsa thata introducea thea readera toa secureacodeareviewaandahowaitacanabeaintroducedaintoaaacompany’saSnSDLCoaaItathenaconcentratesaona specificatechnicalasubjectsaandaprovidesaexamplesaofawhataaareviewerashouldalookaforawhenareviewinga technicalacodeoaaSpecificallyatheaguideacovers– Overview Thisasectionaintroducesatheareaderatoasecureacodeareviewaandatheaadvantagesaitacanabringatoaaadeveln opmentaorganizationoaaItagivesaanaoverviewaofasecureacodeareviewatechniquesaandadescribesahowacodea reviewacomparesaotheratechniquesaforaanalyzingasecureacodeo Methodology Theamethodologyasectionagoesaintoamoreadetailaonahowatoaintegrateasecureareviewatechniquesaintoaden velopmentaorganizationsaSnSDLCaandahowatheapersonnelareviewingatheacodeacanaensureatheyahaveathea correctacontextatoaconductaanaeffectiveareviewoaaTopicsaincludeaapplyingariskabasedaintelligenceatoasecurin tyacodeareviewsmausingathreatamodellingatoaunderstandatheaapplicationabeingareviewedmaandaunderstandn ingahowaexternalabusinessadriversacanaaffectatheaneedaforasecureacodeareviewo Introduction - Contents 7How to use TheacontentsaandatheastructureaofatheabookahaveabeenacarefullyadesignedoaFurthermaallatheacontributedachaptersahaveabeenajudin ciouslyaeditedaandaintegratedaintoaaaunifyingaframeworkathataprovidesauniformityainastructureaandastyleo This book is written to satisfy three different perspectives. 1. Managementateamsawhoawishatoaunderstandatheareasonsaofawhyacodeareviewsaareaneededaandawhyatheyaareaincludedainabest practicesainadevelopingasecureaenterpriseasoftwareaforatodaysaorganizationsoaSenioramanagementashouldathoroughlyareadasecn tionsaoneaandatwoaofathisabookoaaManagementaneedsatoaconsideratheafollowingaitemsaifadoingasecureacodingaisagoingatoabeapartaofa theaorganizationsasoftwareadevelopmentalifecycle– • Doesaorganizationaprojectaestimationaallotatimeaforacodeareviewsﬄ • Doesamanagementahaveatheacapabilityatoatrackathearelevantametricsaofacodeareviewaandastaticaanalysisaforaeachaprojectaand programmerﬄ • Managementaneedsatoadecideawhenainatheaprojectalifeacycleawillathatacodeareviewsashouldabeadoneainatheaprojectalifecycleaand whatachangesatoaexistingaprojectsarequireareviewaofapreviouslyacompletedacodeareviewso 2. Softwarealeadsawhoawantatoagiveamanfullyafeedbackatoapeersainacodeareviewawithaampleaempiricalaartifactsaasawhatatoalookafora inahelpingacreateasecureaenterpriseasoftwareaforatheiraorganizationsoaTheyashouldaconsider– •AsaaapeeracodeareviewermatoauseathisabookayouafirstadecidedaonatheatypeaofacodeareviewadoayouawantatoaaccomplishoaaLetsaspendaa fewaminutesagoingaoveraeachatypeaofacodeareviewatoahelpainadecidingahowathisabookacanabeaassistanceatoayouo • APIpdesignacodeareviewsoaUseathisabookatoaunderstandahowaarchitectureadesignsacanaleadatoasecurityavulnerabilitiesoaAlsoaifathea APIaisaaathirdapartyaAPIawhatasecurityacontrolsaareainaplaceainatheacodeatoapreventasecurityavulnerabilitiesoa • MaintainabilityacodeareviewsoaTheseatypesaofacodeareviewsaareamoreatowardsatheaorganizationsainternalabestacodingapracticesoa Thisabookadoesacoveracodeametricsmawhichacanahelpatheacodeareviewermabetteraunderstandawhatacodeatoalookaataforasecurityavuln nerabilitiesaifaaasectionaofacodeaisaoverlyacomplexo • IntegrationacodeareviewsoaAgainatheseatypesaofacodeareviewsaareamoreatowardsatheaorganizationsainternalacodingapoliciesoaaIsa theacodeabeingaintegratedaintoatheaprojectafullyavettedabyaITamanagementaandaapprovedﬄaManyasecurityavulnerabilitiesaareanowa beingaimplementedabyausingaopenasourcealibrariesawhichhamayabringainadependenciesathataareanotasecureo • TestingacodeareviewsoaaAgileaandaTestaDrivenadesignawhereaprogrammeracreatesaunitatestsatoaproveacodeamethodsaworksaasathea programmeraintendedoaThisacodeaisanotaaaguideaforatestingasoftwareoaTheacodearevieweramayawantatoapayaattentionatoaunitatesta casesatoamakeasureaallamethodsahaveaappropriateaexceptions•acodeafailsainaaasafeawayoaIfapossibleaeachasecurityacontrolainacodeahasa theaappropriateaunitatestacasesoaa 3. Secureacodeareviewerawhoawantsaanaupdatedaguideaonahowasecureacodeareviewsaareaintegratedainatoatheaorganizationsasecurea softwareadevelopmentalifecycleoaThisabookawillaalsoaworkaasaaareferenceaguideaforatheacodeareviewaasacodeaisainatheareviewaprocesso ThisabookaprovidesaaacompleteasourceaofainformationaneededabyatheacodearevieweroaItashouldabeareadafirstaasaaastoryaaboutacodea reviewsaandasecondsaasaaadesktopareferenceaguideo HOW TO USE THE CODE REVIEW GUIDE 8 2 9 SECURE CODE REVIEW Technical Reference For Secure Code Review HereatheaguideadrillsadownaintoacommonavulnerabilitiesaandatechnicalacontrolsmaincludingaXSSmaSQLainjectionma sessiona trackingma authenticationma authorizationma loggingma anda informationa leakagema givinga codea examplesa ina variousalanguagesatoaguideatheareviewero Thisasectionacanabeausedatoalearnatheaimportantaaspectsaofatheavariousacontrolsmaandaasaanaonnthenjobareferencea whenaconductingasecureacodeareviewso WeastartawithatheaOWASPaToparqaissuesmadescribingatechnicalaaspectsatoaconsideraforaeachaofatheseaissuesoaaWea thenamoveaontoaotheracommonaapplicationasecurityaissuesanotaspecificatoatheaOWASPaToparq Secureacodeareviewaisaprobablyatheasinglenmostaeffectiveatechniqueaforaidentifyingasecurityabugsaearlyainathea systemadevelopmentalifecycleoaWhenausedatogetherawithaautomatedaandamanualapenetrationatestingmacodea reviewacanasignificantlyaincreaseatheacostaeffectivenessaofaanaapplicationasecurityaverificationaefforto ThisaguideadoesanotaprescribeaaaprocessaforaperformingaaasecurityacodeareviewoaRathermaitaprovidesaguidanceaona howatheaeffortashouldabeastructuredaandaexecutedoaTheaguideaalsoafocusesaonatheamechanicsaofareviewingacodea foracertainavulnerabilitieso Manualasecureacodeareviewaprovidesainsightaintoathea“realarisk”aassociatedawithainsecureacodeoaThisacontextualma whitenboxaapproachaisatheasingleamostaimportantavalueoaAahumanarevieweracanaunderstandathearelevanceaofa aabugaoravulnerabilityainacodeoaContextarequiresahumanaunderstandingaofawhataisabeingaassessedoaWithaapn propriateacontextaweacanamakeaaaseriousariskaestimateathataaccountsaforabothathealikelihoodaofaattackaandathea businessaimpactaofaaabreachoaCorrectacategorizationaofavulnerabilitiesahelpsawithapriorityaofaremediationaanda fixingathearightathingsaasaopposedatoawastingatimeafixingaeverythingo 5.1 Why Does Code Have Vulnerabilities? MITREa hasa catalogueda circaa rqqqa differenta kindsa ofa softwarea weaknessesa ina thea CWEa projectoaThesea area alla differentawaysathatasoftwareadevelopersacanamakeamistakesathataleadatoainsecurityoaEveryaoneaofatheseaweakn nessesaisasubtleaandamanyaareaseriouslyatrickyoaSoftwareadevelopersaareanotataughtaaboutatheseaweaknessesaina schoolaandamostadoanotareceiveaanyaonatheajobatrainingaaboutatheseaproblemso Thesea problemsa havea becomea soa importanta ina recenta yearsa becausea wea continuea toa increasea connectivitya andaaddatechnologiesaandaprotocolsaataanaextremelyafastarateoaTheaabilityatoainventatechnologyahasaseriouslya outstrippedatheaabilityatoasecureaitoaManyaofatheatechnologiesainauseatodayasimplyahaveanotareceivedaenougha ioraanyjasecurityascrutinyo ThereaareamanyareasonsawhyabusinessesaareanotaspendingatheaappropriateaamountaofatimeaonasecurityoaUltin matelymatheseareasonsastemafromaanaunderlyingaproblemainatheasoftwareamarketoaBecauseasoftwareaisaessenn tiallyaaablackaboxmaitaisaextremelyadifficultaforaaacustomeratoatellatheadifferenceabetweenagoodacodeaandainsecurea codeoaWithoutathisavisibilityavendorsaareanotaencouragedatoaspendaextraaeffortatoaproduceasecureacodeoaaNevn erthelessmainformationasecurityaexpertsafrequentlyagetapushbackawhenatheyaadvocateaforasecurityacodeareviewma withatheafollowingaiunjustifiedjaexcusesaforanotaputtingamoreaeffortaintoasecurity–a “WeaneveragetahackedaithataIaknowaof jmaweadon’taneedasecurity” Secure Code Review10 “Weahaveaaafirewallathataprotectsaouraapplications” “Weatrustaouraemployeesanotatoaattackaouraapplications” OverathealastarqayearsmatheateamainvolvedawithatheaOWASPaCodeaReviewaProjectahasaperformedathousandsaofa applicationareviewsmaandafoundathataeveryanonntrivialaapplicationahasahadasecurityavulnerabilitiesoaIfacodeahasa notabeenareviewedaforasecurityaholesmathealikelihoodathatatheaapplicationahasaproblemsaisavirtuallyarqqfo StillmathereaareamanyaorganizationsathatachooseanotatoaknowaaboutatheasecurityaofatheiracodeoaToathemmaconsidera Rumsfeld’sacrypticaexplanationaofawhataweaactuallyaknow–a “oooweaknowmathereaareaknownaknowns•athereaareathingsaweaknowaweaknowoaWeaalsoaknowathereaareaknownaunn knowns•athataisatoasayaweaknowathereaareasomeathingsaweadoanotaknowoaButathereaareaalsoaunknownaunknownsa nnatheaonesaweadon’taknowaweadon’taknowo”naDonaldaRumsfeld Ifainformedadecisionsaareabeingamadeabasedaonaaameasurementaofariskainatheaenterprisemawhichawillabeafullya supportedoaHowevermaifarisksaareanotabeingaunderstoodmatheacompanyaisanotabeingadulyadiligentmaandaisabeinga irresponsibleabothatoashareholdersaandacustomerso 5.2 What is Secure Code Review? Codeareviewaaimsatoaidentifyasecurityaflawsainatheaapplicationarelatedatoaitsafeaturesaandadesignmaalongawithathea exactarootacausesoaWithatheaincreasingacomplexityaofaapplicationsaandatheaadventaofanewatechnologiesmathea traditionalawayaofatestingamayafailatoadetectaallatheasecurityaflawsapresentainatheaapplicationsoaOneamustaundern standatheacodeaofatheaapplicationmaexternalacomponentsmaandaconfigurationsatoahaveaaabetterachanceaofafindinga theaflawsoaSuchaaadeepadiveaintoatheaapplicationacodeaalsoahelpsainadeterminingaexactamitigationatechniquesa thatacanabeausedatoaavertatheasecurityaflawso Itaisatheaprocessaofaauditingatheasourceacodeaofaanaapplicationatoaverifyathatatheaproperasecurityaandalogicala controlsaareapresentmathatatheyaworkaasaintendedmaandathatatheyahaveabeenainvokedainathearightaplacesoaCodea reviewaisaaawayaofahelpingaensureathatatheaapplicationahasabeenadevelopedasoaasatoabea“selfndefending”ainaitsa givenaenvironmentoa Securea codea reviewa allowsa aa companya toa assurea applicationa developersa area followinga securea developmenta techniquesoaAageneralaruleaofathumbaisathataaapenetrationatestashouldanotadiscoveraanyaadditionalaapplicationa vulnerabilitiesa relatinga toa thea developeda codea aftera thea applicationa hasa undergonea aa propera securitya codea reviewoaAtathealeastaveryafewaissuesashouldabeadiscoveredoa AllasecurityacodeareviewsaareaaacombinationaofahumanaeffortaandatechnologyasupportoaAtaoneaendaofatheaspecn trumaisaanainexperiencedapersonawithaaatextaeditoroaAtatheaotheraendaofatheascaleaisaanaexpertasecurityateamawitha advancedastaticaanalysisaiSASTjatoolsoaUnfortunatelymaitatakesaaafairlyaseriousalevelaofaexpertiseatoauseatheacurrenta applicationasecurityatoolsaeffectivelyoaTheyaalsoadon’taunderstandadynamicadataaflowaorabusinessalogicoaSASTa toolsaareagreataforacoverageaandasettingaaaminimumabaselineo Toolsa cana bea useda toa performa thisa taska buta theya alwaysa needa humana verificationoaTheya doa nota understanda contextmawhichaisatheakeystoneaofasecurityacodeareviewoaToolsaareagoodaataassessingalargeaamountsaofacodeaanda pointingaoutapossibleaissuesmabutaaapersonaneedsatoaverifyaeveryaresultatoadetermineaifaitaisaaarealaissuemaifaitaisa actuallyaexploitablemaandacalculateatheariskatoatheaenterpriseoaHumanareviewersaareaalsoanecessaryatoafillainafora theasignificantablindaspotsmawhichaautomatedatoolsmasimplyacannotachecko Secure Code Review 11Secure Code Review 5.3 What is the difference between Code Review and Secure Code Review? TheaCapabilityaMaturityaModelaiCMMjaisaaawidelyarecognizedaprocessamodelaforameasuringatheadevelopmenta processesaofaaasoftwareadevelopmentaorganizationoaaItarangesafroma‘levelar’awhereadevelopmentaprocessesaarea adahocmaunstableaandanotarepeatablematoa‘levelav’awhereatheadevelopmentaprocessesaareawellaorganizedmadocun mentedaandacontinuouslyaimprovingoaaItaisaassumedathataaacompany’sadevelopmentaprocessesawouldastartaouta atalevelarawhenastartingaoutaiaokoaastartnupamodejaandawillabecomeamoreadefinedmarepeatableaandagenerallya professionalaasatheaorganizationamaturesaandaimprovesoaaIntroducingatheaabilityatoaperformacodeareviewsainotea thisaisanotadealingawithasecureacodeareviewayetjacomesainawhenaanaorganizationahasareachedalevelasaiRepeatn ablejaoralevelataiDefinedjoaa SecureaCodeaReviewaisaanaenhancementatoatheastandardacodeareviewapracticeawhereatheastructureaofathearen viewaprocessaplacesasecurityaconsiderationsmasuchaasacompanyasecurityastandardsmaatatheaforefrontaofatheaden cisionnmakingoaaManyaofatheseadecisionsawillabeaexplainedainathisadocumentaandaattemptatoaensureathatathea reviewaprocessacanaadequatelyacoverasecurityarisksainatheacodeabasemaforaexampleaensuringahighariskacodeaisa reviewedainamoreadepthmaensuringareviewersahaveatheacorrectasecurityacontextawhenareviewingatheacodemaenn suringareviewersahaveatheanecessaryaskillsaandasecureacodingaknowledgeatoaeffectivelyaevaluateatheacodeo 5.4 Determining the Scale of a Secure Source Code Review? Thealevelaofasecureasourceacodeareviewawillavaryadependingaonatheabusinessaoraregulatoryaneedsaofatheasoftwaremathea sizeaofatheasoftwareadevelopmentaorganizationawritingatheaapplicationsaandatheaskillsaofatheapersonneloaaSimilaratoa otheraaspectsaofasoftwareadevelopmentasuchaasaperformancemascalabilityaandamaintainabilitymasecurityaisaaameasureaofa maturityainaanaapplicationoaSecurityaisaoneaofatheanonnfunctionalarequirementsathatashouldabeabuiltaintoaeveryaseriousa applicationaoratoolathataisausedaforacommercialaoragovernmentalapurposeso Ifatheadevelopmentaenvironmentaconsistsaofaoneapersonaprogrammingaasaaahobbyaandawritingaaaprogramatoatracka theiraweeklyashoppingainavisualabasicaiCMMalevelarjmaitaisaunlikelyathatathataprogrammerawillauseaallaofatheaadvicea withinathisadocumentatoaperformaextensivealevelsaofasecureacodeareviewoaOnatheaotheraextrememaaalargeaorganizationa withathousandsaofadevelopersawritingahundredsaofaapplicationsawillaiifatheyawishatoabeasuccessfuljatakeasecurityaverya seriouslymajustalikeatheyawouldatakeaperformanceaandascalabilityaseriouslyo Notaeveryadevelopmentaorganizationahasatheanecessitymaoraresourcesmatoafollowaandaimplementaallaofatheatopicsaina thisadocumentmabutaallaorganizationsashouldabeaableatoabeginatoawriteatheiradevelopmentaprocessesainaaawayathata cana accommodatea thea processesa anda technicala advicea mosta importanta toa themoa a Thosea processesa shoulda thena beaextensibleatoaaccommodateamoreaofatheasecureacodeareviewaconsiderationsaasatheaorganizationadevelopsaanda matureso Inaaastartnupaconsistingaofatapeopleainaaadarkenedaroommathereawillanotabeaaa‘codeareviewateam’atoasendatheacodeatoma insteadait’llabeatheablokeainatheacornerawhoareadaaasecureacodingabookaonceaandanowausesaitatoapropaupahisamonitoroaa Inaaamediumasizedacompanyathereamightabeauqqadevelopersmasomeawithasecurityaasaanainterestaoraspecialtymahowevera theaorganizationsaprocessesamightagiveatheasameaamountaofatimeatoareviewaaatalineaCSSachangeaasaitagivesatoaaa redesigna ofa thea flagshipa productsa authenticationa codeoa a Herea thea challengea isa toa increasea thea workforce’sa securea codingaknowledgeaiinageneraljaandaimproveatheaprocessesathroughathingsalikeathreatamodellingaandasecureacodea reviewoaa ForasomealargeracompaniesawithamanyathousandsaofadevelopersmatheaneedaforasecurityainatheaSnSDLCaisaataitsagreatestma butaprocessaefficiencyahasaanaimpactaonatheabottomalineoaaTakeaanaexampleaofaaalargeacompanyawithavmqqqadeveloperso Ifaaachangeaisaintroducedatoatheaprocessathataresultsainaeachadeveloperatakingaanaextraarvaminutesaaaweekatoaperforma aataskmasuddenlyathat’sarmsvqahoursaextraaeachaweekaforatheacompanyaasaaawholeaThisaresultsainaaaneedaforaaanaextraatqa fullatimeadevelopersaeachayearajustatoastayaonatrackaiassumingaaauqahouraweekjoaaTheachallengeahereaisatoaensureathea securityachangesatoathealifecycleaareaefficientaandadoanotaimpedeatheadevelopersafromaperformingatheiratasko 12 Itamustabearememberedathoughmanoamatterawhatasizeatheaorganizationmatheareasonatoaperformasecureacodearen viewaisatoacatchamoreabugsaandacatchathemaearlierainatheaSnSDLCoaaItaisaquickeratoaconductaaasecureacodeareviewa andafindabugsathatawaymacomparedatoafindingatheabugsainatestingaorainaproductionoaaForatheavmqqqnpersonaorgan nizationmahowalongawillaitatakeatoafindaaabugainatestingmainvestigatemarencodemarenreviewmarenreleaseaandarentestﬄaa Whataifatheacodeagoesatoaproductionawhereaprojectamanagementaandasupportawillagetainvolvedainatrackingathea issueaandacommunicatingawithacustomersﬄaaMaybearvaminutesaaaweekawillaseemalikeaaabargaino 5.5 We Can’t Hack Ourselves Secure Penetrationa testinga isa generallya aa blacknboxa pointa ina timea testa anda shoulda bea repeateda ona eacha releasea iora buildjaofatheasourceacodeatoafindaanyaregressionsoaaManyacontinuousaintegrationatoolsaieogoaJenkinspHudsonja allowarepeatableatestsmaincludingaautomatedapenetrationatestsmatoabearunaagainstaaabuiltaandainstalledaversiona ofaaaproductoa Asasourceacodeachangesmatheavalueaofatheafindingsaofaanaunmaintainedapenetrationatestsadegradeawithatimeoa Thereaareaalsoaprivacymacomplianceaandastabilityaandaavailabilityaconcernsmawhichamayanotacoveredabyapenetran tionatestingmabutacanabeacoveredainacodeareviewsoaDataainformationaleakageainaaacloudaenvironmentaforaexamplea mayanotabeadiscoveredmaoraallowedmaviaaaapenetrationatestoaaThereforeapenetrationatestingashouldabeaseenaasaana importantatoolainatheaarsenalmabutaaloneaitawillanotaensureaproductasoftwareaisasecureo Theacommonamethodsaofaidentifyingavulnerabilitiesainaaasoftwareaprojectaare– •aSourceaCodeaScanningausingaautomatedatoolsathatarunaagainstaaasourceacodearepositoryaoramodulemafindinga stringapatternsadeemedatoapotentiallyacauseasecurityavulnerabilitieso Secure Code Review Thereaseemsatoabeaaacatchnssawithatheafollowingasentiment•aasamanyacodeadevelopersaareanotaawareaoraskilledaina securitymaaacompanyashouldaimplementapeerasecureacodeareviewsaamongstadeveloperso HowadoesaaaworkforceaintroduceatheasecurityaskillsatoaimplementaaasecureacodeareviewamethodologyﬄaaManya securityamaturityamodelsaieogoaBSIMMaoraOpenSAMMjadiscussatheaconceptaofaaacoreasecurityateammawhoaareaskilleda developersaandaskillasecurityasubjectamatteraexpertsaiSMEsjoaaInatheaearlyadaysaofaaacompanyarollingaoutaaasen cureacodeareviewaprocessmatheasecurityaSMEsawillabeacentralainatheahigherariskareviewsmausingatheiraexperienceaanda knowledgeatoapointaoutaaspectsaofatheacodeathatacouldaintroducearisko Asawellaasatheacoreasecurityateamaaafurtheragroupaofadevelopersawithaanainterestainasecurityacanaactaasateamalocala securityaSMEsmatakingapartainamanyasecureacodeareviewsoaaTheseasatellitesaiasaBSIMMacallsathemjawillabeaguidedabya theacoreasecurityateamaonatechnicalaissuesmaandawillahelpaencourageasecureacodingo Overatimemaanaorganizationabuildsasecurityaknowledgeawithinaitsacoremaandasatelliteateamsmawhichainaturnsaspreadsa theasecurityaknowledgeaacrossaalladevelopersasinceamostacodeareviewsawillahaveaaasecurityaSMEatakingaparto Thea‘onnthenjob’atrainingathisagivesatoaalladevelopersaisaveryaimportantoaaWhereasaanaorganizationacanasendatheiraden velopersaonatrainingacoursesaiclassroomaoraCBTjawhichawillaintroduceathematoacommonasecurityatopicsaandacreatea awarenessmanoatrainingacourseacanabearqqfarelevantatoaaadeveloper’sajoboaaInatheasecureacodeareviewaprocessmaeacha developerawhoasubmitsatheiracodeawillareceiveasecurityarelatedafeedbackathataisaentirelyarelevantatoathemmasincea theareviewaisaofatheacodeatheyaproducedo Skilling a Workforce for Secure Code Review 13Secure Code Review •aAutomatedaPenetrationaTestingaiblackpgreyaboxjathroughapenetratingatestingatoolsaautomaticascansmawherea theatoolaisainstalledaonatheanetworkawithatheawebasiteabeingatestedmaandarunsaaasetaofaprendefinedatestsaagainsta theawebasiteaURLso •aManualaPenetrationaTestingmaagainausingatoolsmabutawithatheaexpertiseaofaaapenetrationatesteraperformingamorea complicatedatestso •aSecureaCodeaReviewawithaaasecurityasubjectamatteraexperto Itashouldabeanotedathatanoaoneamethodawillabeaableatoaidentifyaallavulnerabilitiesathataaasoftwareaprojectamighta encountermahoweveraaadefenseninndepthaapproachawillareduceatheariskaofaunknownaissuesabeingaincludingaina productionasoftwareoaa DuringaaasurveyaataAppSecaUSAasqrvathearespondentsaratedawhichasecurityamethodawasatheamostaeffectiveaina finding– 1) Generalasecurityavulnerabilities 2) Privacyaissues 3) Businessalogicabugs 4) ComplianceaissuesaisuchaasaHIPPAmaPCImaetcoj 5) Availabilityaissues Thearesultsaareashownainafigurearo Vulnerabilities SourceaCodeaScanningaTools AutomatedaScan ManualaPenaTest ManualaCodeaReview q v rq rv sq sv tq tv Privacy BusinessaLogic Compliance iHIPPAj Availability Figure 1: Surveyarelatingadetectionamethodsatoageneralavulnerabilityatypes 14 Secure Code Review Ar As At Au Av Aw Ax Ay A“ Arq SourceaCodeaScanningaTool AutomatedaScan ManualaPenaTest ManualaCodeaReview q v rq rv sq sv tq tv Figure 2: SurveyarelatingadetectionamethodsatoaOWASPaToparqavulnerabilityatypes Figure 3: CodeaReviewaandaPenetrationaTestingaInteractions Theseasurveysashowathatamanualacodeareviewashouldabeaaacomponentaofaaacompany’sasecurealifecyclemaasaina manyacasesaitaisaasagoodmaorabettermathanaotheramethodsaofadetectingasecurityaissueso 5.6 Coupling Source Code Review and Penetration Testing Theaterma“twqareview”arefersatoaanaapproachainawhichathearesultsaofaaasourceacodeareviewaareausedatoaplanaanda executeaaapenetrationatestmaandathearesultsaofatheapenetrationatestaaremainaturnmausedatoainformaadditionalasourcea codeareviewo CODE REVIEW SUSPECTED KNOWN VULNERABILITIES EXPLOITED VULNERABILITIES PENETRATION TEST 15Secure Code Review Knowingatheainternalacodeastructureafromatheacodeareviewmaandausingathataknowledgeatoaformatestacasesaanda abuseacasesaisaknownaasawhiteaboxatestingaialsoacalledaclearaboxaandaglassaboxatestingjoaThisaapproachacanaleadatoa aamoreaproductiveapenetrationatestmasinceatestingacanabeafocusedaonasuspectedaoraevenaknownavulnerabilitiesoaUsn ingaknowledgeaofatheaspecificaframeworksmalibrariesaandalanguagesausedainatheawebaapplicationmatheapenetrationa testacanaconcentrateaonaweaknessesaknownatoaexistainathoseaframeworksmalibrariesaandalanguageso Aawhiteaboxapenetrationatestacanaalsoabeausedatoaestablishatheaactualariskaposedabyaaavulnerabilityadiscovereda throughacodeareviewoaAavulnerabilityafoundaduringacodeareviewamayaturnaoutanotatoabeaexploitableaduringapenn etrationatestadueatoatheacodeareviewerisjanotaconsideringaaaprotectiveameasureaiinputavalidationmaforainstancejoa WhileatheavulnerabilityainathisacaseaisarealmatheaactualariskamayabealoweradueatoathealackaofaexposureoaaHoweveratherea isastillaanaadvantageatoaaddingatheapenetrationatestaencaseatheaprotectiveameasureaisachangedainatheafutureaanda thereforeaexposesatheavulnerabilityo Whileavulnerabilitiesaexploitedaduringaaawhiteaboxapenetrationatestaibasedaonasecureacodeareviewjaareacertainlya realmatheaactualariskaofatheseavulnerabilitiesashouldabeacarefullyaanalyzedoaItaisaunrealisticathataanaattackerawoulda beagivenaaccessatoatheatargetawebaapplication’sasourceacodeaandaadviceafromaitsadevelopersoaThusmatheariskathata anaoutsideaattackeracouldaexploitatheavulnerabilitiesafoundabyatheawhiteaboxapenetrationatesteraisaprobablyalown eroaHowevermaifatheawebaapplicationaorganizationaisaconcernedawithatheariskaofaattackersawithainsideaknowledgea iformeraemployeesaoracollusionawithacurrentaemployeesaoracontractorsjmathearealnworldariskamayabeajustaasahigho ThearesultsaofatheapenetrationatestacanathenabeausedatoatargetaadditionalaareasaforacodeareviewoaBesidesaaddressn ingatheaparnticularavulnerabilityaexploitedainatheatestmaitaisaaagoodapracticeatoalookaforaadditionalaplacesawhereathata sameaclassaofavulnerabilityaisapresentmaevenaifanotaexplicitlyaexploitedainatestoaForainstancemaifaoutputaencodingaisa notausedainaoneaareaaofatheaapplicationaandatheapenetrationatestaexploitedathatmaitaisaquiteapossibleathataoutputa encodingaisaalsoanotausedaelsewhereainatheaapplicationo 5.7 Implicit Advantages of Code Review to Development Practices Integratingacodeareviewaintoaaacompany’sadevelopmentaprocessesacanahaveamanyabenefitsawhichawilladependa uponatheaprocessesaandatoolsausedatoaperformacodeareviewsmahowawellathatadataaisabackedaupmaandahowathosea toolsaareausedoaTheadaysaofabringingadevelopersaintoaaaroomaandadisplayingacodeaonaaaprojectormawhilstarecordinga theareviewaresultsaonaaaprintedacopyaarealongagonematodayamanyatoolsaexistatoamakeacodeareviewamoreaefficienta andatoatrackatheareviewarecordsaandadecisionsoaWhenatheacodeareviewaprocessaisastructuredacorrectlymatheaactaofa reviewingacodeacanabeaefficientaandaprovideaeducationalmaauditableaandahistoricalabenefitsatoaanyaorganizationoa Thisasectionaprovidesaaalistaofabenefitsathataaacodeareviewaprocedureacanaaddatoadevelopmentaorganizationo Provides an historical record Ifaanyadeveloperahasajoinedaaacompanymaoramovedateamsawithinaaacompanymaandahadatoamaintainaoraenhanceaaa pieceaofacodeawrittenayearsaagomaoneaofatheabiggestafrustrationsacanabeathealackaofacontextatheanewadeveloperahasa onatheaoldacodeoaVariousaschoolsaofaopinionaexistaonacodeadocumentationmabothawithinatheacodeaicommentsjaanda externalatoatheacodeaidesignaandafunctionaladocumentsmawikismaetcojoaOpinionsarangeafromazerondocumentationa toleranceathroughatoanearnNASAaleveladocumentationmawhereatheasizeaofatheadocumentationafaraexceedsatheasizea ofatheacodeamoduleo Manyaofatheadiscussionsathataoccuraduringaaacodeareviewmaifarecordedmawouldaprovideavaluableainformationaiconn textjatoamoduleamaintainersaandanewaprogrammersoaFromatheawriteradescribingatheamoduleaalongawithasomeaofa theiradesignadecisionsmatoaeachareviewersacommentsmastatingawhyatheyathinkaoneaSQLaqueryashouldabearestrucn turedmaoraanaalgorithmachangedmathereaisaaadevelopmentastoryaunfoldingainafrontaofatheareviewersaeyesawhichacana beausedabyafutureacodersaonatheamodulemawhoaareanotainvolvedainatheareviewameetingso 16 Secure Code Review Capturingathoseareviewadiscussionsainaaareviewatoolaautomaticallyaandastoringathemaforafutureareferenceawillapron videatheadevelopmentaorganizationawithaaahistoryaofatheachangesaonatheamoduleawhichacanabeaqueriedaataaalatn eratimeabyanewadevelopersoaTheseadiscussionsacanaalsoacontainalinksatoaanyaarchitecturalpfunctionalpdesignptesta specificationsmabugaoraenhancementanumberso Verification that the change has been tested Whenaaadeveloperaisaaboutatoasubmitacodeaintoathearepositorymahowadoesatheacompanyaknowatheyahaveasufficientn lyatestedaitﬄaAddingaaadescriptionaofatheatestsatheyahavearunaimanuallyaoraautomatedjaagainstatheachangedacodea canagiveareviewersaiandamanagementjaconfidenceathatatheachangeawillaworkaandanotacauseaanyaregressionsoaAlsoa byadeclaringatheatestsatheawriterahasaranaagainstatheirachangematheaauthoraisaallowingareviewersatoareviewatheatestsa andasuggestafurtheratestingathatamayahaveabeenamissedabyatheaauthoro Inaaadevelopmentascenarioawhereaautomatedaunitaoracomponentatestingaexistsmatheacodingaguidelinesacanarequirea thatatheadeveloperaincludeathoseaunitpcomponentatestsainatheacodeareviewoaThisaagainaallowsareviewersawithinathisa environmentatoaensureatheacorrectaunitpcomponentatestsaareagoingatoabeaincludedainatheaenvironmentmakeepinga theaqualityaofatheacontinuousaintegrationacycleso Coding education for junior developers Afteraanaemployeealearnsatheabasicsaofaaalanguageaandareadaaafewaofatheabestapracticesabookmahowacanatheyageta goodaonnthenjobaskillsatoalearnamoreﬄaBesidesabuddyacodingaiwhichararelyahappensaandaisaneveracostaeffectiveja andatrainingasessionsaibrownabagasessionsaonacodingmatechatalksmaetcojatheadesignaandacodeadecisionsadiscusseda duringaaacodeareviewacanabeaaalearningaexperienceaforajunioradevelopersoaManyaexperiencedadevelopersaadmitatoa thisabeingaaatwoawayastreetmawhereanewadevelopersacanacomeainawithanewaideasaoratricksathatatheaolderadevelopersa canalearnafromoaAltogetherathisacrossapollinationaofaexperienceaandaideasacanaonlyabeabeneficialatoaaadevelopmenta organizationo Familiarization with code base Whenaaanewafeatureaisadevelopedmaitaisaoftenaintegratedawithatheamainacodeabasemaandahereacodeareviewacanabeaaa conduitaforatheawiderateamatoalearnaaboutatheanewafeatureaandahowaitsacodeawillaimpactatheaproductoaThisahelpsa preventafunctionaladuplicationawhereaseparateateamsaendaupacodingatheasameasmallapieceaofafunctionalityo ThisaalsoaappliesaforadevelopmentaenvironmentsawithasiloedateamsoaHereatheacodeareviewaauthoracanareachaoutatoa otherateamsatoagainatheirainsightmaandaallowathoseaotherateamsatoareviewatheiramodulesmaandaeveryoneathenalearnsa aabitamoreaaboutatheacompany’sacodeabaseo Pre-warning of integration clashes Inaaabusyacodeabaseathereawillabeatimesaiespeciallyaonacoreacodeamodulesjawhereamultipleadevelopersacanawritea codeaaffectingatheasameamoduleoaManyapeopleahaveahadatheaexperienceaofacuttingatheacodeaandarunningathea testsmaonlyatoadiscoverauponasubmissionathatasomeaotherachangeahasamodifiedatheafunctionalitymarequiringathea authoratoarecodeaandaretestasomeaaspectsaofatheirachangeoaSpreadingatheawordaonaupcomingachangesaviaacodea reviewsagivesaaagreaterachanceaofaaadeveloperalearningathataaachangeaisaaboutatoaimpactatheiraupcomingacommitma andadevelopmentatimelinesmaetcomacanabeaupdatedaaccordinglyo ManyadevelopmentaenvironmentsahaveacodingaguidelinesawhichanewacodeamustaadhereatooaCodingaguidelinesa canatakeamanyaformsoaIt’saworthapointingaoutathatasecurityaguidelinesacanabeaaaparticularlyarelevantatouchapointa Secure Coding Guidelines Touch Point 17Secure Code Review 5.8 Technical Aspects of Secure Code Review SecurityacodeareviewsaareaveryaspecificatoatheaapplicationabeingareviewedoaTheyamayahighlightasomeaflawsathata areanewaoraspecificatoatheacodeaimplementationaofatheaapplicationmalikeainsecureaterminationaofaexecutionaflowma synchronizationaerrorsmaetcoaTheseaflawsacanaonlyabeauncoveredawhenaweaunderstandatheaapplicationacodeaflowa andaitsalogicoaThusmasecurityacodeareviewaisanotajustaaboutascanningatheacodeaforasetaofaunknownainsecureacodea patternsabutaitaalsoainvolvesaunderstandingatheacodeaimplementationaofatheaapplicationaandaenumeratingathea flawsaspecificatoaito Theaapplicationabeingareviewedamightahaveabeenadesignedawithasomeasecurityacontrolsainaplacemaforaexampleaaa centralizedablacklistmainputavalidationmaetcoaaTheseasecurityacontrolsamustabeastudiedacarefullyatoaidentifyaifatheya areafoolnproofoaAccordingatoatheaimplementationaofatheacontrolmatheanatureaofaattackaoraanyaspecificaattackavecn torathatacanabeausedatoabypassaitmamustabeaanalyzedoaEnumeratingatheaweaknessainatheaexistingasecurityacontrola isaanotheraimportantaaspectaofatheasecurityacodeareviewso Therea area variousa reasonsa whya securitya flawsa manifesta ina thea applicationma likea aa lacka ofa inputa validationa ora parameteramishandlingoaInatheaprocessaofaaacodeareviewatheaexactarootacauseaofaflawsaareaexposedaandathea completeadataaflowaisatracedoaTheaterma‘sourceatoasinkaanalysis’ameansatoadetermineaallapossibleainputsatoathea applicationaisourcejaandahowatheyaareabeingaprocessedabyaitaisinkjoaAasinkacouldabeaanainsecureacodeapatterna likeaaadynamicaSQLaquerymaaalogawritermaoraaaresponseatoaaaclientadeviceoa ConsideraaascenarioawhereatheasourceaisaaauserainputoaItaflowsathroughatheadifferentaclassespcomponentsaofathea applicationaandafinallyafallsaintoaaaconcatenatedaSQLaqueryaiaasinkjaandathereaisanoaproperavalidationabeinga appliedatoaitainatheapathoaInathisacaseatheaapplicationawillabeavulnerableatoaSQLainjectionaattackmaasaidentifieda byatheasourceatoasinkaanalysisoaSuchaanaanalysisahelpsainaunderstandingmawhichavulnerableainputsacanaleadatoaaa possibilityaofaanaexploitainatheaapplicationo Onceaaaflawaisaidentifiedmathearevieweramustaenumerateaallatheapossibleainstancesapresentainatheaapplicationoa Thisawouldanotabeaaacodeareviewainitiatedabyaaacodeachangemathisawouldabeaaacodeascanainitiatedabyamanagen menta baseda ona aa flawa beinga discovereda anda resourcesa beinga committeda toa finda ifa thata flawa existsa ina othera partsaofatheaproductoaaForaexamplemaanaapplicationacanabeavulnerableatoaXSSavulnerabilityabecauseaofauseaofa unnvalidatedainputsainainsecureadisplayamethodsalikeascriptletsa‘responseowrite’amethodmaetcoainaseveralaplaceso 5.9 Code Reviews and Regulatory Compliance Manyaorganizationsawitharesponsibilityaforasafeguardingatheaintegritymaconfidentialityaandaavailabilityaofatheira softwareaandadataaneedatoameetaregulatoryacomplianceoaThisacomplianceaisausuallyamandatoryaratherathanaaa voluntaryastepatakenabyatheaorganizationoa Compliance regulations include: • PCIaiPaymentaCardaIndustryjastandards • Centralabankaregulations withinaaacodeareviewmaasaunfortunatelyatheasecureacodingaissuesaareaunderstoodaonlyabyaaasubsetaofatheadevelopn mentateamoaThereforeaitacanabeapossibleatoaincludeateamsawithavariousatechnicalaexpertiseaintoatheacodeareviewsma ioeoasomeoneafromatheasecurityateamaiorathatapersonainatheacornerawhoaknowsaallatheasecurityastuffjacanabeainviteda asaaatechnicalasubjectaexpertatoatheareviewatoacheckatheacodeafromatheiraparticularaangleoaThisaisawhereatheaOWASPa toparqaguidelinesacouldabeaenforcedo 18 Secure Code Review • Auditingaobjectives • HIPPA Complianceaisaanaintegralapartaofasoftwareasecurityadevelopmentalifencycleaandacodeareviewaisaanaimportanta partaofacomplianceaasamanyarulesainsistaonatheaexecutionaofacodeareviewsainaorderatoacomplyawithacertainaregn ulationso Toaexecuteaproperacodeareviewsathatameetacompliancearulesaitaisaimperativeatoauseaanaapprovedamethodolon gyoaCompliancearequirementsasuchaasaPCImaspecificallyarequirementaw–a“Developaandamaintainasecureasystems”ma whileaPCInDSSatoqmawhichahasabeenaavailableasinceaNovemberasqrtmaexposesaaaseriesaofarequirementsawhicha applyatoadevelopmentaofasoftwareaandaidentifyingavulnerabilitiesainacodeoaTheaPaymentaCardaIndustryaDataa SecurityaStandardaiPCInDSSjabecameaaamandatoryacomplianceastepaforacompaniesaprocessingacreditacardapayn mentsainaJuneasqqvoaPerformingacodeareviewsaonacustomacodeahasabeenaaarequirementasinceatheafirstaversiona ofatheastandardoa TheaPCIastandardacontainsaseveralapointsarelatingatoasecureaapplicationadevelopmentmabutathisaguideawillafocusa solelyaonatheapointsmawhichamandateacodeareviewsoaAllaofatheapointsarelatingatoacodeareviewsacanabeafoundaina requirementawa“Developaandamaintainasecureasystemsaandaapplications”oa 5.10 PCI-DSS Requirements Related to Code Review SpecificallymarequirementawotosamandatesaaacodeareviewaofacustomacodeoaReviewingacustomacodeaprioratoaren leaseatoaproductionaoracustomersainaorderatoaidentifyaanyapotentialacodingavulnerabilityaiusingaeitheramanuala oraautomatedaprocessesjatoaincludeaataleastatheafollowing– • Codeachangesaareareviewedabyaindividualsaotherathanatheaoriginatingacodeaauthormaandabyaindividualsaknowln edgeableaaboutacodeareviewatechniquesaandasecureacodingapracticeso • Codeareviewsaensureacodeaisadevelopedaaccordingatoasecureacodingaguidelines • Appropriateacorrectionsaareaimplementedaprioratoareleaseo • Codeareviewaresultsaareareviewedaandaapprovedabyamanagementaprioratoareleaseo Requirement 6.5 address common coding vulnerabilities in software-development processes as follows: • Trainadevelopersainasecureacodingatechniquesmaincludingahowatoaavoidacommonacodingavulnerabilitiesmaanda understandingahowasensitiveadataaisahandledainamemoryo • Developaapplicationsabasedaonasecureacodingaguidelineso Thea PCIa Councila expandeda optiona onea toa includea internala resourcesa performinga codea reviewsoaThisa addeda weightatoaanainternalacodeareviewaandashouldaprovideaanaadditionalareasonatoaensureathisaprocessaisaperformeda correctlyo TheaPaymentaApplicationaDataaSecurityaStandardaiPAnDSSjaisaaasetaofarulesaandarequirementsasimilaratoaPCInDSSoa HowevermaPAnDSSaappliesaespeciallyatoasoftwareavendorsaandaothersawhoadevelopapaymentaapplicationsathata storemaprocessmaoratransmitacardholderadataaasapartaofaauthorizationaorasettlementmawhereatheseapaymentaapplin cationsaareasoldmadistributedmaoralicensedatoathirdapartiesoa 19Secure Code Review PA-DSS Requirements Related to Code Review RequirementsaregardingacodeareviewaareaalsoaappliedasinceatheseaareaderivedafromaPAnDSSainarequirementava iPCImasqrqj–a vosaDevelopaallapaymentaapplicationsaiinternalaandaexternalmaandaincludingawebaadministrativeaaccessatoaprodn uctjabasedaonasecureacodingaguidelineso vorouaReviewaofapaymentaapplicationacodeaprioratoareleaseatoacustomersaafteraanyasignificantachangematoaidentin fyaanyapotentialacodingavulnerabilityo Note: Thisarequirementaforacodeareviewsaappliesatoaallapaymentaapplicationacomponentsaibothainternalaanda publicnfacingawebaapplicationsjmaasapartaofatheasystemadevelopmentalifeacycleoaCodeareviewsacanabeaconducteda byaknowledgeableainternalapersonnelaorathirdapartieso 20 METHODOLOGY Codeareviewaisasystematicaexaminationaofacomputerasourceacodeaandareviewsaareadoneainavariousaformsaanda canabeaaccomplishedainavariousastagesaofaeachaorganizationaSnSDLCoaThisabookadoesanotaattemptatoatellaeacha organizationahowatoaimplementacodeareviewsainatheiraorganizationabutathisasectionadoesagoaoverainagenerica termsaandamethodologyaofadoingacodeareviewsafromainformalawalkthroughsmaformalainspectionsmaoraToolnassistn edacodeareviewso 6.1 Factors to Consider when Developing a Code Review Process Whena planninga toa executea aa securitya codea reviewma therea area multiplea factorsa toa considera sincea everya codea reviewaisauniqueatoaitsacontextoaInaadditionatoatheaelementsadiscussedainathisasectionmaoneamustaconsideraanya technicala ora businessa relateda factorsa ibusinessa decisionsa sucha asa deadlinesa anda resourcesja thata impacta thea analysisaasatheseafactorsaandamayaultimatelyadecideatheacourseaofatheacodeareviewaandatheamostaeffectiveawaya toaexecuteaito Risks Itaisaimpossibleatoasecureaeverythingaatarqqfmathereforeaitaisaessentialatoaprioritizeawhatafeaturesaandacomponentsa mustabeasecurelyareviewedawithaaariskabasedaapproachoaWhileathisaprojectahighlightsasomeaofatheavitalaareasaofadesigna securityapeeraprogrammersashouldareviewaallacodeabeingasubmittedatoaaarepositorymanotaallacodeawillareceiveatheaattenn tionaandascrutinyaofaaasecureacodeareviewo Purpose & Context Computeraprogramsahaveadifferentapurposesaandaconsequentlyatheagradeaofasecurityawillavaryadependingaonathea functionalityabeingaimplementedoaAapaymentawebaapplicationawillahaveahigherasecurityastandardsathanaaapromotionna alawebsiteoaStayaremindedaofawhatatheabusinessawantsatoaprotectoaInatheacaseaofaaapaymentaapplicationmadataasuchaasa creditacardsawillahaveatheahighestapriorityahoweverainatheacaseaofaaapromotionalawebsitemaoneaofatheamostaimportanta thingsatoaprotectawouldabeatheaconnectionacredentialsatoatheawebaserversoaThisaisaanotherawayatoaplaceacontextaintoaaa risknbasedaapproachoaPersonsaconductingatheasecurityareviewashouldabeaawareaofatheseaprioritieso Lines of Code AnaindicatoraofatheaamountaofaworkaisatheanumberaofalinesaofacodeathatamustabeareviewedoaIDEsaiIntegratedaDen velopmentaEnvironmentsjasuchaasaVisualaStudioaoraEclipseacontainafeaturesmawhichaallowsatheaamountaofalinesa ofacodeatoabeacalculatedmaorainaUnixpLinuxathereaareasimpleatoolsalikea‘wc’athatacanacountathealinesoaProgramsa writtenainaobjectnorientedalanguagesaareadividedaintoaclassesaandaeachaclassaisaequivalentatoaaapageaofacodeoa Generallyalineanumbersahelpapinpointatheaexactalocationaofatheacodeathatamustabeacorrectedaandaisaveryausefula whenareviewingacorrectionsadoneabyaaadeveloperaisuchaasatheahistoryainaaacodearepositoryjoaTheamorealinesaofa codeaaaprogramacontainsmatheagreateratheachancesathataerrorsaareapresentainatheacodeo Programming language Programsa writtena ina typeda safea languagesa isucha asa Cda ora Javaja area lessa vulnerablea toa certaina securitya bugsa suchaasabufnaferaoverflowsathanaothersalikeaCaandaClloaWhenaexecutingacodeareviewmatheakindaofalanguageawilla determineatheatypesaofaexpectedabugsoaTypicallyasoftwareahousesatendatowardsaaafewalanguagesathatatheira programmersaareaexperiencedainmahoweverawhenaaadecisionaisamadeatoacreateanewacodeainaaalanguageanewatoa theadeveloperamanagementamustabeaawareaofatheaincreasedariskaofasecurelyareviewingathatacodeadueatoathea lackaofainnhouseaexperienceoaThroughoutathisaguidemasectionsaexplainatheamostacommonaissuesasurroundinga theaspecificaprogrammingalanguageacodeatoabeareviewedmauseathisaasaaareferenceatoaspotaspecificasecurityaissuesa inatheacodeo Methodology 21 Resources, Time & Deadlines AsaevermathisaisaaafundamentalafactoroaAaproperacodeareviewaforaaacomplexaprogramawillatakealongeraandaitawilla needa highera analysisa skillsa thana aa simplea oneoaThea risksa involveda ifa resourcesa area nota properlya provideda area higheroaMakeasureathatathisaisaclearlyaassessedawhenaexecutingaaareviewo 6.2 Integrating Code Reviews in the S-SDLC CodeareviewsaexistainaeveryaformalaSecureaSoftwareaDevelopmentaLifecycleaiSnSDLCjmabutacodeareviewsaalsoa varyawidelyainatheiralevelaofaformalityoaToaconfuseatheasubjectamoremacodeareviewsavaryainapurposeaandainarelan tionatoawhatatheacodearevieweraisalookingaformabeaitasecuritymacompliancemaprogrammingastylemaetcoaThroughouta theaSnSDLCaiXPmaAgilemaRADmaBSIMMmaCMMImaMicrosoftaALMjathereaareapointsawhereaanaapplicationasecurityaSMEa shouldatoabeainvolvedoaTheaideaaofaintegratingasecureacodeareviewsaintoaanaSnSLDCamayasoundadauntingaasa therea isa anothera layera ofa complexitya ora additionala costa anda timea toa ana alreadya overa budgeta anda timea conn strainedaprojectoaHoweveraitaisaprovenatoabeacostaeffectiveaandaprovidesaanaadditionalalevelaofasecurityathata staticaanalyzersacannotaprovideoaa Inasomeaindustriesatheadriveaforasecureaenhancementsatoaaacompany’saSnSDLCamayanotabeadrivenapurelyabya theadesireatoaproduceabetteracodematheseaindustriesahavearegulationsaandalawsathatademandaaalevelaofadueacarea whenawritingasoftwareaieogoatheagovernmentalaandafinancialaindustriesjaandatheafinesalevelledaataaacompanya whoahasanotaattemptedatoasecureatheiraSnSDLCawillabeafaragreaterathanatheacostsaofaaddingasecurityaintoathea developmentalifecycleo WhenaintegratingasecureacodeareviewsaintoatheaSnSDLCatheaorganizationashouldacreateastandardsaandapoliciesa thatatheasecureacodeareviewerashouldaadhereatooaThisawillacreateathearightaimportanceaofatheataskasoaitaisanotajusta lookedaataasaaaprojectataskathatajustaneedsatoabeacheckedaoffoaProjectatimeaalsoaneedsatoabeaassignedatoatheataska soathereaisaenoughatimeatoacompleteatheatasksaiandaforaanyaremedialatasksathatacomeaoutaofatheasecureacodea reviewjoaaStandardsaalsoaallowamanagementaandasecurityaexpertsaieogoaCISOsmasecurityaarchitectsjatoadirectaemn ployeesaonawhatasecureacodingaisatoabeaadheredatomaandaallowsatheaemployeesatoareferatoatheaistandardjawhena reviewaarbitrationaisanecessaryo Methodology A standard report template will provide enough information to enable the code reviewer to clas- sify and prioritize the software vulnerabilities based on the applications threat model. This report does not need to be pages in length, it can be document based or incorporated into many auto- mated code review tools. A report should provide the following information: • Date of review. • Application name, code modules reviewed. • Developers and code reviewer names. • Task or feature name, (TFS, GIT, Subversion, trouble ticket, etc.). Code Review Reports 22 TodayamostaorganizationsahaveamodifiedatheiraSnSDLCaprocessatoaaddaagileaintoatheiraSnSDLCaprocessoaBecauseaofathisa theaorganizationaisagoingatoaneedatoalookaatatheiraownainternaladevelopmentapracticesatoabestadetermineawhereaanda howaoftenasecureacodeareviewsaneedatoahappenoaIfatheaprojectaisalateaandaoverabudgetathenathisaincreasesatheachancea thataaasoftwareafixacouldacauseaaasecureavulnerabilityasinceanowatheaemphasisaisaonagettingatheaprojectatoadeploymenta quickeroaCodeareviewsaforacodeainaproductionamayafindasoftwareavulnerabilitiesabutaunderstandathatathereaisaaaracea withahackersatoafindatheabugaandatheavulnerableasoftwareawillaremainainaproductionawhileathearemedialafixaisabeinga workedaono 6.3 When to Code Review OnceaanaorganizationadecidesatoaincludeacodeareviewsapartaofatheirainternalacodeaprocessoaTheanextabigaquestionatoa askaisatoadetermineawhatastagesaofatheaSDLCawillatheacodeabeareviewedoaThisasectionatalksaaboutathreeapossibleawaysatoa includeacodeareviewsoaThereaareathreeastagesabeainatheaSDLCawhenacodeacanabeareviewed– When code is about to be checked in (pre-commit) Theadevelopmentaorganizationacanastateainatheiraprocessathataallacodeahasatoabeareviewedabeforeatheacodeacanabea submittedatoatheasourceacodearepositoryoaaThisahasatheadisadvantageaofaslowingatheacheckninaprocessadownmaasathea reviewacanatakeatimemahoweveraitahasamanyaadvantagesainathatabelowastandardacodeaisaneveraplacedainatheacodealinema andamanagementacanabeaconfidentathataiifaprocessesaareabeingafollowedjatheasubmittedacodeaisaatatheaqualityathata hasabeenastipulatedoaa Foraexamplemaprocessesamayastateathatacodeatoabeasubmittedamustaincludealinksatoarequirementsaandadesignadocun mentationaandanecessaryaunitaandaautomatedatestsoaThisawayatheareviewersawillahaveacontextaonatheaexactacodeamodn ificationabeingadoneaidueatoatheadocumentationjaandatheyawillaknowahowatheadeveloperahasatestedatheacodeaidueatoa theatestsjoaaIfatheapeerareviewersadoanotathinkatheadocumentationaisacompletemaoratheatestsaareaextensiveaenoughmatheya canarejectatheareviewmanotabecauseaofatheacodeaitselfmabutabecauseatheanecessaryadocsaoratestsaareanotacompleteoaInaana environmentausingaCIawithaautomatedatestsarunninganightlymatheadevelopmentateamaasaaawholeawillaknowatheanexta dayaifollowingacheckninjaifatheasubmittedacodeawasaofaenoughaqualityoaaAlsoamanagementaknowathataonceaaabugaora featureaisacheckedainathatatheadeveloperahasafinishedatheirataskmathere’sanoa“I’llafinishathoseatestsaupanextaweek”ascenarn iosawhichaaddsariskatoatheadevelopmentatasko When code has just been checked into a code base (post-commit) Hereatheadeveloperasubmitsatheiracodeachangemaandathenausesatheacodearepositoryachangenlistsatoasendatheacodea diffaforareviewoaaThisahasatheaadvantageaofabeingafasteraforatheadeveloperaasathere’sanoareviewagateatoapassabeforeatheya checkninatheiracodeoaaTheadisadvantageaisathatmainapracticemathisamethodacanaleadatoaaalesseraqualityaofacodeoaaAadevelopn Methodology • A brief sentence(s) to classify and prioritize software vulnerability if any and what if any remedial tasks need to be accomplished or follow up is needed. • Link to documents related to task/feature, including requirements, design, testing and threat modeling documents. • Code Review checklist if used, or link to organization Code Review Checklist. (see Appendix A) • Testing the developer has carried out on the code. Preferably the unit or automated tests them- selves can be part of the review submission. • If any tools such as FxCop, BinScope Binary Analyzer, etc. were used prior to code review. 23 erawillabealessainclinedatoafixasmalleraissuesaonceatheacodeahasabeenacheckedainmausuallyawithaaamantraaofa“Wellatheacodea isainanowmait’lladoo”oaaThereaalsoaaariskaofatimingmaasaotheradevelopersacouldawriteaotheracodeafixesaintoatheasameamodulea beforeatheareviewaisadoneaorachangesaandatestsahaveabeenawrittenmameaningatheadeveloperanotaonlyahasatoaimplementa theacodeachangesafromatheapeeraorasecurityareviewmabutatheyaalsoahaveatoadoasoainaaawayathatadoesanotabreakaothera subsequentachangesoaaSuddenlyatheadeveloperahasatoarentestatheasubsequentafixesatoaensureanoaregressionso SomeadevelopmentaorganizationsausingatheaAgileamethodologyaaddaaa‘securityasprint’aintoatheiraprocessesoaDuringathea securityasprintatheacodeacanabeasecurityareviewedmaandahaveasecurityaspecificatestacasesaiwrittenaoraautomatedjaaddedo When code audits are done Someaorganizationsahaveaprocessesatoareviewacodeaatacertainaintervalsaiioeoayearlyjaorawhenaaavulnerableapieceaofa codeaisasuspectedaofabeingarepeatedathroughoutatheacodeabaseoaaHereastaticacodeaanalyzersmaorasimpleastringasearchesa throughatheacodeaiforaspecificavulnerabilityapatternsjacanaspeedaupatheaprocessoaaThisareviewaisanotaconnectedatoathea submissionaofaaafeatureaorabugafixmatheyaareatriggeredabyaprocessaconsiderationsaandaarealikelyatoainvolveatheareviewaofa anaentireaapplicationaoracodeabasearatherathanaaareviewaofaaasingleasubmissiono 6.4 Security Code Review for Agile and Waterfall Development Todayaagileadevelopmentaisaanaumbrellaatermaforaaalotaofapracticesathataincludeaprogrammingmacontinuousainten grationmatestingmaprojectamanagementmaetcoaThereaareamanyaflavorsaofaagileadevelopmentmaperhapsaasamanyaflavorsa asathereaareapractitionersoaAgileadevelopmentaisaaaheterogeneousareferenceaframeworkawhereatheadevelopmenta teamacanapickawhatapracticesatheyawantatoauseoa Agileahasasomeapracticesathatacouldaaffectahowaandawhenacodeaisareviewedmaforaexampleaagileatriesatoakeepacodea reviewaandatestingaasanearaasapossibleatoatheadevelopmentaphaseoaItaisaaacommonapracticeatoadefineashortadeveln opmentacyclesaiaokoaoaIterationsaoraSprintsjoaAtatheaendaofaeachacyclemaallatheacodeashouldabeaproductionaqualitya codeoaItacanabeaincompletemabutaitamustaaddasomeavalueoaThataaffectsatheareviewaprocessmaasareviewingashouldabea continuousoaFromatheapointaofaviewaofasecureacodingareviewmaitashouldn’tamakeaaadifferenceaifatheadevelopmenta Methodology SomeaorganizationsaassumeasecureacodeareviewacanabeaaajobaforaaasecurityaorarisknanalysisateamamemberoaaHown everaalladevelopersaneedatoaunderstandatheaexposureapointsaofatheiraapplicationsaandawhatathreatsaexistaforatheira applicationsoa Manyacompaniesahaveasecurityateamsathatadoanotahaveamembersawithacodingabackgroundsmawhichacanamakea interactionsawithadevelopmentateamsachallengingoaBecauseaofathisadevelopmentateamsaareausuallyaskepticalaofa securityainputaandaguidanceoaSecurityateamsaareausuallyawillingatoaslowathingsadownatoaensureaconfidentialitya andaintegrityacontrolsaareainaplaceawhileadevelopersaareafaceawithapressureafromabusinessaunitsatheyasupportatoa createaandaupdateacodeaasaquicklyaasapossibleoaUnfortunatelyatheamoreacriticalatheaapplicationatoaoperationalaora businessaneedsmatheamoreapressureatoadeployatheacodeatoaproductiono ItaisabestatoaweaveasecureacodeareviewsaintoatheaSDLCaprocessesasoathatadevelopmentaorganizationsadoanotaseea securityaasaaahindrancemabutaasaanaassistanceoaaAsamentionedapreviouslymaspreadingasecureacodingaSMEsathroughn outaanaorganizationaisatellitesainaBSIMMaterminologyjaallowsatheasecureacodeareviewatasksatoascaleaandareacha moreadevelopmentateamsoaaAsatheaprocessagrowsmamoreaofatheadevelopersagainaawarenessaofasecureacodingaissuesa iasatheyahaveareviewsarejectedaonasecureacodingagroundsjaandatheafrequencyaofasecureacodingaissuesainacodea reviewsashouldadropo Who Should Perform Secure Code Reviews 24 organizationausesaagileaorawaterfalladevelopmentapracticesoaaCodeareviewaisaalignedatoatheacodeasubmittedmanotathea orderaofafeatureadevelopmentavsatestingmaoratheatimeapatternsaassignedatoatheacodingataskoaaInamanyaorganizationsa thealineabetweenawaterfallaandaagileaisabecomingablurredmawithatraditionalawaterfalladepartmentsaintroducingathea continuousaintegrationaiCIjaaspectsafromaagilemaincludinganightlyabuildsmaautomatedatestingmatestadrivenadevelopn mentmaetco 6.5 A Risk Based Approach to Code Review Aadevelopmentahouseawillahaveavariousadegreesaofacodeachangesabeingareviewedmafromasimpleaonealineabugafixesa inabackendascriptsathatarunaonceaaayearmatoalargeafeatureasubmissionsainacriticalabusinessalogicoaTypicallyatheaintenn sityaofatheacodeareviewavariesabasedaonatheaperceivedariskathatatheachangeapresentso Inatheaendmatheascaleaofatheacodeareviewacomesadownatoatheamanagementaofaresourcesaiskilledapersonsmacompanya timemamachinesmaetcojoaItawouldanotabeascalableatoabringainamultipleasecurityaexpertsaforaeveryacodeachangeaoccurn ringaonaaaproductmathearesourcesaofathoseapersonsaorathoseateamsawouldanotabealargeaenoughatoahandleaeverya changeoaThereforeacompaniesacanamakeaaacallaonawhichachangesaareaimportantaandaneedatoabeacloselyascrutin nizedmaandawhichaonesacanabeaallowedathroughawithaminimalainspectionoaThisawillaallowamanagementatoabettera sizeatheadevelopmentacyclemaifaaachangeaisagoingatoabeadoneainaanaareaawhichaisahighariskmamanagementacanaknowa toasetaasideasufficientatimeaforacodeareviewaandaensureapersonsawitharelevantaskillsawillabeaavailableoaTheaprocessa ofadecidingawhichachangesaneedawhichalevelaofacodeareviewaisabasedaonatheariskalevelaofatheamoduleatheachangea isawithino Ifatheareviewaintensityaofacodeachangesaisabasedaonatheariskalevelaofatheamoduleabeingachangedmawhoashoulda decideathealevelaofariskﬄaUltimatelyamanagementaisaresponsibleaforatheaoutputaofaaacompanymaandathusatheyaarea responsibleaforatheariskaassociatedawithaproductsasoldabyatheacompanyoaThereforeaitaisaupatoamanagementaiorapern sonsadelegatedabyamanagementjatoacreateaaareproducibleameasureaoraframeworkaforadecidingatheariskaassociateda withaaacodeachangeoa Decisionsaonatheariskaofaaamoduleaorapieceaofacodeashouldabeabasedaonasolidacostabenefitaanalysisaandaitawouldabea irresponsibleatoadecideaallamodulesaareahighariskoaThereforeamanagementashouldameetawithapersonsawhoahavea anaunderstandingaofatheacodeabaseaandasecurityaissuesafacedabyatheaproductsmaandacreateaaameasureaofariskafora variousaelenmentsaofacodeoaCodeacouldabeasplitaupaintoamodulesmadirectoriesmaproductsmaetcomaeachawithaaariskalevela associatedawithaito Variousamethodsaexistainathearealmaofariskaanalysisatoaassignariskatoaentitiesmaandamanyabooksahaveabeenadedicateda toathisatypeaofadiscussionoaTheathreeamainatechniquesaforaestablishingariskaareaoutlined in table 1 below. Methodology Technique Method Quantitative BringapeopleatogetheraandaestablishaaamonetaryavalueaonatheapotentialalossaassociatedawithatheacodeoaGaugeathealikelin hoodathatatheacodeacouldabeacompromisedoaUseadollaravaluesaproducedafromatheseacalculationsatoadetermineathealevela ofarisko Qualitative Delphi Bringapeopleatogetheraandadiscussaopinionsaonawhatalevelaofalossaisaassociatedawithatheamodulesmaandaopinionsaonalikelin hoodaofacompromiseoaQualitativeadoesanotaattemptatoanailadownamonetaryaassociationsawithathealossmabutatendsatowardsa theaperceptionaoraopinionaofaassociatedalosseso Independentlyainterviewaoraquestionapeopleaonathealossesaandacompromisesaofatheamodulesmawhilstalettingathemaknowa theafeedbackawillabeaanonymousoaTheaimpressionahereaisathatatheapeopleawillagiveamoreahonestaanswersatoatheaquestionsa andawillanotabeaswayedabyaotherapeople’saargumentsaandaanswerso Table 1: OptionsaForaEstablishingaRisk 25 RiskaisachanceaofasomethingabadahappeningaandatheadamageathatacanabeacausedaifaitaoccursoaTheacriteriaaforadecidn ingatheariskaprofileaofadifferentacodeamodulesawillabeaupatoatheamanagementateamaresponsibleaforadeliveringathea changesmaexamplesaareaprovidedain table 2. Whenalevelsaofariskahaveabeenaassociatedawithaproductsaandamodulesmathenatheapoliciesacanabeacreatedadetern miningawhatalevelaofacodeareviewamustabeaconductedoaItacouldabeathatacodeachangesainaaalevelaoneariskamodulea mustabeareviewedabyatapersonsaincludingaaaSecurityaArchitectmawhereasachangesainaaalevelauariskamoduleaonlya needaaaquickaoneapersonapeerareviewoa Otheraoptionsaioracriteriajaforariskieramodulesacanaincludeademandsaonaautomatedatestingaorastaticaanalysismaeogoa codeachangesainahighariskacodeamustaincludeayqfacodeacoverageaonastaticaanalysisatoolsmaandasufficientaauton matedatestsatoaensureanoaregressionsaoccuroaTheseacriteriaacanabeademandedaandacheckedaasapartaofatheacodea reviewatoaensureatheyaareacapableaofatestingatheachangedacodeo Someacompaniesalogicallyasplitatheiracodeaintoadifferingarepositoriesmawithamoreasensitiveacodeaappearingainaaa repositoryawithaaalimitedasubsetaofadevelopersahavingaaccessoaIfatheacodeaisasplitainathisafashionmathenaitamustabea rememberedathataonlyadevelopersawithaaccessatoatheariskieracodeashouldabeaableatoaconductareviewsaofathata codeo Riskaanalysisacouldaalsoabeausedaduringatheacodeareviewatoadecideahowatoareactatoaaacodeachangeathataintroducn esariskaintoatheaproductmaasainatable 3oaInaaatypicalariskaanalysisaprocessmatheateamaneedsatoadecideawhetheratoa acceptmatransfermaavoidaorareduceathearisksoaWhenaitacomesatoacodeareviewsaitaisanotapossibleatoatransferatheariska asatransferringariskanormallyameansatakingaoutainsuranceatoacoveratheacostaofaexposureo Methodology Criteria Explanation Ease of exposure IsatheacodeachangeainaaapieceaofacodeadirectlyaexposedatoatheainternetﬄaDoesaanainsiderauseatheainterfaceadirectlyﬄ Value of loss Regulatory controls HowamuchacouldabealostaifatheamoduleahasaaavulnerabilityaintroducedﬄaDoesatheamoduleacontainasomeacriticalapassworda hashingamechanismmaoraaasimpleachangeatoaHTMLaborderaonasomeainternalatestatoolﬄ Ifaaapieceaofacodeaimplementsabusinessalogicaassociatedawithaaastandardathatamustabeacompliedawithmathenatheseamodn ulesacanabeaconsideredahighariskaasatheapenaltiesaforanonnconformityacanabeahigho Table 2: CommonaCriteriaaForaEstablishingaTheaRiskaProfileaOfaAaCodeaModule Risk Resolution Explanation Reduce ThisaisatheatypicalaresolutionapathoaWhenaaacodeareviewerafindsathatatheacodeachangeaintroducesariskaintoaanaelementaofa businessalogicaiorasimplyaaabugjatheacodeawillabeachangedatoafixatheabugaoracodeainaaawayathatareducesathearisko Accept Whenatheacodeachangeaintroducesaaariskainatheacodeabutathereaisanoaotherawayatoaimplementatheabusinessalogicmatheacodea changeacanapassacodeareviewaifatheariskaisaconsideredaacceptableoaTheariskaandaanyaworkaroundsaoramitigatingafactorsa shouldabeadocumentedacorrectlyasoathataitaisanotaignoredoa Table 3: OptionsaForaHandlingaRisksaIdentifiedaInaAaCodeaReview Avoid Whenatheacodeachangeaintroducesaaariskathataisatooagreatatoabeaacceptedmaandaitaisanotapossibleatoareduceatheariskabyaimplen mentingaaacodeachangemathenatheateamaneedatoaconsideranotaperformingatheachangeoaIdeallyathisadecisionashouldabeareacheda beforeatheacodeareviewastagemabutaitaisaentirelyapossibleathatafactorsacanaariseaduringacodeaimplementationathatachangesathea understoodariskaprofileaofaaacodeamoduleaandapromptsamanagementatoareconsideraifaaachangeashouldagoaaheado 26 6.6 Code Review Preparation Aasecurityareviewaofatheaapplicationashouldauncoveracommonasecurityabugsaasawellaasatheaissuesaspecificatoabusinessa logicaofatheaapplicationoaaInaorderatoaeffectivelyareviewaaabodyaofacodeaitaisaimportantathatatheareviewersaunderstanda theabusinessapurposeaofatheaapplicationaandatheacriticalabusinessaimpactsoaTheareviewersashouldaunderstandatheaattacka surfacemaidentifyatheadifferentathreataagentsaandatheiramotivationsmaandahowatheyacouldapotentiallyaattackatheaapplican tiono Foratheasoftwareadeveloperawhoseacodeaisabeingareviewedmaperformingacodeareviewacanafeelalikeaanaauditaandadeveln opersamayafindaitachallengingatoanotatakeatheafeedbackapersonallyoaAawayatoaapproachathisaisatoacreateaanaatmospherea ofacollaborationabentweenatheareviewermatheadevelopmentateammatheabusinessarepresentativesmaandaanyaotheravesteda interestsoaPorntrayingatheaimageaofaanaadvisoraandanotaaapolicemanaisaimportantatoagetaconoperationafromatheadeveln opmentateamo Theaextentatoawhichainformationagatheringaoccursawilladependaonatheasizeaofatheaorganizationmatheaskillasetaofathearen viewersmaandatheacriticalitypriskaofatheacodeabeingareviewedoaAasmallachangeatoatheaCSSafileainaaasqnapersonastartnupawilla notaresultainaaafullathreatamodelaandaaaseparateasecureareviewateamoaAtatheasameatimeaaanewasingleasignnonaauthentican tionamoduleainaaamultinbillionadollaracompanyawillanotabeasecureacodeareviewedabyaaapersonawhoaonceareadaanaarticlea onasecureacodingoaEvenawithinatheasameaorganizationmahighnriskamodulesaoraapplicationsamayagetathreatamodeledma whereathealowerariskamodulesacanabeareviewedawithaaalesseraemphasisaonathearevieweraunderstandingatheasecuritya modelaofatheamoduleo Thisasectionawillapresentatheabasicaitemsathearevieweraiorareviewateamjashouldaattemptatoaunderstandaaboutatheaapn plicationasubjectedatoaaasecureacodeareviewoaaThisacanabeausedainasmalleracompaniesathatadon’tahaveathearesourcesatoa createaaafullasecurityabaselinemaoraonalowariskacodeawithinalargeracompaniesoaaAalaterasectionagoesaintoadetailaonathreata modelingmawhichawouldabeausedabyalargeracompaniesaonatheirahighestariskacodeabaseso Inaanaidealaworldatheareviewerawouldabeainvolvedainatheadesignaphaseaofatheaapplicationmabutathisaisararelyatheacaseoa Howeveraregardlessaofatheasizeaofatheacodeachangematheaengineerainitiatingatheacodeareviewashouldadirectareviewersa toaanyarelevantaarchitectureaoradesignadocumentsoaTheaeasiestawayatoadoathisaisatoaincludeaaalinkatoatheadocumentsaiasn sumingathey’reastoredainaanaonlineadocumentarepositoryjainatheainitialaenmailmaorainatheacodeareviewatooloaaTheareviewera canathenaverifyathatatheakeyarisksahaveabeenaproperlyaaddressedabyasecurityacontrolsaandathatathoseacontrolsaareauseda inathearightaplaceso Toaeffectivelyaconductatheareviewatheareviewerashouldadevelopafamiliarityawithatheafollowingaaspects– Application features and Business Rules Theareviewerashouldaunderstandaallatheafeaturesacurrentlyaprovidedabyatheaapplicationaandacaptureaallatheabusinessa restrictionsprulesarelatedatoathemoaaThereaisaalsoaaacaseaforabeingamindfulaofapotentialafutureafunctionalityathatamightabea onathearoadmapaforaanaapplicationmatherebyafuturenproofingatheasecurityadecisionsamadeaduringacurrentacodeareviewsoa WhataareatheaconsequencesaofathisasystemafailingﬄaShallatheaenterpriseabeaaffectedainaanyagreatawayaifatheaapplicationa cannotaperformaitsafunctionsaasaintendedﬄ Context AllasecurityaisainacontextaofawhataweaareatryingatoasecureoaRecommendingamilitaryastandardasecurityamechanismsaona anaapplicationathatavendsaapplesawouldabeaoverkillaandaoutaofacontextoaWhatatypeaofadataaisabeingamanipulatedaora processedmaandawhatawouldatheadamageatoatheacompanyabeaifathisadataawasacompromisedﬄaContextaisathea“HolyaGrail”a ofasecureacodeainspectionaandariskaassessmento Methodology 27 Sensitive Data Theareviewerashouldaalsoamakeaaanoteaofatheadataaentitiesalikeaaccountanumbersaandapasswordsathataareasensitiveatoa theaapplicationoaTheacategorizingatheadataaentitiesabasedaonatheirasensitivityawillahelpathearevieweratoadetermineathea imnpactaofaanyakindaofadataalossainatheaapplicationo User roles and access rights ItaisaimportantatoaunderstandatheatypeaofausersaallowedatoaaccessatheaapplicationoaIsaitaexternallyafacingaorainternalatoa “trusted”ausersﬄaaGenerallyaanaapplicationathataisaaccessibleaonlyaforatheainternalausersaofaanaorganizationamightabea exposedatoathreatsathataareadifferentathanatheaoneathataisaavailableaforaanyoneaonatheaInternetoaHencemaknowingathea usersaofatheaapplicationaandaitsadeployedaenvironmentawouldaallowathearevieweratoarealizeatheathreataagentsacorrectlyoa InaadditionatoathismatheadifferentaprivilegesalevelsapresentainatheaapplicationamustaalsoabeaunderstoodoaItawouldahelpa thearevieweratoaenumerateadifferentasecurityaviolationspprivilegeaescalationaattacksathatacanabeaapplicableatoatheaapn plicationo Application type Thisarefersatoaunderstandingawhetheratheaapplicationaisabrowserabasedaapplicationmaaadesktopabasedastandaloneaapn plicationmaaawebnservicemaaamobileaapplicationsaoraaahybridaapplicationoaDifferentatypeaofaapplicationafacesadifferenta kindsaofasecurityathreatsaandaunderstandingatheatypeaofatheaapplicationawouldahelpathearevieweratoalookaforaspecifica securityaflawsmadetermineacorrectathreatsaagentsaandahighlightanecessaryacontrolsasuitableatoatheaapplicationo Code ThealanguageisjausedmatheafeaturesaandaissuesaofathatalanguageafromaaasecurityaperspectiveoaTheaissuesaaaprogrammera needsatoalookaoutaforaandalanguageabestapracticesafromaaasecurityaandaperformanceaperspectiveo Design GenerallyawebaapplicationsahaveaaawellndefinedacodealayoutaifatheyaareadevelopedausingaMVCadesignaprincipleoaApplin cationsacanahaveatheiraownacustomadesignaoratheyamayauseasomeawellnknownadesignaframeworksalikeaStrutspSpringa etcoaWhereaareatheaapplicationapropertiespconfigurationaparametersastoredﬄaaHowaisatheabusinessaclassaidentifiedafora anyafeaturepURLﬄaaWhatatypesaofaclassesagetaexecutedaforaanyaprocessingaanyarequestﬄaieogoacentralizedacontrollerma commandaclassesmaviewapagesaetcojaaHowaisatheaviewarenderedatoatheausersaforaanyarequestﬄ Company Standards and Guidelines ManyacompaniesawillahaveastandardsaandaguidelinesadictatedabyamanagementoaaThisaisahowatheamanagementaiultin matelyaresponsibleaforatheaorganizationsainformationasecurityjacontrolawhatalevelsaofasecurityaareaappliedatoavariousa functionsmaandahowatheyashouldabeaappliedoaaForaexamplemaifatheacompanyahasaaaSecureaCodingaGuidelinesadocumentma reviewersashouldaknowaandaunderstandatheaguidelinesaandaapplyathemaduringatheacodeareviewo 6.7 Code Review Discovery and Gathering Information TheareviewersawillaneedacertainainformationaaboutatheaapplicationainaorderatoabeaeffectiveoaFrequentlymathisainforman tionacanabeaobtainedabyastudyingadesignadocumentsmabusinessarequirementsmafunctionalaspecificationsmatestaresultsma andathealikeoaHowevermainamostarealnworldaprojectsmatheadocumentationaisasignificantlyaoutaofadateaandaalmostanevera hasaappropriateasecurityainformationoaIfatheadevelopmentaorganizationahasaproceduresaandatemplatesaforaarchitecturea andadesignadocumentsmathearevieweracanasuggestaupdatesatoaensureasecurityaisaconsideredaiandadocumentedjaata theseaphaseso Ifatheareviewersaareainitiallyaunfamiliarawithatheaapplicationmaoneaofatheamostaeffectiveawaysatoagetastartedaisatoatalka withatheadevelopersaandathealeadaarchitectaforatheaapplicationoaThisadoesanotahaveatoabeaaalongameetingmaitacouldabeaaa whiteboardasessionaforatheadevelopmentateamatoashareasomeabasicainformationaaboutatheakeyasecurityaconsiderationsa Methodology28 andacontrolsoaAawalkthroughaofatheaactualarunningaapplicationaisaveryahelpfulatoagiveatheareviewersaaagoodaideaaabouta howatheaapplicationaisaintendedatoaworkoaAlsoaaabriefaoverviewaofatheastructureaofatheacodeabaseaandaanyalibrariesauseda canahelpatheareviewersagetastartedo Ifatheainformationaaboutatheaapplicationacannotabeagainedainaanyaotherawaymathenatheareviewersawillahaveatoaspenda someatimeadoingareconnaissanceaandasharingainformationaaboutahowatheaapplicationaappearsatoaworkabyaexamininga theacodeoaaPreferablyathisainformationacanathenabeadocumentedatoaaidafutureareviewso SecurityacodeareviewaisanotasimplyaaboutatheacodeastructureoaItaisaimportantatoarememberatheadata•atheareasonathata weareviewacodeaisatoaensureathataitaadequatelyaprotectsatheainformationaandaassetsaitahasabeenaentrustedawithmasucha asamoneymaintellectualapropertymatradeasecretsmaoralivesoaTheacontextaofatheadataawithawhichatheaapplicationaisaintendeda toaprocessaisaveryaimportantainaestablishingapotentialariskoaIfatheaapplicationaisadevelopedausingaanainbuiltpwellnknowna designaframeworkatheaanswersatoatheamostaofatheseaquestionsawouldabeaprendefinedoaButmainacaseaitaisacustomathenathisa informationawillasurelyaaidatheareviewaprocessmamainlyainacapturingatheadataaflowaandainternalavalidationsoaKnowinga theaarchitectureaofatheaapplicationagoesaaalongawayainaunderstandingatheasecurityathreatsathatacanabeaapplicableatoa theaapplicationoa Aadesignaisaaablueprintaofaanaapplication•aitalaysaaafoundationaforaitsadevelopmentoaItaillustratesathealayoutaofatheaapplin cationaandaidentifiesadifferentaapplicationacomponentsaneededaforaitoaItaisaaastructureathatadeterminesaexecutionaflowa ofatheaapplicationoaMostaofatheaapplicationadesignsaareabasedaonaaaconceptaofaMVCoaInasuchadesignsadifferentacompon nentsainteractawithaeachaotherainaanaorderedasequenceatoaserveaanyauserarequestoaaDesignareviewashouldabeaanaintegrala partaofasecureasoftwareadevelopmentaprocessoaDesignareviewsaalsoahelpatoaimplementingatheasecurityarequirementsa inaaabetterawayo Collectingaallathearequiredainformationaofatheaproposedadesignaincludingaflowachartsmasequenceadiagramsmaclassadian gramsaandarequirementsadocumentsatoaunderstandatheaobjectiveaofatheaproposedadesignoaaTheadesignaisathoroughlya studiedamainlyawitharespectatoatheadataaflowmadifferentaapplicationacomponentainteractionsaandadataahandlingoaThisaisa achievedathroughamanualaanalysisaandadiscussionsawithatheadesignaoratechnicalaarchitect’sateamoaTheadesignaandathea architectureaofatheaapplicationamustabeaunderstoodathoroughlyatoaanalyzeavulnerableaareasathatacanaleadatoasecuritya breachesainatheaapplicationoa AfteraunderstandingatheadesignmatheanextaphaseaisatoaanalyzeatheathreatsatoatheadesignoaThisainvolvesaobservingathea designafromaanaattacker’saperspectiveaandauncoveringatheabackdoorsaandainsecureaareasapresentainaitoaaTable 4abelowa Methodology Existing security controls •aAreathereaanyaknownaweaknessesainathirdnpartasecurityacontrols •aIsatheaplacementsaofasecurityacontrolsacorrectﬄ Architecture •aAreaconnectionsatoaexternalaserversasecureﬄ •aAreainputsafromaexternalasourcesavalidatedﬄ Configuration files and data stores •aIsathereaanyasensitiveadataainaconfigurationafilesﬄ •aWhoahasaaccessatoaconfigurationaoradataafilesﬄ Authentication and access control •aDoesatheadesignaimplementaaccessacontrolaforaallaresourcesﬄ •aAreasessionsahandledacorrectlyﬄ •aWhatafunctionalityacanabeaaccessedawithoutaauthenticationﬄ Design Area Questions to consider Data Flow •aAreauserainputsausedatoadirectlyareferenceabusinessalogicﬄ •aIsathereapotentialaforadataabindingaflawsﬄ •aIsatheaexecutionaflowacorrectainafailureacasesﬄ Table 4: ExampleaDesignaQuestionsaDuringaSecureaCodeaReview 29 highlightsasomeaquestionsathatacanabeaaskedaofatheaarchitectureaandadesignatoaaidasecureacodeareviewso EveryasecurityarequirementashouldabeaassociatedawithaaasecurityacontrolabestasuitedaforatheadesignoaHeremaweawoulda identifyaexactachangesaoraadditionsatoabeaincorporatedainatheadesignathataareaneededatoameetaanyarequirementaora mitigateaaathreatoaThealistaofasecurityarequirementsaandaproposedacontrolsacanabeathenadiscussedawithatheadevelopn mentateamsoaTheaqueriesaofatheateamsashouldabeaaddressedaandafeasibilityaofaincorporatingatheacontrolsamustabea determinedoaExceptionsmaifaanyamustabeatakenaintoaaccountaandaalternatearecommendationsashouldabeaproposedoaIna thisaphaseaaafinalaagreementaonatheasecurityacontrolsaisaachievedoaTheafinaladesignaincorporatedabyatheadevelopmenta teamsacanabeareviewedaagainaandafinalizedaforafurtheradevelopmentaprocesso 6.8 Static Code Analysis StaticaCodeaAnalysisaisacarriedaoutaduringatheaimplementationaphaseaofaSnSDLCoaStaticacodeaanalysisacommonlya refersatoarunningastaticacodeaanalysisatoolsathataattemptatoahighlightapossibleavulnerabilitiesawithinathea‘static’a inonnrunningjasourceacodeo IdeallyastaticacodeaanalysisatoolsawouldaautomaticallyafindasecurityaflawsawithafewafalseapositivesoaThatameansaitashoulda haveaaahighadegreeaofaconfidenceathatatheabugsathataitafindsaarearealaflawsoaHowevermathisaidealaisabeyondatheastateaofa theaartaforamanyatypesaofaapplicationasecurityaflawsoaThusmasuchatoolsafrequentlyaserveaasaaidsaforaanaanalystatoahelpa themazeroainaonasecurityarelevantaportionsaofacodeasoatheyacanafindaflawsamoreaefficientlymaratherathanaaatoolathatafindsa allaflawsaautomaticallyo BugsamayaexistainatheaapplicationadueatoainsecureacodemadesignaoraconfigurationoaAutomatedaanalysisacanabeacarriedaona theaapplicationacodeatoaidentifyabugsathroughaeitheraofatheafollowingatwoaoptions– Methodology DefiningaaagenericachecklistmawhichatheadevelopmentateamacanafillaoutacanagiveareviewersatheadesiredacontextoaThea checklistaisaaagoodabarometeraforathealevelaofasecurityatheadevelopersahaveaattemptedaorathoughtaofoaIfasecuritya codeareviewabecomesaaacommonarequirementmathenathisachecklistacanabeaincorporatedaintoaaadevelopmentapron cedureaieogoadocumentatemplatesjasoathatatheainformationaisaalwaysaavailableatoacodeareviewersoaSeeaAppendixaAa foraaasampleacodeareviewachecklisto Theachecklistashouldacoveratheamostacriticalasecurityacontrolsaandavulnerabilityaareasasuchaas– •aDataaValidation •aAuthentication •aSessionaManagement •aAuthorization •aCryptography •aErroraHandling •aLogging •aSecurityaConfiguration •aNetworkaArchitecture Code Review Checklist 30 1. Static code scanner scripts based on a pattern search (in-house and open source). 2. Static code analyzers (commercial and open source). Advantagesaandadisadvantagesaofasourceacodeascannersaareashownainatables 5 and 6. Thoughacodeascanningascriptsaandaopenasourceatoolsacanabeaefficientaatafindingainsecureacodeapatternsmatheyaoftena lackatheacapabilityaofatracingatheadataaflowoaThisagapaisafilledabyastaticacodeaanalyzersmawhichaidentifyatheainsecureacodea patternsabyapartiallyaiorafullyjacompilingatheacodeaandainvestigatingatheaexecutionabranchesmaallowingaforasourceatoa sinkaanalysisoaStaticacodeaanalyzersaandascannersaareacomprehensiveaoptionsatoacomplementatheaprocessaofacodea reviewo Choosing a static analysis tool ChoosingaaastaticaanalysisatoolaisaaadifficultataskasinceathereaareaaalotaofachoicesoaTheacomparisonachartsabelowacoulda helpaorganizationadecideawhichatoolaisarightaforathemmaalthoughathisalistaisanotaexhaustiveoa Methodology Source to sink analysis SomeaanalyzersacanatraceatheacodeaandaidentifyatheavulnerabilitiesathroughasourceatoasinkaanalysisoaTheyaidentifyapossiblea inputsatoatheaapplicationaandatraceathemathoroughlyathroughoutatheacodeauntilatheyafindathematoabeaassociatedawithaanya insecureacodeapatternoaSuchaaasourceatoasinkaanalysisahelpsatheadevelopersainaunderstandingatheaflawsabetteraasatheyageta aacompletearootacauseaanalysisaofatheaflaw Elaborate reporting format Scannersaprovideaaadetailedareportaonatheaobservedavulnerabilitiesawithaexactacodeasnippetsmariskaratingaandacompletea descriptiona ofa thea vulnerabilitiesoaThisa helpsa thea developmenta teamsa toa easilya understanda thea flawsa anda implementa necessaryacontrols Advantage Explanation Reduction in manual efforts Theatypeaofapatternsatoabeascannedaforaremainsacommonaacrossaapplicationsmacomputersaareabetteraatasuchascansathana humansoaInathisascenariomascannersaplayaaabigaroleaisaautomatingatheaprocessaofasearchingatheavulnerabilitiesathrougha largeacodebaseso Find all the instances of the vulnerabilities ScannersaareaveryaeffectiveainaidentifyingaallatheainstancesaofaaaparticularavulnerabilityawithatheiraexactalocationoaThisaisa helpfulaforalargeracodeabaseawhereatracingaforaflawsainaallatheafilesaisadifficulto Table 5: AdvantagesaToaUsingaSourceaCodeaScanners Limitation Explanation Business logic flaws remain untouched Theaflawsathataarearelatedatoaapplication’sabusinessalogicmatransactionsmaandasensitiveadataaremainauntouchedabyatheascann nersoaTheasecurityacontrolsathataneedatoabeaimplementedainatheaapplicationaspecificatoaitsafeaturesaandadesignaareaoftena notapointedabyatheascannersoaThisaisaconsideredaasatheabiggestalimitationaofastaticacodeaanalyzerso Limited scope Staticacodeaanalyzersaareaoftenadesignedaforaspecificaframeworksaoralanguagesaandawithinathatascopeatheyacanasearcha foraaacertainasetaofavulnerableapatternsoaaOutsideaofathisascopeatheyafailatoaaddressatheaissuesanotacoveredainatheirasearcha patternarepositoryo Design flaws DesignaflawsaareanotaspecificatoatheacodeastructureaandastaticacodeaanalyzersafocusaonatheacodeoaAascannerpanalyzerawilla notaspotaaadesignaissueawhenalookingaatatheacodemawhilstaaahumanacanaoftenaidentifyadesignaissuesawhenalookingaatatheira implementationo False positives Notaallaofatheaissuesaflaggedabyastaticacodeaanalyzersaareatrulyaissuesmaandathusathearesultsafromatheseatoolsaneedatoabea understoodaandatriagedabyaanaexperiencedaprogrammerawhoaunderstandsasecureacodingoaaThereforeaanyoneahopinga thatasecureacodeacheckingacanabeaautomatedaandarunaatatheaendaofatheabuildawillabeadisappointedmaandathereaisastillaaa dealaofamanualainterventionarequiredawithaanalyzerso Table 6: DisadvantagesaToaUsingaSourceaCodeaScanners 31 Some of the criteria for choosing a tool are: • Doesatheatoolasupportatheaprogrammingalanguageausedﬄ • IsathereaaapreferenceabetweenacommercialaorafreeatoolsﬄaUsuallyatheacommercialatoolsahaveamoreafeaturesaandaarea moreareliableathanatheafreeaonesmawhilstatheirausabilityamightadiffero • WhatatypeaofaanalysisaisabeingacarriedaoutﬄaIsaitasecuritymaqualitymastaticaoradynamicaanalysisﬄ TheanextasteparequiresathatasomeaworkaisadoneasinceaitaisaquiteasubjectiveoaTheabestathingatoadoaisatoatestaaafewatoolsatoa seeaifatheateamaisasatisfiedawithadifferentaaspectsasuchaasatheauseraexperiencematheareportingaofavulnerabilitiesmathealevela ofafalseapositivesaandatheacustomizationaandatheacustomerasupportoaTheachoiceashouldanotabeabasedaonatheanumberaofa featuresmabutaonatheafeaturesaneededaandahowatheyacouldabeaintegratedainatheaSnSDLCoaAlsomabeforeachoosingatheatoolma theaexpertiseaofatheatargetedausersashouldabeaclearlyaevaluatedainaorderatoachooseaanaappropriateatoolo 6.9 Application Threat Modeling ThreatamodelingaisaanainndepthaapproachaforaanalyzingatheasecurityaofaanaapplicationoaItaisaaastructuredaapproachathata enablesaemployeesatoaidentifymaquantifymaandaaddressatheasecurityarisksaassociatedawithaanaapplicationoaThreatamodeln ingaisanotaanaapproachatoareviewingacodemabutaitacomplementsatheasecureacodeareviewaprocessabyaprovidingacontexta andariskaanalysisaofatheaapplicationoa TheainclusionaofathreatamodelingainatheaSnSDLCacanahelpatoaensureathataapplicationsaareabeingadevelopedawithasecurin tyabuiltninafromatheaveryabeginningoaThismacombinedawithatheadocumentationaproducedaasapartaofatheathreatamodelinga processmacanagiveathearevieweraaagreateraunderstandingaofatheasystemmaallowsathearevieweratoaseeawhereatheaentrya pointsatoatheaapplicationaareaiioeoatheaattackasurfacejaandatheaassociatedathreatsawithaeachaentryapointaiioeoaattackavecn torsjoa TheaconceptaofathreatamodelingaisanotanewabutathereahasabeenaaaclearamindnsetachangeainarecentayearsoaModernathreata modelingalooksaataaasystemafromaaapotentialaattacker’saperspectivemaasaopposedatoaaadefender’saviewpointoaManyacomn paniesahaveabeenastrongaadvocatesaofatheaprocessaoveratheapastanumberaofayearsmaincludingaMicrosoftawhoahasamadea threatamodelingaaacoreacomponentaofatheiraSnSDLCmawhichatheyaclaimatoabeaoneaofatheareasonsaforatheaincreasedasen curityaofatheiraproductsainarecentayearso WhenasourceacodeaanalysisaisaperformedaoutsideatheaSnSDLCmasuchaasaonaexistingaapplicationsmathearesultsaofatheathreata modelingahelpainareducingatheacomplexityaofatheasourceacodeaanalysisabyapromotingaaariskabasedaapproachoaInsteadaofa reviewingaallasourceacodeawithaequalafocusmaaarevieweracanaprioritizeatheasecurityacodeareviewaofacomponentsawhosea threatamodelingahasarankedawithahighariskathreatso The threat modeling process can be decomposed into 3 high level steps: 6.9.1. Step 1: Decompose the Application. Theafirstastepainatheathreatamodellingaprocessaisaconcernedawithagainingaanaunderstandingaofatheaapplicationaandahowa itainteractsawithaexternalaentitiesoaThisainvolvesacreatingausencasesatoaunderstandahowatheaapplicationaisausedmaidentin fyingaentryapointsatoaseeawhereaaapotentialaattackeracouldainteractawithatheaapplicationmaidentifyingaassetsaioeoaitemsp areasathatatheaattackerawouldabeainterestedainmaandaidentifyingatrustalevelsawhicharepresentatheaaccessarightsathatathea applicationawillagrantatoaexternalaentitiesoaThisainformationaisadocumentedainatheathreatamodeladocumentaandaitaisaalsoa usedatoaproduceadataaflowadiagramsaiDFDsjaforatheaapplicationoaTheaDFDsashowatheadifferentadataapathsathroughathea systemmahighlightingatheaprivilegeaitrustjaboundarieso Methodology32 Items to consider when decomposing the application include External Dependencies Externaladependenciesaareaitemsaexternalatoatheacodeaofatheaapplicationathatamayaposeaaathreatatoatheaapplicationoa Theseaitemsaareatypicallyastillawithinatheacontrolaofatheaorganizationmabutapossiblyanotawithinatheacontrolaofatheaden velopmentateamoaTheafirstaareaatoalookaatawhenainvestigatingaexternaladependenciesaisahowatheaapplicationawillabea deployedainaaaproductionaenvironmentoa ThisainvolvesalookingaatahowatheaapplicationaisaoraisanotaintendedatoabearunoaForaexampleaifatheaapplicationaisaexpecteda toabearunaonaaaserverathatahasabeenahardenedatoatheaorganization’sahardeningastandardaandaitaisaexpectedatoasitabehinda aafirewallmathenathisainformationashouldabeadocumentedoa Entry Points Entryapointsaiakaaattackavectorsjadefineatheainterfacesathroughawhichapotentialaattackersacanainteractawithatheaapplin cationaorasupplyaitawithadataoaInaorderaforaaapotentialaattackeratoaattackaanaapplicationmaentryapointsamustaexistoaEntrya pointsainaanaapplicationacanabealayeredmaforaexampleaeachawebapageainaaawebaapplicationamayacontainamultipleaentrya pointsoa Assets Theasystemamustahaveasomethingathatatheaattackeraisainterestedain•atheseaitemspareasaofainterestaareadefinedaasaassetsoa AssetsaareaessentiallyathreatatargetsmaioeoatheyaareatheareasonathreatsawillaexistoaAssetsacanabeabothaphysicalaassetsaanda abstractaassetsoaForaexamplemaanaassetaofaanaapplicationamightabeaaalistaofaclientsaandatheirapersonalainformation•athisaisa aaphysicalaassetoaAnaabstractaassetamightabeatheareputationaofaanaorganizationo Determining the Attack Surface TheaattackasurfaceaisadeterminedabyaanalyzingatheainputsmadataaflowsaandatransactionsoaAamajorapartaofaactuallyapern formingaaasecurityacodeareviewaisaperformingaanaanalysisaofatheaattackasurfaceoaAnaapplicationatakesainputsaandapron ducesaoutputaofasomeakindoaTheafirstastepaisatoaidentifyaallainputatoatheacodeo Inputsatoatheaapplicationamayaincludeatheabulletapointsabelowaandafigure 4adescribesaanaexampleaprocessaforaidentin fyingaanaapplicationsainputapaths–a • Browserainput • Cookies • Propertyafiles • Externalaprocesses • Dataafeeds • Servicearesponses • Flatafiles • Commandalineaparameters • Environmentavariables Methodology 33Methodology TRANSITIONAL ANALYSIS INITIATION IDENTIFY INPUT PATHS IDENTIFY AREAS OF LATE & DY- NAMIC BINDING FOLLOW PATH EACH PARAME- TER THROUGH CODE IDENTIFY AREAS OF CONFIG FILE REFERENCE IDENTIFY ATTACK SURFACE INPUT PARAMETERS (USER) INPUT PARAMETERS (CONFIG) IDENTIFY ATTACK SURFACE IDENTIFY ATTACK SURFACE IDENTIFY ATTACK SURFACE INPUT PARAMETERS (CONTROL) INPUT PARAMETERS (BLACKEND) Figure 4: Exampleaprocessadiagramaforaidentifyingainputapaths 34 Methodology Trust Levels TrustalevelsarepresentatheaaccessarightsathatatheaapplicationawillagrantatoaexternalaentitiesoaTheatrustalevelsaareacrossnrefn erencedawithatheaentryapointsaandaassetsoaThisaallowsaaateamatoadefineatheaaccessarightsaoraprivilegesarequiredaataeacha entryapointmaandathosearequiredatoainteractawithaeachaasseto Data flow analysis ExploringatheaattackasurfaceaincludesadynamicaandastaticadataaflowaanalysisoaWhereaandawhenavariablesaareasetaanda howatheavariablesaareausedathroughoutatheaworkflowmahowaattributesaofaobjectsaandaparametersamightaaffectaothera dataawithinatheaprogramoaItadeterminesaifatheaparametersmamethodacallsmaandadataaexchangeamechanismsaimplementa thearequiredasecurityo Transaction analysis Transactionaanalysisaisaneededatoaidentifyaandaanalyzeaallatransactionsawithinatheaapplicationmaalongawithathearelevanta securityafunctionsainvokedoa Theaareasathataareacoveredaduringatransactionaanalysisaare– • DatapInputaValidationaofadataafromaallauntrustedasources • Authentication • SessionaManagement • Authorization • Cryptographyaidataaatarestaandainatransitj • ErroraHandlingapInformationaLeakage • LoggingapAuditing Data Flow Diagrams AllaofatheainformationacollectedaallowsaanaaccuratelyamodelatheaapplicationathroughatheauseaofaDataaFlowaDiagramsa iDFDsjoaTheaDFDsawillaallowatheaemployeeatoagainaaabetteraunderstandingaofatheaapplicationabyaprovidingaaavisuala representationaofahowatheaapplicationaprocessesadataoaTheafocusaofatheaDFDsaisaonahowadataamovesathroughathea applicationaandawhatahappensatoatheadataaasaitamovesoaDFDsaareahierarchicalainastructuremasoatheyacanabeausedatoa decomposeatheaapplicationaintoasubsystemsoaTheahighalevelaDFDawillaallowatheaemployeeatoaclarifyatheascopeaofathea applicationabeingamodelledoaThealoweralevelaiterationsawillaallowamoreafocusaonatheaspecificaprocessesainvolvedawhena processingaspecificadataoa ThereaareaaanumberaofasymbolsathataareausedainaDFDsaforathreatamodellingmaasashowainatheafollowingatable 7abelow– Theaprocessashapearepresentsaaataskathatahandlesadataawithina theaapplicationoaTheataskamayaprocessatheadataaoraperformaana actionabasedaonatheadatao PROCESS Methodology ELEMENT IMAGE DESCRIPTION Theaexternalaentityashapeaisausedatoarepresentaanyaentitya outsideatheaapplicationathatainteractsawithatheaapplicationaviaa anaentryapointo EXTERNAL ENTITY Table 7: ThreataModelingaSymbols 35 DFDsashowahowadataamovesalogicallyathroughatheasystemaandaallowsatheaidentificationadataaenteringaoraleavn ingatheasystemaalongawithatheastorageaofadataaandatheaflowaofacontrolathroughatheseacomponentsoaTrustaboundn ariesashowaanyalocationawhereathealevelaofatrustachangesoaProcessacomponentsashowawhereadataaisaprocessedma suchaasawebaserversmaapplicationaserversmaandadatabaseaserversoaEntryapointsashowawhereadataaentersatheasysn temaiioeoainputafieldsmamethodsjaandaexitapointsaareawhereaitaleavesatheasystemaiioeoadynamicaoutputmamethodsjma respectivelyoaEntryaandaexitapointsadefineaaatrustaboundaryo 6.9.2 Step 2: Determine and rank threats CriticalatoatheaidentificationaofathreatsaisausingaaathreatacategorizationamethodologyoaAathreatacategorizationa suchaasaSTRIDEacanabeausedmaoratheaApplicationaSecurityaFrameaiASFjathatadefinesathreatacategoriesasuchaasaAun ditingagaLoggingmaAuthenticationmaAuthorizationmaConfigurationaManagementmaDataaProtectionainaStorageaanda TransitmaDataaValidationaandaExceptionaManagementoa TheagoalaofatheathreatacategorizationaisatoahelpaidentifyathreatsabothafromatheaattackeraiSTRIDEjaandatheadefenn siveaperspectiveaiASFjoaDFDsaproducedainasteparahelpatoaidentifyatheapotentialathreatatargetsafromatheaattacker’sa perspectivema sucha asa dataa sourcesma processesma dataa flowsma anda interactionsa witha usersoaThesea threatsa cana bea identifiedafurtheraasathearootsaforathreatatrees•athereaisaoneatreeaforaeachathreatagoaloa Froma thea defensivea perspectivema ASFa categorizationa helpsa toa identifya thea threatsa asa weaknessesa ofa securitya controlsaforasuchathreatsoaCommonathreatnlistsawithaexamplesacanahelpainatheaidentificationaofasuchathreatsoaUsea andaabuseacasesacanaillustrateahowaexistingaprotectiveameasuresacouldabeabypassedmaorawhereaaalackaofasucha protectionaexistsoa Theadeterminationaofatheasecurityariskaforaeachathreatacanabeadeterminedausingaaavaluenbasedariskamodelasucha asaDREADaoraaalessasubjectiveaqualitativeariskamodelabasedauponageneralariskafactorsaieogoalikelihoodaandaimn pactjo TheafirstastepainatheadeterminationaofathreatsaisaadoptingaaathreatacategorizationoaAathreatacategorizationapron Methodology Theamultipleaprocessashapeaisausedatoapresentaaacollectionaofa subprocessesoaTheamultipleaprocessacanabeabrokenadownaintoa itsasubprocessesainaanotheraDFDo MULTIPLE PROCESS Theadataaflowashapearepresentsadataamovementawithinathea applicationoaTheadirectionaofatheadataamovementaisarepresentn edabyatheaarrowo DATA FLOW Theaprivilegeaboundaryashapeaisausedatoarepresentathea changeaofaprivilegealevelsaasatheadataaflowsathroughathea applicationo PRIVILEGE BOUNDARY Theadataastoreashapeaisausedatoarepresentalocationsawherea dataaisastoredoaDataastoresadoanotamodifyatheadatamatheyaonlya storeadatao DATA STORE 36 videsaaasetaofathreatacategoriesawithacorrespondingaexamplesasoathatathreatsacanabeasystematicallyaidentifieda inatheaapplicationainaaastructuredaandarepeatableamannero STRIDE ThreatalistsabasedaonatheaSTRIDEamodelaareausefulainatheaidentificationaofathreatsawitharegardsatoatheaattackera goalsoaForaexamplemaifatheathreatascenarioaisaattackingathealoginmawouldatheaattackerabruteaforceatheapasswordatoa breakatheaauthenticationﬄaIfatheathreatascenarioaisatoatryatoaelevateaprivilegesatoagainaanotherauser’saprivilegesma wouldatheaattackeratryatoaperformaforcefulabrowsingﬄ AathreatacategorizationasuchaasaSTRIDEaisausefulainatheaidentificationaofathreatsabyaclassifyingaattackeragoalsa suchaasashownainatable 8o Itaisavitalathataallapossibleaattackavectorsashouldabeaevaluatedafromatheaattacker’sapointaofaviewoaForaexamplemathealogina pageaallowsasendingaauthenticationacredentialsmaandatheainputadataaacceptedabyaanaentryapointahasatoavalidateafora potentialamaliciousainputatoaexploitavulnerabilitiesasuchaasaSQLainjectionmacrossasiteascriptingmaandabufferaoverflowsoa Additionallymatheadataaflowapassingathroughathatapointahasatoabeausedatoadetermineatheathreatsatoatheaentryapointsa toatheanextacomponentsaalongatheaflowoaIfatheafollowingacomponentsacanabearegardedacriticalaieogoatheaholdasensitivea datajmathataentryapointacanabearegardedamoreacriticalaasawelloaInaanaendatoaendadataaflowatheainputadataaiioeoausernamea andapasswordjafromaaaloginapagemapassedaonawithoutavalidationmacouldabeaexploitedaforaaaSQLainjectionaattackatoaman nipulateaaaqueryaforabreakingatheaauthenticationaoratoamodifyaaatableainatheadatabaseo ExitapointsamightaserveaasaattackapointsatoatheaclientaieogoaXSSavulnerabilitiesjaasawellaforathearealizationaofainformationa disclosureavulnerabilitiesoaInatheacaseaofaexitapointsafromacomponentsahandlingaconfidentialadataaieogoadataaaccessa componentsjmaanyaexitapointsalackingasecurityacontrolsatoaprotectatheaconfidentialityaandaintegrityacanaleadatoadisclon sureaofasuchaconfidentialainformationatoaanaunauthorizedausero InamanyacasesathreatsaenabledabyaexitapointsaarearelatedatoatheathreatsaofatheacorrespondingaentryapointoaInathealogina examplemaerroramessagesareturnedatoatheauseraviaatheaexitapointamightaallowaforaentryapointaattacksmasuchaasaaccounta Methodology STRIDE Explanation Spoofing “Identityaspoofing”aisaaakeyariskaforaapplicationsathatahaveamanyausersabutaprovideaaasingleaexecutionacontextaatatheaapn plicationaandadatabasealeveloaInaparticularmausersashouldanotabeaableatoabecomeaanyaotherauseraoraassumeatheaattributesa ofaanotherausero Tampering Usersacanapotentiallyachangeadataadeliveredatoathemmareturnaitmaandatherebyapotentiallyamanipulateaclientnsideavalidan tionmaGETaandaPOSTaresultsmacookiesmaHTTPaheadersmaandasoaforthoaTheaapplicationashouldaalsoacarefullyacheckadataaren ceivedafromatheauseraandavalidateathataitaisasaneaandaapplicableabeforeastoringaorausingaito Repudiation UsersamayadisputeatransactionsaifathereaisainsufficientaauditingaorarecordkeepingaofatheiraactivityoaForaexamplemaifaaausera saysatheyadidanotamakeaaafinancialatransfermaandatheafunctionalityacannotatrackahispheraactivitiesathroughatheaapplicationma thenaitaisaextremelyalikelyathatatheatransactionawillahaveatoabeawrittenaoffaasaaalosso Information Disclosure Denial of Service Elevation of Privilege UsersaarearightfullyawaryaofasubmittingaprivateadetailsatoaaasystemoaIsapossibleaforaanaattackeratoapubliclyarevealauseradataa atalargemawhetheraanonymouslyaoraasaanaauthorizedauserﬄ ApplicationadesignersashouldabeaawareathatatheiraapplicationsamayabeasubjectatoaaadenialaofaserviceaattackoaTheauseaofa expensivearesourcesasuchaasalargeafilesmacomplexacalculationsmaheavyndutyasearchesmaoralongaqueriesashouldabeareserveda foraauthenticatedaandaauthorizedausersmaandanotaavailableatoaanonymousauserso Ifaanaapplicationaprovidesadistinctauseraandaadministrativearolesmathenaitaisavitalatoaensureathatatheauseracannotaelevatea hispheraroleatoaaahigheraprivilegeaoneo Table 8: ExplanationaOfaTheaStrideaAttributes 37Methodology harvestingaieogoausernameanotafoundjmaoraSQLainjectionaieogoaSQLaexceptionaerrorsjoaFromatheadefensiveaperspectivema theaidentificationaofathreatsadrivenabyasecurityacontrolacategorizationasuchaasaASFaallowsaaathreataanalystatoafocusaona specificaissuesarelatedatoaweaknessesaieogoavulnerabilitiesjainasecurityacontrolsoaTypicallyatheaprocessaofathreataidentin ficationainvolvesagoingathroughaiterativeacyclesawhereainitiallyaallatheapossibleathreatsainatheathreatalistathataapplyatoa eachacomponentaareaevaluatedoaAtatheanextaiterationmathreatsaareafurtheraanalyzedabyaexploringatheaattackapathsmathea rootacausesaieogoavulnerabilitiesjaforatheathreatatoabeaexploitedmaandatheanecessaryamitigationacontrolsaieogoacountern measuresjoa Onceacommonathreatsmavulnerabilitiesmaandaattacksaareaassessedmaaamoreafocusedathreataanalysisashouldatakeainaconn siderationauseaandaabuseacasesoaByathoroughlyaanalyzingatheauseascenariosmaweaknessesacanabeaidentifiedathatacoulda leadatoathearealizationaofaaathreatoaAbuseacasesashouldabeaidentifiedaasapartaofatheasecurityarequirementaengineeringa activityoaTheseaabuseacasesacanaillustrateahowaexistingaprotectiveameasuresacouldabeabypassedmaorawhereaaalackaofasucha protectionaexistsoaaFinallymaitaisapossibleatoabringaallaofathisatogetherabyadeterminingatheatypesaofathreatatoaeachacompon nentaofatheadecomposedasystemoaThisacanabeadoneabyarepeatingatheatechniquesaalreadyadiscussedaonaaaloweralevela threatamodelmaagainausingaaathreatacategorizationasuchaasaSTRIDEaoraASFmatheauseaofathreatatreesatoadetermineahowathea threatacanabeaexposedabyavulnerabilitymaandauseaandamisuseacasesatoafurtheravalidateathealackaofaaacountermeasureatoa mitigateatheathreato Microsoft DREAD threat-risk ranking model InatheaMicrosoftaDREADathreatnriskarankingamodelmatheatechnicalariskafactorsaforaimpactaareaDamageaandaAffectedaUsn ersmawhileatheaeaseaofaexploitationafactorsaareaReproducibilitymaExploitabilityaandaDiscoverabilityoaThisariskafactorizationa allowsatheaassignmentaofavaluesatoatheadifferentainfluencingafactorsaofaaathreatoa Toadetermineathearankingaofaaathreatmatheathreataanalystahasatoaanswerabasicaquestionsaforaeachafactoraofariskmaforaexn ample– Theaimpactamainlyadependsaonatheadamageapotentialaandatheaextentaofatheaimpactmasuchaasatheanumberaofa componentsathataareaaffectedabyaaathreato Damage Howabigawouldatheadamageabeaifatheaattackasucceededﬄ Canaanaattackeracompletelyatakeaoveraandamanipulateatheasystemﬄ Canaanaattackeracrashatheasystemﬄ Reproducibility Howaeasyaisaitatoareproduceaanaattackatoaworkﬄ Canatheaexploitabeaautomatedﬄ Exploitability Howamuchatimemaeffortmaandaexpertiseaisaneededatoaexploitatheathreatﬄa Doesatheaattackeraneedatoabeaauthenticatedﬄa Affected Users Discoverability Ifaaathreatawereaexploitedmawhatapercentageaofausersawouldabeaaffectedﬄ Canaanaattackeragainaadministrativeaaccessatoatheasystemﬄ Howaeasyaisaitaforaanaattackeratoadiscoverathisathreatﬄ DREAD Questions Table 9: ExplanationaOfaTheaDreadaAttributes 38 TheseaquestionsahelpainatheacalculationaofatheaoverallariskavaluesabyaassigningaqualitativeavaluesasuchaasaHighma MediumaandaLowatoaLikelihoodaandaImpactafactorsoaInathisacasemausingaqualitativeavaluesmaratherathananumerica onesalikeainatheacaseaofatheaDREADamodelmahelpaavoidathearankingabecomingaoverlyasubjectiveo 6.9.3 Step 3: Determine countermeasures and mitigation. Aalackaofaprotectionaagainstaaathreatamightaindicateaaavulnerabilityawhoseariskaexposureacouldabeamitigateda withatheaimplementationaofaaacountermeasureoaSuchacountermeasuresacanabeaidentifiedausingathreatncountern measureamappingalistsoaOnceaaariskarankingaisaassignedatoatheathreatsmaitaisapossibleatoasortathreatsafromatheahighn estatoathealowestariskmaandaprioritizeatheamitigationaeffortmasuchaasabyarespondingatoasuchathreatsabyaapplyingathea identifiedacountermeasuresoa Theariskamitigationastrategyamightainvolveaevaluatingatheseathreatsafromatheabusinessaimpactathatatheyaposea andaestablishingacountermeasuresaioradesignachangesjatoareduceatheariskoa Otheraoptionsamightaincludeaacceptingatheariskmaassumingatheabusinessaimpactaisaacceptableabecauseaofacomn pensatingacontrolsmainformingatheauseraofatheathreatmaremovingatheariskaposedabyatheathreatacompletelymaorathea leastapreferableaoptionmathataismatoadoanothingoaaIfatheariskaidentifiedaisaextremematheafunctionalityaoraproducta couldabeadiscontinuedmaasatheariskaofasomethingagoingawrongaisagreaterathanatheabenefito Theapurposeaofatheacountermeasureaidentificationaisatoadetermineaifathereaisasomeakindaofaprotectiveameasurea ieogoasecurityacontrolmapolicyameasuresjainaplaceathatacanapreventaeachathreatapreviouslyaidentifiedaviaathreata analysisafromabeingarealizedoaVulnerabilitiesaareathenathoseathreatsathatahaveanoacountermeasuresoa SinceaeachaofatheseathreatsahasabeenacategorizedaeitherawithaSTRIDEaoraASFmaitacanabeapossibleatoafindaapproprin ateacountermeasuresainatheaapplicationawithinatheagivenacategoryoaEachaofatheaaboveastepsaisadocumentedaasa theyaareacarriedaoutoaThearesultingasetaofadocumentsaisatheathreatamodelaforatheaapplicationoaDetailedaexamplesa ofahowatoacarryaoutathreatamodelingaisagivenainaAppendix Boa Threat Profile Onceathreatsaandacorrespondingacountermeasuresaareaidentifiedaitaisapossibleatoaderiveaaathreataprofileawithathea followingacriteria– AamoreagenericariskamodelatakesaintoaconsiderationatheaLikelihoodaieogoaprobabilityaofaanaattackjaandatheaImpacta ieogoadamageapotentialj– Risk = Likelihood x Impact NoteathatathisaisaaaconceptualaformulaaandaisanotaexpectedatoauseaactualavaluesaforalikelihoodaandaimpactoaaThea likelihoodaoraprobabilityaisadefinedabyatheaeaseaofaexploitationmawhichamainlyadependsaonatheatypeaofathreataanda theasystemacharacteristicsmaandabyatheapossibilityatoarealizeaaathreatmawhichaisadeterminedabyatheaexistenceaofaana appropriateacountermeasureo Likelihood Methodology 39 6.10 Metrics and Code Review MetricsameasureatheasizeaandacomplexityaofaaapieceaofacodeoaaThereaisaaalongalistaofaqualityaandasecurityacharn acteristicsathatacanabeaconsideredawhenareviewingacodeaisuchaasmabutanotalimitedatomacorrectnessmaefficiencyma portabilitymamaintainabilitymareliabilityaandasecurabilityjoaNoatwoncodeareviewasessionsawillabeatheasameasoasomea judgmentawillabeaneededatoadecideatheabestapathoaMetricsacanahelpadecideatheascaleaofaaacodeareviewo Metricsacanaalsoabearecordedarelatingatoatheaperformanceaofatheacodeareviewersaandatheaaccuracyaofatheareviewa processmatheaperformanceaofatheacodeareviewafunctionmaandatheaefficiencyaandaeffectivenessaofatheacodeareviewa functiono Theafigure 5 describesatheauseaofametricsathroughoutatheacodeareviewaprocessoa Some of the options for calculating the size of a review task include: Lines of Code (LOC): AacountaofatheaexecutablealinesaofacodeaicommentednoutacodeaorablankalinesaareanotacountedjoaThisagivesaaa roughaestimateabutaisanotaparticularlyascientificoa Function Point: TheaestimationaofasoftwareasizeabyameasuringafunctionalityoaTheacombinationaofaaanumberaofastatementsawhicha performaaaspecificataskmaindependentaofaprogrammingalanguageausedaoradevelopmentamethodologyoaaInaana objectaorientatedalanguageaaaclassacouldabeaaafunctionalapointo Defect Density: TheaaverageaoccurrenceaofaprogrammingafaultsaperaLinesaofaCodeaiLOCjoaThisagivesaaahighalevelaviewaofatheacodea qualityabutanotamuchamoreoaFaultadensityaonaitsaownadoesanotagiveariseatoaaapragmaticametricoaDefectadensitya wouldacoveraminoraissuesaasawellaasamajorasecurityaflawsainatheacode•aallaareatreatedatheasameawayoaSecurityaofa codeacannotabeajudgedaaccuratelyausingadefectadensityaaloneo Risk Density: SimilaratoadefectadensitymabutadiscoveredaissuesaarearatedabyariskaihighmamediumagalowjoaInadoingathisaweacana giveainsightaintoatheaqualityaofatheacodeabeingadevelopedaviaaaa[XaRiskapaLoC]aora[YaRiskapaFunctionaPoint]avaluea iXgYabeingahighmamediumaoralowarisksjaasadefinedabyainternalaapplicationadevelopmentapoliciesaandastandardso For example: 4 High Risk Defects per 1000 (Lines of Code) 2 Medium Risk Defects per 3 Function Points Threat Type Description Non-mitigated threats Threatsawhichahaveanoacountermeasuresaandarepresentavulnerabilitiesathatacanabeafullyaexploitedaandacauseaanaimpacto Partially mitigated threats Threatsapartiallyamitigatedabyaoneaoramoreacountermeasuresmawhicharepresentavulnerabilitiesathatacanaonlyapartiallyabea exploitedaandacauseaaalimitedaimpacto Fully mitigated threats Theseathreatsahaveaappropriateacountermeasuresainaplaceaandadoanotaexposeavulnerabilityaandacauseaimpacto Table 10: TypesaOfaMitigatedaThreats Methodology40 Methodology PERSIST METRICS PERFORM REVIEW CODE SUBMITED FOR SCR CODE RESUBMITED FOR RE-REVIEW HAS CONTEXT OF CODE BEEN DEFINED RECOMENDED CODE TRIAGE MEETING DEFINE CRITERIA PROJECT OR VULNERABILITY BASED CODE REVIEW DATABASE TREND ANALYSIS RECORD FINDINGS DEVELOP METRICS PREVIOUS FINDINGS STANDARDS GUIDELINES POLICIES NO YES COMMUNICATE RESULTS TO TEAM The Use of Metrics Throughout The Code Review Process Figure 5: Exampleaprocessadiagramaforaidentifyingainputapaths 41 Cyclomatic complexity (CC): Aastaticaanalysisametricausedatoaassistainatheaestablishmentaofariskaandastabilityaestimationsaonaanaitemaofacodema suchaasaaaclassmamethodmaoraevenaaacompleteasystemoaItawasadefinedabyaThomasaMcCabeainatheaxq’saandaitaisaeasya toacalculateaandaapplymahenceaitsausefulnesso TheaMcCabeacyclomaticacomplexityametricaisadesignedatoaindicateaaaprogram’satestabilitymaunderstandabilitya andamaintainabilityoaThisaisaaccomplishedabyameasuringatheacontrolaflowastructuremainaorderatoapredictatheadiffin cultyaofaunderstandingmatestingmamaintainingmaetcoaOnceatheacontrolaflowastructureaisaunderstoodaoneacanagainaaa realizationaofatheaextentatoawhichatheaprogramaisalikelyatoacontainadefectsoaTheacyclomaticacomplexityametricaisa intendedatoabeaindependentaofalanguageaandalanguageaformatathatameasuresatheanumberaofalinearlyaindepenn dentapathsathroughaaaprogramamoduleoaItaisaalsoatheaminimumanumberaofapathsathatashouldabeatestedo Byaknowingatheacyclomaticacomplexityaofatheaproductmaoneacanafocusaonatheamoduleawithatheahighestacomn plexityoaThisawillamostalikelyabeaoneaofatheapathsadataawillatakemathusaableatoaguideaoneatoaaapotentiallyahighariska locationaforavulnerabilitiesoaTheahigheratheacomplexityatheagreaterapotentialaforamoreabugsoaTheamoreabugsathea higheratheaprobabilityaforamoreasecurityaflawso DoesacyclomaticacomplexityarevealasecurityariskﬄaOneawillanotaknowauntilaafteraaareviewaofatheasecurityaposturea ofatheamoduleoaTheacyclomaticacomplexityametricaprovidesaaarisknbasedaapproachaonawhereatoabeginatoareviewa andaanalyzeatheacodeoaSecuringaanaapplicationaisaaacomplexataskaandainamanyawaysacomplexityaanaenemyaofa securityaasasoftwareacomplexityacanamakeasoftwareabugsahardatoadetectoaComplexityaofasoftwareaincreasesaovera timeaasatheaproductaisaupdatedaoramaintainedo Cyclomatic complexity can be calculated as: CC = Number of decisions +1 …awhereaaadecisionawouldabeaconsideredaasacommandsawhereaexecutionaisabranchedawithaifpelsemaswitchmacasema catchmawhilemadomatemplatedaclassacallsmaetcom AsatheadecisionacountaincreasesmasoadoatheacomplexityaandatheanumberaofapathsoaComplexacodealeadsatoalessa stabilityaandamaintainabilityo The more complex the code, the higher risk of defects. A company can establish thresholds for cyclomatic complexity for a module: 0-10: Stable code, acceptable complexity 11-15: Medium Risk, more complex 16-20: High Risk code, too many decisions for a unit of code. Modulesawithaaaveryahighacyclomaticacomplexityaareaextremelyacomplexaandacouldabearefactoredaintoasmallera methodsoa Bad Fix Probability: Thisa isa thea probabilitya ofa ana errora accidentallya inserteda intoa aa programa whilea tryinga toa fixa aa previousa errorma knownainasomeacompaniesaasaaaregressiono Cyclomatic Complexity: 1 – 10 == Bad Fix Probability: 5% Cyclomatic Complexity: 20 –30 == Bad Fix Probability: 20% Cyclomatic Complexity: > 50 == Bad Fix Probability: 40% Cyclomatic Complexity: Approaching 100 == Bad Fix Probability: 60% Asatheacomplexityaofasoftwareaincreaseasoadoesatheaprobabilityatoaintroduceanewaerrorso Methodology42 Inspection Rate: ThisametricacanabeausedatoagetaaaroughaideaaofathearequiredadurationatoaperformaaacodeareviewoaTheainspectiona rateaisathearateaofacoverageaaacodearevieweracanacoveraperaunitaofatimeoaForaexamplemaaarateaofasvqalinesaperahoura couldabeaaabaselineoaThisarateashouldanotabeausedaasapartaofaaameasureaofareviewaqualitymabutasimplyatoadetern mineadurationaofatheatasko Defect Detection Rate: ThisametricameasureatheadefectsafoundaperaunitaofatimeoaAgainmacanabeausedatoameasureaperformanceaofathea codeareviewateammabutanotatoabeausedaasaaaqualityameasureoaDefectadetectionarateawouldanormallyaincreaseaasa theainspectionarateaiabovejadecreaseso Re-inspection Defect Rate: Thearateaatawhichauponareninspectionaofatheacodeamoreadefectsaexistmasomeadefectsastillaexistmaoraotheradefectsa manifestathroughaanaattemptatoaaddressapreviouslyadiscoveredadefectsairegressionsjo 6.11 Crawling Code Crawlingacodeaisatheapracticeaofascanningaaacodeabaseaofatheareviewatargetaandainterfaceaentryapointsmalookinga forakeyacodeapointersawhereinapossibleasecurityavulnerabilityamightaresideoaCertainaAPIsaarearelatedatoaintern facingatoatheaexternalaworldaorafileaIOaorauseramanagementmawhichaareakeyaareasaforaanaattackeratoafocusaonoaIna crawlingacodeawealookaforaAPIsarelatingatoatheseaareasoaWeaalsoaneedatoalookaforabusinessalogicaareasawhichamaya causeasecurityaissuesmabutagenerallyatheseaareabespokeamethodsawhichahaveabespokeanamesaandacannotabeaden tectedadirectlymaevenathoughaweamayatouchaonacertainamethodsadueatoatheirarelationshipawithaaacertainakeyaAPIo Weaalsoaneedatoalookaforacommonaissuesarelatingatoaaaspecificalanguage•aissuesathatamayanotabeasecurityarelateda butawhichamayaaffectatheastabilitypavailabilityaofatheaapplicationainatheacaseaofaextraordinaryacircumstancesoa Otheraissuesawhenaperformingaaacodeareviewaareaareasasuchaaasimpleacopyrightanoticeainaorderatoaprotectaone’sa intellectualapropertyoaGenerallyatheseaissuesashouldabeapartaofaaacompaniesaCodingaGuidelinesaioraStandardjma andashouldabeaenforceableaduringaaacodeareviewoaaForaexampleaaarevieweracanarejectaaacodeareviewabecausea theacodeaviolatesasomethingainatheaCodingaGuidelinesmaregardlessaofawhetheraoranotatheacodeawouldaworkaina itsacurrentastateo CrawlingacodeacanabeadoneamanuallyaorainaanaautomatedafashionausingaautomatedatoolsoaHoweveraworkinga manuallyaisaprobablyanotaeffectivemaasaiasacanabeaseenabelowjathereaareaplentyaofaindicatorsmawhichacanaapplyatoa aalanguageoaToolsaasasimpleaasagrepaorawingrepacanabeausedoaOtheratoolsaareaavailableawhichawouldasearchafora keywordsarelatingatoaaaspecificaprogrammingalanguageoaIfaaateamaisausingaaaparticularareviewatoolathataallowsa itatoaspecifyastringsatoabeahighlightedainaaareviewaieogoaPythonabasedareviewatoolsausingapygmentsasyntaxahighn lightermaoraanainnhouseatoolaforawhichatheateamacanachangeatheasourceacodejathenatheyacouldaaddathearelevanta stringaindicatorsafromathealistsabelowaandahaveathemahighlightedatoareviewersaautomaticallyoaa Theabasisaofatheacodeareviewaisatoalocateaandaanalyzeaareasaofacodemawhichamayahaveaapplicationasecurityaimplin cationsoaAssumingatheacodeareviewerahasaaathoroughaunderstandingaofatheacodemawhataitaisaintendedatoadomaanda theacontextainawhichaitaisatoabeausedmafirstlyaoneaneedsatoasweepatheacodeabaseaforaareasaofainteresto Appendix Cagivesapracticalaexamplesaofahowatoacarryaoutacodeacrawlingainatheafollowingaprogrammingalann guages– •aoNet •aJava •aASP •aCllpApache Methodology 43 A1 44 A1 - Injection 7.1 Overview What is Injection? Injectionaattacksaallowaaamaliciousauseratoaaddaorainjectacontentaandacommandsaintoaanaapplicationainaorderatoa modifyaitsabehaviouroaaTheseatypesaofaattacksaareacommonmawidespreadmaanaeasyaforaaahackeratoatestaifaaawebasitea isavulnerableaandaeasyaandaquickaforatheaattackeratoatakeaadvantageaofoaTodayatheyaareaveryacommonainalegacya applicationsathatahaven’tabeenaupdatedo 7.2 SQL Injection TheamostacommonainjectionavulnerabilityaisaSQLainjectionoaInjectionavulnerabilityaisaalsoaeasyatoaremediateaanda protectaagainstoaThisavulnerabilityacoversaSQLmaLDAPmaXpathmaOSacommandsmaXMLaparserso Injection vulnerability can lead to… 1. Disclosurepleakingaofasensitiveainformationo 2. DataaintegrityaissuesoaSQLainjectionamayamodifyadatamaaddanewadatamaoradeleteadatao 3. Elevationaofaprivilegeso 4. Gainingaaccessatoabacknendanetworko SQLacommandsaareanotaprotectedafromatheauntrustedainputoaSQLaparseraisanotaableatoadistinguishabetweena codeaandadatao UsingastringaconcatenationatoagenerateaaaSQLastatementaisaveryacommonainalegacyaapplicationsawhereaden velopersawereanotaconsideringasecurityoaTheaissueaisathisacodingatechniqueadoesanotatellatheaparserawhichaparta ofatheastatementaisacodeaandawhichapartaisadataoaInasituationsawhereauserainputaisaconcatenatedaintoatheaSQLa statementmaanaattackeracanamodifyatheaSQLastatementabyaaddingaSQLacodeatoatheainputadatao 1. UntrustedainputaisaacceptableabyatheaapplicationoaThereaareaseveralawaysatoamitigateainjectionavulnerabilityma whitelistingmaregexmaetcoaTheafiveabestawaysaareoaAllafiveashouldabeausedatogetheraforaaadefenseainadepthaapproacho a 1. HtmlEncodeaallauserainputo 2. UsingastaticaanalysisatoolsoaMostastaticaanalysisaforalanguagesalikeaoNetmaJavamapythonaareaaccurateoaHowevera staticaanalysisacanabecomeaanaissueawhenainjectionacomesafromaJavaScriptaandaCSSo 3. ParameterizeaSQLaqueriesoaUseaSQLamethodsaprovidedabyatheaprogrammingalanguageaoraframeworkathata parameterizeatheastatementsmasoathatatheaSQLaparseracanadistinguishabetweenacodeaandadataoa INJECTIONA1 SELECT custName, address1 FROM cust_table WHERE custID= ‘“ + request.GetParameter(“id”) + ““String custQuery = Code Data 45 4. UseaStoredaProceduresoaStoredaproceduresawillagenerallyahelpatheaSQLaparseradifferentiateacodeaandadataoa HoweveraStoredaProceduresacanabeausedatoabuildadynamicaSQLastatementsaallowingatheacodeaandadataatoaben comeablendedatogetheracausingatheaitatoabecomeavulnerableatoainjectiono 5. Provideadeveloperatrainingaforabestapracticesaforasecureacodingo Blind SQL Injection TypicallyaSQLaqueriesareturnasearcharesultsathataareapresentedatoaaauseroaHowevermathereaareacasesawhereaSQLa queriesaareahappeningabehindatheascenesathatainfluenceahowatheapageaisarenderedmaandaaunfortunatelyaattackn ersacanastillagleanainformationabasedaonatheaerroraresponsesafromavariousaUIaelementsoaBlindaSQLainjectionaisaaa typeaofaattackathataasksatheadatabaseatrueaorafalseaquestionsaandadeterminesatheaanswerabasedaonatheaapplican tionsaresponseoa EffectivelyatheaattackerausesaSQLaqueriesatoadetermineawhataerroraresponsesaareareturnedaforavalidaSQLmaanda whicharesponsesaareareturnedaforainvalidaSQLoaThenatheaattackeracanaprobe•aforaexampleacheckaifaaatableacalleda “user_password_table”aexistsoaOnceatheyahaveathatainformationmatheyacouldauseaanaattackalikeatheaoneadescribeda aboveatoamaliciouslyadeleteatheatablemaoraattemptatoareturnainformationafromatheatableaidoesatheausernamea “john”aexistﬄjoaBlindaSQLainjectionsacanaalsoauseatimingsainsteadaofaerroramessagesmaeogoaifainvalidaSQLatakesasa secondsatoarespondmabutavalidaSQLareturnsainaqovasecondsmatheaattackeracanauseathisainformationo Parameterized SQL Queries ParameterizedaSQLaqueriesaisometimesacalledapreparedastatementsjaallowatheaSQLaqueryastringatoabeadefineda inasuchaaawayathatatheaclientainputacan’tabeatreatedaasapartaofatheaSQLasyntaxoa Take the example in sample 7.1: Ina thisa examplea thea stringa‘query’a isa constructeda ina aa waya thata ita doesa nota relya ona anya clienta inputma anda thea ‘PreparedStatement’aisaconstructedafromathatastringoaWhenatheaclientainputaisatoabeaenteredaintoatheaSQlmathea ‘setString’afunctionaisausedaandatheafirstaquestionamarka“ﬄ”aisareplacedabyatheastringavalueaofa‘firstname’matheasecn ondaquestionamarkaisareplacedabyatheavalueaofa‘lastname’oaWhenathea‘setString’afunctionaisacalledmathisafunctiona automaticallyachecksathatanoaSQLasyntaxaisacontainedawithinatheastringavalueoaMostapreparedastatementaAPIsa allowayouatoaspecifyatheatypeathatashouldabeaenteredmaeogoa‘setInt’maora‘setBinary’maetco Safe String Concatenation? Soadoesathisameanayouacan’tauseastringaconcatenationaataallainayouraDBahandlingacodeﬄaItaisapossibleatoauseastringa concatenationasafelymabutaitadoesaincreaseatheariskaofaanaerrormaevenawithoutaanaattackeraattemptingatoainjecta SQLasyntaxaintoayouraapplicationo YouashouldaneverauseastringaconcatenationainacombinationawithatheaclientainputavalueoaTakeaanaexampleawherea theaexistenceainotatheavaluejaofaaaclientainputavariablea“surname”aisausedatoaconstructatheaSQLaqueryaofathea preparedastatement• Sample 7.1 ra aStringaquerya…a“SELECTaidmafirstnamemalastnameaFROMaauthorsaWHEREaforenamea…aﬄaandasurnamea…aﬄ”•a sa aPreparedStatementapstmta…aconnectionoprepareStatementiaqueryaj•a ta apstmtosetStringiarmafirstnameaj•a ua apstmtosetStringiasmalastnameaj•a A1 - Injection46 Hereatheavalueaofa‘lastname’aisanotabeingausedmabutatheaexistanceaofaitaisabeingaevaluatedoaHoweverathereaisastillaaariska whenatheaSQLastatementaisalargeraandahasamoreacomplexabusinessalogicainvolvedainacreatingaitoaTakeatheafollowinga exampleawhereatheafunctionawillasearchabasedaonafirstnameaoralastname– ThisalogicawillabeafineawhenaeitherafirstnamemaoralastnameaisagivenmahoweveraifaneitherawereagivenathenatheaSQLastaten mentawouldanotahaveaanyaWHEREaclausemaandatheaentireatableawouldabeareturnedoaThisaisanotaanaSQLainjectionaithea attackerahasadoneanothingatoacauseathisasituationmaexceptanotapassingatwoavaluesjahoweveratheaendaresultaisatheasamema informationahasabeenaleakedafromatheadatabasemadespiteatheafactathataaaparameterizedaqueryawasausedoa ForathisareasonmatheaadviceaisatoaavoidausingastringaconcatenationatoacreateaSQLaqueryastringsmaevenawhenausingaparamn eterizedaqueriesmaespeciallyaifatheaconcatenationainvolvesabuildingaanyaitemsainatheawhereaclauseo Using Flexible Parameterized Statements FunctionalarequirementsaoftenaneedatheaSQLaqueryabeingaexecutedatoabeaflexibleabasedaonatheauserainputmaeogoaifathea endauseraspecifiesaaatimeaspanaforatheiratransactionasearchathenathisashouldabeausedmaoratheyamightawishatoaqueryabaseda onaeitherasurnameaoraforenamemaorabothoaInathisacaseatheasafeastringaconcatenationaaboveacouldabeausedmahoweverafroma raStringaquerya…a“SelectaidmafirstnamemalastnameaFROMaauthorsaWHEREaforenamea…aﬄ”•a saifailastnameb…aNULLaggalastnameolengthab…aqja{ taaaaaqueryal…a“aandasurnamea…aﬄ”• uaa} vaqueryal…a“•”•a wa a xa aPreparedStatementapstmta…aconnectionoprepareStatementiaqueryaj•a ya apstmtosetStringiarmafirstnamej•a “a a rqa aifailastnameb…aNULLaggalastnameolengthab…aqja{apstmtosetStringiasmalastnameaj•a} Sample 7.2 raStringaquerya…a“selectaidmafirstnamemalastnameaFROMaauthors”• s taifaiiafirstnameab…aNULLaggafirstnameolengthab…aqajaggaialastnameab…aNULLaggalastnameolengthab…aqajja{ u   aqueryal…a“WHEREaforenamea…aﬄaANDasurnamea…aﬄ”• va} waelseaifaiafirstnameab…aNULLaggafirstnameolengthab…aqaja{ x    aqueryal…a“WHEREaforenamea…aﬄ”• ya} “aelseaifaialastnameb…aNULLaggalastnameolengthab…aqaja{ rq    aqueryal…a“WHEREasurnamea…aﬄ”• rra} rs rtaqueryal…a“•”• ru rvaPreparedStatementapstmta…aconnectionoprepareStatementiaqueryaj Sample 7.3 A1 - Injection 47 aamaintenanceapointaofaviewathisacouldainviteafutureaprogrammersatoamisunderstandatheadifferenceabetweenasafea concatenationaandatheaunsafeaversionaiusingainputastringavaluesadirectlyjo Oneaoptionaforaflexibleaparameterizedastatementsaisatoausea‘if’astatementsatoaselectatheacorrectaqueryabasedaonathea inputavaluesaprovidedmaforaexample– PHP SQL Injection AnaSQLainjectionaattackaconsistsaofainjectingaSQLaqueryaportionsainatheabacknendadatabaseasystemaviaatheaclienta interfaceainatheawebaapplicationoaTheaconsequenceaofaaasuccessfulaexploitationaofaanaSQLainjectionavariesafroma justareadingadataatoamodifyingadataaoraexecutingasystemacommandsoaaSQLaInjectionainaPHParemainsatheanumbera oneaattackavectormaandaalsoatheanumberaoneareasonaforadataacompromisesaasashownainasample 7.5o Example 1 : ra aStringaquery•a sa aPreparedStatementapstmt•a ta a ua aifaiaifirstnameb…aNULLaggafirstnameolengthab…aqjagga va aaaaaalastnameb…aNULLaggalastnameolengthab…aqjaja{a wa aaaaaaquerya…a“SelectaidmafirstnamemalastnameaFROMaauthorsaWHEREaforenamea…aﬄaandasurnamea…aﬄ”a xa aaaaaapstmta…aconnectionoprepareStatementiaqueryaj•a ya aaaaaapstmtosetStringiarmafirstnameaj•a “a aaaaaapstmtosetStringiasmalastnameaj•a rqa a}a rra aelseaifaifirstnameab…aNULLaggafirstnameolengthab…aqja{a rsa aaaaaaquerya…a“SelectaidmafirstnamemalastnameaFROMaauthorsaWHEREaforenamea…aﬄ”•a rta aaaaaapstmta…aconnectionoprepareStatementiaqueryaj•a rua aaaaaapstmtosetStringiarmafirstnameaj•a rva a}a rwa aelseaifailastnameab…aNULLaggalastnameolengthab…aqj{a rxa aaaaaaquerya…a“SelectaidmafirstnamemalastnameaFROMaauthorsaWHEREasurname…aﬄ”•a rya aaaaaapstmta…aconnectionoprepareStatementiaqueryaj•a r“a aaaaaapstmtosetStringiarmalastnamej•a sqa a}a sra aelse{a ssa aaaaaathrowaNameNotSpecifiedExceptionij•a} Sample 7.4 ra”ﬄphpa raepass…e_GET[“pass”]•a saecona…amysql_connecti‘localhost’ma‘owasp’ma‘abcrst’j•a taamysql_select_dbi“owasp_php”maeconj•a uaaesql…”SELECTacardaFROMausersaWHEREapassworda…a‘”oepasso”’”•a vaeresulta…amysql_queryiesqlj•a waaﬄ—a Sample 7.5 A1 - Injection48 TheamostacommonawaysatoapreventaSQLaInjectionainaPHPaareausingafunctionsasuchaasaaddslashesijaandamysql_ real_escape_stringijabutathoseafunctionacanaalwaysacauseaSQLaInjectionsainasomeacaseso Addslashes : YouawillaavoidaSqlainjectionausingaaddslashesijaonlyainatheacaseawhenayouawrapatheaqueryastringawithaquoteso Theafollowingaexampleawouldastillabeavulnerableaa mysql_real_escape_string(): mysql_real_escape_stringijaisaaalittleabitamoreapowerfulathanaaddslashesijaasaitacallsaMySQL’salibraryafunctiona mysql_real_escape_stringmawhichaprependsabackslashesatoatheafollowingacharacters–a\\xqqma\\nma\\rma\\ma‘ma“aanda\\xrao Asa witha addslashesijma mysql_real_escape_stringija willa onlya worka ifa thea querya stringa isa wrappeda ina quotesoa Aa stringasuchaasatheafollowingawouldastillabeavulnerableatoaanaSQLainjection– SQLainjectionsaoccurawhenainputatoaaawebaapplicationaisanotacontrolledaorasanitizedabeforeaexecutingatoathea backnendadatabaseo TheaattackeratriesatoaexploitathisavulnerabilityabyapassingaSQLacommandsainaherphisainputaandathereforeawilla createaaaundesiredaresponseafromatheadatabaseasuchaasaprovidingainformationathatabypassesatheaauthorizationa anda authenticationa programmeda ina thea weba applicationoa a Ana examplea ofa vulnerablea javaa codea isa showna ina sampleaxox An example of a vulnerable java code Theainputaparametera“name”aisapassedatoatheaStringaqueryawithoutaanyaproperavalidationaoraverificationoaaThea querya‘SELECTkaFROMausersawhereaname”aisaequalatoatheastringa‘username’acanabeaeasilyamisusedatoabypassa somethingadifferentathatajustathea‘name’oaForaexamplematheaattackeracanaattemptatoapassainsteadainathisawayaacn cessingaallauserarecordsaandanotaonlyatheaoneaentitledatoatheaspecificausera a“aaaORaar…ro ra aeida…aaddslashesiae_GET[‘id’]aj•a sa equerya…a‘SELECTatitleaFROMabooksaWHEREaida…a‘aoaeid•a Sample 7.6 raaHttpServletRequestarequesta…aooo•a saStringauserNamea…arequestogetParameteri“name”j•a taaConnectionaconaa…aoooa uaaaStringaquerya…a“SELECTakaFROMaUsersaWHEREaaanamea…a‘”alauserNameala“’”•a vaconoexecuteiqueryj• Sample 7.7 A1 - Injection 49 .NET Sql Injection FrameworkaroqagasoqamightabeamoreavulnerableatoaSQLainjectionsathanathealateraversionsaofaoNEToaThanksatoathea properaimplementationaandauseaofadesignapattersaalreadyaembeddedainaASPoNETasuchaasaMVCialsoadependinga onatheaversionjmaitaisapossibleatoacreateaapplicationsafreeafromaSQLainjectionsmahowevermathereamightabeatimesa whereaaadeveloperamightapreferatoauseaSQLacodeadirectlyainatheacodeoa Example. Aadeveloperacreatesaaawebpageawithatafieldsaandasubmitabuttonmatoasearchaforaemployeesaonafieldsa‘name’ma ‘lastname’aanda‘id’a TheadeveloperaimplementsaaastringaconcatenatedaSQLastatementaorastoredaprocedureainatheacodeasuchaasaina sampleaxoyo ThisacodeaisaequivalentatoatheaexecutedaSQLastatementainasampleaxo“o AahackeracanathenainsertatheafollowingaemployeeaIDaviaatheawebainterfacea“rst’•DROPaTABLEapubsann”aandaexen cuteatheafollowingacode– SELECT name, lastname FROM authors WHERE ei_id = ‘123’; DROP TABLE pubs --’ Theasemicolona“•”aprovidesaSQLawithaaasignalathataitahasareachedatheaendaofatheasqlastatementmahowevermathea hackerausesathisatoacontinueatheastatementawithatheamaliciousaSQLacodea ; DROP TABLE pubs; Parameter collections ParameteracollectionsasuchaasaSqlParameterCollectionaprovideatypeacheckingaandalengthavalidationoaIfayouausea aaparametersacollectionmainputaisatreatedaasaaaliteralavaluemaandaSQLaServeradoesanotatreataitaasaexecutableacodema andathereforeatheapayloadacananotabeainjectedoa UsingaaaparametersacollectionaletsayouaenforceatypeaandalengthachecksoaValuesaoutsideaofathearangeatriggeraana exceptionoaMakeasureayouahandleatheaexceptionacorrectlyoaExampleaofatheaSqlParameterCollection– Hibernate Query Language (HQL) raSqlDataAdapterathisCommanda…anewaSqlDataAdapteri sa“SELECTanamemalastnameaFROMaemployeesaWHEREaei_ida…a‘”al aaaaaidNumberoTextala“’”mathisConnectionj• Sample 7.8 raSqlDataAdapterathisCommanda…anewaSqlDataAdapteri sa“SearchEmployeeSPa‘”alaidNumberoTextala“’”mathisConnectionj• Sample 7.9 A1 - Injection50 HibernateafacilitatesatheastorageaandaretrievalaofaJavaadomainaobjectsaviaaObjectpRelationalaMappingaiORMjoa ItaisaaaveryacommonamisconceptionathataORMasolutionsmalikeahibernatemaareaSQLaInjectionaproofoaHibernateaallowsathea useaofa“nativeaSQL”aandadefinesaaaproprietaryaqueryalanguagemacalledaHQLaiHibernateaQueryaLanguagej•atheaformeraisa proneatoaSQLaInjectionaandathealateraisaproneatoaHQLaioraORMjainjectiono What to Review • Alwaysavalidateauserainputabyatestingatypemalengthmaformatmaandarangeo • Testatheasizeaandadataatypeaofainputaandaenforceaappropriatealimitsoa • TestatheacontentaofastringavariablesaandaacceptaonlyaexpectedavaluesoaRejectaentriesathatacontainabinaryadatamaescapea sequencesmaandacommentacharacterso • WhenayouaareaworkingawithaXMLadocumentsmavalidateaalladataaagainstaitsaschemaaasaitaisaenteredo • NeverabuildaSQLastatementsadirectlyafromauserainputoa • UseastoredaproceduresatoavalidateauserainputmawhenanotausingastoredaproceduresauseaSQLaAPIaprovidedabyaplatformoa ioeoaParameterizedaStatementso • Implementamultiplealayersaofavalidationoa • NeveraconcatenateauserainputathataisanotavalidatedoaStringaconcatenationaisatheaprimaryapointaofaentryaforascripta injectiono YouashouldareviewaallacodeathatacallsaEXECUTEmaEXECmaanyaSQLacallsathatacanacallaoutsidearesourcesaoracommandalineo OWASP References • https://www.owasp.org/index.php/SQL_Injection_Prevention_Cheat_Sheet OWASP SQL Injection Prevention Cheat Sheet • https://www.owasp.org/index.php/Query_Parameterization_Cheat_Sheet OWASP Query Parameterization Cheat Sheet • https://www.owasp.org/index.php/Command_Injection OWASP Command Injection Article • https://www.owasp.org/index.php/XXE OWASP XML eXternal Entity (XXE) Reference Article rausingaiSqlConnectionaconna…anewaSqlConnectioniconnectionStringjja{a saDataSetadataObja…anewaDataSetij•a taSqlDataAdapterasqlAdaptera…anewaSqlDataAdapteria“StoredProc”maconnj•asqlAdapteroSelectCommando CommandTypea…aaa uaCommandTypeoStoredProcedure•a vasqlAdapteroSelectCommandoParametersoAddi“@usrId”maSqlDbTypeoVarCharmarvj•aaa waasqlAdapteroSelectCommandoParameters[“@usrIda“]oValuea…aUIDoText• Sample 7.10 A1 - Injection 51 • https://www.owasp.org/index.php/ASVS ASVS: Output Encoding/Escaping Requirements (V6) • https://www.owasp.org/index.php/Testing_for_SQL_Injection_(OWASP-DV-005) OWASP Testing Guide: Chap- ter on SQL Injection Testing External References • http://cwe.mitre.org/data/definitions/77.html CWE Entry 77 on Command Injection • http://cwe.mitre.org/data/definitions/89.html CWE Entry 89 on SQL Injection • http://cwe.mitre.org/data/definitions/564.html CWE Entry 564 on Hibernate Injection • Livshits and Lam, 2005 “Finding Security Vulnerabilities in Java Applications with Static Analysis” available at https://www.usenix.org/legacy/event/sec05/tech/full_papers/livshits/livshits_html/#sec:sqlinjexample • http://www.php.net/manual/en/book.pdo.php PDO • https://technet.microsoft.com/en-us/library/ms161953(v=sql.105).aspx 7.3 JSON (JavaScript Object Notation) JSONaiJavaScriptaObjectaNotationjaisaanaopenastandardaformatathatausesaeasyatoareadatextatoatransmitadataaben tweenaaaserveraandawebaapplicationsoaaJSONadataacanabeausedabyaaalargeanumberaofaprogrammingaLanguagesa andaisabecomingatheadenfactoastandardainareplacingaXMLo JSONamainasecurityaconcernaisaJSONatextadynamicallyaembeddedainaJavaScriptmabecauseaofathisainjectionaisaaaveryareala vulnerabilityoaaTheavulnerabilityainatheaprogramathatamayainadvertentlyatoarunaaamaliciousascriptaorastoreatheamaliciousa scriptatoaaadatabaseoaThisaisaaaveryarealapossibilityawhenadealingawithadataaretrievedafromatheaInterneto TheacodearevieweraneedsatoamakeasureatheaJSONaisanotausedawithaJavascriptaevaloaMakeasureaJSONoparsei…jaisausedo Varaparsed_objecta…aevali“i“alaJason_textaala“j”j•aappaRedaflagaforatheacodeareviewero aJSONoparseitext[mareviver]j•aooappaMuchabetterathenausingajavascriptaevalafunctiono a Codeareviewerashouldacheckatoamakeasureatheadeveloperaisanotaattemptingatoarejectaknownabadapatternsainatextp stringadatamaUsingaregexaoraotheradevicesaisafraughtawithaerroraandamakesatestingaforacorrectnessaveryahardoaAllowaonlya whitelistedaalphanumericakeywordsaandacarefullyavalidatedanumberso Doa nota allowa JSONa dataa toa constructa dynamica HTMLoa Alwaysa usa safea DOMa featuresa likea innerTexta ora CreateTextn Nodei…j Object/Relational Mapping (ORM) ObjectpRelationaMappingaiORMjafacilitatesatheastorageaandaretrievalaofadomainaobjectsaviaaHQLaiHibernateaQuerya LanguagejaoraoNETaEntityaframeworkoa ItaisaaaveryacommonamisconceptionathataORMasolutionsmalikeahibernateaareaSQLaInjectionaproofoaTheyaareanotoaORM’sa allowatheauseaofa“nativeaSQL”oaaThruaproprietaryaqueryalanguagemacalledaHQLaisaproneatoaSQLaInjectionaandathealateraisa proneatoaHQLaioraORMjainjectionoaLinqaisanotaSQLaandabecauseaofathataisanotaproneatoaSQLainjectionoaHoweverausinga excutequeryaoraexcutecommandaviaalinqacausesatheaprogramanotatoausealinqaprotectionamechanismaandaisavulneran bilityatoaSQLainjectionoa A1 - Injection52 Bad Java Code Examples Listaresultsa…asessionocreateQueryi“fromaItemsaasaitemawhereaitemoida…a“alacurrentItemogetIdijjolistij• NHibernateaisatheasameaasaHibernateaexceptaitaisaanaORMasolutionaforaMicrosoftaoNETaplatformoaNHibernateaisaalsoavuln nerableatoaSQLainjectionaifausedamyadynamicaquerieso Bad .Net Code Example Code Reviewer Action CodearevieweraneedsatoamakeasureaanyadataausedainaanaHQLaqueryausesaHQLaparameterizedaqueriesasoathataita wouldabeausedaasadataaandanotaasacodeoaaTheyacanaalsoauseatheaCriteriaaAPIaatahttps://docs.jboss.org/hibernate/ orm/3.3/reference/en/html/querycriteria.html 7.5 Content Security Policy (CSP) IsaaaWtCaspecificationaofferingatheapossibilityatoainstructatheaclientabrowserafromawhichalocationaandporawhicha typeaofaresourcesaareaallowedatoabealoadedoaToadefineaaaloadingabehaviormatheaCSPaspecificationausea“directive”a whereaaadirectiveadefinesaaaloadingabehavioraforaaatargetaresourceatypeoaCSPahelpsatoadetectaandamitigateacern tainatypesaofaattacksmaincludingaCrossaSiteaScriptingaiXSSjaandadataainjectionaattacksoaTheseaattacksaareausedafora everythingafromadataatheftatoasiteadefacementaoradistributionaofamalware DirectivesacanabeaspecifiedausingaHTTParesponseaheaderaiaaserveramayasendamoreathanaoneaCSPaHTTPaheadera fieldawithaaagivenaresourcearepresentationaandaaaserveramayasendadifferentaCSPaheaderafieldavaluesawithadifn ferentarepresentationsaofatheasamearesourceaorawithadifferentaresourcesjaoraHTMLaMetaatagmatheaHTTPaheadersa belowaareadefinedabyatheaspecs– • ContentnSecuritynPolicya–aDefinedabyaWtCaSpecsaasastandardaheadermausedabyaChromeaversionasvaandalaterma FirefoxaversionastaandalatermaOperaaversionar“aandalatero • XnContentnSecuritynPolicya–aUsedabyaFirefoxauntilaversionastmaandaInternetaExploreraversionarqaiwhichapartiallya implementsaContentaSecurityaPolicyjo • XnWebKitnCSPa–aUsedabyaChromeauntilaversionasv Risk TheariskawithaCSPacanahaveasamainasources– • Policiesamisconfigurationm • Tooapermissiveapolicieso What to Review Codearevieweraneedsatoaunderstandawhatacontentasecurityapoliciesawerearequiredabyaapplicationadesignaanda howatheseapoliciesaareatestedatoaensureatheyaareainauseabyatheaapplicationo stringauserNamea…actxoGetAuthenticatedUserNameij• aStringaquerya…a“SELECTakaFROMaItemsaWHEREaownera…a‘”a alauserNameala“’aANDaitemnamea…a‘”aa alaItemNameoTextala“’”• aListaitemsa…asessoCreateSQLQueryiqueryjoListij A1 - Injection 53 Useful security-related HTTP headers Inamostaarchitecturesatheseaheadersacanabeasetainawebaserversaconfigurationawithoutachangingaactualaapplican tion’sacodeoaThisaoffersasignificantlyafasteraandacheaperamethodaforaataleastapartialamitigationaofaexistingaissuesma andaanaadditionalalayeraofadefenseaforanewaapplicationso NoteatheaSpringaSecurityalibraryacanaassistawithatheseaheadersmaseeahttp–ppdocsospringoiopspringnsecuritypsitep docspcurrentpreferencephtmlpheadersohtml Header name Description Example Strict-Transport-Security https://tools.ietf.org/ html/rfc6797 X-Frame-Options https://tools.ietf.org/ html/draft-ietf-websec-x- frame-options-01 Frame-Options https://tools.ietf.org/ html/draft-ietf-websec- frame-options-00 HTTPaStrictnTransportnSecurityaiHSTSjaenforcesasecureaiHTTPaoveraSSLpTLSjaconnectionsa toa thea serveroa Thisa reducesa impacta ofa bugsa ina weba applicationsa leakinga sessiona dataa througha cookiesa anda externala linksa anda defendsa againsta Manninnthenmiddlea attacksoa HSTSaalsoadisablesatheaabilityaforauser’satoaignoreaSSLanegotiationawarningso ProvidesaClickajackingaprotectionoaValues–adenyananoarenderingawithinaaaframemasameorigina nanoarenderingaifaoriginamismatchmaallownfrom–aDOMAINanaallowarenderingaifaframedabya framealoadedafromaDOMAIN StrictnTransportnSecurity–a maxnage…rwqxquqq•a includeSubDomains XnFramenOptions–adeny Table 11: SecurityaRelatedaHTTPaHeaders X-Content-Type-Options https://blogs.msdn. microsoft.com/ ie/2008/09/02/ie8-securi- ty-part-vi-beta-2-update/ Content-Security-Policy, X-Content-Security-poli- cy,X-WebKit-CSP https://www.w3.org/TR/ CSP/ Content-Security-Poli- cy-Report_Only https://www.w3.org/TR/ CSP/ Theaonlyadefinedavaluema“nosniff”mapreventsaInternetaExploreraandaGoogleaChromeafroma MIMEnsniffingaaaresponseaawayafromatheadeclaredacontentntypeoaThisaalsoaappliesatoaGoon gleaChromemawhenadownloadingaextensionsoaThisareducesaexposureatoadrivenbyadownn loadaattacksaandasitesaservingauserauploadedacontentathatmabyacleveranamingmacouldabea treatedabyaMSIEaasaexecutableaoradynamicaHTMLafileso Contenta Securitya Policya requiresa carefula tuninga anda precisea definitiona ofa thea policyoa Ifa enabledmaCSPahasasignificantaimpactaonatheawayabrowserarendersapagesaieogomainlineaJavaSn criptadisabledabyadefaultaandamustabeaexplicitlyaallowedainapolicyjoaCSPapreventsaaawidea rangeaofaattacksmaincludingaCrossnsiteascriptingaandaotheracrossnsiteainjectionso Likea ContentnSecuritynPolicyma buta onlya reportsoa Usefula duringa implementationma tuninga andatestingaeffortso XnContentnTypenOptions–a nosniff ContentnSecuritynPolicy–a defaultnsrca‘self’ ContentnSecuritynPoln icynReportnOnly–aden faultnsrca‘self’•areportnuria http–pploghostoexampleo compreportsojsp X-XSS-Protection [http://blogs. msdn.com/b/ie/ar- chive/2008/07/02/ ie8-security-part-iv-the- xss-filter.aspx X-XSS-Pro- tection] ThisaheaderaenablesatheaCrossnsiteascriptingaiXSSjafilterabuiltaintoamostarecentawebabrowsn ersoaIt’sausuallyaenabledabyadefaultaanywaymasoathearoleaofathisaheaderaisatoarenenableathea filteraforathisaparticularawebsiteaifaitawasadisabledabyatheauseroaThisaheaderaisasupportedaina IEaylmaandainaChromeainotasureawhichaversionsjoaTheaantinXSSafilterawasaaddedainaChromea uoaItsaunknownaifathataversionahonoredathisaheadero XnXSSnProtection–ar•a mode…block A1 - Injection54 References Apache:ahttp://httpd.apache.org/docs/2.0/mod/mod_headers.html IIS:ahttp://technet.microsoft.com/pl-pl/library/cc753133(v=ws.10).aspx 7.6 Input Validation InputavalidationaisaoneaofatheamostaeffectiveatechnicalacontrolsaforaapplicationasecurityoaItacanamitigateanumern ousavulnerabilitiesaincludingacrossnsiteascriptingmavariousaformsaofainjectionmaandasomeabufferaoverflowsoaInputa validationaisamoreathanacheckingaformafieldavaluesoa Alla dataa froma usersa needsa toa bea considereda untrustedoa Remembera onea ofa thea topa rulesa ofa securea codinga isa “Don’tatrustauserainput”oaAlwaysavalidateauseradataawithatheafullaknowledgeaofawhatayouraapplicationaisatryinga toaaccomplisho Regularaexpressionsacanabeausedatoavalidateauserainputmabutatheamoreacomplicatedathearegularaexpressaareathea moreachanceaitaisanotafullaproofaandahasaerrorsaforacorneracasesoaaRegularaexpressionsaareaalsoaveryahardafroaQAa toatestoaRegularaexpressionsamayaalsoamakeaitahardaforatheacodearevieweratoadoaaagoodareviewaofathearegulara expressionso Data Validation Alla externala inputa toa thea systema ianda betweena systemspapplicationsja shoulda undergoa inputa validationoaThea validationarulesaareadefinedabyatheabusinessarequirementsaforatheaapplicationoaIfapossiblemaanaexactamatchavalin datorashouldabeaimplementedoaExactamatchaonlyapermitsadataathataconformsatoaanaexpectedavalueoaAa“Knowna good”aapproachaiwhitenlistjmawhichaisaaalittleaweakermabutamoreaflexiblemaisacommonoaKnownagoodaonlyapermitsa characterspASCIIarangesadefinedawithinaaawhitenlistoa SuchaaarangeaisadefinedabyatheabusinessarequirementsaofatheainputafieldoaTheaotheraapproachesatoadataavalidan tionaarea“knownabadm”awhichaisaaablackalistaofa“badacharacters”oaThisaapproachaisanotafutureaproofaandawouldaneeda maintenanceoa“Encodeabad”awouldabeaveryaweakmaasaitawouldasimplyaencodeacharactersaconsidereda“bad”atoaaa formatmawhichashouldanotaaffectatheafunctionalityaofatheaapplicationo Business Validation BusinessavalidationaisaconcernedawithabusinessalogicoaAnaunderstandingaofatheabusinessalogicaisarequiredapriora toareviewingatheacodemawhichaperformsasuchalogicoaBusinessavalidationacouldabeausedatoalimitatheavaluearangea oraaatransactionainputtedabyaaauseraorarejectainputmawhichadoesanotamakeatooamuchabusinessasenseoaReviewinga codeaforabusinessavalidationacanaalsoaincludearoundingaerrorsaorafloatingapointaissuesawhichamayagiveariseatoa issuesasuchaasaintegeraoverflowsmawhichacanadramaticallyadamageatheabottomalineoa Canonicalization Canonicalizationaisatheaprocessabyawhichavariousaequivalentaformsaofaaanameacanabearesolvedatoaaasingleastann dardanamemaorathea“canonical”anameoa TheamostapopularaencodingsaareaUTFnymaUTFnrwmaandasoaonaiwhichaareadescribedainadetailainaRFCassx“joaAasinglea charactermasuchaasaaaperiodpfullnstopaiojmamayabearepresentedainamanyadifferentaways–aASCIIasEmaUnicodeaCqaAEma andamanyaotherso Withatheamyriadawaysaofaencodingauserainputmaaawebaapplication’safiltersacanabeaeasilyacircumventedaifathey’rea notacarefullyabuilto A1 - Injection 55 Bad Example Good Example .NET Request Validation OneasolutionaisatoauseaoNetaa“RequestaValidation”oaaUsingarequestavalidationaisaaagoodastartaonavalidatingausera dataaandaisausefuloaTheadownsideaisatooagenericaandanotaspecificaenoughatoameetaallaofaourarequirementsatoa provideafullatrustaofauseradatao Youacananeverausearequestavalidationaforasecuringayouraapplicationaagainstacrossnsiteascriptingaattackso TheafollowingaexampleashowsahowatoauseaaastaticamethodainatheaUriaclassatoadetermineawhetheratheaUriaprovidn edabyaaauseraisavalido var isValidUri = Uri.IsWellFormedUriString(passedUri, UriKind.Absolute); HowevermatoasufficientlyaverifyatheaUrimayouashouldaalsoacheckatoamakeasureaitaspecifiesahttpaorahttpsoaTheafollown ingaexampleausesainstanceamethodsatoaverifyathatatheaUriaisavalido avar uriToVerify = new Uri(passedUri); var isValidUri = uriToVerify.IsWellFormedOriginalString(); var isValidScheme = uriToVerify.Scheme == “http” || uriToVerify.Scheme == “https”• BeforearenderingauserainputaasaHTMLaoraincludingauserainputainaaaSQLaquerymaencodeatheavaluesatoaensureaman liciousacodeaisanotaincludedo YouacanaHTMLaencodeatheavalueainamarkupawithathea”f–af—asyntaxmaasashownabelowo <span><%: userInput %></span> OrmainaRazorasyntaxmayouacanaHTMLaencodeawitha@maasashownabelowo apublicastaticavoidamainiString[]aargsja{ aaaaaFileaxa…anewaFilei“pcmdp”alaargs[r]j• aaaaaStringaabsPatha…axogetAbsolutePathij• a} Sample 7.11 publicastaticavoidamainiString[]aargsjathrowsaIOExceptiona{ aaaaaFileaxa…anewaFilei“pcmdp”alaargs[r]j• aaaaaStringacanonicalPatha…axogetCanonicalPathij• a Sample 7.12 A1 - Injection56 <span>@userInput</span> TheanextaexampleashowsahowatoaHTMLaencodeaaavalueainacodenbehindo var encodedInput = Server.HtmlEncode(userInput); Managed Code and Non-Managed Code BothaJavaaandaoNetahaveatheaconceptaofamanagedaandanonnmanagedacodeoaToaofferasomeaofatheseaprotectionsa duringatheainvocationaofanativeacodemadoanotadeclareaaanativeamethodapublicoaInsteadmadeclareaitaprivateaanda exposeatheafunctionalityathroughaaapublicawrapperamethodoaAawrapperacanasafelyaperformaanyanecessaryainputa validationaprioratoatheainvocationaofatheanativeamethod– JavaaSampleacodeatoacallaaaNativeaMethodawithaDataaValidationainaplace Data validations checklist for the Code Reviewer. • EnsureathataaaDataaValidationamechanismaisapresentoa publicafinalaclassaNativeMethodWrappera{ a aaaaaaaaaaaaprivateanativeavoidanativeOperationibyte[]adatamaintaoffsetmaintalenj• a a aaaaaaaaa a aaaaaaaaaaaapublicavoidadoOperationibyte[]adatamaintaoffsetmaintalenja{ a aaaaaaaaaaaaaaaappacopyamutableainput a aaaaaaaaaaaaaaaadataa…adataocloneij• a a aaaaaaaaaaaaaaaappavalidateainput a aaaaaaaaaaaaaaaappaNoteaoffsetllenawouldabeasubjectatoaintegeraoverflowo a aaaaaaaaaaaaaaaappaForainstanceaifaoffseta…araandalena…aIntegeroMAX_VALUEm a aaaaaaaaaaaaaaaappaaathenaoffsetllena……aIntegeroMIN_VALUEawhichaisalower a aaaaaaaaaaaaaaaappaaathanadataolengtho a aaaaaaaaaaaaaaaappaFurtherm a aaaaaaaaaaaaaaaappaaaloopsaofatheaform a aaaaaaaaaaaaaaaappaaaaaaaforaiintai…offset•ai”offsetllen•allija{aoooa} a aaaaaaaaaaaaaaaappaaawouldanotathrowaanaexceptionaoracauseanativeacodeato a aaaaaaaaaaaaaaaappaaacrasho a a aaaaaaaaaaaaaaaaifaioffseta”aqa||alena”aqa||aoffseta—adataolengthanalenja{ a aaaaaaaaaaaaaaaaaaaaaathrowanewaIllegalArgumentExceptionij• a aaaaaaaaaaaaaaaa} a a aaaaaaaaaaaaaaaanativeOperationidatamaoffsetmalenj• a aaaaaaaaaaaa} a aaaaaaaa} Sample 7.13 A1 - Injection 57 • EnsureaallainputathatacanaiandawilljabeamodifiedabyaaamaliciousauserasuchaasaHTTPaheadersmainputafieldsmahiddena fieldsmadropadownalistsmaandaotherawebacomponentsaareaproperlyavalidatedoa • Ensureathatatheaproperalengthachecksaonaallainputaexistoa • Ensureathataallafieldsmacookiesmahttpaheaderspbodiesmaandaformafieldsaareavalidatedoa • Ensureathatatheadataaisawellaformedaandacontainsaonlyaknownagoodacharsaifapossibleoa • Ensureathatatheadataavalidationaoccursaonatheaserverasideoa • Examineawhereadataavalidationaoccursaandaifaaacentralizedamodelaoradecentralizedamodelaisausedoa • Ensureathereaareanoabackdoorsainatheadataavalidationamodeloa • “GoldenaRule–aAllaexternalainputmanoamatterawhataitaismawillabeaexaminedaandavalidatedo” Resources: http–ppmsdnomicrosoftocompennusplibrarypvstudiopsystemouri A1 - Injection58 A2 59 8.1 Overview WebaapplicationsaandaWebaservicesabothauseaauthenticationaasatheaprimaryameansaofaaccessacontrolafromalogn insaviaauseraidaandapasswordsoaThisacontrolaisaessentialatoatheapreventionaofaconfidentialafilesmadatamaorawebapagesa fromabeingaaccessabyahackersaorausersawhoadoanotahaveatheanecessaryaaccessacontrolalevelo 8.2 Description AuthenticationaisaimportantmaasaitaisatheagatewayatoatheafunctionalityayouaareawishingatoaprotectoaOnceaaausera isaauthenticatedatheirarequestsawillabeaauthorizedatoaperformasomealevelaofainteractionawithayouraapplicationa thatanonnauthenticatedausersawillabeabarredafromoaYouacannotacontrolahowausersamanageatheiraauthenticationa informationaoratokensmabutayouacanaensureathereaisanowawayatoaperformaapplicationafunctionsawithoutapropera authenticationaoccurringo ThereaareamanyaformsaofaauthenticationawithapasswordsabeingatheamostacommonoaOtheraformsaincludeaclienta certificatesmabiometricsmaoneatimeapasswordsaoveraSMSaoraspecialadevicesmaoraauthenticationaframeworksasuchaasa OpenaAuthorizationaiOAUTHjaoraSingleaSignaOnaiSSOjo Typicallyaauthenticationaisadoneaoncemawhenatheauseralogsaintoaaawebsitemaandasuccessfulaauthenticationaresultsa inaaawebasessionabeingasetupaforatheauseraiseeaSessionaManagementjoaFurtheraiandastrongerjaauthenticationa canabeasubsequentlyarequestedaifatheauseraattemptsatoaperformaaahighariskafunctionmaforaexampleaaabankausera couldabeaaskedatoaconfirmaanawadigitanumberathatawasasentatoatheiraregisteredaphoneanumberabeforeaallowinga moneyatoabeatransferredo AuthenticationaisajustaasaimportantawithinaaacompaniesafirewallaasaoutsideaitoaAttackersashouldanotabeaableatoa runafreeaonaaacompaniesainternalaapplicationsasimplyabecauseatheyafoundaaawayainathroughaaafirewalloaAlsoa separationaofaprivilegeaioradutiesjameansasomeoneaworkingainaaccountsashouldanotabeaableatoamodifyacodeaina aarepositorymaoraapplicationamanagersashouldanotabeaableatoaeditatheapayrollaspreadsheetso 8.3 What to Review Whenareviewingacodeamodulesawhichaperformaauthenticationafunctionsmasomeacommonaissuesatoalookaoutafora include– • EnsureathealoginapageaisaonlyaavailableaoveraTLSoaSomeasitesaleaveathealoginapageahasaHTTPmabutamakeatheaform submissionaURLaHTTPSasoathatatheausersausernameaandapasswordaareaencryptedawhenasentatoatheaserveroaHown everaifathealoginapageaisanotasecuredmaaariskaexistsaforaaamanninnthenmiddleatoamodifyatheaformasubmissionaURLa toaanaHTTPaURLmaandawhenatheauseraentersatheirausernameagapasswordatheyaareasentainatheaclearo • MakeasureayourausernamespusernidsaareacaseainsensitiveoaManyasitesauseaemailaaddressesaforausernamesaand emaila addressesa area alreadya casea insensitiveoa Regardlessma ita woulda bea verya strangea fora usera‘smith’a anda usera ‘Smith’atoabeadifferentausersoaCouldaresultainaseriousaconfusiono • EnsureafailureamessagesaforainvalidausernamesaorapasswordsadoanotaleakainformationoaIfatheaerroramessage indicatesatheausernameawasavalidmabutatheapasswordawasawrongmathenaattackersawillaknowathatausernameaexistsoa Ifatheapasswordawasawrongmadoanotaindicateahowaitawasawrongo • Makeasureathataeveryacharacteratheauseratypesainaisaactuallyaincludedainatheapasswordo BROKEN AUTHENTICATION AND SESSION MANAGEMENTA2 A2 - Broken Authentication and Session Management60 A2 - Broken Authentication and Session Management • DoanotalogainvalidapasswordsoaManyatimesaanaenmailaaddressaisausedaasatheausernamemaandathoseausersawilla haveaaafewapasswordsamemorizedabutamayaforgetawhichaoneatheyausedaonayourawebasiteoaTheafirstatimeatheya mayauseaaapasswordathatainainvalidaforayourasitemabutavalidaforamanyaotherasitesathatathisauseraiidentifiedabyathea usernamejoaIfayoualogathatausernameaandapasswordacombinationmaandathatalogaleaksaoutmathisalowalevelacompron miseaonayourasiteacouldanegativelyaaffectamanyaotherasiteso • Longerapasswordsaprovideaaagreateracombinationaofacharactersaandaconsequentlyamakeaitamoreadifficultafor anaattackeratoaguessoaMinimumalengthaofatheapasswordsashouldabeaenforcedabyatheaapplicationoaPasswordsa shorterathanarqacharactersaareaconsideredatoabeaweakoaPassphrasesashouldabeaencouragedoaForamoreaonapassn wordalengthsaseeatheaOWASPaAuthenticationaCheataSheeto • ToapreventabruteaforceaattacksmaimplementatemporaryaaccountalockoutsaoraratealimitaloginaresponsesoaIfaaauser failsatoaprovideatheacorrectausernameaandapasswordavatimesmathenalockatheaaccountaforaXaminutesmaoraimplementa logicawherealoginaresponsesatakeaanaextraarqasecondsoaBeacarefulathoughmathisacouldaleakatheafactathatatheausern nameaisavalidatoaattackersacontinuallyatryingarandomausernamesmasoaasaanaextraameasuremaconsideraimplementn ingatheasamealogicaforainvalidausernameso • Forainternalasystemsmaconsideraforcingatheausersatoachangeapasswordsaafteraaasetaperiodaofatimemaandastoreaaa referenceaieogoahashjaofathealastavaoramoreapasswordsatoaensureatheauseraisanotasimplyarenusingatheiraoldapassn wordo • Passwordacomplexityashouldabeaenforcedabyamakingausersachooseapasswordastringsathataincludeavariousatypeaofa charactersaieogoauppernaandalowerncasealettersmanumbersmapunctuationmaetcojoaIdeallymatheaapplicationawouldaindicateatoa theauseraasatheyatypeainatheiranewapasswordahowamuchaofatheacomplexityapolicyatheiranewapasswordameetsoaForamorea onapasswordacomplexityaseeatheaOWASPaAuthenticationaCheataSheeto • Itaisacommonaforaanaapplicationatoahaveaaamechanismathataprovidesaaameansaforaaauseratoagainaaccessatoatheir accountainatheaeventatheyaforgetatheirapasswordoaThisaisaanaexampleaofawebasiteafunctionalityathisaisainvokedabyaunaun thenticatedausersaiasatheyahaveanotaprovidedatheirapasswordjoaEnsureainterfacesalikeathisaareaprotectedafromamisusemaifa askingaforapasswordareminderaresultsainaanaenmailaoraSMSabeingasentatoathearegisteredausermadoanotaallowatheapassworda resetafeatureatoabeausedatoaspamatheauserabyaattackersaconstantlyaenteringatheausernameaintoathisaformoaPleaseaseea ForgotaPasswordaCheataSheetaforadetailsaonathisafeatureo • ItaisacriticalaforaanaapplicationatoastoreaaapasswordausingathearightacryptographicatechniqueoaPleaseaseea PasswordaStorageaCheataSheetaforadetailsaonathisafeatureo WhenareviewingaMVCaoNETaisaisaimportantatoamakeasureatheaapplicationatransmitsaandareceivedaoveraaasecurealinkoaItaisa recommendedatoahaveaallawebapagesanotajustaloginapagesauseaSSLoa Weaneedatoaprotectasessionacookiesmawhichaareausefulaasausersacredentialso InatheaglobaloasaxafileaweacanareviewatheaRegisterGlobalFiltersamethodo publicastaticavoidaRegisterGlobalFiltersiGlobalFilterCollectionafiltersja{ “afltersoAddinewaRequireHttpsAttributeijj•aa“a } Sample 8.1 61A2 - Broken Authentication and Session Management TheaattributeaRequireHttpsAttributeijacanabeausedatoamakeasureatheaapplicationarunsaoveraSSLpTLS ItaisarecommendedathatathisabeaenabledaforaSSLpTLSasiteso • Forahighariskafunctionsmaeogoabankingatransactionsmauseraprofileaupdatesmaetcomautilizeamultinfactoraauthenticationa iMFAjoaThisaalsoamitigatesaagainstaCSRFaandasessionahijackingaattacksoaMFAaisausingamoreathanaoneaauthenticationa factoratoalogonaoraprocessaaatransaction– •aSomethingayouaknowaiaccountadetailsaorapasswordsj •aSomethingayouahaveaitokensaoramobileaphonesj •aSomethingayouaareaibiometricsj • IfatheaclientamachineaisainaaacontrolledaenvironmentautilizeaSSLaClientaAuthenticationmaalsoaknownaasatwonway SSLaauthenticationmawhichaconsistsaofabothabrowseraandaserverasendingatheirarespectiveaSSLacertificatesaduringatheaTLSa handshakeaprocessoaThisaprovidesastrongeraauthenticationaasatheaserveraadministratoracanacreateaandaissueaclientacern tificatesmaallowingatheaserveratoaonlyatrustaloginarequestsafromamachinesathatahaveathisaclientaSSLacertificateainstalledoa Secureatransmissionaofatheaclientacertificateaisaimportanto References • https–ppwwwoowaspoorgpindexophppAuthentication_Cheat_Sheet • http–ppcsrconistogovppublicationspnistpubspyqqnrtspnistnspyqqnrtsopdf • http–ppwwwocodeprojectocompArticlesptswvxupAnnIntroductionntonMutualnSSLnAuthentication • https–ppcweomitreoorgpdatapdefinitionspsyxohtmlaImproperaAuthentication • OWASP ASVS requirements areas for Authentication (V2) 8.4 Forgot Password Overview Ifayourawebasiteaneedsatoahaveauseraauthenticationathenamostalikelyaitawillarequireauseranameaandapasswordatoa authenticateauseraaccessesoaHoweveraasacomputerasystemahaveaincreasedainacomplexitymasoahasaauthenticatinga usersahasaalsoaincreasedoaAsaaaresultatheacodearevieweraneedsatoabeaawareaofatheabenefitsaandadrawbacksaofausera authenticationareferredatoaasa“DirectaAuthentication”apatternainathisasectionoaThisasectionaisagoingatoaemphasisea designapatternsaforawhenausersaforgetauseraidaandaorapasswordaandawhatatheacodearevieweraneedsatoaconsidera whenareviewingahowauseraidaandapasswordsacanabearetrievedawhenaforgottenabyatheauseraandahowatoadoathisa inaaasecureamannero General considerations Notifyauserabyaiphoneasmsmaemailjasuchathatatheauserahasatoaclickaaalinkainatheaemailathatatakesathematoayourasitea andaaskatheauseratoaenteraaanewapasswordo AskauseratoaenteraloginacredentialsatheyaalreadyahaveaiFacebookmaTwittermaGooglemaMicrosoftaLivemaOpenIDaetcjatoa validateauserabeforeaallowingauseratoachangeapasswordo Sendanotificationatoauseratoaconfrmaregistrationaoraforgotapasswordausageo SendanotificationsathataaccountainformationahasabeenachangedaforaregisteredaemailoaSetaappropriateatimeaouta valueoaIoeoaIfauseradoesanotarespondatoaemailawithinauyahoursathenauserawillabeafrozenaoutaofasystemauntilausera renaffirmsapasswordachangeo • Theaidentityaandasharedasecretppasswordamustabeatransferredausingaencryptionatoaprovideadataaconfidentin alityoa 62 • Aasharedasecretacananeverabeastoredainaclearatextaformatmaevenaifaonlyaforaaashortatimeainaaamessageaqueueo • Aasharedasecretamustaalwaysabeastoredainahashedaoraencryptedaformatainaaadatabaseo • Theaorganizationastoringatheaencryptedasharedasecretadoesanotaneedatheaabilityatoaviewaoradecryptausersa passwordsoaUserapasswordamustaneverabeasentabackatoaaausero • IfatheaclientamustacacheatheausernameaandapasswordaforapresentationaforasubsequentacallsatoaaaWebaservice thenaaasecureacacheamechanismaneedsatoabeainaplaceatoaprotectauseranameaandapasswordo • Whenareportingaanainvalidaentryabackatoaaausermatheausernameaandaorapasswordashouldanotabeaidentifiedaasaben ingainvalidoaUserafeedabackperroramessageamustaconsiderabothauseranameaandapasswordaasaoneaitema“useracredential”oa Ioeoa“Theausernameaorapasswordayouaenteredaisaincorrecto” 8.5 CAPTCHA Overview CAPTCHAaianaacronymafora“CompletelyaAutomatedaPublicaTuringatestatoatellaComputersaandaHumansaApart”ojaisa anaaccessacontrolatechniqueo CAPTCHAaisausedatoapreventaautomatedasoftwareafromagainingaaccessatoawebmailaservicesalikeaGmailmaHotmaila andaYahooatoacreateaenmailaspammaautomatedapostingsatoablogsmaforumsaandawikisaforatheapurposeaofapromotiona icommercialmaandaorapoliticaljaoraharassmentaandavandalismaandaautomatedaaccountacreationo CAPTCHA’sahaveaprovedausefulaandatheirauseahasabeenaupheldainacourtoaCircumventingaCAPTCHAahasabeena upheldainaUSaCourtsaasaaaviolationaDigitalaMillenniumaCopyrightaActaantincircumventionasectionarsqriajitjaanda EuropeanaDirectiveasqqrps“pECo General considerations CodeareviewaofaCAPTCHA’sathearevieweraneedsatoapayaattentionatoatheafollowingarulesatoamakeasureatheaCAPTn CHAaisabuiltawithastrongasecurityaprincipalso • Doanotaallowatheauseratoaenteramultipleaguessesaafteraanaincorrectaattempto • TheasoftwareadesigneraandacodeareviewaneedatoaunderstandatheastaticsaofaguessingoaIoeoaOneaCAPTCHAa designashowsafouraitacatsaandaraboatjapicturesmaUseraisarequestedatoapickatheapictureawhereaitaisanotainatheasameacatn egoryaofatheaotherapicturesoaAutomatedasoftwareawillahaveaaasuccessarateaofasvfabyaalwaysapickingatheafirstapictureoa SecondadependingaonatheafixedapoolaofaCAPTCHAaimagesaoveratimeaanaattackeracanacreateaaadatabaseaofacorrecta answersathenagainarqqfaaccesso • ConsiderausingaaakeyabeingapassedatoatheaserverathatausesaaaHMACaiHashnbasedamessageaauthentication codejatheaanswero Text base CAPTCHA’s should adhere to the following security design principals... 1. RandomizeatheaCAPTCHAalength–aDon’tauseaaafixedalength•aitagivesatooamuchainformationatoatheaattackero 2. Randomizeatheacharacterasize–aMakeasureatheaattackeracan’tamakeaeducatedaguessesabyausingaseveralafont sizesapaseveralafontso 3. WaveatheaCAPTCHA–aWavingatheaCAPTCHAaincreasesatheadifficultyaforatheaattackero 4. Don’tauseaaacomplexacharset–aUsingaaalargeacharsetadoesanotaimproveasignificantlyatheaCAPTCHAascheme’s A2 - Broken Authentication and Session Management 63 securityaandareallyahurtsahumanaaccuracyo 5. UseaantinrecognitionatechniquesaasaaameansaofastrengtheningaCAPTCHAasecurity–aRotationmascalingaanda rotatingasomeacharactersaandausingavariousafontasizesawillareduceathearecognitionaefficiencyaandaincreaseasecun rityabyamakingacharacterawidthalessapredictableo 6. KeepathealineawithinatheaCAPTCHAs–aLinesamustacrossaonlyasomeaofatheaCAPTCHAalettersmasoathataitaisa impossibleatoatellawhetheraitaisaaalineaoraaacharacterasegmento 7. Usealargealines–aUsingalinesathataareanotaasawideaasatheacharacterasegmentsagivesaanaattackeraaarobusta discriminatoraandamakesathealineaantinsegmentationatechniqueavulnerableatoamanyaattackatechniqueso 8. CAPTCHAadoesacreateaissuesaforawebasitesathatamustabeaADAaiAmericansawithaDisabilitiesaActaofar““qja compliantoaCodearevieweramayaneedatoabeaawareaofawebaaccessibilitiesaandasecurityatoareviewatheaCAPTCHAa implementationawhereawebasiteaisarequiredatoabeaADAacomplaintabyalawo References • UNITEDaSTATESaofaAMERICAavsaKENNETHaLOWSONmaKRISTOFERaKIRSCHmaLOELaSTEVENSONaFederalaIndictmentoa FebruaryastmasqrqoaRetrievedasqrsnqrnqso • http–ppwwwogoogleocomprecaptchapcaptchaa • http–ppwwwoadaogovpanprmsqrqpwebfsqanprm_sqrqohtm • InaccessibilityaofaCAPTCHAanaAlternativesatoaVisualaTuringaTestsaonatheaWebahttp–ppwwwowtoorgpTRpturingtestpa 8.6 Out-of-Band Communication Overview Theaterma‘outnofnband’aisacommonlyausedawhenaanawebaapplicationacommunicatesawithaanaendauseraoveraaa channelaseparateatoatheaHTTParequestpresponsesaconductedathroughatheausers’awebabrowseroaCommonaexamn plesaincludeatextpSMSmaphoneacallsmaenmailaandaregularamailo Description Theamainareasonaanaapplicationawouldawishatoacommunicateawithatheaendauseraviaatheseaseparateachannelsa isaforasecurityoaAausernameaandapasswordacombinationacouldabeasufficientaauthenticationatoaallowaaauseratoa browseaandauseanonnsensitiveapartsaofaaawebsitemahoweveramoreasensitiveaiorariskyjafunctionsacouldarequirea aa strongera forma ofa authenticationoa Aa usernamea anda passworda coulda havea beena stolena througha ana infecteda computermathroughasocialaengineeringmadatabasealeakaoraotheraattacksmameaningatheawebaapplicationacannota putatooamuchainatrustaaawebasessionaprovidingatheavalidausernameaandapasswordacombinationaisaactuallyathea intendedausero Examples of sensitive operations could include: • Changingapassword • Changingaaccountadetailsmasuchaasaenmailaaddressmahomeaaddressmaetc • Transferringafundsainaaabankingaapplication • Submittingmamodifyingaoracancellingaorders Ina thesea casesa manya applicationsa willa communicatea witha youa viaa aa channela othera thana aa browsinga sessionoa Manyalargeaonnlineastoresawillasendayouaconfirmationaenmailsawhenayouachangeaaccountadetailsmaorapurchasea itemsoaThisaprotectsainatheacaseathataanaattackerahasatheausernameaandapasswordmaifatheyabuyasomethingmathea legitimateauserawillagetaanaenmailaandahaveaaachanceatoacancelatheaorderaoraalertatheawebsiteathatatheyadidanota modifyatheaaccounto A2 - Broken Authentication and Session Management64 WhenaoutnofnbandatechniquesaareaperformedaforaauthenticationaitaisatermedatwonfactoraauthenticationoaTherea areathreeawaysatoaauthenticate– 1. SomethingayouaknowaieogoapasswordmapassphrasemamemorizedaPINj 2. SomethingayouahaveaieogoamobileaphonemacashacardmaRSAatokenj 3. Somethingayouaareaieogoairisascanmafingerprintj Ifaaabankingawebsiteaallowsausersatoainitiateatransactionsaonlinemaitacouldauseatwonfactoraauthenticationabyatakn ingarjatheapasswordausedatoalogainaandasjasendingaanaPINanumberaoveraSMSatoatheausersaregisteredaphonemaanda thena requiringa thea usera entera thea PINa beforea completinga thea transactionoaThisa requiresa somethinga thea usera knowsaipasswordjaandahasaiphoneatoareceiveatheaPINjo Aa‘chipnandnpin’abankingacardawillauseatwonfactoraauthenticationmabyarequiringausersatoahaveatheacardawithathema isomethingatheyahavejaandaalsoaenteraaaPINawhenaperformingaaapurchaseaisomethingatheyaknowjoaAa‘chipnandn pin’acardaisanotauseawithinatheaPINanumbermalikewiseaknowingatheaPINanumberaisauselessaifayouadoanotahaveathea cardo What to Review Whenareviewingacodeamodulesawhichaperformaoutnofnbandafunctionsmasomeacommonaissuesatoalookaoutafora include– 1. RecognizeatheariskaofatheasystemabeingaabusedoaAttackersawouldalikeatoafloodasomeoneawithaSMSamessages fromayourasitemaoraenmailsatoarandomapeopleoaEnsure– 2. Whenapossiblemaonlyaauthenticatedausersacanaaccessalinksathatacauseaanaoutnofnbandafeatureatoabeainvoked iforgotapasswordabeingaanaexceptionjo 3. Ratealimitatheainterfacemathusausersawithainfectedamachinesmaorahackedaaccountsmacan’tauseaitatoaflooda outnofnbandamessagesatoaaausero 4. Doanotaallowatheafeatureatoaacceptatheadestinationafromatheausermaonlyausearegisteredaphoneanumbersm enmailsmaaddresseso 5. Forahighariskasitesaieogoabankingjatheausersaphoneanumberacanabearegisteredainapersonaratherathanaviaathe webasiteo 6. Doanotasendaanyapersonalaoraauthenticationainformationainatheaoutnofnbandacommunicationo 7. EnsureaanyaPINsaorapasswordsasendaoveraoutnofnbandachannelsahaveaaashortalifenspanaandaarearandomo 8. AaconsiderationacanabeatoapreventaSMSamessagesabeingasentatoatheadeviceacurrentlyaconductingathea browsingasessionaiioeoauserabrowsingaonatheiraiPhonemawereatheaSMSaisasentatojoaHoweverathisacanabeahardatoaenforceoa IfapossibleagiveausersatheachoiceaofabandatheyawishatoauseoaForabankingasitesaZitmoamalwareaonamobilea devicesaiseeareferencesjacanainterceptatheaSMSamessagesmahoweveraiOSadevicesahaveanotabeenaaffectedabyathisamaln wareayetmasoausersacouldachooseatoahaveaSMSaPINsasentatoatheiraAppleadevicesmaandawhenaonaAndroidatheyacouldausea recordedavoiceamessagesatoareceiveatheaPINo 9. Inaaatypicaladeploymentsaspecializedahardwarepsoftwareaseparateafromatheawebaapplicationawillahandleathe outnofnbandacommunicationmaincludingatheacreationaofatemporaryaPINsaandapossiblyapasswordsoaInathisascenarioatherea isanoaneedatoaexposeatheaPINppasswordatoayourawebaapplicationaiincreasingariskaofaexposurejmainsteadatheawebaapplin cationashouldaqueryatheaspecializedahardwarepsoftwareawithatheaPINppasswordasuppliedabyatheaendausermaandareceivea A2 - Broken Authentication and Session Management 65 aapositiveaoranegativearesponseo Manyasectorsaincludingatheabankingasectorahavearegulationsarequiringatheauseaofatwonfactoraauthenticationaforacertaina typesaofatransactionsoaInaotheracasesatwonfactoraauthenticationacanareduceacostsadueatoafraudaandarenassureacustomersa ofatheasecurityaofaaawebsiteo References • https–ppwwwoowaspoorgpindexophppForgot_Password_Cheat_Sheet • http–ppsecurelistocompblogpvirusnwatchpvxywqpnewnzitmonfornandroidnandnblackberryp 8.7 Session Management Overview AawebasessionaisaaasequenceaofanetworkaHTTParequestaandaresponseatransactionsaassociatedatoatheasameauseroaSessiona managementaorastateaisaneededabyawebaapplicationsathatarequireathearetainingaofainformationaorastatusaaboutaeacha useraforatheadurationaofamultiplearequestsoaThereforemasessionsaprovideatheaabilityatoaestablishavariablesa–asuchaasaaccessa rightsaandalocalizationasettingsa–awhichawillaapplyatoaeachaandaeveryainteractionaaauserahasawithatheawebaapplicationa foratheadurationaofatheasessiono Description Codearevieweraneedsatoaunderstandawhatasessionatechniquesatheadevelopersausedmaandahowatoaspotavulnerabilitiesa thatamayacreateapotentialasecurityarisksoaWebaapplicationsacanacreateasessionsatoakeepatrackaofaanonymousausersaaftera theaveryafirstauserarequestoaAnaexampleawouldabeamaintainingatheauseralanguageapreferenceoaAdditionallymawebaapn plicationsawillamakeauseaofasessionsaonceatheauserahasaauthenticatedoaThisaensuresatheaabilityatoaidentifyatheauseraona anyasubsequentarequestsaasawellaasabeingaableatoaapplyasecurityaaccessacontrolsmaauthorizedaaccessatoatheauseraprivatea datamaandatoaincreaseatheausabilityaofatheaapplicationoaThereforemacurrentawebaapplicationsacanaprovideasessionacapabiln itiesabothapreaandapostaauthenticationo TheasessionaIDaoratokenabindsatheauseraauthenticationacredentialsaiinatheaformaofaaauserasessionjatoatheausera HTTPatrafficaandatheaappropriateaaccessacontrolsaenforcedabyatheawebaapplicationoaTheacomplexityaofathesea threea componentsa iauthenticationma sessiona managementma anda accessa controlja ina moderna weba applicationsma plusatheafactathataitsaimplementationaandabindingaresidesaonatheawebadeveloper’sahandsaiasawebadevelopmenta frameworkadoanotaprovideastrictarelationshipsabetweenatheseamodulesjmamakesatheaimplementationaofaaasecurea sessionamanagementamoduleaveryachallengingo TheadisclosuremacapturemapredictionmabruteaforcemaorafixationaofatheasessionaIDawillaleadatoasessionahijackingaiora sidejackingjaattacksmawhereaanaattackeraisaableatoafullyaimpersonateaaavictimauserainatheawebaapplicationoaAttackn ersacanaperformatwoatypesaofasessionahijackingaattacksmatargetedaoragenericoaInaaatargetedaattackmatheaattacker’sa goalaisatoaimpersonateaaaspecificaioraprivilegedjawebaapplicationavictimauseroaForagenericaattacksmatheaattacker’sa goalaisatoaimpersonateaioragetaaccessaasjaanyavalidaoralegitimateauserainatheawebaapplicationo WithatheagoalaofaimplementingasecureasessionaIDsmatheagenerationaofaidentifiersaiIDsaoratokensjamustameetathea followingaproperties– • TheanameausedabyatheasessionaIDashouldanotabeaextremelyadescriptiveanoraofferaunnecessaryadetailsaaboutathe purposeaandameaningaofatheaIDo • ItaisarecommendedatoachangeatheadefaultasessionaIDanameaofatheawebadevelopmentaframeworkatoaaageneric namemasuchaasa“id”o • TheasessionaIDalengthamustabeaataleastarsyabitsairwabytesjaiTheasessionaIDavalueamustaprovideaataleastawuabits ofaentropyjo A2 - Broken Authentication and Session Management66 • TheasessionaIDacontentaioravaluejamustabeameaninglessatoapreventainformationadisclosureaattacksmawhereaana attackeraisaableatoadecodeatheacontentsaofatheaIDaandaextractadetailsaofatheausermatheasessionmaoratheainneraworkn ingsaofatheawebaapplicationo ItaisarecommendedatoacreateacryptographicallyastrongasessionaIDsathroughatheausageaofacryptographicahasha functionsasuchaasaSHAsaisvwabitsjo What to Review RequireacookiesawhenayouraapplicationaincludesaauthenticationoaCodearevieweraneedsatoaunderstandawhatainn formationaisastoredainatheaapplicationacookiesoaRiskamanagementaisaneededatoaaddressaifasensitiveainformationa isastoredainatheacookiearequiringaSSLaforatheacookie .Net ASPX web.config Java web.xml PHP.INI Session Expiration Inareviewingasessionahandlingacodeathearevieweraneedsatoaunderstandawhataexpirationatimeoutsaareaneededa byatheawebaapplicationaoraifadefaultasessionatimeoutaareabeingausedoaInsufficientasessionaexpirationabyatheaweba ”authenticationamode…”Forms”— a”formsaloginUrl…”member_loginoaspx” aaacookieless…”UseCookies” aaarequireSSL…”true” aaapath…”pMyApplication”ap— ”pauthentication— Sample 8.2 ”sessionnconfig— a”cookienconfig— aa”secure—true”psecure— a”pcookienconfig— ”psessionnconfig— Sample 8.3 voidasession_set_cookie_paramsaiaintaelifetimea[mastringaepatha[mastringaedomaina[maboolaesecurea…atruea[maboola ehttponlya…atruea]]]]aj Sample 8.4 A2 - Broken Authentication and Session Management 67 applicationaincreasesatheaexposureaofaotherasessionnbasedaattacksmaasaforatheaattackeratoabeaableatoareuseaaavalida sessionaIDaandahijackatheaassociatedasessionmaitamustastillabeaactiveoa Rememberaforasecureacodingaoneaofaouragoalsaisatoareduceatheaattackasurfaceaofaouraapplicationo .Net ASPX ASPXatheadeveloperacanachangeatheadefaultatimeaoutaforaaasessionoaThisacodeainatheaweboconfigafileasetsathea timeoutasessionatoarvaminutesoaTheadefaultatimeoutaforaanaaspxasessionaisatqaminuteso Java PHP DoesanotahaveaaasessionatimeoutamechanismoaPHPadevelopersawillaneedatoacreateatheiraownacustomasessionatimeouto Session Logout/Ending. Webaapplicationsashouldaprovideamechanismsathataallowasecurityaawareausersatoaactivelyacloseatheirasessionaonceatheya haveafinishedausingatheawebaapplicationo oNetaASPXaSessionoAbandonijamethodadestroysaallatheaobjectsastoredainaaaSessionaobjectaandareleasesatheiraresourcesoa IfayouadoanotacallatheaAbandonamethodaexplicitlymatheaserveradestroysatheseaobjectsawhenatheasessionatimesaoutoaYoua shouldauseaitawhenatheauseralogsaoutoaSessionoClearijaRemovesaallakeysaandavaluesafromatheasessionoaDoesanotachangea sessionaIDoaUseathisacommandaifayouaifayouadon’tawantatheauseratoareloginaandaresetaallatheasessionaspecificadatao Session Attacks Generallyathreeasortsaofasessionaattacksaareapossible– • SessionaHijacking–astealingasomeone’sasessionnidmaandausingaitatoaimpersonateathatausero • SessionaFixation–asettingasomeone’sasessionnidatoaaapredefinedavaluemaandaimpersonatingathemausingathat knownavalue • SessionaElevation–awhenatheaimportanceaofaaasessionaisachangedmabutaitsaIDaisanoto ”systemoweb— aaa”sessionStatea aaaaamode…”InProc” aaaaacookieless…”true” aaaaatimeout…”rv”ap— a”psystemoweb— Sample 8.5 ”sessionnconfig— aaaa”sessionntimeout—r”psessionntimeout— ”psessionnconfig— Sample 8.6 A2 - Broken Authentication and Session Management68 Session Hijacking • MostlyadoneaviaaXSSaattacksmamostlyacanabeapreventedabyaHTTPnOnlyasessionacookiesaiunlessaJavascriptacode requiresaaccessatoathemjo • It’sagenerallyaaagoodaideaaforaJavascriptanotatoaneedaaccessatoasessionacookiesmaasapreventingaallaflavorsaofaXSSa isausuallyatheatoughestapartaofahardeningaaasystemo • SessionnidsashouldabeaplacedainsideacookiesmaandanotainaURLsoaURLainformationaareastoredainabrowser’sahistoryma andaHTTPaReferrersmaandacanabeaaccessedabyaattackerso • AsacookiesacanabeaaccessedabyadefaultafromajavascriptaandapreventingaallaflavorsaofaXSSaisausuallyatheatoughesta partaofahardeningaaasystemmathereaisaanaattributeacalleda“HTTPOnly”mathataforbidsathisaaccessoaTheasessionacookiea shoulda hasa thisa attributea setoa Anywayma asa therea isa noa needa toa accessa aa sessiona cookiea froma thea clientma youa shouldagetasuspiciousaaboutaclientasideacodeathatadependsaonathisaaccesso • Geographicala locationa checkinga cana helpa detecta simplea hijackinga scenariosoa Advanceda hijackersa usea thea sameIPaiorarangejaofatheavictimo • Anaactiveasessionashouldabeawarnedawhenaitaisaaccessedafromaanotheralocationo • Anaactiveausersashouldabeawarnedawhenaspheahasaanaactiveasessionasomewhereaelseaiifatheapolicyaallowsa multipleasessionsaforaaasingleauserjo Session Fixation • Ifatheaapplicationaseesaaanewasessionnidathataisanotapresentainatheapoolmaitashouldabearejectedaandaaanewa sessionnidashouldabeaadvertisedoaThisaisatheasoleamethodatoapreventafixationo • Allatheasessionnidsashouldabeageneratedabyatheaapplicationmaandathenastoredainaaapoolatoabeacheckedalateraforoa Applicationaisatheasoleaauthorityaforasessionagenerationo Session Elevation • Wheneveraaasessionaisaelevatedailoginmalogoutmacertainaauthorizationjmaitashouldabearolledo • Manya applicationsa createa sessionsa fora visitorsa asa wella ianda nota justa authenticateda usersjoa Theya shoulda definitelyarollatheasessionaonaelevationmabecauseatheauseraexpectsatheaapplicationatoatreatathemasecurelyaaftera theyalogino • Whenaaadownnelevationaoccursmatheasessionainformationaregardingatheahigheralevelashouldabeaflushedo • SessionsashouldabearolledawhenatheyaareaelevatedoaRollingameansathatatheasessionnidashouldabeachangedmaanda theasessionainformationashouldabeatransferredatoatheanewaido Server-Side Defenses for Session Management .NET ASPX GeneratinganewasessionaId’sahelpsapreventmasessionarollingmafixationmahijackingo A2 - Broken Authentication and Session Management 69 Java PHP.INI References • https–ppwwwwoowaspoorgpindexophppSecureFlag publicaclassaGuidSessionIDManagera–aSessionIDManagera{ aaapublicaoverrideastringaCreateSessionIDiHttpContextacontextj{ returnaGuidoNewGuidijoToStringij• aaa} aaapublicaoverrideaboolaValidateistringaidja{ try{ aaaaaaaGuidatestGuida…anewaGuidiidj• aaaaaaaifaiida……atestGuidoToStringijj aaaaaaaaareturnatrue• aaaaa}catchiExceptionaeja{athrowaea} aaaaareturnafalse• aaa} a} Sample 8.7 requestogetSessionifalsejoinvalidateij• ppandathenacreateaaanewasessionawith getSessionitruejaigetSessionijj Sample 8.8 sessionouse_trans_sida…aq sessionouse_only_cookies Sample 8.9 A2 - Broken Authentication and Session Management70 A3 71 9.1 Overview What is Cross-Site Scripting (XSS)? CrossnsiteascriptingaiXSSjaisaaatypeaofacodingavulnerabilityoaItaisausuallyafoundainawebaapplicationsoaXSSaenablesaattackn ersatoainjectaamaliciousaintoawebapagesaviewedabyaotherausersoaXSSamayaallowaattackersatoabypassaaccessacontrolsasucha asatheasamenoriginapolicyamayoaThisaisaoneaofatheamostacommonavulnerabilitiesafoundaaccordinglyawithaOWASPaTopa rqoaSymantecainaitsaannualathreatareportafoundathataXSSawasatheanumberatwoavulnerabilityafoundaonawebaserversoaThea severitypriskaofathisavulnerabilityamayarangeafromaaanuisanceatoaaamajorasecurityariskmadependingaonatheasensitivityaofa theadataahandledabyatheavulnerableasiteaandatheanatureaofaanyasecurityamitigationaimplementedabyatheasite’saorganin zationoaa Description ThereaareathreeatypesaofaXSSmaReflectedaXSSaiNonnPersistentjmaStoredaXSSiPersistentjmaandaDOMabasedaXSSoaaEachaofa theseatypesahasadifferentameansatoadeliveraaamaliciousapayloadatoatheaserveroaTheaimportantatakeawayaisatheaconsen quencesaareatheasameo What to Review Crossnsiteascriptingavulnerabilitiesaareadifficultatoaidentifyaandaremoveafromaaawebaapplication CrossnsiteascriptingaflawsacanabeadifficultatoaidentifyaandaremoveafromaaawebaapplicationoaTheabestapracticeatoasearcha foraflawsaisatoaperformaanaintenseacodeareviewaandasearchaforaallaplacesawhereauserainputathroughaaaHTTParequesta couldapossiblyamakeaitsawayaintoatheaHTMLaoutputoa Code reviewer needs to closely review. 1. ThatauntrustedadataaisanotatransmittedainatheasameaHTTParesponsesaasaHTMLaoraJavaScripto 2. WhenadataaisatransmittedafromatheaserveratoatheaclientmauntrustedadataamustabeaproperlyaencodedaandatheaHTTPa responseoaDoanotaassumeadataafromatheaserveraisasafeoaBestapracticeaisatoaalwaysacheckadatao 3. WhenaintroducedaintoatheaDOMmauntrustedadataaMUSTabeaintroducedausingaoneaofatheafollowingaAPIs– a. NodeotextContent b. documentocreateTextNode c. ElementosetAttributeaisecondaparameteraonlyj CodeareviewerashouldaalsoabeaawareaofatheaHTMLatagsaisuchaasa”imgasrc…—ma”iframe…—ma”bgsoundasrc…—aetcojacana beausedatoatransmitamaliciousaJavaScripto WebaapplicationavulnerabilityaautomatedatoolspscannersacanahelpatoafindaCrossnSiteascriptingaflawsoaHoweveratheya cannotafindaallaXSSavulnerabilitiesmahenceamanualacodeareviewsaareaimportantoaManualacodeareviewsawontacatcha allaeitherabutaaadefenseainadepthaapproachaisaalwaysatheabestaapproachabasedaonayouralevelaofarisko OWASPaZedaAttackaProxyiZAPjaisaanaeasyatoauseaintegratedapenetrationntestingatoolaforafindingavulnerabilitiesainaweba applicationsoaZAPaprovidesaautomatedascannersaasawellaasaaasetaofatoolsathataallowayouatoafindasecurityavulnerabilitiesa manuallyoaItaactsaasaaawebaproxyathatayouapointayourabrowseratoasoaitacanaseeatheatrafficagoingatoaaasiteaandaallowsayoua toaspidermascanmafuzzmaandaattackatheaapplicationoaThereaareaotherascannersaavailableabothaopenasourceaandacommercialoaa CROSS-SITE SCRIPTING (XSS)A3 A3 - Cross-Site Scripting (XSS)72 Use Microsft’s Anti-XSS library AnotheralevelaofahelpatoapreventaXSSaisatoauseaanaAntinXSSalibraryo UnfortunatelymaHtmlEncodeaoravalidationafeatureaisanotaenoughatoadealawithaXSSmaespeciallyaifatheauserainputa needsatoabeaaddedatoaJavaScriptacodematagaattributesmaXMLaoraURLoaInathisacaseaaagoodaoptionaisatheaAntinXSSa libraya .NET ASPX 1. OnaASPXaoNetapagesacodeareviewashouldacheckatoamakeasureawebaconfigafileadoesanotaturnaoffapagea validationoa”pagesavalidateRequest…”false”ap— 2. oNetaframeworkauoqadoesanotaallowapageavalidationatoabeaturnedaoffoaHenceaifatheaprogrammerawantsatoaturnaofa pageavalidationatheadeveloperawillaneedatoaregressabackatoasoqavalidationamodeoa”httpRuntimearequestValidationn Mode…”soq”ap— 3. Codearevieweraneedsatoamakeasureapageavalidationaisaneveraturnedaoffaonaanywhereaandaifaitaisaunderstanda whyaandathearisksaitaopensatheaorganizationatooa”f@aPageaLanguage…”Cd”aValidationRequest…”false” .NET MVC WhenaMVCawebaappsaareaexposedatoamaliciousaXSSacodematheyawillathrowaanaerroralikeatheafollowingaone– To avoid this vulnerability, make sure the following code is included: <%server.HtmlEncode(stringValue)%> TheaHTMLEncodeamethodaappliesaHTMLaencodingatoaaaspecifiedastringoaThisaisausefulaasaaaquickamethodaofa encodingaformadataaandaotheraclientarequestadataabeforeausingaitainayouraWebaapplicationoaEncodingadataaconn vertsapotentiallyaunsafeacharactersatoatheiraHTMLnencodedaequivalentoiMSDNmsqrtja JavaScript and JavaScript Frameworks Botha Javascripta anda Javascripta frameworksa area nowa widelya usea ina weba applicationsa todayoaThisa hindersa thea codeareviewerainaknowingawhataframeworksadoaaagoodajobaonapreventingaXSSaflawsaandawhichaonesadon’toaa CodeareviewerashouldacheckatoaseeawhatatoaseeaifaanyaCVEaexistsaforatheaframeworkabeingausedaandaalsoachecka thatatheajavascriptaframeworkaisathealatestastableaversiono Figure 6: ExampleaoNetaXSSaFrameworkaError 73 OWASP References • OWASPaXSSaPreventionaCheataSheet • OWASPaXSSaFilteraEvasionaCheataSheet • OWASPaDOMabasedaXSSaPreventionaCheataSheet • TestingaGuide–arstatachaptersaonaDataaValidationaTesting • OWASPaZedaAttackaProxyaProject External References • https://www4.symantec.com/mktginfo/whitepaper/ISTR/21347932_GA-internet-security-threat-re- port-volume-20-2015-social_v2.pdf • https://cwe.mitre.org/data/definitions/79.html • http://webblaze.cs.berkeley.edu/papers/scriptgard.pdf • http://html5sec.org • https://cve.mitre.org 9.2 HTML Attribute Encoding HTMLaattributesamayacontainauntrustedadataoaItaisaimportantatoadetermineaifaanyaotatheaHTMLaattributesaonaaa givenapageacontainsadataafromaoutsideatheatrustaboundaryoa SomeaHTMLaattributesaareaconsideredasaferathanaothersasuchaasaalignmaalinkmaaltmabgcolormabordermacellpaddingma cellspacingmaclassmacolormacolsmacolspanmacoordsmadirmafacemaheightmahspacemaismapmalangmamarginheightmamarginwidthma multiplemanohrefmanoresizemanoshademanowrapmarefmarelmarevmarowsmarowspanmascrollingmashapemaspanmasummarymatabinn dexmatitlemausemapmavalignmavaluemavlinkmavspacemawidtho WhenareviewingacodeaforaXSSaweaneedatoalookaforaHTMLaattributesasuchaasatheafollowingareviewingacodeafora XSSaweaneedatoalookaforaHTMLaattributesasuchaasatheafollowing– <input type=”text” name=”fname” value=”UNTRUSTED DATA”> Attacksamayatakeatheafollowingaformat– “><script>/* bad stuff */</script> What is Attribute encoding? HTMLaattributeaencodingareplacesaaasubsetaofacharactersathataareaimportantatoapreventaaastringaofacharactersa fromabreakingatheaattributeaofaanaHTMLaelemento a Thisaisabecauseatheanatureaofaattributesmatheadataatheyacontainmaandahowatheyaareaparsedaandainterpretedabya aabrowseraoraHTMLaparseraisadifferentathanahowaanaHTMLadocumentaandaitsaelementsaarearead•aOWASPaXSSa PreventionaCheataSheetoaExceptaforaalphanumericacharactersmaescapeaallacharactersawithaASCIIavaluesalessathana svwawithatheagdxHH•aformataioraaanamedaentityaifaavailablejatoapreventaswitchingaoutaofatheaattributeoaThearean sonathisaruleaisasoabroadaisathatadevelopersafrequentlyaleaveaattributesaunquotedoaProperlyaquotedaattributesa canaonlyabeaescapedawithatheacorrespondingaquoteoaUnquotedaattributesacanabeabrokenaoutaofawithamanya charactersmaincludinga[space] fakalamanap •a”a…a—a^aanda|oa AttributeaencodingamayabeaperformedainaaanumberaofawaysoaTwoaresourcesaare– 1. HttpUtilityoHtmlAttributeEncodeaa 74 http–ppmsdnomicrosoftocompennusplibrarypwdekqzbfoaspxa 2. OWASPaJavaaEncoderaProjecta https–ppwwwoowaspoorgpindexophppOWASP_Java_Encoder_Projecta HTML Entity HTMLaelementsawhichacontainauseracontrolledadataaoradataafromauntrustedasourcedashouldabeareviewedafora contextualaoutputaencodingoaInatheacaseaofaHTMLaentitiesaweaneedatoahelpaensureaHTMLaEntityaencodingaisa performed–a ExampleaHTMLaEntityacontainingauntrustedadata–a HTMLaEntityaEncodingaisarequireda Ita isa recommendeda toa reviewa wherepifa untrusteda dataa isa placeda withina entitya objectsoa Searchinga thea sourcea codeafroatheafollowingaencodersamayahelpaestablishaifaHTMLaentityaencodingaisabeingadoneainatheaapplicationa andainaaaconsistentamannero OWASP Java Encoder Project https–ppwwwoowaspoorgpindexophppOWASP_Java_Encoder_Projecta OWASP ESAPI http–ppcodeogoogleocompppowaspnesapinjavapsourcepbrowseptrunkpsrcpmainpjavaporgpowasppesapipcodecsp HTMLEntityCodecojava JavaScript Parameters Untrusteda datama ifa beinga placeda insidea aa JavaScripta functionpcodea requiresa validationoa Invalidateda dataa maya breakaoutaofatheadataacontextaandawindaupabeingaexecutedainatheacodeacontextaonaaausersabrowseroa Examplesaofaexploitationapointsaisinksjathataareaworthareviewingafor–a HTMLaBodyaContextaaaaaaaa”span—UNTRUSTEDaDATA”pspan—aaaaORaaaa”body—oooUNTRUSTEDaDATAa”pbody—aaaaORaaaa ”div—UNTRUSTEDaDATAa”pdiv—aaaa aaagann—agamp•aaaa”ann—aglt•aaaa—ann—aggt•aaaa“ann—agquot•aaaa‘ann—agdxsx•a aaa”inputatype…”text”aname…”data”avalue…””f…EncodeoforHtmlAttributeidataValuej f—”ap— aaaStringasafea…aESAPIoencoderijoencodeForHTMLiarequestogetParameteria“input”ajaj•a A3 - Cross-Site Scripting (XSS) 75 aaaa”script—varacurrentValue…’UNTRUSTEDaDATA’•”pscript—aaaaaa”script—someFunctioni‘UNTRUSTEDaDATA’j•”p script—aaaaaaattack–a‘j•pkaBADaSTUFFakpaaaaaa Potential solutions: OWASPaHTMLaSanitizeraProjecT OWASPaJSONaSanitizeraProjecta ESAPIaJavaScriptaescapingacanabeacallainathisamanner–a PleaseanoteathereaareasomeaJavaScriptafunctionsathatacananeverasafelyauseauntrustedadataaasainputanaevenaifa javascriptaescapedba ForaexampleainoteathisaisaanaexampleaofahowaNOTatoauseaJavaScriptj–a eval() jquery Safeausageaiuseatextmanotahtmljaaaaa a”script—aaaaawindowosetIntervali‘oooEVENaIFaYOUaESCAPEaUNTRUSTEDaDATAaYOUaAREaXSSEDaHEREooo’j•aaaaa”pscript—a aaaaStringasafea…aESAPIoencoderijoencodeForJavaScriptiarequestogetParameteria“input”ajaj•a ei“duserInput”j avaratxtFielda…a“Ar”•aaaaavaratxtUserInputa…a“’test@googleoie’•alertirj•”•aaaaaevaliaaa“documentoforms[q]o”alatxtFieldala “ovaluea…”alaArj•a Sample 9.1 aaaavaratxtAlertMsga…a“HelloaWorld–a“•aaaaavaratxtUserInputa…a“test”script—alertirj”\\pscript—”•aaaaaei“dmessage”johtmliaaa txtAlertMsgal””alatxtUserInputala“”j•a Sample 9.2 A3 - Cross-Site Scripting (XSS)76 .text Nested Contexts Bestatoaavoidasuchanestedacontexts–aanaelementaattributeacallingaaaJavaScriptafunctionaetcoatheseacontextsacana reallyamessawithayouramindoa WhenatheabrowseraprocessesathisaitawillafirstaHTMLadecodeatheacontentsaofatheaonclickaattributeoaItawillapassathea resultsatoatheaJavaScriptaInterpreteroaSoaweahaveasacontextxahereoooHTMLaandaJavascriptaisabrowseraparsersjoaWea needatoaapplya“layered”aencodingainatheaRIGHTaorder– 1. JavaScriptaencodea 2. HTMLaAttributeaEncodeasoaita“unwinds”aproperlyaandaisanotavulnerableoa a ”divaonclick…”showErrori‘”f…requestogetParameteri“errorxyz”jf—’j”a—Anaerroraoccurreda”pdiv—aaaaaaaaaa HereaweahaveaaaHTMLaattributeionClickjaandawithinaaanestedaJavascriptafunctionacallaishowErrorjoa ”divaonclick…”showErroraaaai‘”f…aEncoderoencodeForHtmliEncoderoencodeForJavaScriptiarequesto getParameteri“error”jf—’jjj”aaaaa—Anaerroraoccurredaoooo”pdiv—aa iaaa“test”script—alertirj”\\pscript—”j•”nnatreatauserainputaasatexta A3 - Cross-Site Scripting (XSS) 77 A4 78 A4 - Insecure Direct Object Reference INSECURE DIRECT OBJECT REFERENCEA4 10.1 Overview InsecureaDirectaObjectaReferenceaisaaacommonplaceavulnerabilityawithawebaapplicationsathataprovideavaryinga levelsaofaaccessaoraexposesaanainternalaobjectatoatheauseroaExamplesaofawhatacanabeaexposedaareadatabasearen cordsmaURLsmafilesmaaccountanumbersmaoraallowingausersatoabypassawebasecurityacontrolsabyamanipulatingaURLso Theauseramayabeaauthorizedatoaaccessatheawebaapplicationmabutanotaaaspecificaobjectmasuchaasaaadatabasearecordma specificafileaoraevenaanaURLoaPotentialathreatsacanacomeafromaanaauthorizedauseraofatheawebaapplicationawhoaaln tersaaaparameteravalueathatadirectlyapointsatoaanaobjectathatatheauseraisn’taauthorizedatoaaccessoaIfatheaapplicationa doesn’taverifyatheauseraforathataspecificaobjectmaitacanaresultainaanainsecureadirectaobjectareferenceaflawo 10.2 Description Theasourceaofatheaproblemaofathisariskaisabasedaonatheamanipulationaoraupdatingaofatheadataageneratedaprevin ouslyaataserverasideoa What to Review SQL Injection Anaexampleaofaanaattackamakingauseaofathisavulnerabilityacouldabeaaawebaapplicationawhereatheauserahasaalreadya beenavalidatedoaNowatheauserawantsatoaviewaopenahisaopenainvoicesaviaaanotherawebapageoaTheaapplicationa passesatheaaccountanumberausingatheaURLastringoaTheaanaapplicationausesaunverifiedadataainaaaSQLacallathataisa accessingaaccountainformation–a Thea attackera simplya modifiesa thea‘acct’a parametera ina theira browsera toa senda whatevera accounta numbera theya wantoaIfatheaapplicationadoesanotaperformauseraverificationmatheaattackeracanaaccessaanyauser’saaccountmainsteada ofaonlyatheaintendedacustomer’saaccountoa HTTP POST requests AaCyberaSecurityaAnalystaiIbrahimaRaafatjafoundaanainsecureadirectaobjectareferenceavulnerabilityawithaYahooba SuggestionsabyausingaLiveaHTTPaHeadersacheckatheacontentainatheaPOSTarequestaheacouldasee–a Whereaparametera‘fid’aisatheatopicaidaanda‘cid’aisathearespectiveacommentaIDoaWhileatestingmaheafoundachanginga prop…addressbookgfid…twxuutgcrumb…QuoPSLBfBeogcid…rstwvuxy“qgcmd…adelete_commenta Stringaquerya…a“SELECTakaFROMaacctsaWHEREaaccounta…aﬄ”•aPreparedStatementapstmta…aconnectiono prepareStatementiqueryamaoooaj• pstmtosetStringiarmarequestogetParameteri“acct”jj• ResultSetaresultsa…apstmtoexecuteQueryij• Sample 10.1 79A4 - Insecure Direct Object Reference theafidaandacidaparameteravaluesaallowahimatoadeleteaotheracommentsafromatheaforummathataareaactuallyaposteda byaanotherausero NextmaheausedatheasameamethodatoatestapostadeletionamechanismaandafoundaaasimilaravulnerabilityainathatoaAa normalaHTTPaHeaderaPOSTarequestaofadeletingaaapostais–a HeafoundathatmaappendingatheafidaitopicaidjavariableatoatheaURLaallowsahimatoadeleteathearespectiveapostaofaothera users– AfterafutheraanalysisaheafoundaanaattackeracouldamodifyatheaparametersainaHTTPaPOSTarequestsatoadeletearova millionarecordsaenteredabyaYahooausersa Indirect Reference Maps Moreovermatheaattackersamayafindaoutatheainternalanamingaconventionsaandainferatheamethodanamesaforaopern ationafunctionalityoaForainstancemaifaanaapplicationahasaURLsaforaretrievingadetailainformationaofaanaobjectalike– AttackersawillatryatoauseatheafollowingaURLSatoaperformamodificationaonatheaobject–a Alsoaifawebaapplicationaisareturningaanaobjectalistingapartaofatheadirectoryapathaoraobjectanameaanaattackeracana modifyatheseo Data Binding Technique AnotherapopularafeatureaseenainamostaofatheadesignaframeworksaiJSPpStructsmaSpringjaisadataabindingmawhereaHTTPa GETarequestaparametersaoraHTTPaPOSTavariablesagetadirectlyaboundatoatheavariablesaofatheacorrespondingabusinessp commandaobjectoaBindingahereameansathatatheainstanceavariablesaofasuchaclassesagetaautomaticallyainitializeawitha thearequestaparameteravaluesabasedaonatheiranamesoaConsideraaasampleadesignagivenabelow•aobserveathatatheabusin nessalogicaclassabindsatheabusinessaobjectaclassabindsatheabusinessaobjectawithathearequestaparameterso Theaflawainasuchadesignaisathatatheabusinessaobjectsamayahaveavariablesathataareanotadependentaonathearequestapan rametersoaSuchavariablesacouldabeakeyavariablesalikeapricemamaxalimitmarolemaetcoahavingastaticavaluesaoradependentaona someaserverasideaprocessingalogicoaAathreatainasuchascenariosaisathataanaattackeramayasupplyaadditionalaparametersa inarequestaandatryatoabindavaluesaforaunexposedavariableaofabusinessaobjectaclasso POSTacmd…delete_itemgcrumb…SbWqLzoLDPqa POSTacmd…delete_itemgcrumb…SbWqLzoLDPqgfid…xxxxxxxxa xyzocompCustomerspViewpsruyrqsuuvaaoraxyzocompCustomerspViewDetailsoaspxﬄID…sruyrqsuuva xyzocompCustomerspUpdatepsruyrqsuuvaoraxyzocompCustomerspModifyoaspxﬄID…sruyrqsuuva OraxyzocompCustomerspadmina 80 Secure Design Recommendation– • Anaimportantapointatoabeanotedahereaisathatatheabusinesspformpcommandaobjectsamustahaveaonlyathosea instanceavariablesathataareadependentaonatheauserainputso • Ifaadditionalavariablesaareapresentathoseamustanotabeavitalaonesalikearelatedatoatheabusinessaruleaforatheafeatureo • Inaanyacaseatheaapplicationamustaacceptaonlyadesiredainputsafromatheauseraandathearestamustabearejectedaoralefta unboundoaAndainitializationaofaunexposedaofavariablesmaifaanyamustatakeaplaceaafteratheabindingalogico Review Criteria ReviewatheaapplicationadesignaandacheckaifaitaincorporatesaaadataabindingalogicoaInacaseaitadoesmacheckaifabusinessa objectspbeansathatagetaboundatoathearequestaparametersahaveaunexposedavariablesathataareameantatoahaveastatica valuesoaIfasuchavariablesaareainitializedabeforeatheabindingalogicathisaattackawillaworkasuccessfullyo What the Code Reviewer needs to do: Codearevieweraneedsatoa“mapaoutaallalocationsainatheacodeabeingareviewedawhereauserainputaisausedatoareferencea objectsadirectly”oaThesealocationsaincludeawhereauserainputaisausedatoaaccessaaadatabasearowmaaafilemaapplicationapagn esmaetcoaThearevieweraneedsatoaunderstandaifamodificationaofatheainputausedatoareferenceaobjectsacanaresultainathea retrievalaofaobjectsatheauseraisanotaauthorizedatoaviewoa Ifauntrustedainputaisausedatoaaccessaobjectsaonatheaserverasidemathenaproperaauthorizationachecksamustabeaemployeda toaensureadataacannotabealeakedoaaProperainputavalidationawillaalsoabearequiredatoaensureatheauntrustedainputaisa properlyaunderstoodaandausedabyatheaserverasideacodeoaaNoteathatathisaauthorizationaandainputavalidationamustabea performedaonatheaserveraside•aclientasideacodeacanabeabypassedabyatheaattackeroa Binding issues in MVC .NET A.K.A Over-Posting A.K.A Mass assignments InaMVCaframeworkmamassaassignmentsaareaaamechanismathataallowsausatoaupdateaouramodelsawithadataacomingainaaa requestainaHTTPaformafieldsoaAsatheadataathataneedsatoabeaupdatedacomesainaaacollectionaofaformafieldsmaaauseracoulda sendaaarequestaandamodifyaotherafieldsainatheamodelathatamayanotabeainatheaformaandatheadeveloperadidn’taintenda toabeaupdatedo a DependingaonatheamodelsayouacreatemathereamightabeasensitiveadataathatayouawouldanotalikeatoabeamodifiedoaThea vulnerabilityaisaexploitedawhenaaamaliciousauseramodifysaaamodel’safieldsmawhichaareanotaexposedatoatheauseraviaathea viewmaandatheamaliciousauseratoachangeahiddenamodelavaluesaaddsaadditionalamodelaparameterso aaaapublicaclassauser aaaa{ aaaaaaaapublicaintaIDa{aget•aset•a}aa”naexposedaviaaviewaa aaaaaaaapublicastringaNamea{aget•aset•a}a”naexposedaviaaview aaaaaaaapublicaboolaisAdmin{aget•aset•a}a”nhiddenafromaview aaaa} Sample 10.2 A4 - Insecure Direct Object Reference 81 Corresponding view (HTML) TheacorrespondingaHTMLaforathisamodelacontainasafields–aIDaandaName IfaanaattackeraaddsatheaisAdminaparameteratoatheaformaandasubmitsatheyacanachangeatheamodelaobjectaaboveo SoaaamaliciousaattackeramayachangeaisAdmin…true Recommendations: 1 - Useaaamodelawhichadoesanotahaveavaluesatheauserashouldanotaedito 2 - Useatheabindamethodaandawhitelistaattributesawhichacanabeaupdatedo 3 - UseatheacontrolleroUpdateModelamethodatoaexcludeacertainaattributeaupdateso References • OWASPaToparqnsqqxaonaInsecureaDiraObjectaReferences • ESAPIaAccessaReferenceaMapaAPI • ESAPIaAccessaControlaAPIaiSeeaisAuthorizedForDataijmaisAuthorizedForFileijmaisAuthorizedForFunctionijaj • https–ppwwwoowaspoorgpindexophppCategory–OWASP_Application_Security_Verification_Standard_Project • https–ppcweomitreoorgpdatapdefinitionspwt“ohtml • https–ppcweomitreoorgpdatapdefinitionspssohtml ID–a”f…aHtmloTextBoxi“ID”jaf—a”br— aaaaName–aa”f…aHtmloTextBoxi“Name”jaaf—a”br— aaaaaaaaaaaaaaaaaaaa”nnanoaisAdminahereb Sample 10.3 A4 - Insecure Direct Object Reference82 A5 83 SECURITY MISCONFIGURATIONA5 ManyamodernaapplicationsaareadevelopedaonaframeworksoaTheseaframeworksaprovideatheadeveloperalessaworka toadomaasatheaframeworkadoesamuchaofathea“housekeeping”oaTheacodeadevelopedawillaextendatheafunctionalitya ofatheaframeworkoaItaisahereathatatheaknowledgeaofaaagivenaframeworkmaandalanguageainawhichatheaapplicationa isaimplementedmaisaofaparamountaimportanceoaMuchaofatheatransactionalafunctionalityamayanotabeavisibleainathea developer’sacodeaandahandledaina“parent”aclassesoaTheareviewerashouldabeaawareaandaknowledgeableaofathea underlyingaframeworko a Webaapplicationsadoanotaexecuteainaisolationmatheyatypicallyaareadeployedawithinaanaapplicationaserveraframen workmarunningawithinaanaoperatingasystemaonaaaphysicalahostmawithinaaanetworko Secureaoperatingasystemaconfigurationaialsoacalledahardeningjaisanotatypicallyawithinatheascopeaofacodeareviewoa ForamoreainformationmaseeatheaCenteraforaInternetaSecurityaoperatingasystemabenchmarkso NetworksatodayaconsistaofamuchamoreathanaroutersaandaswitchesaprovidingatransportaservicesoaFilteringaswitchn esmaVLANsa ivirtuala LANsjma firewallsmaWAFsa iWeba Applicationa Firewalljma anda variousa middlea boxesa ieogoa reversea proxiesmaintrusionadetectionaandapreventionasystemsjaallaprovideacriticalasecurityaservicesawhenaconfiguredatoa doasooaThisaisaaabigatopicmabutaoutsideatheascopeaofathisawebaapplicationacodeareviewaguideoaForaaagoodasummaryma seeatheaSANSaiSystemaAdministrationmaNetworkingmaandaSecurityjaInstituteaCriticalaControlarq–aSecureaConfigun rationsaforaNetworkaDevicesasuchaasaFirewallsmaRoutersmaandaSwitcheso ApplicationaserveraframeworksahaveamanyasecurityarelatedacapabilitiesoaTheseacapabilitiesaareaenabledaandaconn figuredainastaticaconfigurationafilesmacommonlyainaXMLaformatmabutamayaalsoabeaexpressedaasaannotationsawithina theacodeo 11.1 Apache Struts Inastrutsatheastrutsnconfigoxmlaandatheaweboxmlafilesaareatheacoreapointsatoaviewatheatransactionalafunctionalitya ofaanaapplicationoaaTheastrutsnconfigoxmlafileacontainsatheaactionamappingsaforaeachaHTTParequestawhileathea weboxmlafileacontainsatheadeploymentadescriptoro Theastrutsaframeworkahasaaavalidatoraenginemawhichareliesaonaregularaexpressionsatoavalidateatheainputadataoa TheabeautyaofatheavalidatoraisathatanoacodeahasatoabeawrittenaforaeachaformabeanoaiFormabeanaisatheaJavaaobjecta whichareceivedatheadataafromatheaHTTParequestjoaTheavalidatoraisanotaenabledabyadefaultainastrutsoaToaenableathea validatormaaaplugninamustabeadefinedainathea”plugnin—asectionaofastrutsnconfigoxmloaTheapropertyadefinedatellsa theastrutsaframeworkawhereatheacustomavalidationarulesaareadefinedaivalidationoxmljaandaaadefinitionaofathea actualarulesathemselvesaivalidationnrulesoxmljo WithoutaaaproperaunderstandingaofatheastrutsaframeworkmaandabyasimplyaauditingatheaJavaacodemaoneawouldanota seeaanyavalidationabeingaexecutedmaandaoneadoesanotaseeathearelationshipabetweenatheadefinedarulesaandathea Javaafunctionso TheaactionamappingsadefineatheaactionatakenabyatheaapplicationauponareceivingaaarequestoaHeremainasample 11.1maweacanaseeathatawhenatheaURLacontainsa“plogin”atheaLoginActionashallabeacalledoaFromatheaactionamapn pingsaweacanaseeatheatransactionsatheaapplicationaperformsawhenaexternalainputaisareceivedo 84 11.2 Java Enterprise Edition Declarative Configuration SomeasecurityacapabilitiesaareaaccessibleafromawithinaaaJavaaprogramoaProgrammaticasecurityaisadoneawithinathea webaapplicationausingaframeworkaspecificaorastandardaJavaaEnterpriseaEditionaiJEEjaframeworkaAPIsoaJEEahasathea JEEasecurityamodelawhichmausesaaarolenbasedasecurityamodelainawhichmaaccessatoaapplicationaresourcesaisagranteda basedaonatheasecurityaroleoaTheasecurityaroleaisaaalogicalagroupingaofaprincipalsaiauthenticatedaentitiesmausuallyaaa userjmaandaaccessaisadeclaredabyaspecifyingaaasecurityaconstraintaonathearoleo TheaconstraintsaandarolesaareaexpressedaasadeploymentadescriptorsaexpressedaasaXMLaelementsoaDifferentatypesa ofacomponentsauseadifferentaformatsmaoraschemasmaforatheiradeploymentadescriptors– • Webacomponentsamayauseaaawebaapplicationadeploymentadescriptorainatheafileaweboxml • EnterpriseaJavaBeansacomponentsamayauseaanaEJBadeploymentadescriptoranamedaMETAnINFpejbnjaroxml TheadeploymentadescriptoracanadefinearesourcesaieogoaservletsaaccessibleaviaaaaspecificaURLjmawhicharolesaarea authorizedatoaaccessathearesourcemaandahowaaccessaisaconstrainedaieogoaviaaGETabutanotaPOSTjo Thea examplea weba componenta descriptora ina sample 11.2ma iincludeda ina thea“weboxml”a fileja definesa aa Cataloga servletmaaa“manager”arolemaaaSalesInfoaresourceawithinatheaservletaaccessibleaviaaGETaandaPOSTarequestsmaanda specifiesa thata onlya usersa witha“manager”a rolema usinga SSLa anda successfullya usinga HTTPa basica authenticationa shouldabeagrantedaaccesso A5 - Security Misconfiguration ”ﬄxmlaversion…”roq”aencoding…”ISOnyyv“nr”aﬄ— ”bDOCTYPEastrutsnconfigaPUBLIC aaaaaaaaa“nppApacheaSoftwareaFoundationppDTDaStrutsaConfigurationaroqppEN” aaaaaaaaa“http–ppjakartaoapacheoorgpstrutspdtdspstrutsnconfig_r_qodtd”— ”strutsnconfig— ”formnbeans— aaa”formnbeananame…”login”atype…”testostrutsoLoginForm”ap— ”pformnbeans— ”globalnforwards— ”pglobalnforwards— ”actionnmappings— aaa”action aaaaaaapath…”plogin” aaaaaaatype…”testostrutsoLoginAction”a— aaaaaaaaaaa”forwardaname…”valid”apath…”pjsppMainMenuojsp”ap— aaaaaaaaaaa”forwardaname…”invalid”apath…”pjsppLoginViewojsp”ap— aaa”paction— ”pactionnmappings— ”plugninaclassName…”orgoapacheostrutsovalidatoroValidatorPlugIn”— aaaaa”setnpropertyaproperty…”pathnames” aaaaavalue…”ptestpWEBnINFpvalidatornrulesoxmlmapWEBnINFpvalidationoxml”p— ”pplugnin— ”pstrutsnconfig— Sample 11.1 85A5 - Security Misconfiguration ”ﬄxmlaversion…”roq”aencoding…”ISOnyyv“nr”ﬄ— ”webnappaxmlns…”http–ppjavaosunocompxmlpnspjsee” aaxmlns–xsi…”http–ppwwwowtoorgpsqqrpXMLSchemaninstance” aaxsi–schemaLocation…”http–ppjavaosunocompxmlpnspjsee aaahttp–ppjavaosunocompxmlpnspjseepwebnapp_s_voxsd”aversion…ﬄsovﬄ— aaaa”displaynname—AaSecureaApplication”pdisplaynname— aaaa”servlet— aaaaaa”servletnname—catalog”pservletnname— aaaaaa”servletnclass—comomycorpoCatalogServlet”pservletnclass— aaaaaa”initnparam— aaaaaaaa”paramnname—catalog”pparamnname— aaaaaaaa”paramnvalue—Spring”pparamnvalue— aaaaaa”pinitnparam— aaaaaa”bnnaDefineaSecurityaRolesann— aaaaaa”securitynrolenref— aaaaaaaa”rolenname—MGR”prolenname— aaaaaaaa”rolenlink—manager”prolenlink— aaaaaa”psecuritynrolenref— aaaa”pservlet— aaaa”securitynrole— aaaaaa”rolenname—manager”prolenname— aaaa”psecuritynrole— aaaa”servletnmapping— aaaaaa”servletnname—catalog”pservletnname— aaaaaa”urlnpattern—pcatalogpk”purlnpattern— aaaa”pservletnmapping— aaaa”bnnaDefineaAaSecurityaConstraintann— aaaa”securitynconstraint— aaaa”bnnaSpecifyatheaResourcesatoabeaProtectedann— aaaa”webnresourcencollection— aaaaaa”webnresourcenname—SalesInfo”pwebnresourcenname— aaaaaa”urlnpattern—psalesinfopk”purlnpattern— aaaaaa”httpnmethod—GET”phttpnmethod— aaaaaa”httpnmethod—POST”phttpnmethod— aaaaa”pwebnresourcencollection— aaaa”bnnaSpecifyawhichaUsersaCanaAccessaProtectedaResourcesann— aaaa”authnconstraint— aaaaaa”rolenname—manager”prolenname— aaaa”pauthnconstraint— Sample 11.2 86 SecurityarolesacanaalsoabeadeclaredaforaenterpriseaJavaabeansainathea“ejbnjaroxml”afileaasaseenainafigureasample 11.3o Fora beansma howeverma rathera thana specifyinga accessa toa resourcesa withina servletsma accessa toa beana methodsa isa specifiedoaTheaexampleainasample 11.4aillustratesaseveralatypesaofamethodaaccessaconstraintsaforaseveralabeanso aaa”bnnaSpecifyaSecureaTransportausingaSSLaiconfidentialaguaranteejann— aaaa”userndatanconstraint— aaaaaa”transportnguarantee—CONFIDENTIAL”ptransportnguarantee— aaaa”puserndatanconstraint— aaaa”psecuritynconstraint— aaaa”bnnaSpecifyaHTTPaBasicaAuthenticationaMethodann— aaaa”loginnconfig— aaaaaa”authnmethod—BASIC”pauthnmethod— aaaaaa”realmnname—file”prealmnname— aaaa”ploginnconfig— ”pwebnapp— ”ejbnjar— aaaa”assemblyndescriptor— aaaaaaaa”securitynrole— aaaaaaaaaaaa”description—Theasingleaapplicationarole”pdescription— aaaaaaaaaaaa”rolenname—TheApplicationRole”prolenname— aaaaaaaa”psecuritynrole— aaaa”passemblyndescriptor— ”pejbnjar— Sample 11.3 ”ejbnjar— aaaa”assemblyndescriptor— aaaaaaaa”methodnpermission— aaaaaaaaaaaa”description—Theaemployeeaandatempnemployeearolesamayaaccessaany aaaaaaaaaaaaaaaamethodaofatheaEmployeeServiceabeana”pdescription— aaaaaaaaaaaa”rolenname—employee”prolenname— aaaaaaaaaaaa”rolenname—tempnemployee”prolenname— aaaaaaaaaaaa”method— aaaaaaaaaaaaaaaa”ejbnname—EmployeeService”pejbnname— aaaaaaaaaaaaaaaa”methodnname—k”pmethodnname— aaaaaaaaaaaa”pmethod— aaaaaaaa”pmethodnpermission— Sample 11.4 A5 - Security Misconfiguration 87 aaaaaaaa”methodnpermission— aaaaaaaaaaaa”description—TheaemployeearoleamayaaccessatheafindByPrimaryKeym aaaaaaaaaaaaaaaagetEmployeeInfomaandatheaupdateEmployeeInfoiStringjamethodaof aaaaaaaaaaaaaaaatheaAardvarkPayrollabeana”pdescription— aaaaaaaaaaaa”rolenname—employee”prolenname— aaaaaaaaaaaa”method— aaaaaaaaaaaaaaaa”ejbnname—AardvarkPayroll”pejbnname— aaaaaaaaaaaaaaaa”methodnname—findByPrimaryKey”pmethodnname— aaaaaaaaaaaa”pmethod— aaaaaaaaaaaa”method— aaaaaaaaaaaaaaaa”ejbnname—AardvarkPayroll”pejbnname— aaaaaaaaaaaaaaaa”methodnname—getEmployeeInfo”pmethodnname— aaaaaaaaaaaa”pmethod— aaaaaaaaaaaa”method— aaaaaaaaaaaaaaaa”ejbnname—AardvarkPayroll”pejbnname— aaaaaaaaaaaaaaaa”methodnname—updateEmployeeInfo”pmethodnname— aaaaaaaaaaaaaaaa”methodnparams— aaaaaaaaaaaaaaaaaaaa”methodnparam—javaolangoString”pmethodnparam— aaaaaaaaaaaaaaaa”pmethodnparams— aaaaaaaaaaaa”pmethod— aaaaaaaa”pmethodnpermission— aaaaaaaa”methodnpermission— aaaaaaaaaaaa”description—Theaadminaroleamayaaccessaanyamethodaofathe aaaaaaaaaaaaaaaaEmployeeServiceAdminabeana”pdescription— aaaaaaaaaaaa”rolenname—admin”prolenname— aaaaaaaaaaaa”method— aaaaaaaaaaaaaaaa”ejbnname—EmployeeServiceAdmin”pejbnname— aaaaaaaaaaaaaaaa”methodnname—k”pmethodnname— aaaaaaaaaaaa”pmethod— aaaaaaaa”pmethodnpermission— aaaaaaaa”methodnpermission— aaaaaaaaaaaa”description—Anyaauthenticatedauseramayaaccessaanyamethodaofathe aaaaaaaaaaaaaaaaEmployeeServiceHelpabean”pdescription— aaaaaaaaaaaa”uncheckedp— aaaaaaaaaaaa”method— aaaaaaaaaaaaaaaa”ejbnname—EmployeeServiceHelp”pejbnname— aaaaaaaaaaaaaaaa”methodnname—k”pmethodnname— aaaaaaaaaaaa”pmethod— aaaaaaaa”pmethodnpermission— aaaaaaaa”excludenlist— aaaaaaaaaaaa”description—NoafireTheCTOamethodsaofatheaEmployeeFiringabeanamayabe aaaaaaaaaaaaaaaausedainathisadeployment”pdescription— aaaaaaaaaaaa”method— aaaaaaaaaaaaaaaa”ejbnname—EmployeeFiring”pejbnname— aaaaaaaaaaaaaaaa”methodnname—fireTheCTO”pmethodnname— aaaaaaaaaaaa”pmethod— aaaaaaaa”pexcludenlist— A5 - Security Misconfiguration88 IfaXMLadeploymentadescriptorsaareausedatoasecureatheaapplicationmacodeareviewashouldaincludeathea“weboxml”a anda“ejbnjaroxml”afilesatoaensureathataaccessacontrolsaareaproperlyaappliedatoatheacorrectarolesmaandaauthentican tionamethodsaareaasaexpectedo 11.3 JEE Annotations JEEaannotationsaforasecurityaareadefinedainatheaJavaaDocsa[2]oaaTheaavailableaannotationsaare– • @DeclareRoles • @DenyAll - noarolesamayainvokeatheamethodo • @PermitAll - allarolesamayainvokeatheamethodo • @RolesAllowed - rolesapermittedatoainvokeatheamethodo • @RunAs - dynamicallyarunatheamethodaasaaaparticulararoleo Foraexampleatheacodeainasample 11.5aallowsaemployeesaandamanagersatoaaddamoviesatoatheapersistentastorema anyoneatoalistamoviesmabutaonlyamanagersamayadeleteamovieso CodeareviewashouldalookaforasuchaannotationsoaIfapresentmaensureatheyareflectatheacorrectarolesaandapermissionsma andaareaconsistentawithaanyadeclaredaroleapermissionsainathea“ejbnjaroxml”afileo aaaa”passemblyndescriptor— ”pejbnjar— publicaclassaMoviesa{ aaaaprivateaEntityManageraentityManager• aaaa@RolesAllowedi{“Employee”ma“Manager”}j aaaapublicavoidaaddMovieiMovieamoviejathrowsaExceptiona{ aaaaaaaaentityManageropersistimoviej• aaaa} aaaa@RolesAllowedi{“Manager”}j aaaapublicavoidadeleteMovieiMovieamoviejathrowsaExceptiona{ aaaaaaaaentityManageroremoveimoviej• aaaa} aaaa@PermitAll aaaapublicaList”Movie—agetMoviesijathrowsaExceptiona{ aaaaaaaaQueryaquerya…aentityManagerocreateQueryi“SELECTamafromaMovieaasam”j• aaaaaaaareturnaqueryogetResultListij• aaaa} } Sample 11.5 A5 - Security Misconfiguration 89 11.4 Framework Specific Configuration Apache Tomcat Theaserveroxml[3]afileashouldabeareviewedatoaensureasecurityarelatedaparametersaareaconfiguredaasaexpectedoaTheatomn cataserveroxmlafileadefinesamanyasecurityarelatedaparameterso Filtersaareaespeciallyapowerfulmaandaaacodeareviewashouldavalidateatheyaareausedaunlessathereaisaaacompellingareasona notatooa Jetty Jettyaaddsaseveralasecurityaenhancements– • Limitingaformacontent • Obfuscatingapasswords Theamaximumaformacontentasizeaandanumberaofaformakeysacanabeaconfiguredaataserveraandawebaapplicationalevela inathea“jettynweboxml”afileo ”Configureaclass…”orgoeclipseojettyowebappoWebAppContext”— aa… aa”Setaname…”maxFormContentSize”—sqqqqq”pSet— aa”Setaname…”maxFormKeys”—sqq”pSet— ”pConfigure—aaaa ”configureaclass…”orgoeclipseojettyoserveroServer”— aaooo aa”Callaname…”setAttribute”— aaaa”Arg—orgoeclipseojettyoserveroRequestomaxFormContentSize”pArg— aaaa”Arg—rqqqqq”pArg— aaa”pCall— aa”Callaname…”setAttribute”— aaaa”Arg—orgoeclipseojettyoserveroRequestomaxFormKeys”pArg— aaaa”Arg—sqqq”pArg— aaa”pCall— ”pconfigure— Sample 11.6 Parameter Description Server Thisaisatheashutdownaporto Connectors maxPostSizemamaxParameterCountmaservermaSSLEnabledmasecuremacipherso Host Context Filter autoDeploymadeployOnStartupmadeployXML crossContextmaprivilegedmaallowLinking Tomcataprovidesaaanumberaofafiltersawhichamayabeaconfiguredatoaincomingarequests Table 12: ApacheaTomcataSecurityaParameters A5 - Security Misconfiguration90 JettyaalsoasupportsatheauseaofaobfuscatedapasswordsainajettyaXMLafilesawhereaaaplainatextapasswordaisausuallya neededoasample 11.7ashowsaexampleacodeasettingatheapasswordaforaaaJDBCaDatasourceawithaobfuscationaithea obfuscatedapasswordaisageneratedabyaJettyaorgoeclipseojettyoutilosecurityoPasswordautilityjo JBoss AS JBossaApplicationaServermalikeaJettymaallowsapasswordaobfuscationaicalledapasswordamaskingainaJBossjainaitsaXMLa configurationafilesoaAfterausingaJBossapasswordautilityatoacreateapasswordamaskmareplaceaanyaoccurrenceaofaaa maskedapasswordainaXMLaconfigurationafilesawithatheafollowingaannotationo SeeaMaskingaPasswordsainaXMLaConfigurationainatheaJBossaSecurityaGuideo ”Newaid…”DSTest”aclass…”orgoeclipseojettyoplusojndioResource”— ”Arg—”pArg— ”Arg—jdbcpDSTest”pArg— ”Arg— a ”Newaclass…”comojolboxobonecpoBoneCPDataSource”— aa ”Setaname…”driverClass”—comomysqlojdbcoDriver”pSet— aa ”Setaname…”jdbcUrl”—jdbc–mysql–pplocalhost–ttqwpfoo”pSet— aa ”Setaname…”username”—dbuser”pSet— aa ”Setaname…”password”— aa ”Callaclass…”orgoeclipseojettyoutilosecurityoPassword”aname…”deobfuscate”— aaa ”Arg—OBF–rrixrvrrrvsnrrixrshqrrixrshsrrixrvrrrvsnrrix”pArg—a aa ”pCall— aa ”pSet— aa ”Setaname…”minConnectionsPerPartition”—v”pSet— aa ”Setaname…”maxConnectionsPerPartition”—vq”pSet— aa ”Setaname…”acquireIncrement”—v”pSet— aa ”Setaname…”idleConnectionTestPeriod”—tq”pSet— a ”pNew— ”pArg— ”pNew— Sample 11.7 ”annotation—@orgojbossosecurityointegrationopasswordoPassword aaaaaaaaaaaaaaaaaaaaaisecurityDomain…MASK_NAMEmmethodName…setPROPERTY_NAMEj ”pannotation— Sample 11.8 A5 - Security Misconfiguration 91 Oracle WebLogic WebLogicaserverasupportsaadditionaladeploymentadescriptorsainathea“weblogicoxml”afileaasashownainatable 13o MoreainformationaonaWebLogicaadditionaladeploymentadescriptorsamayabeafoundaataweblogicoxmlaDeploymenta Descriptorso ForageneralaguidelinesaonasecuringawebaapplicationsarunningawithinaWebLogicmaseeatheaProgrammingaWebLogn icaSecurityaguideaandatheaNSA’saBEAaWebLogicaPlatformaSecurityaGuideo 11.5 Programmatic Configuration: J2EE TheaJsEEaAPIaforaprogrammaticasecurityaconsistsaofamethodsaofatheaEJBContextainterfaceaandatheaHttpServlen tRequestainterfaceoaTheseamethodsaallowacomponentsatoamakeabusinessnlogicadecisionsabasedaonatheasecuritya roleaofatheacalleraoraremoteauseraithereaareaalsoamethodsatoaauthenticateausersmabutathataisaoutsideatheascopeaofa secureadeploymentaconfigurationjo The J2EE APIs that interact with J2EE security configuration include: •agetRemoteUsermawhichadeterminesatheauseranameawithawhichatheaclientaauthenticated • isUserInRolemawhichadeterminesawhetheraaaremoteauseraisainaaaspecificasecurityaroleo • getUserPrincipalmawhichadeterminesatheaprincipalanameaofatheacurrentauseraandareturnsaaajavaosecurityoa UseaofatheseaprogrammaticaAPIsashouldabeareviewedatoaensureaconsistencyawithatheaconfigurationoaSpecificallyma theasecuritynrolenrefaelementashouldabeadeclaredainatheadeploymentadescriptorawithaaarolennameasubelementa containingathearoleanameatoabeapassedatoatheaisUserInRoleamethodo Theacodeainasample 11.9ademonstratesatheauseaofaprogrammaticasecurityaforatheapurposesaofaprogrammatica loginaandaestablishingaidentitiesaandarolesoaThisaservletadoesatheafollowing– • displaysainformationaaboutatheacurrentausero • promptsatheauseratoalogaino • printsaoutatheainformationaagainatoademonstrateatheaeffectaofathealoginamethodo Parameter Description externally-defined RoleatoaprincipalamappingsaareaexternallyadefinedainaWebLogicaAdminaConsole run-as-principal-name Assignaaaprincipalatoaaaroleawhenarunningaasathatarole run-as-role-assignment security-permission Filter security-permission-spec security-role-assignment Containsathearunnasnprincipalnnameadescriptor Containsasecuritynpermissionnspecadescriptor Tomcataprovidesaaanumberaofafiltersawhichamayabeaconfiguredatoaincomingarequests Specifyaapplicationapermissionsa[6]aaaa Explicitlyaassignaprincipalsatoaaarole Table 13: WeblogicaSecurityaParameters A5 - Security Misconfiguration92 • Iogsatheauseraouto • printsaoutatheainformationaagainatoademonstrateatheaeffectaofathealogoutamethodo packageaenterpriseoprogrammatic_login• importajavaoiook• importajavaonetok• importajavaxoannotationosecurityoDeclareRoles• importajavaxoservletok• importajavaxoservletohttpok• @DeclareRolesi“javaeewuser”j publicaclassaLoginServletaextendsaHttpServleta{ aaaapkka aaaaakaProcessesarequestsaforabothaHTTPaGETaandaPOSTamethodso aaaaaka@paramarequestaservletarequest aaaaaka@paramaresponseaservletaresponse aaaaakp aaaaprotectedavoidaprocessRequestiHttpServletRequestarequestma aaaaaaaaaaaaaaaaaHttpServletResponsearesponsej aaaaaaaaaaaathrowsaServletExceptionmaIOExceptiona{ aaaaaaaaresponseosetContentTypei“textphtml•charset…UTFny”j• aaaaaaaaPrintWriteraouta…aresponseogetWriterij• aaaaaaaatrya{ aaaaaaaaaaaaStringauserNamea…arequestogetParameteri“txtUserName”j• aaaaaaaaaaaaStringapassworda…arequestogetParameteri“txtPassword”j• aaaaaaaaaaaa aaaaaaaaaaaaoutoprintlni“BeforeaLogin”ala“”br—”br—”j• aaaaaaaaaaaaoutoprintlni“IsUserInRoleﬄoo”a aaaaaaaaaaaaaaaaaaaaaaaalarequestoisUserInRolei“javaeewuser”jl””br—”j• aaaaaaaaaaaaoutoprintlni“getRemoteUserﬄoo”alarequestogetRemoteUserijl””br—”j• aaaaaaaaaaaaoutoprintlni“getUserPrincipalﬄoo”a aaaaaaaaaaaaaaaaaaaaaaaalarequestogetUserPrincipalijl””br—”j• aaaaaaaaaaaaoutoprintlni“getAuthTypeﬄoo”alarequestogetAuthTypeijl””br—”br—”j• aaaaaaaaaaaa aaaaaaaaaaaatrya{ aaaaaaaaaaaaaaaarequestologiniuserNamemapasswordj•a aaaaaaaaaaaa}acatchiServletExceptionaexja{ aaaaaaaaaaaaaaaaoutoprintlni“LoginaFailedawithaaaServletExceptionoo”a aaaaaaaaaaaaaaaaaaaalaexogetMessageijj• aaaaaaaaaaaaaaaareturn• aaaaaaaaaaaa} aaaaaaaaaaaaoutoprintlni“AfteraLoginooo”l””br—”br—”j• aaaaaaaaaaaaoutoprintlni“IsUserInRoleﬄoo”a Sample 11.9 A5 - Security Misconfiguration 93 MoreadetailedainformationacanabeafoundainatheaJavaaEEaTutorial–aUsingaProgrammaticaSecurityawithaWebaApplin cationso 11.6 Microsoft IIS ASPoNETapaIISaapplicationsauseaanaoptionalaXMLnbasedaconfigurationafilemanamedaweboconfigmatoamaintainaapn plicationa configurationa settingsoaThisa coversa issuesa sucha asa authenticationma authorizationma errora pagesma HTTPa settingsmadebugasettingsmawebaserviceasettingsmaetcoaWithoutaknowledgeaofatheseafilesmaaatransactionalaanalysisa wouldabeaveryadifficultaandanotaaccurateo InaIISaxathereaisaaaconfigurationasystemawhichaaffectsatheahierarchyalevelaandahowaoneafileacanainheritafroma anotheroaTheafollowingafigureashowsahowathisawillaworkaandathealocationaofaeachafileaiAguilarmasqqwj aaaaaaaaaaaaaaaaaaaaaaaalarequestoisUserInRolei“javaeewuser”jl””br—”j• aaaaaaaaaaaaoutoprintlni“getRemoteUserﬄoo”alarequestogetRemoteUserijl””br—”j• aaaaaaaaaaaaoutoprintlni“getUserPrincipalﬄoo”a aaaaaaaaaaaaaaaaaaaaaaaalarequestogetUserPrincipalijl””br—”j• aaaaaaaaaaaaoutoprintlni“getAuthTypeﬄoo”alarequestogetAuthTypeijl””br—”br—”j• aaaaaaaaaaaa aaaaaaaaaaaarequestologoutij• aaaaaaaaaaaaoutoprintlni“AfteraLogoutooo”l””br—”br—”j• aaaaaaaaaaaaoutoprintlni“IsUserInRoleﬄoo”a aaaaaaaaaaaaaaaaaaaaaaaalarequestoisUserInRolei“javaeewuser”jl””br—”j• aaaaaaaaaaaaoutoprintlni“getRemoteUserﬄoo”alarequestogetRemoteUserijl””br—”j• aaaaaaaaaaaaoutoprintlni“getUserPrincipalﬄoo” aaaaaaaaaaaaaaaaaaaaaaaalarequestogetUserPrincipalijl””br—”j• aaaaaaaaaaaaoutoprintlni“getAuthTypeﬄoo”alarequestogetAuthTypeijl””br—”j• aaaaaaaa}afinallya{ aaaaaaaaaaaaoutocloseij• aaaaaaaa} aaaa} aaaaooo } machine.config (root) web.config ApplicationHost.config windows\\system32\\intsrv web.config c:\\inetpub\\wwwroot http–pplocalhost web.config d:\\MyApp http–pplocalhostpMyApp Figure 7: IISaConfigurationaFiles A5 - Security Misconfiguration94 ItaisapossibleatoaprovideaaafileaweboconfigaatathearootaofatheavirtualadirectoryaforaaawebaapplicationoaIfatheafileaisa absentmatheadefaultaconfigurationasettingsainamachineoconfigawillabeausedoaIfatheafileaisapresentmaanyasettingsaina weboconfigawillaoverrideatheadefaultasettingso Manya ofa thea importanta securitya settingsa area nota seta ina thea codema buta ina thea frameworka configurationa filesoa Knowledgea ofa thea frameworka isa ofa paramounta importancea whena reviewinga frameworknbaseda applicationsoa Someaexamplesaofaframeworkaspecificaparametersainatheaweboconfigafileaareashownainatable 14o 11.7 Framework Specific Configuration: Microsoft IIS SecurityafeaturesacanabeaconfiguredainaIISausingatheaWeboconfigaiapplicationaleveljaoraApplicationHostoconfigaiservera leveljafilemainathea”systemowebServer—”security—asectionoaTheatypesaofafeaturesathatamayabeaconfiguredainclude– • Permittedaauthenticationamethods • Authorizationarules • Requestafiltersaandalimits • UseaofaSSL • SourceaIPaaddressafiltering • Errorahandling Thea Weboconfiga anda ApplicationHostoconfiga filesa shoulda bea includeda ina codea reviewoa Thea ”systemowebn ”authenticationamode…”Forms”— aaa”formsaname…”name” aaaaaaloginUrl…”url”a aaaaaaaprotection…”Encryption” aaaaaaatimeout…”tq”apath…”p”a aaaaaaarequireSSL…”true|” aaaaaaaslidingExpiration…”false”— aaaaaa”credentialsapasswordFormat…”Clear”— aaaaaaaaa”useraname…”username”apassword…”password”p— aaaaaa”pcredentials— aaa”pforms— aaa”passportaredirectUrl…”internal”p— ”pauthentication— Sample 11.10 Parameter Description authentication mode TheadefaultaauthenticationamodeaisaASPoNETaformsnbasedaauthenticationo loginUrl SpecifiesatheaURLawhereathearequestaisaredirectedaforaloginaifanoavalidaauthenticationacookieaisafoundo protection timeout SpecifiesathatatheacookieaisaencryptedausingatDESaoraDESabutaDVaisanotaperformedaonatheacookieoaBewareaofaplaintexta attackso Cookieaexpiryatimeainaminuteso Table 14: ParametersaInaTheaWeboconfigaFile A5 - Security Misconfiguration 95 Server—”security—asectionsashouldabeareviewedatoaensureaallasecurityaconfigurationaisaasaexpectedo ForaguidelinesaonasecuringatheaoverallaconfigurationaofaMicrosoftaIISmaseeatheaIISasupportsabasicmaclientacertificatema digestmaIISaclientacertificatemaandaWindowsaauthenticationamethodsoaTheyaareaconfiguredainathea”systemowebn Server—”security—”authentication—asectiono a Theaexampleain sample 11.11adisablesaanonymousaauthenticationaforaaasiteanamedaMySitemathenaenablesabotha basicaauthenticationaandawindowsaauthenticationaforatheasiteo IISaauthorizationaconfigurationaallowsaspecificationaofausersaaccessatoatheasiteaoraserveraandaisaconfiguredainathea <system.webServer><security><authorization>asectionoa Theaconfigurationainasample 11.12aremovesatheadefaultaIISaauthorizationasettingsmawhichaallowsaallausersaaccessa toaWebasiteaoraapplicationacontentmaandathenaconfiguresaanaauthorizationaruleathataallowsaonlyausersawithaadn ministratoraprivilegesatoaaccessatheacontento IISasupportsafilteringmaincludingaenforcingalimitsmaonaincomingaHTTParequestsoaTable 15ashowsamanyaofatheaIISa securityaparametersathatacanabeaseto ”locationapath…”MySite”— aaa”systemowebServer— aaaaaa”security— aaaaaaaaa”authentication— aaaaaaaaaaaa”anonymousAuthenticationaenabled…”false”ap— aaaaaaaaaaaa”basicAuthenticationaenabled…”true”adefaultLogonDomain…”MySite”ap— aaaaaaaaaaaa”windowsAuthenticationaenabled…”true”ap— aaaaaaaaaa”pauthentication— aaaaaa”psecurity— aaa”psystemowebServer— ”plocation— Sample 11.11 ”configuration— aaa”systemowebServer— aaaaaa”security— aaaaaaaaa”authorization— aaaaaaaaaaaa”removeausers…”k”aroles…””averbs…””ap— aaaaaaaaaaaa”addaaccessType…”Allow”ausers…””aroles…”Administrators”ap— aaaaaaaaa”pauthorization— aaaaaa”psecurity— aaa”psystemowebServer— ”pconfiguration Sample 11.12 A5 - Security Misconfiguration96 Theseaparametersaareaconfiguredainathea<system.webServer><security><requestFiltering>asectionoaTheaexn ampleainasample 11.13– • DeniesaaccessatoatwoaURLasequencesoaTheafirstasequenceapreventsadirectoryatransversalaandatheasecondasen quenceapreventsaaccessatoaalternateadataastreamso • SetsatheamaximumalengthaforaaaURLatoasKBaandatheamaximumalengthaforaaaqueryastringatoarKBo ”configuration— aaa”systemowebServer— aaaaaa”security— aaaaaaaaa”requestFiltering— aaaaaaaaaaaa”denyUrlSequences— aaaaaaaaaaaaaaa”addasequence…”oo”ap— aaaaaaaaaaaaaaa”addasequence…”–”ap— aaaaaaaaaaaa”pdenyUrlSequences— aaaaaaaaaaaa”fileExtensionsaallowUnlisted…”false”ap— aaaaaaaaaaaa”requestLimitsamaxUrl…”squy”amaxQueryString…”rqsu”ap— aaaaaaaaaaaa”verbsaallowUnlisted…”false”ap— aaaaaaaaa”prequestFiltering— aaaaaa”psecurity— aaa”psystemowebServer— ”pconfiguration— Sample 11.13 Parameter Function denyUrlSequences AalistaofaprohibitedaURLapatterns fileExtensions Allowedaoraprohibitedafileaextensions hiddenSegments requestLimits verbs alwaysAllowedUrls alwaysAllowedQueryStrings denyQueryStringSequences filteringRules URLsathatacannotabeabrowsed URLmacontentmaqueryastringmaandaHTTPaheaderalengthalimits Allowedaoraprohibitedaverbs URLsaalwaysapermitted Queryastringsaalwaysaallowed Prohibitedaqueryastrings Customafilteringarules Table 15: IISaSecurityaParameters A5 - Security Misconfiguration 97 • DeniesaaccessatoaunlistedafileanameaextensionsaandaunlistedaHTTPaverbso IISaallowsaspecifyingawhetheraSSLaisasupportedmaisarequiredmawhetheraclientaauthenticationaisasupportedaoraren quiredmaandacipherastrengthoaItaisaconfiguredainathea”systemowebServer—”security—”access—asectionoaaTheaexn ampleainafigure A5.13aspecifiesaSSLaasarequiredaforaallaconnectionsatoatheasiteaMySiteo IISaallowsarestrictionsaonasourceaIPaaddressesaoraDNSanamesoaItaisaconfiguredainathe <system.webServer><se- curity><ipSecurity>asectionaasashownainasample 11.15awhereatheaexampleaconfigurationadeniesaaccessatoathea IPaaddressa192.168.100.1aandatoatheaentire 169.254.0.0anetwork– DetailedainformationaonaIISasecurityaconfigurationacanabeafoundaataIISaSecurityaConfigurationoaSpecificasecuritya featureaconfigurationainformationacanabeafoundaataAuthenticationmaAuthorizationmaSSLmaSourceaIPmaRequestaFiltern ingmaandaCustomaRequestaFiltering[12]o 11.8 Programmatic Configuration: Microsoft IIS MicrosoftaIISasecurityaconfigurationacanaalsoabeaprogrammaticallyasetafromavariousalanguages– • appcmdoexeasetaconfig • Cd • VisualaBasic • JavaScript ForaexamplemadisablingaanonymousaauthenticationaforaaasiteanamedaMySitemathenaenablingabothabasicaauthentin cationaandawindowsaauthenticationaforatheasiteaiasadoneaviaaconfigurationainatheasectionaabovejacanabeaaccomn ”locationapath…”MySite”— aaa”systemowebServer— aaaaaa”security— aaaaaaaaa”accessasslFlags…”ssl”— aaaaaa”psecurity— aaa”psystemowebServer— ”plocation— Sample 11.14 ”locationapath…”DefaultaWebaSite”— aaa”systemowebServer— aaaaaa”security— aaaaaaaaa”ipSecurity— aaaaaaaaaaaa”addaipAddress…”r“sorwyorqqor”ap— aaaaaaaaaaaa”addaipAddress…”rw“osvuoqoq”asubnetMask…”svvosvvoqoq”ap— aaaaaaaaa”pipSecurity— aaaaaa”psecurity— aaa”psystemowebServer— ”plocation— Sample 11.15 A5 - Security Misconfiguration98 plishedafromatheacommandalineausingatheacommandsainafigureasample 11.16o Alternativelyatheasameaauthenticationasetupacanabeacodedaprogrammaticallyaasain sample 11.17o Whenareviewingasourceacodemaspecialaattentionashouldabeapaidatoaconfigurationaupdatesainasecurityasectionso 11.9 Further IIS Configurations Filtering Requests and URL Rewriting appcmdoexeasetaconfiga“MySite”ansection–systemowebServerpsecuritypauthentication aaaaaapanonymousAuthenticationapenabled–”False”apcommit–apphost appcmdoexeasetaconfiga“MySite”ansection–systemowebServerpsecuritypauthentication aaaaapbasicAuthenticationapenabled–”True”apcommit–apphost appcmdoexeasetaconfiga“MySite”ansection–systemowebServerpsecuritypauthentication aaaapwindowsAuthenticationapenabled–”True”apcommit–apphost Sample 11.16 usingaSystem• usingaSystemoText• usingaMicrosoftoWeboAdministration• internalastaticaclassaSamplea{ aaaprivateastaticavoidaMainija{ aaaaaausingiServerManageraserverManagera…anewaServerManagerijja{a aaaaaaaaaConfigurationaconfiga…aserverManageroGetApplicationHostConfigurationij• aaaaaaaaaConfigurationSectionaanonymousAuthenticationSectiona… aaaaaaaaaaaconfigoGetSectioni“systemowebServerpsecuritypauthentication aaaaaaaaaaaaaaaaaaaaaaaaaaaaaapanonymousAuthentication”ma“MySite”j• aaaaaaaaaanonymousAuthenticationSection[“enabled”]a…afalse• aaaaaaaaaConfigurationSectionabasicAuthenticationSectiona… aaaaaaaaaaaconfigoGetSectioni“systemowebServerpsecuritypauthentication aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaapbasicAuthentication”ma“MySite”j• aaaaaaaaabasicAuthenticationSection[“enabled”]a…atrue• aaaaaaaaaConfigurationSectionawindowsAuthenticationSectiona… aaaaaaaaaaaconfigoGetSectioni“systemowebServerpsecuritypauthentication aaaaaaaaaaaaaaaaaaaaaaaaaaaaapwindowsAuthentication”ma“MySite”j• aaaaaaaaawindowsAuthenticationSection[“enabled”]a…atrue• aaaaaaaaaserverManageroCommitChangesij• aaaaaa} aaa} } Sample 11.17 A5 - Security Misconfiguration 99 RequestaFilteringawasaintroducedainaIISxaandaitahasareplacedatheafunctionalityaUrlScanaaddnonaforaIISawoqoaThisa builtninasecurityafeatureaallowsatoafilteraundesiredaURLarequestabutaitaisaalsoapossibleatoaconfigureadifferentakindsa ofafilteringoaToabeginawithmaitaisaimportantatoaunderstandahowatheaIISapipelineaworksawhenaaarequestaisadoneoaThea followingadiagramashowsatheaorderainatheseamodules HTTP RESPONSE BEGIN REQUEST AUTHENTICATE REQUEST AUTHORIZE REQUEST RESOLVE CACHE END REQUEST REQUEST FILTERING (HIGH PRIORITY) URL REWRITE MODULE (MEDIUM PRIORITY) HTTP REQUEST (Yakushev, 2008) Figure 8: IISaRequestaFilteringFiles A5 - Security Misconfiguration100 RequestafilteringacanabeasetupathroughatheaIISainterfaceaoraonatheaweboconfigafileoaExample– iYakushevmasqqyj ”configuration— aaa”systemowebServer— aaaaaa”security— aaaaaaaaa”requestFiltering— aaaaaaaaaaaa”denyUrlSequences— aaaaaaaaaaaaaaa”addasequence…”oo”ap— aaaaaaaaaaaaaaa”addasequence…”–”ap— aaaaaaaaaaaa”pdenyUrlSequences— aaaaaaaaaaaa”fileExtensionsaallowUnlisted…”false”ap— aaaaaaaaaaaa”requestLimitsamaxUrl…”squy”amaxQueryString…”rqsu”ap— aaaaaaaaaaaa”verbsaallowUnlisted…”false”ap— aaaaaaaaa”prequestFiltering— aaaaaa”psecurity— aaa”psystemowebServer— ”pconfiguration— Sample 11.18 usingaSystem• ausingaSystemoText• ausingaMicrosoftoWeboAdministration• ainternalastaticaclassaSample a{ aaaaprivateastaticavoidaMainij aaaa{ aaaaaaausingaiServerManageraserverManagera…anewaServerManagerijj aaaaaaa{ aaaaaaaaaaConfigurationaconfiga…aserverManageroGetWebConfigurationi“DefaultaWebaSite”j• aaaaaaaaaaConfigurationSectionarequestFilteringSectiona…aconfigoGetSectioni“systemowebServerpsecurityaa aaaaaaaaaaprequestFiltering”j• aaaaaaaaaConfigurationElementCollectionadenyUrlSequencesCollectiona…aaa aaaaaaaaarequestFilteringSectionoGetCollectioni“denyUrlSequences”j• aaaaaaaaaConfigurationElementaaddElementa…adenyUrlSequencesCollectionoCreateElementi“add”j• aaaaaaaaaaddElement[“sequence”]a…a@”oo”• aaaaaaaaadenyUrlSequencesCollectionoAddiaddElementj• aaaaaaaaaConfigurationElementaaddElementra…adenyUrlSequencesCollectionoCreateElementi“add”j• aaaaaaaaaaddElementr[“sequence”]a…a@”–”• aaaaaaaaadenyUrlSequencesCollectionoAddiaddElementrj• aaaaaaaaaConfigurationElementaaddElementsa…adenyUrlSequencesCollectionoCreateElementi“add”j• aaaaaaaaaaddElements[“sequence”]a…a@”\\”• aaaaaaaaadenyUrlSequencesCollectionoAddiaddElementsj• Sample 11.19 A5 - Security Misconfiguration 101 Thisacanaalsoabeadoneathroughatheaapplicationacodemaforaexample– iYakushevmasqqyj Filtering Double - Encoded Requests Thisaattackatechniqueaconsistsaofaencodingauserarequestaparametersatwiceainahexadecimalaformatainaorderatoa bypassasecurityacontrolsaoracauseaunexpectedabehaviorafromatheaapplicationoaIt’sapossibleabecauseatheawebn serveraacceptsaandaprocessesaclientarequestsainamanyaencodedaformso Byausingadoubleaencodingait’sapossibleatoabypassasecurityafiltersathataonlyadecodeauserainputaonceoaTheaseconda decodingaprocessaisaexecutedabyatheabackendaplatformaoramodulesathataproperlyahandleaencodedadatamabuta don’tahaveatheacorrespondingasecurityachecksainaplaceo Attackersacanainjectadoubleaencodingainapathnamesaoraqueryastringsatoabypassatheaauthenticationaschemaaanda securityafiltersainauseabyatheawebaapplicationo ThereaareasomeacommonacharacterathataareausedainaWebaapplicationsaattacksoaForaexamplemaPathaTraversalaatn tacksausea“../” (dot-dot-slash)amawhileaXSSaattacksausea“<” and “>”acharactersoaTheseacharactersagiveaaahexadecin malarepresentationathatadiffersafromanormaladatao Foraexamplema“../” (dot-dot-slash)acharactersarepresenta%2E%2E%2fainahexadecimalarepresentationoaWhenathea %asymbolaisaencodedaagainmaitsarepresentationainahexadecimalacodeaisa%25oaThearesultafromatheadoubleaencodn ingaprocessa”../”(dot-dot-slash)awouldabea%252E%252E%252F– • Theahexadecimalaencodingaofa“oop”arepresentsa“fsEfsEfsf”a • Thenaencodingathea“f”arepresentsa“fsv”a • Doubleaencodingaofa“oop”arepresentsa“fsvsEfsvsEfsvsF” IfayouadoanotawantaIISatoaallowadoublednencodedarequestsatoabeaservedmauseatheafollowingaiIISaTeammsqqxj– aaaaaaaaaserverManageroCommitChangesij• aaaaaaa} aaaa} a} ”configuration— aaa”systemowebServer— aaaa”security— aaaaaa”requestFiltering aaaaaaaallowDoubleEscaping…”false”— aaaaaa”prequestFiltering— aaaa”psecurity— aaa”psystemowebServer— a”pconfiguration— Sample 11.20 A5 - Security Misconfiguration102 Filter High Bit Characters ThisaallowsaorarejectsaallarequestsatoaIISathatacontainanonnASCIIacharactersaoaWhenathisaoccursaerroracodeauquorsoa isadisplayedatoatheauseraoaTheaUrlScan (IIS6 add-on)aequivalentaisaAllowHighBitCharacterso Filter Based on File Extensions UsingathisafilterayouacanaallowaIISatoaaarequestabasedaonafileaextensionsmatheaerroracodealoggedaisauquoxoaTheaAl- lowExtensionsaandaDenyExtensionsaoptionsaareatheaUrlScanaequivalentso Filter Based on Request Limits WhenaIISarejectsaaarequestabasedaonarequestalimitsmatheaerroracodealoggedais– • uquortaifatheacontentaisatooalongo • uquoruaifatheaURLaisatooalargeo • uquorvaifatheaqueryastringaisatooalongo Thisacanabeausedatoalimitaaalongaqueryastringaoratooamuchacontentasentatoaanaapplicationawhichayouacannota changeatheasourceacodeatoafixatheaissueo ”configuration— aa”systemowebServer— aaa”security— aaaaa”requestFiltering aaaaaallowHighBitCharacters…”true”— aaaaa”prequestFiltering— aaa”psecurity— aa”psystemowebServer— a”pconfiguration— Sample 11.21 aa”configuration— aaa”systemowebServer— aaaa”security— aaaaa”requestFiltering— aaaaaa”fileExtensionsaallowUnlisted…”true”a— aaaaaa”addafileExtension…”oasp”aallowed…”false”p— aaaaaa”pfileExtensions— aaaaa”prequestFiltering— aaaa”psecurity— aaa”psystemowebServer— aa”pconfiguration— Sample 11.22 A5 - Security Misconfiguration 103 Filter by Verbs WhenaIISarejectaaarequestabasedaonathisafeaturematheaerroracodealoggedaisauquowoaThisacorrespondsatoatheaUseAln lowVerbsmaAllowVerbsmaandaDenyVerbsaoptionsainaUrlScano InacaseayouawantatheaapplicationatoauseaonlyacertainatypeaofaverbmaitaisanecessaryatoafirtasetatheaallowUnlistedatoa ‘false’aandathenasetatheaverbsathatayouawouldalikeatoaallowaiseeaexamplej Filter Based on URL Sequences ThisafeatureadefinesaaalistaofasequencesathataIISacanarejectawhenaitaisapartaofaaarequestoaWhenaIISarejectaaarequesta forathisafeaturematheaerroracodealoggedaisauquovoThisacorrespondsatoatheaDenyUrlSequencesafeatureainaUrlScano ThisaisaaaveryapowerfulafeatureoaThisaavoidsaaagivenacharacterasequenceafromaeverabeingaattendedabyaIIS– aaaa”configuration— aaaa”systemowebServer— aaaaaa”security— aaaaaaa”requestFiltering— aaaaaaaa”requestLimits aaaaaaaaamaxAllowedContentLength…”tqqqqqqq” aaaaaaaaamaxUrl…”swq” aaaaaaaaamaxQueryString…”sv”a aaaaaaaaap— aaaaaaa”prequestFiltering— aaaaaa”psecurity— aaaaa”psystemowebServer— aaa”pconfiguration— Sample 11.23 ”configuration— aaaa”systemowebServer— aaaaa”security— aaaaaa”requestFiltering— aaaaaaa”verbsaallowUnlisted…”false”— aaaaaaaaa”addaverb…”GET”aallowed…”true”ap— aaaaaaa”pverbs— aaaaaa”prequestFiltering— aaaaa”psecurity— aaaa”psystemowebServer— a”pconfiguration— Sample 11.24 aaa”configuration— aaaa”systemowebServer— Sample 11.25 A5 - Security Misconfiguration104 Filter Out Hidden Segments InacaseayouawantaIISatoaserveacontentainabinaryadirectoryabutanotatheabinarymayouacanaapplyathisaconfigurationo Password protection and sensitive information Theaweboconfigafilesamightaincludeasensitiveainformationainatheaconnectionastringsasuchaasadatabaseapasswordsma mailaserverauseranamesaamongaothersoa Sectionsathataarearequiredatoabeaencryptedaare– • ”appSettings—oaThisasectionacontainsacustomaapplicationasettingso • ”connectionStrings—oaThisasectionacontainsaconnectionastringso • ”identity—oaThisasectionacanacontainaimpersonationacredentialso • ”sessionState—oaThisasectionacontainsatheaconnectionastringaforatheaoutnofnprocessasessionastateaprovidero Passwordsaandauseranamesacontainedainaaa”connectionstring—asectionashouldabeaencryptedoaASPoNETaallowsa youatoaencryptathisainformationabyausingatheafunctionalityaaaspnet_regiisaoThisautilityaisafoundainatheainstalleda oNETaframeworkaunderatheafoldera %windows%\\Microsoft.NET\\Framework\\v2.0.50727 Youacanaspecifyatheasectionayouaneedatoaencryptabyausingatheacommand– aspnet_regiis -pef sectiontobeencryoted Encrypting sections in Web.Config file Evenathoughaencryptingasectionsaisapossiblemanotaallasectionsacanabeaencryptedmaspecificallyasectionsathataarea aaaaaa”security— aaaaaaa”requestFiltering— aaaaaaaaa”denyUrlSequences— aaaaaaaaaaa”addasequence…”oo”p— aaaaaaaaa”pdenyUrlSequences— aaaaaaa”prequestFiltering— aaaaaa”psecurity— aaaaa”psystemowebServer— aaa”pconfiguration— ”configuration— aaa”systemowebServer— aaaaaa”security— aaaaaaaa”requestFiltering— aaaaaaaaaa”hiddenSegments— aaaaaaaaaaaa”addasegment…”BIN”p— aaaaaaaaaa”phiddenSegments— aaaaaaaa”prequestFiltering— aaaaaa”psecurity— aaaaa”psystemowebServer— aaa”pconfiguration— Sample 11.26 A5 - Security Misconfiguration 105 readabeforeauseracodeaisarunoaTheafollowingasectionsacannotabeaencrypted– • ”processModel— • ”runtime— • ”mscorlib— • ”startup— • ”systemoruntimeoremoting— • ”configProtectedData— • ”satelliteassemblies— • ”cryptographySettings— • ”cryptoNameMapping— • ”cryptoClasses— Machine-Level RSA key container or User-Level Key Containers EncryptingaaasingleafileausingamachinenlevelaRSAakeyahasaitsadisadvantagesawhenathisafileaisamovedatoaothera serversoaInathisacasemausernlevelaRSAakeyacontaineraisastronglyaadvisedoaTheaRSAProtectedConfigurationProvidera supportsamachinenlevelaandausernlevelakeyacontainersaforakeyastorageo RSAamachineakeyacontainersaareastoredainatheafollowingafolder– \\Documents and Settings\\All Users\\Application Data\\Microsoft\\Crypto\\RSA\\MachineKeys User Key Container Whenatheaapplicationathataneedsatoabeaprotectedaisainaaasharedahostingaenvironmentaandaprotectionaofasensin tiveadataacannotabeaaccessibleatoaotheraapplicationsmatheauserakeyacontaineraisastronglyarecommendedoa Inathisacaseaeachaapplicationashouldahaveaaaseparateaidentityo RSAausernlevelakeyacontainersaareastoredainatheafollowingafolder– a \\Documents and Settings\\{UserName}\\Application Data\\Microsoft\\Crypto\\RSA IIS configurations DependingaonatheaversionaofaIISathatamustabeaconfiguredmaitaisaimportantatoareviseasomeaofaitsasettingsawhicha canacompriseasecurityainatheaservero Trust level TheatrustalevelaisaaasetaofaCodeaAccessaSecurityapermissionsagrantedatoaanaapplicationawithinaaahostingaenvironn mentoaTheseaareadefinedausingapolicyafilesoaDependingaonatheatrustalevelathatamustabeaconfiguredmaitaisapossiblea toagrantaFULLmaHIGHmaMEDIUMmaLOWaoraMINIMALaleveloaTheaASPoNETahostadoesanotaapplyaanyaadditionalapolicya toaapplicationsathataarearunningaatatheafullntrustalevelo Example– ”systemoweb— aaa”securityPolicy— aaaaa”trustLevelaname…”Full”apolicyFile…”internal”p— aaa”psecurityPolicy— a”psystemoweb— Sample 11.27 A5 - Security Misconfiguration106 Lock Trust Levels InatheaoNETaframeworkaweboconfigafileaisapossibleatoalockaapplicationsafromachangingatheiratrustalevel Thisafileaisafoundaat– C:\\Windows\\Microsoft.NET\\Framework\\{version}\\CONFIG TheafollowingaexampleashowsahowatoalockasadifferentaapplicationaconfigurationatrustalevelsaiMSDNmasqrtj References • YakushevaRuslanamasqqya“IISaxoqaRequestaFilteringaandaURLaRewritinga“aavailableaatahttp://www.iis.net/learn/ extensions/url-rewrite-module/iis-request-filtering-and-url-rewritingaiLastaaccessedaonaruaJulymasqrtj • OWASPmasqq“a“DoubleaEncoding”aavailableaatahttps–ppwwwoowaspoorgpindexophppDouble_EncodingaiLastaaacn cessedaonaruaJulymasqrtj • IISaTeammasqqxa“UseaRequestaFilteringa“aaavailableaatahttp://www.iis.net/learn/manage/configuring-security/ use-request-filteringaaiLastaaccessedaonaruaJulymasqrtj • AguilaraCarlosamsqqwa“TheanewaConfigurationaSystemainaIISax”aavailableaatahttp://blogs.msdn.com/b/carlosag/ archive/2006/04/25/iis7configurationsystem.aspxaiLastaaccessedaonaruaJulymasqrtj • MSDNmasqrtaoaHowato–aLockaASPoNETaConfigurationaSettingsaavailableaatahttp://msdn.microsoft.com/en-us/ library/ms178693.aspxaiLastaaccessedaonaruaJulymasqrtj 11.10 Strongly Named Assemblies DuringatheabuildaprocessaeitheraQAaoraDevelopersaareagoingatoapublishatheacodeaintoaexecutableaformatsoaUsun allyathisaconsistsaofaanaexeaoraandaoneaoraseveralaDLL’soaDuringatheabuildppublishaprocessaaadecisionaneedsatoabea madeatoasignaoranotasignatheacodeoa Signingayouracodeaisacalledacreatinga“stronganames”abyaMicrosoftoaIfayouacreateaaaprojectausingaVisualaStudioaanda useaMicrosoftsa“Runacodeaanalysis”amostalikelyayourawillaencounteraaaMicrosoftadesignaerroraifatheacodeaisanota stronganamed•a“WarningaaaaaraCAssrqa–aMicrosoftoDesigna–aSigna‘xxxoexe’awithaaastronganameakeyo” ”configuration— aaa”locationapath…”applicationr”aallowOverride…”false”— aaaaa”systemoweb— aaaaaaa”trustalevel…”High”ap— aaaaa”psystemoweb— aaa”plocation— aaa”locationapath…”applications”aallowOverride…”false”— aaaaa”systemoweb— aaaaaaa”trustalevel…”Medium”ap— aaaaa”psystemoweb— aaa”plocation— a”pconfiguration— Sample 11.28 A5 - Security Misconfiguration 107 Codeareviewaneedsatoabeaawareaifastronganamingaisabeingausedmabenefitsaandawhatathreatavectorsastronganaminga helpsapreventaoraunderstandatheareasonsaforanotausingastronganamingo Aastronganameaisaaamethodatoasignaanaassembly’saidentityausingaitsatextanamemaversionanumbermacultureainforman tionmaaapublicakeyaandaaadigitalasignatureoaiSolismasqrsj • Stronganamingaguaranteesaaauniqueanameaforathataassemblyo • StronganamesaprotectatheaversionalineageaofaanaassemblyoaAastronganameacanaensureathatanoaoneacanaapron duceaaasubsequentaversionaofayouraassemblyoaUsersacanabeasureathataaaversionaofatheaassemblyatheyaarealoadinga comesafromatheasameapublisherathatacreatedatheaversionatheaapplicationawasabuiltawitho TheaaboveatwoapointsaareaveryaimportantaifayouaareagoingatoauseaGlobalaAssemblyaCacheaiGACjo • StronganamesaprovideaaastrongaintegrityacheckaandapreventaspoofingoaPassingatheaoNETaFrameworkasecuritya checksaguaranteesathatatheacontentsaofatheaassemblyahaveanotabeenachangedasinceaitawasabuiltoa Notemahowevermathatastronganamesainaandaofathemselvesadoanotaimplyaaalevelaofatrustalikeathataprovidedmafora examplemabyaaadigitalasignatureaandasupportingacertificateoaIfayouauseatheaGACaassembliesarememberatheaassemn bliesaareanotaverifiedaeachatimeatheyaloadasinceatheaGACabyadesignaisaaalockedndownmaadminnonlyastoreo Whatastronganamesacan’tapreventaisaaamaliciousauserafromastrippingatheastronganameasignatureaentirelymamodin fyingatheaassemblymaorarensigningaitawithatheamaliciousauser’sakeyoa Theacodearevieweraneedsatoaunderstandahowatheastronganameaprivateakeyawillabeakeptasecureaandamanagedoa Thisaisacrucibleaifayouadecideastronganameasignaturesaareaaagoodafitaforayouraorganizationoa IfaprincipleaofaleastaprivilegeaisausedasoacodeaisanotaoralessasusceptibleatoabeaaccessabyatheahackeraandatheaGACaisa notabeingausedastronganamesaprovidesalessabenefitsaoranoabenefitsaataallo How to use Strong Naming Signingatools Inaorderatoacreateaaastronganameaassemblyathereaareaaasetaofatoolsaandastepsathatayouaneedatoafollow UsingaVisualaStudio InaorderatoauseaVisualaStudioatoacreateaaaStronglyaNamedaAssemblymaitaisanecessaryatoahaveaaacopyaofatheapublicp privateakeyapairafileoaItaisaalsoapossibleatoacreateathisapairakeyainaVisualaStudio InaVisualaStudioasqqvmatheaCdmaVisualaBasicmaandaVisualaJdaintegratedadevelopmentaenvironmentsaiIDEsjaallowayoua toagenerateakeyapairsaandasignaassembliesawithoutatheaneedatoacreateaaakeyapairausingaSnoexeaiStrongaNamea Tooljoa TheseaIDEsahaveaaaSigningatabainatheaProjectaDesigneroaoaTheauseaofatheaAssemblyKeyFileAttributeatoaidentifyakeya fileapairsahasabeenamadeaobsoleteainaVisualaStudioasqqvo Theafollowingafigureaillustratesatheaprocessadoneabyatheacompiler A5 - Security Misconfiguration108 Using Strong Name tool TheaSignaToolaisaaacommandnlineatoolathatadigitallyasignsafilesmaverifiesasignaturesainafilesmaoratimeastampsafileso TheaSignaToolaisanotasupportedaonaMicrosoftaWindowsaNTmaWindowsaMemaWindowsa“ymaoraWindowsa“vo Inacaseayouaaren’tausingathea“VisualaStudioaCommandaPrompt”aiStarta——aMicrosoftaVisualaStudioasqrqa——aVisuala StudioaToolsa——aVisualaStudioaCommandaPromptaisqrqjjayouacanalocateasn.exeaatafProgramFiles%\\Microsoft SDKs\\Windows\\v7.0A\\bin\\sn.exe TheafollowingacommandacreatesaaanewmarandomakeyapairaandastoresaitainakeyPairosnko sn -k keyPair.snk TheafollowingacommandastoresatheakeyainakeyPairosnkainatheacontaineraMyContainerainatheastronganameaCSPo sn -i keyPair.snk MyContainer a TheafollowingacommandaextractsatheapublicakeyafromakeyPairosnkaandastoresaitainapublicKeyosnko sn -p keyPair.snk publicKey.snk TheafollowingacommandadisplaysatheapublicakeyaandatheatokenaforatheapublicakeyacontainedainapublicKeyosnko sn -tp publicKey.snk TheafollowingacommandaverifiesatheaassemblyaMyAsmodllo sn -v MyAsm.dll TheafollowingacommandadeletesaMyContainerafromatheadefaultaCSPo sn -d MyContainer Using the Assembly Linker(AI.exe) C#VB COMPILER • ASSEMBLY BINARY • SIMPLE NAME • VERSION NUMBER • CULTURE INFO PUBLIC KEY PRIVATE KEY ASSEMBLY Manifest VersionaNumber CultureaInfo PublicaKey SimpleaName Metadata CIL Digital Signature Figure 9: CdaStrongaNaming A5 - Security Misconfiguration 109 ThisatoolaisaautomaticallyainstalledawithaVisualaStudioaandawithatheaWindowsaSDKoaToarunatheatoolmawearecomn mendathatayouauseatheaVisualaStudioaCommandaPromptaoratheaWindowsaSDKaCommandaPromptaiCMDaShelljoa TheseautilitiesaenableayouatoarunatheatoolaeasilymawithoutanavigatingatoatheainstallationafolderoaForamoreainforman tionmaseeaVisualaStudioaandaWindowsaSDKaCommandaPromptso If you have Visual Studio installed on your computer: OnatheataskbarmaclickaStartmaclickaAllaProgramsmaclickaVisualaStudiomaclickaVisualaStudioaToolsmaandathenaclickaVisuala StudioaCommandaPrompto norn If you have the Windows SDK installed on your computer: OnatheataskbarmaclickaStartmaclickaAllaProgramsmaclickatheafolderaforatheaWindowsaSDKmaandathenaclickaCommanda PromptaioraCMDaShelljo Atatheacommandapromptmatypeatheafollowing– al sources options Remarks AllaVisualaStudioacompilersaproduceaassembliesoaHoweveraifayouahaveaoneaoramoreamodulesaimetadataawithouta aamanifestjayouacanauseaAloexeatoacreateaanaassemblyawithatheamanifestainaaaseparateafileo Toainstallaassembliesainatheacachemaremoveaassembliesafromatheacachemaoralistatheacontentsaofatheacachemauseathea GlobalaAssemblyaCacheaToolaiGacutil.exejo Theafollowingacommandacreatesaanaexecutableafileatsaoexeawithaanaassemblyafromatheatsonetmoduleamoduleoa TheaentryapointaisatheaMainamethodainaMyClasso aal t2.netmodule /target:exe /out:t2a.exe /main:MyClass.Main Use Assembly attributes YouacanainsertatheastronganameainformationainatheacodeadirectlyoaForathismadependingaonawhereatheakeyafileaisa locatedayouacanauseaAssemblyKeyFileAttributeaoraAssemblyKeyNameAttribute Use Compiler options :use /keyfile or /delaysign Safeguardingatheakeyapairafromadevelopersaisanecessaryatoamaintainaandaguaranteeatheaintegrityaofatheaassemn bliesoaTheapublicakeyashouldabeaaccessiblemabutaaccessatoatheaprivateakeyaisarestrictedatoaonlyaaafewaindividualsoa Whenadevelopingaassembliesawithastronganamesmaeachaassemblyathatareferencesatheastrongnnamedatargetaasn semblyacontainsatheatokenaofatheapublicakeyausedatoagiveatheatargetaassemblyaaastronganameoaThisarequiresathata theapublicakeyabeaavailableaduringatheadevelopmentaprocesso YouacanauseadelayedaorapartialasigningaatabuildatimeatoareserveaspaceainatheaportableaexecutableaiPEjafileaforathea stronganameasignaturemabutadeferatheaactualasigningauntilasomealaterastageaitypicallyajustabeforeashippingathea assemblyjo You can use /keyfile or /delaysign in C# and VB.NET (MSDN) References • http–ppmsdnomicrosoftocompennusplibrarypwduqtxadiv…vsoyqjoaspx • http–ppmsdnomicrosoftocompennusplibrarypcuqvshexiv…vsorrqjoaspx • http–ppmsdnomicrosoftocompennusplibrarypkvbvttstiv…vsoyqjoaspx A5 - Security Misconfiguration110 • http–ppmsdnomicrosoftocompennusplibraryptqxatdyeiv…vsoyqjoaspx • http–ppmsdnomicrosoftocompennusplibraryptqxatdyeiv…vsorrqjoaspx 11.10 Round Tripping RoundaTrippingaisaaareverseaengineeringatechniqueathataallowsaandaattackeratoadecompileaanaassemblyafromaaa certainaapplicationoaIldasmoexeacanabeausedaforathisapurposemaandaILAsmaisausedatoarecompiledatheaassemblyo TheaMSILaDisassembleriaIldasmoexejaisaaacompanionatoolatoatheaMSILaAssembleraiIlasmoexejoaIldasmoexeatakesaaa portableaexecutableaiPEjafileathatacontainsaMicrosoftaintermediatealanguageaiMSILjacodeaandacreatesaaatextafilea suitableaasainputatoaIlasmoexeoaThisatoolaisaautomaticallyainstalledawithaVisualaStudioaandawithatheaWindowsaSDKoa The importance of Obfuscation AsamentionedabeforemaRoundaTrippingaisaaatechniqueausedatoareverseaengineeraassembliesoaThereforemaifayoua wantatoaavoidayouraassembliesabeingareversedaengineeredaoraevenaworsemathatatheacodeaisavictimaofamaliciousa manipulationausingatheaIldasmaandaIlasmatoolsmathenaitaisaadvisableatoaapplyaitoaThereaareadifferentakindsaofaprodn uctsathatacanabeausedaforathisapurposeasuchaasaDeepSeamaCryptoaoraDotfuscatoro Using Obfuscation Theamostaeffectiveatechniqueausedatoaavoidareverseaengineeringaandatamperingaofaassembliesaisatheauseaofa ObfuscationoaVisualaStudioacontainsaaaversionaofaDotfuscatoroaThisaprogramaisaaccessibleabyachoosingaonatheaVSa menumaToolsaAaDotfuscatoriCommunityaEditionamenuacommandjoaNote–aThisatoolsaisanotaavailableainaExpressa versions Toaobfuscateayouraassemblies– • BuildatheaprojectainaVSaStudio • Toolsnn—aDotfuscatoraCommunityaEdition • Aascreenapromptsaaskingaforawhichaprojectatypemachoosea‘CreataNewaProject’aandaclickaOK • OnatheaInputatabaofatheaDotfuscatorainterfacemaclicka‘BrowseaandaAddaassemblyatoalist’ Browseaforatheacompiledaapplication ASPNetConfigs Introduction SecuringaresourcesainaASPoNETaapplicationsaisaaacombinationaofaconfigurationasettingsainatheaWeboconfigafilea butaalsomait’saimportantatoarememberathatatheaIISaconfigurationsaplayaalsoaaabigapartaonathisoaIt’saanaintegrateda approachawhichaprovidesaaatotalaframeworkaofasecurityo TheafollowingahighlightsatheamostaimportantaaspectsaofaASPoNETaconfigurationasettingsawithinatheaweboconfiga fileoaForaaatotalaoverviewaseeachapteraASPoNETasecurityaihttps–ppwwwoowaspoorgpindexophppCRVs_Frameworkn SpecIssuesASPNetj Secure Configuration Values SensitiveaInformationasavedainaconfigafilesashouldabeaencryptedoaEncryptionakeysastoredainatheamachineKeya elementaforaexampleaoraconnectionstringsawithausernameaandapasswordsatoaloginatoadatabaseo Lock ASP.NET Configuration settings YouacanalockaconfigurationasettingsainaASPoNETaconfigurationafilesaiWeboconfigafilesjabyaaddingaanaallowOvern rideaattributeatoaaalocationaelementa A5 - Security Misconfiguration 111 Configure directories using Location Settings Throughathea”location—aelementayouacanaestablishasettingsaforaspecificafoldersaandafilesoaTheaPathaattributeaisa usedatoaspecifyatheafileaorasubdirectoryoaThisaisadoneainatheaWeboconfigafileaexample– Configure exceptions for Error Code handling Showingaandahandlingatheacorrectaerroracodeawhenaaauserasendsaaabadarequestaorainvalidaparametersaisaanaimn portantaconfigurationasubjectoaLoggingatheseaerrorsaareaalsoaanaexcellentahelpawhenaanalyzingapotentialaattacksa toatheaapplicationo ItaisapossibleatoaconfigureatheseaerrorsainatheacodeaorainatheaWeboConfigafile TheaHttpExceptionamethodadescribesaanaexceptionathataoccurredaduringatheaprocessingaofaHTTParequestsoFora example– orainatheaWeboconfigafile– ”locationapath…”o”a— aaaa”sectionraooop— aaaa”sectionsaoooap— aa”plocation— aa”locationapath…”DefaultaWebaSite”a— aaaa”sectionra…ap— aaaa”sectionsa…ap— aa”plocation aa”locationapath…”DefaultaWebaSitepMyApplicationpAdminpxyzohtml”a— aaaa”sectionraoooap— aaaa”sectionsaoooap— aa”plocation— Sample 11.29 ifaistringoIsNullOrEmptyiRequest[“id”]jj aaaaathrowanewaHttpExceptioniuqqma“Badarequest”j• Sample 11.30 ”configuration— aa”systemoweb— aaaa”customErrorsamode…”On”adefaultRedirect…”ErrorPageohtml”a aaaaaaaaaaaaaaaaaredirectMode…”ResponseRewrite”— Sample 11.31 A5 - Security Misconfiguration112 Input validation AnythingacomingafromaexternalasourcesacanabeaconsideraasainputainaaawebaapplicationoaNotaonlyatheauserainn sertingadataathroughaaawebaformmabutaalsoadataaretrievedafromaaawebaserviceaoradatabasemaalsoaheadersasenta fromatheabrowsersafallaunderathisaconceptoaAawayaofadefiningawhenainputaisasafeacanabeadoneathroughaoutlininga aatrustaboundaryo DefiningawhataisaknownaasatrustaboundaryacanahelpausatoavisualizeaallapossibleauntrustedainputsoaOneaofathosea areauserainputoASPoNETahasadifferentatypesaofavalidationsadependingaonathealevelaofacontrolatoabeaappliedoaBya defaultmawebapagesacodeaisavalidatedaagainstamaliciousausersoaTheafollowingaisaaalistatypesaofavalidationsauseda iMSDNmasqrtj– References MSDNmasqrta“SecuringaASPoNETaConfigurations”aavailableaata http–ppmsdnomicrosoftocompennusplibrarypmsrxyw““fsyv…vsorqqfs“oaspxaiLastaViewedmasvthaJulyasqrtj 11.11 .NET Authentication Controls InatheaoNETmathereaareaAuthenticationatagsainatheaconfigurationafileoaThea”authentication—aelementaconfiguresa theaauthenticationamodeathatayouraapplicationsauseoaTheaappropriateaauthenticationamodeadependsaonahowa youraapplicationaoraWebaserviceahasabeenadesignedoaTheadefaultaMachineoconfigasettingaappliesaaasecureaWinn dowsaauthenticationadefaultaasashownabelow authentication Attributes:mode=”[Windows|Forms|Passport|None]” <authentication mode=”Windows” /> aaaaaa”errorastatusCode…”uqq”aredirect…”BadRequestohtml”ap— aaaaaa”errorastatusCode…”uqu”aredirect…”FileNotFoundohtml”ap— aaaa”pcustomErrors— aa”psystemoweb— a”pconfiguration— Type of validation Control to use Required entry RequiredFieldValidator Comparison to a value CompareValidator Description Ensuresathatatheauseradoesanotaskipaanaentryo Comparesaaauser’saentryaagainstaaaconstantavaluemaagainstatheavalueaofaanothera controlaiusingaaacomparisonaoperatorasuchaasalessathanmaequalmaoragreaterathanjma oraforaaaspecificadataatypeo Range checking RangeValidator Checksa thata aa user’sa entrya isa betweena specifieda lowera anda uppera boundariesoa Youacanacheckarangesawithinapairsaofanumbersmaalphabeticacharactersmaandadateso Pattern matching RegularExpressionValidator ChecksathatatheaentryamatchesaaapatternadefinedabyaaaregularaexpressionoaThisa typeaofavalidationaenablesayouatoacheckaforapredictableasequencesaofacharactersma suchaasathoseainaenmailaaddressesmatelephoneanumbersmapostalacodesmaandasoaono User-defined CustomValidator Checksatheauser’saentryausingavalidationalogicathatayouawriteayourselfoaThisatypea ofavalidationaenablesayouatoacheckaforavaluesaderivedaatarunatimeo Figure 10: IISaInputaValidation A5 - Security Misconfiguration 113 Forms Authentication Guidelines ToauseaFormsaauthenticationmasetamode…“Forms”aonathea”authentication—aelementoaNextm configurea Formsa authenticationa usinga thea childa ”forms—a elementoaThea followinga fragmenta showsa aa securea ”forms—aauthenticationaelementaconfiguration– UseatheafollowingarecommendationsatoaimproveaFormsaauthenticationasecurity– • PartitionayouraWebasiteo • Setaprotection…“All”o • Useasmallacookieatimenoutavalueso • Considerausingaaafixedaexpirationaperiodo • UseaSSLawithaFormsaauthenticationo • IfayouadoanotauseaSSLmasetaslidingExpirationa…a“false”o • Doanotauseathea”credentials—aelementaonaproductionaserverso • Configureathea”machineKey—aelemento • Useauniqueacookieanamesaandapathso Classic ASP ForaclassicaASPapagesmaauthenticationaisausuallyaperformedamanuallyabyaincludingatheauserainformationainasesn sionavariablesafteravalidationaagainstaaaDBmasoayouacanalookaforasomethingalike– Sessionai“UserId”ja…aUserName Sessionai“Roles”ja…aUserRoles Code Review .Net Manage Code oNETaManagedacodeaisalessavulnerableatoacommonavulnerabilitiesafoundainaunmanagedacodeasuchaasaBuffera Overflowsaandamemoryacorruptionahoweverathereacouldabeaissuesainatheacodeathatacanaaffectaperformanceaanda securityoaaTheafollowingaisaaasummaryaofathearecommendedapracticesatoalookaforaduringatheacodeareviewoaAlsomaita isaworthamentioningasomeatoolsathatacanamakeatheaworkaeasieraonathisapartaandatheyacanahelpayouaunderstanda andapinapointaflawsainayouracode Code Access Security ThisasupportsatheaexecutionaofasemintrustedacodemapreventingaseveralaformsaofasecurityathreatsoaTheafollowingaisa aasummaryaofapossibleavulnerabilitiesadueatoaimproperauseaofaCodeaAccessasecurity– ”authenticationamode…”Forms”— aa”formsaloginUrl…”Restricted\\loginoaspx”aLoginapageainaanaSSLaprotectedafolder aaaprotection…”All”aPrivacyaandaintegrity aaarequireSSL…”true”aPreventsacookieabeingasentaoverahttp aaatimeout…”rq”aLimitedasessionalifetime aaaname…”AppNameCookie”aUniqueapernapplicationaname aaapath…”pFormsAuth”aandapath aaaslidingExpiration…”true”a—aSlidingasessionalifetime aa”pforms— a”pauthentication— Sample 11.32 A5 - Security Misconfiguration114 Declarative security Useadeclarativeasecurityainsteadaofaimperativeawheneverapossibleoa ExampleaofadeclarativeasyntaxiMSDN[s]masqrtj– Unmanaged code EvenathoughaCdaisaaastrongatypealanguagemaitaisapossibleatoauseaunmanagedacodeacallsabyausingathea‘unsafe’a codeoa“Checkathataanyaclassathatausesaanaunmanagedaresourcemasuchaasaaadatabaseaconnectionaacrossamethoda callsmaimplementsatheaIDisposableainterfaceoaIfatheasemanticsaofatheaobjectaareasuchathataaaCloseamethodaisamorea logicalathanaaaDisposeamethodmaprovideaaaCloseamethodainaadditionatoaDispose”o Exception handling ManageacodeashouldauseaexceptionahandlingaforasecurityapurposesaamongaotherareasonsoaMakeasureathatayoua followathesearecommendations– *Avoidaexceptionahandlingainaloopsmauseatrypcatchablockaifaitaisanecessaryo *Identifyacodeathataswallowsaexceptions *Useaexceptionsahandlingaforaunexpectedaconditionsaandanotajustatoacontrolatheaflowainatheaapplication Tools FxCop FxCopaisaanaanalysisatoolathataanalysesabinaryaassembliesmanotasourceacodeoaTheatoolahasaaapredefinedasetaofa rulesaandaitaisapossibleatoaconfigureaandaextendathemo SomeaofatheaavailablearulesaregardingasecurityaareaiCodePlexmasqrqj– Vulnerability Improper use of link demands or asserts Code allows untrusted callers Implications Theacodeaisasusceptibleatoaluringaattacks Maliciousacodeacanauseatheacodeatoaperformasensitiveaoperationsaandaaccessaresources Table 16: CodeaAccessaSecurityaVulnerabilities [MyPermissioniSecurityActionoDemandmaUnrestricteda…atruej] aapublicaclassaMyClass aa{ aaapublicaMyClassij aaa{ aaaaaappTheaconstructoraisaprotectedabyatheasecurityacallo aaa} aaapublicavoidaMyMethodij aaa{ aaaaaappThisamethodaisaprotectedabyatheasecurityacallo aaa} aaapublicavoidaYourMethodij aaa{ aaaaaappThisamethodaisaprotectedabyatheasecurityacallo aaa} } Sample 11.33 A5 - Security Misconfiguration 115 Rule Description EnableEventValidationShouldBeTrue VerifiesaifatheaEnableEventValidationadirectiveaisadisabledaonaaacertainapageo ValidateRequestShouldBeEnabled VerifiesaifatheaValidateRequestadirectiveaisadisabledaonaaacertainapageo ViewStateEncryptionModeShouldBeAlways EnableViewStateMacShouldBeTrue EnableViewStateShouldBeTrue ViewStateUserKeyShouldBeUsed EnableCrossAppRedirectsShouldBeTrue FormAuthenticationProtectionShouldBeAll FormAuthenticationRequireSSLShouldBeTrue FormAuthenticationShouldNotContainFormAuthentica tionCredentials CustomErrorPageShouldBeSpecified DebugCompilationMustBeDisabled VerifiesaifatheaViewStateEncryptionModeadirectiveaisanotasetatoaNeveraonaaacertainapageo VerifiesaifatheaEnableViewStateMacadirectiveaisanotasetatoafalseaonaaacertainapageo VerifiesaifatheaEnableViewStateadirectiveaisanotasetatoafalseaonaaacertainapageo VerifiesaifatheaPageoViewStateUserKeyaisabeingausedainatheaapplicationatoapreventaCSRFo Verifiesa thata systemoweboauthenticationoformsa enableCrossAppRedirectsa isa seta toa trueoa Thea settingsaindicateaifatheauserashouldabearedirectedatoaanotheraapplicationaurlaafteratheaauthenn ticationaprocessoaIfatheasettingaisafalsematheaauthenticationaprocessawillanotaallowaredirectionatoa anotheraapplicationaorahostoaThisahelpsapreventaanaattackeratoaforceatheauseratoabearedirecteda toaanotherasiteaduringatheaauthenticationaprocessoaThisaattackaisacommonlyacalledaOpenaredin rectaandaisausedamostlyaduringaphishingaattackso Verifiesa thata thea protectiona attributea ona thea systemoweboauthenticationoformsa protectiona isa setatoaAllawhichaspecifiesathatatheaapplicationauseabothadataavalidationaandaencryptionatoahelpa protectatheaauthenticationacookieo VerifiesathatathearequireSSLaattributeaonatheasystemoweboauthenticationoformsaconfigurationa elementaisasetatoaTrueawhichaforcesatheaauthenticationacookieatoaspecifyatheasecureaattributeoa ThisadirectsatheabrowseratoaonlyaprovideatheacookieaoveraSSLo Verifiesathatanoacredentialsaareaspecifiedaunderatheaformaauthenticationaconfigurationo VerifiesathatatheaCustomErrorsasectionaisaconfiguredatoahaveaaadefaultaURLaforaredirectingausesa inacaseaofaerroro VerifiesathatadebugacompilationaisaturnedaoffoaThisaeliminatesapotentialaperformanceaandasen curityaissuesarelatedatoadebugacodeaenabledaandaadditionalaextensiveaerroramessagesabeinga returnedo Table 17: FxCopaFlags HttpCookiesRequireSSLShouldBeTrue TraceShouldBeDisabled VerifiesathatatheasystemowebohttpCookiesarequireSSLaconfigurationaisasetatoaTrueawhichaforcesa allacookiesatoabeasentawithatheasecureaattributeoaThisaindicatesatheabrowseratoaonlyaprovideathea cookieaoveraSSLo VerifiesathatatheasystemowebotraceaenabledasettingaisasetatoafalseawhichadisablesatracingoaItaisa recommendedatoadisableatracingaonaproductionaserversatoamakeasureathataanaattackeracannota gainainformationafromatheatraceaaboutayouraapplicationoaTraceainformationacanahelpaanaattackn eraprobeaandacompromiseayouraapplicationo FormAuthenticationSlidingExpirationShouldBeFalse HttpCookiesHttpOnlyCookiesShouldBeTrue VerifiesathatasystemoweboauthenticationoformsaslidingExpirationaisasetatoafalseawhenatheasitea isabeingaservedaoveraHTTPoaThisawillaforceatheaauthenticationacookieatoahaveaaafixedatimeouta valueainsteadaofabeingarefreshedabyaeacharequestoaSinceatheacookieawillatraverseaoveraclearatexta networka anda coulda potentiallya bea interceptedma havinga aa fixeda timeouta valuea ona thea cookiea willalimitatheaamountaofatimeatheacookieacanabeareplayedoaIfatheacookieaisabeingasentaonlyaovera HTTPSmaitaisalessalikelyatoabeainterceptedaandahavingatheaslidingExpirationasettingatoaTrueawilla causeatheatimeoutatoabearefreshedaafteraeacharequestawhichagivesaaabetterauseraexperienceo VerifiesathatatheasystemowebohttpCookiesahttpOnlyCookiesaconfigurationasettingaisasetatoaTruea whichaforcesaallacookiesatoabeasentawithatheaHttpOnlyaattributeo A5 - Security Misconfiguration116 Rule Description AnonymousAccessIsEnabled PagesEnableViewStateMacShouldBeTrue PagesValidateRequestShouldBeEnabled PagesViewStateEncryptionModeShouldBeAlways CustomErrorsModeShouldBeOn MarkVerbHandlersWithValidateAntiforgeryToken PagesEnableEventValidationMustBeTrue RoleManagerCookieProtectionShouldBeAll RoleManagerCookieRequireSSLShouldBeTrue RoleManagerCookieSlidingExpirationShouldBeTrue HttpRuntimeEnableHeaderCheckingShouldBeTrue Looksainatheaweboconfigafileatoaseeaifatheaauthorizationasectionaallowsaanonymousaaccesso Verifiesathatatheaviewstateamacaisaenabledo VerifyathatavalidateRequestaisaenabledo Verifiesathatatheaviewstateaencryptionamodeaisanotaconfiguredatoaneveraencrypto VerifiesathatatheasystemowebocustomErrorsamodeaisasetatoaOnaoraRemoteOnlyoaThisadisableaden tailedaerroramessageareturnedabyaASPoNETatoaremoteauserso ValidateAntiforgeryTokenAttributeaisausedatoaprotectaagainstapotentialaCSRFaattacksaagainsta ASPoNETaMVCaapplicationso Verifiesathataeventavalidationaisaenabledo VerifiesathatatheasystemoweborolemanageracookieProtectionaisasetatoaAllawhichaenforcesathea cookieatoabeabothaencryptedaandavalidatedabyatheaservero Verifiesa thata thea systemoweborolemanagera cookieRequireSSLa attributea isa seta toa Truea whicha forcesathearoleamanageracookieatoaspecifyatheasecureaattributeoaThisadirectsatheabrowseratoaonlya provideatheacookieaoveraSSLo VerifiesathatatheasystemoweborolemanageracookieSlidingExpirationaisasetatoafalseawhenatheasitea isabeingaservedaoveraHTTPoaThisawillaforceatheaauthenticationacookieatoahaveaaafixedatimeouta valueainsteadaofabeingarefreshedabyaeacharequestoaSinceatheacookieawillatraverseaoveraclearatexta networka anda coulda potentiallya bea interceptedma havinga aa fixeda timeouta valuea ona thea cookiea willalimitatheaamountaofatimeatheacookieacanabeareplayedoaIfatheacookieaisabeingasentaonlyaovera HTTPSmaitaisalessalikelyatoabeainterceptedaandahavingatheaslidingExpirationasettingatoaTrueawilla causeatheatimeoutatoabearefreshedaafteraeacharequestawhichagivesaaabetterauseraexperienceo VerifiesathatatheasystemowebohttpRuntimeaenableHeaderCheckingaattributeaisasetatoatrueoaThea settinga indicatesa whethera ASPoNETa shoulda checka thea requesta headera fora potentiala injectiona attacksoaIfaanaattackaisadetectedmaASPoNETarespondsawithaanaerroroaThisaforcesaASPoNETatoaapplya theaValidateRequestaprotectionatoaheadersasentabyatheaclientoaIfaanaattackaisadetectedatheaapn plicationathrowsaHttpRequestValidationExceptiono A5 - Security Misconfiguration 117 A6 118 A6 - Sensitive Data Exposure SENSITIVE DATA EXPOSUREA6 ManyawebaapplicationsadoanotaproperlyaprotectasensitiveadatamasuchaasacreditacardsmataxaIDsmaandaauthenticationa credentialsoaAttackersamayastealaoramodifyasuchaweaklyaprotectedadataatoaconductacreditacardafraudmaidentitya theftmaoraotheracrimesoaSensitiveadataadeservesaextraaprotectionasuchaasaencryptionaatarestaorainatransitmaasawella asaspecialaprecautionsawhenaexchangedawithatheabrowsero 12.1 Cryptographic Controls Softwarea developersma architectsa anda designersa area ata thea forefronta ofa decidinga whicha categorya aa particulara applicationaresidesainoaCryptographyaprovidesaforasecurityaofadataaatarestaiviaaencryptionjmaenforcementaofadataa integrityaiviaahashingpdigestingjmaandanonnrepudiationaofadataaiviaasigningjoaToaensureathisacryptographicacodea adequatelyaprotectionsatheadatamaallasourceacodeamustauseaaastandardaisecurejaalgorithmsawithastrongakeyasizeso Commonaflawsawhenaimplementingacryptographicacodeaincludesatheauseaofanonnstandardacryptographicaalgon rithmsmacustomaimplementationaofacryptographyaistandardaganonnstandardjaalgorithmsmauseaofastandardaalgon rithmsawhichaareacryptographicallyainsecureaieogoaDESjmaandatheaimplementationaofainsecureakeysacanaweakena theaoverallasecurityapostureaofaanyaapplicationoaImplementationaofatheaaforementionedaflawsaenableaattackersa toauseacryptanalyticatoolsaandatechniquesatoadecryptasensitiveadatao 12.2 Description Manyacompaniesahandleasensitiveainformationaforatheiracustomersmaforainstanceamedicaladetailsaoracreditacardanumbersma andaindustryaregulationsadictateathisasensitiveainformationamustabeaencryptedatoaprotectatheacustomers’ainformationoaa InatheamedicalaindustryatheaHIPAAaregulationsaadviseabusinessesawhataprotectionsamustabeaappliedatoamedicaladatama inatheafinancialaindustryamanyaregulationsacoveraPIIaipersonallyaidentifiableainformationjacontrolsoaa Regardlessaofatheafinancialaimpactaofaregulatoryapenaltiesmathereaareamanyabusinessareasonsatoaprotectaithoughaenn cryptionaorahashingjatheainformationaprocessedabyaanaapplicationmaincludingaprivacyaandafraudadetectionpprotectiono AllasensitiveadataathatatheaapplicationahandlesashouldabeaidentifiedaandaencryptionashouldabeaenforcedoaaSimin larlyaaadecisionashouldabeamadeaasatoawhetherasensitiveadataamustabeaencryptedainatransitaiioeoabeingasentafroma oneacomputeratoaanotherjaandporaatarestaiioeoastoredainaaaDBmafilemakeychainmaetcoj– 1) Protectionainatransit•athisatypicallyameansausingatheaSSLpTLSalayeratoaencryptadataatravellingaonatheaHTTPa protocolmaalthoughaitacanaalsoaincludeaFTPSmaoraevenaSSLaonaTCPoaaFrameworksasuchaasaIISaandaApacheaStrutsa comeawithaSSLpTLSafunctionalityaincludedmaandathusatheadeveloperawillanotabeacodingatheaactualaTLSaencrypn tionmabutainsteadawillabeaconfiguringaaaframeworkatoaprovideaTLSasecurityoaa Howeveratheadecisionsamadeaheremaevenaataanaarchitecturalalevelmaneedatoabeawellainformedmaandaaadiscussionaona TLSadesignadecisionsaisacoveredainasectionaroto 2) Protectionaatarest•athisacanaincludeaencryptionaofacreditacardsainatheadatabasemahashingaofapasswordsma producingamessageaauthenticationacodesaiMACsjatoaensureaaamessageahasanotabeenamodifiedabetweenacomn putersoaaWhereaTLSacodeawillacomeawithaaaframeworkmacodeatoaencryptaorahashadataatoabeastoredawillatypicallya needatoauseaAPIsaprovidedabyacryptographicalibrariesoaa TheadeveloperawillanotabeawritingacodeatoaimplementatheaAESaalgorithmaiOpenSSLaoraCryptoAPIawilladoathatjmathea developerawillabeawritingamodulesatoauseaanaAESaimplantationainatheacorrectawayoaaAgainatheacorrectadecisionsaneedatoa beamadearegardingaupntondateaalgorithmsmakeyastoragemaandaotheradesignadecisionsmawhichaareacoveredainasectionarouo 119A6 - Sensitive Data Exposure Cryptography Definitions Beforeadivingaintoadiscussionsaonaencryptingatrafficaandadatamasomeaterminologyausedainathearealmaofacryptogn raphyaisadefinedainatable 18. 12.3 What to Review: Protection in Transit Thea termsa Securea Socketa Layera iSSLja andaTransporta Layera Securitya iTLSja area oftena useda interchangeablyoa Ina factmaSSLavtoraisaequivalentatoaTLSavroqoaHowevermadifferentaversionsaofaSSLaandaTLSaareasupportedabyamoderna webabrowsersaandabyamostamodernawebaframeworksaandaplatformsoaaNoteathatasinceadevelopmentsainaattacksa againstatheaSSLaprotocolahaveashownaitatoabeaweakeraagainstaattacksmathisaguideawillauseatheatermaTLSatoareferatoa transportalayerasecurityaoveratheaHTTPaoraTCPaprotocolso Theaprimaryabenefitaofatransportalayerasecurityaisatheaprotectionaofawebaapplicationadataafromaunauthorizeda disclosureaandamodificationawhenaitaisatransmittedabetweenaclientsaiwebabrowsersjaandatheawebaapplicationa servermaandabetweenatheawebaapplicationaserveraandabackaendaandaotheranonnbrowserabasedaenterpriseacomn ponentso InatheorymatheadecisionatoauseaTLSatoaprotectacomputeratoacomputeracommunicationashouldabeabasedaonathea natureaofatheatrafficaorafunctionalityaavailableaoveratheainterfaceoaaIfasensitiveainformationaisapassingaoverathea Hashing Entropy Encoding Salt Encryption Symmetric Encryption Public-Key Encryption (PKI) Certificate Nonnreversibleatransformationaofadataaintoawhataisacalledaaa‘fingerprint’aora‘hashvalue’oaaInputaofaanyasizeacanabeatakena andaalwaysaresultsainatheasameasizeaofaoutputaiforatheaalgorithmjoaaTheaaimaisanotatoaconvertatheafingerprintabackaintoathea sourceadataaataaalateratimemabutatoarunatheahashaalgorithmaoveratwoasetsaofadataatoadetermineaifatheyaproduceatheasamea fingerprintoaaThisawouldashowathatadataahasanotabeenatamperedawitho EssentiallyathisaisarandomnessoaaCryptographicafunctionsawillaneedatoaworkawithasomeaformaofarandomnessatoaallowathea sourceadataatoabeaencryptedainasuchaaawayathataanaattackeracannotareverseatheaencryptionawithoutatheanecessaryakeyoaa Havingaaagoodasourceaofaentropyaisaessentialatoaanyacryptographicaalgorithmo TransformingadataafromaoneaformaintoaanothermatypicallyawithatheaaimaofamakingatheadataaeasieratoaworkawithoaForaexn ampleaencodingabinaryadataaiwhichacouldanotabeaprintedatoaaascreenaintoaprintableaASCIIaformatawhichacanabeacopyp pastedoaaNoteathataencodingadoesanotaaimatoahideatheadatamatheamethodatoareturnatheaencodedadataabackatoaitsaoriginala formawillabeapublicallyaknowno Aa nonnsecreta valuea thata cana bea addeda toa aa hashinga algorithma toa modifya thea fingerprinta resultoa a Onea attacka againsta hashingaalgorithmsaisaaa‘rainbowatableaattack’awhereaallasourceavaluesaareaprencomputedaandaaatableaproducedoaaThea attackeracanathenatakeaaafingerprintmalookaitaupainatheatablemaandacorrespondaitatoatheaoriginaladataoaaUsingaaauniqueasalta valueaforaeachadataatoabeahashedaprotectsaagainstarainbowatablesmaasaaarainbowatableaforaeachasaltavalueawouldaneedatoa beacreatedmawhichawouldagreatlyaextendatheatimeatakenabyaanaattackeroaaTheasaltaisanotaaasecretaandacanabeastoredaorasenta withatheafingerprinto TransformationaofasourceadataaintoaanaencryptedaformathatacanabeareversedabackatoatheaoriginalasourceoaaTypicallyathea algorithmsausedatoaencryptaareapublicallyaknownmabutarelyaonaaasecreta‘key’atoaguideatheatransformationoaaAnaattackera withoutatheakeyashouldanotabeaableatoatransformatheadataabackaintoatheaoriginalasourceo AaformaofaencryptionawhereatheasameakeyaisaknownatoabothatheasenderaandatheareceiveroaaThisaisaaafastaformaofaencryptionma howeverarequiresaaasecuremaoutnofnbandamethodatoapassatheasymmetricakeyabetweenatheasenderaandareceivero AaformaofaencryptionausingatwoakeysmaoneatoaencryptatheadatamaandaoneatoadecryptatheadataabackatoaitsaoriginalaformoaaThisa isaaasloweramethodaofaencryptionahoweveraoneaofatheakeysacanabeapublicallyaknownaireferredatoaasaaa‘publicakey’joaaThea otherakeyaisacalledaaa‘privateakey’aandaisakeptasecretoaaAnyadataaencryptedawithatheapublicakeyacanabeadecryptedabackaintoa itsaoriginalaformausingatheaprivateakeyoaaSimilarlyaanyadataaencryptedawithatheaprivateakeyacanabeadecryptedabackatoaitsa originalaformausingatheapublicakeyo AnaassociationabetweenaanaentityaieogoapersonmacompanyjaandaaapublicakeyoaaTypicallyathisaformsapartaofaaapublicnkeya infrastructureawhereacertainatrustedaentitiesaieogoaCertificateaAuthoritiesainainternetaTLSjaperformavalidationaofaanaentitlesa credentialsaandaassertaiusingatheiraownacertificatejathataaadeclaredapublicakeyabelongsatoatheaentityo Term Description Table 18: CryptographicaDefinitions 120 interfacemaTLSawillapreventaeavesdroppersafromabeingaableatoaviewaoramodifyatheadataoaaLikewiseaifatheainterfacea allowsamoneyatoabeatransferredmaorasensitiveafunctionsatoabeainitiatedmathenaTLSawillaprotectatheaassociatedalogina orasessionainformationaauthorizingatheauseratoaperformathoseafunctionsoaaHoweverawithatheapriceaofacertificatesa droppingmaandaTLSaconfigurationawithinaframeworksabecomingaeasiermaTLSaprotectionaofaanainterfaceaisanotaaa largeaendeavoraandamanyawebasitesaareausingaTLSaprotectionsaforatheiraentireasiteaiioeoathereaareaonlyaHTTPSa pagesmanoaHTTPapagesaareaavailablejo TheaserveravalidationacomponentaofaTLSaprovidesaauthenticationaofatheaserveratoatheaclientoaIfaconfiguredatoaren quireaclientasideacertificatesmaTLSacanaalsoaplayaaaroleainaclientaauthenticationatoatheaserveroaHowevermainapracticea clientasideacertificatesaareanotaoftenausedainalieuaofausernameaandapasswordabasedaauthenticationamodelsafora clientso Using Validated Implementations TheaUSagovernmentaprovidesaaalistaofasoftwareathatahasabeenavalidatedatoaprovideaaastrongaandasecureaimplen mentationaofavariousacryptographicafunctionsmaincludingathoseausedainaTLSoaaThisalistaisareferredatoaasatheaFIPSa ruqnsavalidatedacryptomoduleso Aacryptomodulemawhetheraitaisaaasoftwarealibraryaoraaahardwareadevicemaimplementsacryptographicaalgorithmsa isymmetricaandaasymmetricaalgorithmsmahashaalgorithmsmarandomanumberageneratoraalgorithmsmaandamessagea authenticationacodeaalgorithmsjoaTheasecurityaofaaacryptomoduleaandaitsaservicesaiandatheawebaapplicationsa thata calla thea cryptomoduleja dependa ona thea correcta implementationa anda integrationa ofa eacha ofa thesea threea partsoaInaadditionmatheacryptomoduleamustabeausedaandaaccessedasecurelyoaaInaorderatoaleverageatheabenefitsaofa TLSaitaisaimportantatoauseaaaTLSaserviceaieogoalibrarymawebaframeworkmawebaapplicationaserverjawhichahasabeena FIPSaruqnsavalidatedoaInaadditionmatheacryptomoduleamustabeainstalledmaconfiguredaandaoperatedainaeitheraana approvedaoraanaallowedamodeatoaprovideaaahighadegreeaofacertaintyathatatheaFIPSaruqnsavalidatedacryptomodn uleaisaprovidingatheaexpectedasecurityaservicesainatheaexpectedamannero When reviewing designs or code that is handling TLS encryption, items to look out for include: • UseaTLSaforathealoginapagesaandaanyaauthenticatedapagesoaaFailureatoautilizeaTLSaforathealoginalandingapagea allowsaanaattackeratoamodifyathealoginaformaactionmacausingatheauser’sacredentialsatoabeapostedatoaanaarbitrarya locationoaFailureatoautilizeaTLSaforaauthenticatedapagesaafterathealoginaenablesaanaattackeratoaviewatheaunenn cryptedasessionaIDaandacompromiseatheauser’saauthenticatedasessiono • UseaTLSainternallyawhenatransmittingasensitiveadataaoraexposingaauthenticatedafunctionalityoaaAllanetworksm bothaexternalaandainternalmawhichatransmitasensitiveadataamustautilizeaTLSaoraanaequivalentatransportalayerasen curityamechanismoaItaisanotasufficientatoaclaimathataaccessatoatheainternalanetworkaisa“restrictedatoaemployees”oa NumerousarecentadataacompromisesahaveashownathatatheainternalanetworkacanabeabreachedabyaattackersoaIna theseaattacksmasniffersahaveabeenainstalledatoaaccessaunencryptedasensitiveadataasentaonatheainternalanetworko • PreferaallainterfacesaiorapagesjabeingaaccessibleaonlyaoveraHTTPSoaaAllapagesawhichaareaavailableaoveraTLSamust notabeaavailableaoveraaanonnTLSaconnectionoaAauseramayainadvertentlyabookmarkaoramanuallyatypeaaaURLatoaaa HTTPapageaieogoahttp–ppexampleocompmyaccountjawithinatheaauthenticatedaportionaofatheaapplicationo • Useathea“secure”aanda“httpnonly”acookieaflagsaforaauthenticationacookiesoaaFailureatoauseathea“secure”aflaga enablesaanaattackeratoaaccessatheasessionacookieabyatrickingatheauser’sabrowseraintoasubmittingaaarequestatoaana unencryptedapageaonatheasiteoaaThea“httpnonly”aflagadeniesaJavaScriptafunctionsaaccessatoatheacookiesacontentso • DoanotaputasensitiveadataainatheaURLoaaTLSawillaprotectatheacontentsaofatheatrafficaonatheawiremaincludingatheaURL whenatransportedmahoweverarememberathataURL’saareavisibleainabrowserahistoryasettingsmaandatypicallyawrittena A6 - Sensitive Data Exposure 121 toaserveralogso • PreventatheacachingaofasensitiveadataoaaTheaTLSaprotocolaprovidesaconfidentialityaonlyaforadataainatransitabutaita doesanotahelpawithapotentialadataaleakageaissuesaatatheaclientaoraintermediaryaproxieso • UseaHTTPaStrictaTransportaSecurityaiHSTSjaforahighariskainterfacesoaaHSTSawillapreventaanyawebaclientsafroma attemptingatoaconnectatoayourawebasiteaoveraaanonnTLSaprotocoloaaFromaaaservernsideapointaofaviewathisamaya seemairrelevantaifanoanonnTLSapagesaareaprovidedmahoweveraaawebasiteasettingaupaHSTSadoesaprotectaclientsa fromaotheraattacksaieogoaDNSacacheapoisioningjo • UseasquyakeyalengthsaiandaabovejaandaSHAnsvwaiandaabovejoaaTheaprivateakeyausedatoagenerateatheacipherakey mustabeasufficientlyastrongaforatheaanticipatedalifetimeaofatheaprivateakeyaandacorrespondingacertificateoaThea currentabestapracticeaisatoaselectaaakeyasizeaofaataleastasquyabitsoaaNoteathataattacksaagainstaSHAnrahaveashowna weaknessaandatheacurrentabestapracticeaisatoauseaataleastaSHAnsvwaoraequivalento • OnlyauseaspecifiedmafullyaqualifiedadomainanamesainayouracertificatesoaaDoanotauseawildcardacertificatesmaoraRFC r“ryaaddressesaieogoarqokaorar“sorwyokjoaaIfayouaneedatoasupportamultipleadomainanamesauseaSubjectaAlternatea NamesaiSANsjawhichaprovideaaaspecificalistingaofamultipleanamesawhereatheacertificateaisavalidoaForaexampleathea certificateacouldalistatheasubject’saCNaasaexampleocommaandalistatwoaSANs–aabcoexampleocomaandaxyzoexampleo comoaTheseacertificatesaareasometimesareferredatoaasa“multipleadomainacertificates”o • AlwaysaprovideaallacertificatesainatheachainoaaWhenaaauserareceivesaaaserveraorahost’sacertificatematheacertificatea mustabeavalidatedabackatoaaatrustedarootacertificationaauthorityoaThisaisaknownaasapathavalidationoaaThereacana beaoneaoramoreaintermediateacertificatesainabetweenatheaendnentityaiserveraorahostjacertificateaandarootacertifn icateoaInaadditionatoavalidatingabothaendpointsmatheaclientasoftwareawillaalsoahaveatoavalidateaallaintermediatea certificatesmawhichacanacauseafailuresaifatheaclientadoesanotahaveatheacertificatesoaaThisaoccursainamanyamobilea platformso 12.4 What to Review: Protection at Rest Asaaageneralarecommendationmacompaniesashouldanotacreateatheiraownacustomacryptographicalibrariesaandaaln gorithmsoaThereaisaaahugeadistinctionabetweenagroupsmaorganizationsmaandaindividualsadevelopingacryptographn icaalgorithmsaandathoseathataimplementacryptographyaeitherainasoftwareaorainahardwareoaaUsingaanaestablisheda cryptographicalibraryathatahasabeenadevelopedabyaexpertsaandatestedabyatheaindustryaisatheasafestawayatoaimn plementacryptographicafunctionsainaaacompany’sacodeoaaSomeacommonaexamplesaofalibrariesausedainavariousa languagesaandaenvironmentsaareacoveredainatheabelowatableo DiscussionLanguage C# .NET Libraries Class libraries within ‘Sys- tem.Security. Cryptogra- phy’ Fora applicationsa codeda ina CdoNETa therea area classa librariesa anda implementationsa withina thea‘SystemoSecurityoCryptogn raphy’athatashouldabeausedoaaThisanamespaceawithinaoNETaaimsatoaprovideaaanumberaofawarppersathatadoanotarequirea proficientaknowledgeaofacryptographyainaorderatoauseaito Table 19: PopularaCryptographicaimplementationsaaccordingatoaenvironment C/C++ (Win32) CryptoAPI and DPAPI ForaCpCllacodearunningaonaWintsaplatformsmatheaCreyptoAPIaandaDPAPIaarearecommendedo C/C++ (Linux) OpenSSL, NSS, boringssl ForaCpCllaonaLinuxpUnixaoperatingasystemsmausaOpenSSLmaNSSmaoraoneaofatheamanyaforksaofathesealibrarieso A6 - Sensitive Data Exposure122 AasecureawayatoaimplementarobustaencryptionamechanismsawithinasourceacodeaisabyausingaFIPSa[x]acompliantaalgon rithmsawithatheauseaofatheaMicrosoftaDataaProtectionaAPIaiDPAPIja[u]aoratheaJavaaCryptographyaExtensionaiJCEja[5]oa A company should identify minimum standards for the following when establishing your cryptographic code strategy: • Whichastandardaalgorithmsaareatoabeausedabyaapplications • Minimumakeyasizesatoabeasupported • Whatatypesaofadataamustabeaencrypted When reviewing code handling cryptography look out for: • IsastrongaenoughaencryptionaalgorithmsabeingausedmaandaisatheaimplementationaofathoseaalgorithmsaFIPSnruqacomn plainto • Isathearightatypeaofacryptographicaalgorithmabeingausedmaisadataabeingahashedathatashouldabeaencryptedawithaaa symmetricakeyﬄaaIfathereaisanoawayatoasafelyatransferatheasymmetricakeyatoatheaotherapartymaisapublicakeyacryptographica algorithmsabeingaemployedﬄ • InaanyacryptographicasystematheaprotectionaofatheakeyaisatheamostaimportantaaspectoaaExposureaofatheasymmetricaora privateakeyameansatheaencryptedadataaisanoalongeraprivateoaaTightlyacontrolawhoahasaaccessatoaenteraoraviewatheakeysma andahowatheakeysaareausedawithinaapplicationso • Anyacodeaimplementingacryptographicaprocessesaandaalgorithmsashouldabeareviewedaandaauditedaagainstaaasetaofa companyaoraregulatoryaspecificationsoaHighaleveladecisionsaneedatoabeamadeaiandacontinuallyarevisitedjaasatoawhataana organizationaconsidersa‘strongaencryption’atoabemaandaallaimplementationainstancesashouldaadhereatoathisastandardo • Cryptographicamodulesamustabeatestedaunderahighaloadawithamultithreadedaimplementationsmaandaeachapieceaofa encryptedadataashouldabeacheckedatoaensureaitawasaencryptedaandadecryptedacorrectlyo • InaoNetacheckaforaexamplesaofacryptographyainatheaMSDNaLibraryaSecurityaPractices–aoNETaFrameworkasoqaSecuritya PracticesaataaaGlance o CheckathatatheaDataaProtectionaAPIaiDPAPIjaisabeingausedo o Verifyanoaproprietaryaalgorithmsaareabeingausedo o CheckathataRNGCryptoServiceProvideraisausedaforaPRNGo o Verifyakeyalengthaisaataleastarsyabitso • InaASPaperformaallaofatheseachecksaonatheaCOMawrapperaasaASPadoesanotahaveadirectaaccessatoacryptographicafunctions o CheckathatatheaDataaProtectionaAPIaiDPAPIjaoraCryptoAPIaisabeingausedaintoaCOMaobject ASP Java CryptoAPI and DPAPI Java Cryp- tography Extension, BouncyCas- tle, Spring Security ClassisaASPapagesadoanotahaveadirectaaccessatoacryptographicafunctionsmasoatheaonlyawayaisatoacreateaCOMawrappersaina VisualaCllaoraVisualaBasicmaimplementingacallsatoaCryptoAPIaoraDPAPIoaaThenacallathemafromaASPapagesausingatheaServero CreateObjectamethodo JCEaisaaastandardaAPIathataanyacryptographicalibraryacanaimplementatoaprovideacryptographicafunctionsatoatheadeveloperoaa OracleaprovideaaalistaofacompaniesathataactaasaCryptographicaServiceaProvidersaandporaofferacleanaroomaimplementationsa ofatheaJCEoaaBouncyCastleaisaonaofatheamoreapopularaimplementationsoaaSpringaSecuirtyaisaalsoapopularainaapplicationa whereaSpringaisaalreadyabeingautilizedo A6 - Sensitive Data Exposure a •aPrssanabottomaofapageaisa slightlyaincorrectainatermsaofabulleta pointsa indentsa na againa let’sa covera quicklyaonaaacallo 123 o Verifyanoaproprietaryaalgorithmsaareabeingaused o CheckathataRNGCryptoServiceProvideraisausedaforaPRNG o Verifyakeyalengthaisaataleastarsyabits • ForaJavaacheckathatatheaJavaaCryptographyaExtensionaiJCEjaisabeingaused o Verifyanoaproprietaryaalgorithmsaareabeingaused o CheckathataSecureRandomaiorasimilarjaisausedaforaPRNG o Verifyakeyalengthaisaataleastarsyabits Bad Practice: Use of Insecure Cryptographic Algorithms TheaDESaandaSHAnqaalgorithmsaareacryptographicallyainsecureoaTheaexampleainasample 12.1aoutlinesaaacryptographica moduleausingaDESaiavailableaperausingatheaJavaaCryptographicaExtensionsjawhichashouldanotabeausedoaaAdditionallyma SHAnraandaMDvashouldabeaavoidedainanewaapplicationsamovingaforwardo Good Practice: Use Strong Entropy Theasourceacodeainasample 12.2aoutlinesasecureakeyagenerationaperauseaofastrongaentropy– packageaorgobadexampleocrypto• ”snip— trya{ aa pkkaaSteparoaGenerateaaaDESakeyausingaKeyGeneratorakp aa KeyGeneratorakeyGena…aKeyGeneratorogetInstancei“DES”j• aa SecretKeyasecretKeya…akeyGenogenerateKeyij• aa aa pkkaaStepsoaCreateaaaCipherabyaspecifyingatheafollowingaparameters aa akaaa a aoaAlgorithmanameanahereaitaisaDES aa akaaa a boaModeanahereaitaisaCBC aa akaaa a coaPaddinganaPKCSvPaddingakp aa CipheradesCiphera…aCipherogetInstancei“DESpCBCpPKCSvPadding”j• ”snip— Sample 12.1 packageaorgoowaspojavaocrypto• importajavaosecurityoSecureRandom• importajavaosecurityoNoSuchAlgorithmException• importasunomiscoBASEwuEncoder• pkk akaThisaprogramaprovidesatheafunctionalityaforaGeneratingaaaSecureaRandomaNumbero akaThereaareasawaysatoagenerateaaaRandomanumberathroughaSecureRandomo akaroaByacallinganextBytesamethodatoagenerateaRandomaBytes Sample 12.2 A6 - Sensitive Data Exposure •aPrssanabottomaofapageaisa slightlyaincorrectainatermsaofabulleta pointsa indentsa na againa let’sa covera quicklyaonaaacallo 124 Good Practice: Use Strong Algorithms BelowaillustratesatheaimplementationaofaAESaiavailableaperaUsingatheaJavaaCryptographicaExtensionsj– akasoaUsingasetSeedibyte[]jatoareseedaaaRandomaobject kp publicaclassaSecureRandomGena{ a publicastaticavoidamainiString[]aargsja{ aa trya{ a aaaaaaaappaInitializeaaasecurearandomanumberagenerator a aaaaaaaaSecureRandomasecureRandoma…aSecureRandomogetInstancei“SHAvrs”j• a aaaa a aaaaaaaappaMethodaranaCallinganextBytesamethodatoagenerateaRandomaBytes a aaaaaaaabyte[]abytesa…anewabyte[vrs]• a aaaaaaaasecureRandomonextBytesibytesj•a a aaaaaaaa a aaaaaaaappaPrintingatheaSecureRandomanumberabyacallingasecureRandomonextDoubleij a aaaaaaaaSystemooutoprintlni“aSecureaRandomadageneratedabyacallinganextBytesijaisa“alasecureRandomo nextDoubleijj• a aaaa a aaaaaaaappaMethodasanaUsingasetSeedibyte[]jatoareseedaaaRandomaobject a aaaaaaaaintaseedByteCounta…arq• a aaaaaaaabyte[]aseeda…asecureRandomogenerateSeediseedByteCountj•aaa a aaaaaaaaa aaaa a aaaaaaaasecureRandomosetSeediseedj•a aaaaaaaa a aaaaaaaaSystemooutoprintlni“aSecureaRandomadageneratedausingasetSeedibyte[]jaisaa“alasecureRandomo nextDoubleijj• a aaaaaaaa a aaaa}acatchaiNoSuchAlgorithmExceptionanoSuchAlgoj aa { aaa Systemooutoprintlni“aNoaSuchaAlgorithmaexistsa“alanoSuchAlgoj• aa } a } } packageaorgoowaspojavaocrypto• importajavaxocryptooKeyGenerator• importajavaxocryptooSecretKey• importajavaxocryptooCipher• importajavaosecurityoNoSuchAlgorithmException• importajavaosecurityoInvalidKeyException• importajavaosecurityoInvalidAlgorithmParameterException• importajavaxocryptooNoSuchPaddingException• Sample 12.3 A6 - Sensitive Data Exposure 125 importajavaxocryptooBadPaddingException• importajavaxocryptooIllegalBlockSizeException• importasunomiscoBASEwuEncoder• pkk akaThisaprogramaprovidesatheafollowingacryptographicafunctionalities akaroaEncryptionausingaAES akasoaDecryptionausingaAES aka akaHighaLevelaAlgorithma– akaroaGenerateaaaDESakeyaispecifyatheaKeyasizeaduringathisaphaseja akasoaCreateatheaCiphera akatoaToaEncrypta–aInitializeatheaCipheraforaEncryption akauoaToaDecrypta–aInitializeatheaCipheraforaDecryption akp publicaclassaAESa{ a publicastaticavoidamainiString[]aargsja{ aa aa StringastrDataToEncrypta…anewaStringij• aa StringastrCipherTexta…anewaStringij• aa StringastrDecryptedTexta…anewaStringij• try{ aa pkk aa akaaSteparoaGenerateaanaAESakeyausingaKeyGenerator aa akaaaa Initializeatheakeysizeatoarsya aa akp aa KeyGeneratorakeyGena…aKeyGeneratorogetInstancei“AES”j• aa keyGenoinitirsyj• aa SecretKeyasecretKeya…akeyGenogenerateKeyij• aa aa pkk aa akaaStepsoaCreateaaaCipherabyaspecifyingatheafollowingaparameters aa akaaa a aoaAlgorithmanameanahereaitaisaAES aa akp aa CipheraaesCiphera…aCipherogetInstancei“AES”j• aa aa pkk aa akaaStepatoaInitializeatheaCipheraforaEncryptiona aa akp aa aesCipheroinitiCipheroENCRYPT_MODEmsecretKeyj• aa aa pkk aa akaaStepauoaEncryptatheaData aa akaaaa roaDeclareapaInitializeatheaDataoaHereatheadataaisaofatypeaString aa akaaaa soaConvertatheaInputaTextatoaBytes A6 - Sensitive Data Exposure126 aa akaaaa toaEncryptatheabytesausingadoFinalamethoda aa akp aa strDataToEncrypta…a“HelloaWorldaofaEncryptionausingaAESa“• aa byte[]abyteDataToEncrypta…astrDataToEncryptogetBytesij• aa byte[]abyteCipherTexta…aaesCipherodoFinalibyteDataToEncryptj•a aa strCipherTexta…anewaBASEwuEncoderijoencodeibyteCipherTextj• aa Systemooutoprintlni“CipheraTextageneratedausingaAESaisa“alstrCipherTextj• aa aa pkk aa kpaaStepavoaDecryptatheaData aa akaaaa roaInitializeatheaCipheraforaDecryptiona aa akaaaa soaDecryptatheacipherabytesausingadoFinalamethoda kp aa aesCipheroinitiCipheroDECRYPT_MODEmsecretKeymaesCipherogetParametersijj• aa byte[]abyteDecryptedTexta…aaesCipherodoFinalibyteCipherTextj• aa strDecryptedTexta…anewaStringibyteDecryptedTextj• aa Systemooutoprintlni“aDecryptedaTextamessageaisa“alstrDecryptedTextj• aa } aa aa catchaiNoSuchAlgorithmExceptionanoSuchAlgoj aa { aaa Systemooutoprintlni“aNoaSuchaAlgorithmaexistsa“alanoSuchAlgoj• aa } aaa catchaiNoSuchPaddingExceptionanoSuchPadj aaa { aaaa Systemooutoprintlni“aNoaSuchaPaddingaexistsa“alanoSuchPadj• aaa } aaaa catchaiInvalidKeyExceptionainvalidKeyj aaaa { aaaaa Systemooutoprintlni“aInvalidaKeya“alainvalidKeyj• aaaa } aaaa catchaiBadPaddingExceptionabadPaddingj aaaa { aaaaa Systemooutoprintlni“aBadaPaddinga“alabadPaddingj• aaaa } aaaa catchaiIllegalBlockSizeExceptionaillegalBlockSizej aaaa { aaaaa Systemooutoprintlni“aIllegalaBlockaSizea“alaillegalBlockSizej• aaaa } aaaa catchaiInvalidAlgorithmParameterExceptionainvalidParamj aaaa { aaaaa Systemooutoprintlni“aInvalidaParametera“alainvalidParamj• aaaa } a } } A6 - Sensitive Data Exposure 127 1.1.4 References [1] BruceaSchneiermaAppliedaCryptographymaJohnaWileyagaSonsmasndaeditionmar““wo [2] MichaelaHowardmaSteveaLipnermaTheaSecurityaDevelopmentaLifecyclemasqqwmappoasvranasvy [3] oNETaFrameworkaDeveloper’saGuidemaCryptographicaServicesmahttp://msdn2.microsoft.com/en-us/library/93bsk- f9z.aspx [4] MicrosoftaDeveloperaNetworkmaWindowsaDataaProtectionmahttp://msdn2.microsoft.com/en-us/library/ ms995355.aspx [5] SunaDeveloperaNetworkmaJavaaCryptographyaExtensionmahttp://java.sun.com/products/jce/ [6] SunaDeveloperaNetworkmaCryptographicaServiceaProvidersaandaCleanaRoomaImplementationsm http://java.sun. com/products/jce/jce122_providers.html [7] FederalaInformationaProcessingaStandardsmahttp://csrc.nist.gov/publications/fips/ 12.5 Encryption, Hashing & Salting Aacryptographicahashaalgorithmmaalsoacalledaaahashafunctionmaisaaacomputeraalgorithmadesignedatoaprovideaaarandoma mappingafromaanaarbitraryablockaofadataaistringaofabinaryadatajaandareturnaaafixednsizeabitastringaknownaasaaa“messagea digest”aandaachieveacertainasecurityo CryptographicahashingafunctionsaareausedatoacreateadigitalasignaturesmamessageaauthenticationacodesaiMACsjmaothera formsaofaauthenticationaandamanyaotherasecurityaapplicationsainatheainformationainfrastructureoaTheyaareaalsoauseda toastoreauserapasswordsainadatabasesainsteadaofastoringatheapasswordainaclearatextaandahelpapreventadataaleakageaina sessionamanagementaforawebaapplicationsoaTheaactualaalgorithmausedatoacreateaaacryptologyafunctionavariesaperaimn plementationaiSHAnsvwmaSHAnvrsmaetcoj NeveraacceptainaaacodeareviewaanaalgorithmacreatedabyatheaprogrammeraforahashingoaAlwaysauseacryptographicafuncn tionsathataareaprovidedabyathealanguagemaframeworkmaoracommonaitrustedjacryptographicalibrariesoaTheseafunctionsaarea wellavettedaandawellatestedabyaexperienceacryptographerso InatheaUnitedaStatesainasqqqmatheadepartmentaofaCommerceaBureauaofaExportarevisedaencryptionaexportaregulationsoa ThearesultsaofatheanewaexportaregulationsaitathatathearegulationsahaveabeenagreatlyarelaxedoaHoweveraifatheacodeaisatoa beaexportedaoutsideaofatheasourceacountryacurrentaexportalawsaforatheaexportaandaimportacountiesashouldabearevieweda foracomplianceoa CaseainapointaisaifatheaentireamessageaisahashedainsteadaofaaadigitalasignatureaofatheamessageatheaNationalaSecuritya AgencyaiNSAjaconsidersathisaaaquasinencryptionaandaStateacontrolsawouldaapplyo Itaisaalwaysaaavalidachoiceatoaseekalegalaadviceawithinatheaorganizationaifatheacodeareviewaisabeingadoneatoaensurealegala complianceo WithasecurityanothingaisasecureaforeveroaThisaisaespeciallyatrueawithacryptographicahashingafunctionsoaaSomeahashinga algorithmsasuchaasaWindowsaLanManahashesaareaconsideredacompletelyabrokenoaOthersalikeaMDvmawhichainatheapasta wereaconsideredasafeaforapasswordahashausagemahaveaknownaissuesalikeacollisionaattacksainoteathatacollisionaattacksadoa notaaffectapasswordahashesjoaTheacodearevieweraneedsatoaunderstandatheaweaknessesaofaobsoleteahashingafunctionsa asawellaasatheacurrentabestapracticesaforatheachoiceaofacryptographicaalgorithmsoa A6 - Sensitive Data Exposure128 Working with Salts Theamostacommonaprogrammaticaissueawithahashingais– • Notausingaaasaltavalue • Usingaaasaltatheasaltavalueaisatooashort • Sameasaltavalueaisausedainamultipleahashesoa Theapurposeaofaaasaltaisatoamakeaitaharderaforaanaattackeratoaperformaprencomputedahashingaattackaieogomausingarainbowa tablesjoaaTakeaforaexampleathatatheaSHAvrsahasaofa‘password’aisaasashownainarowaraofatable 20maandaanyaattackerawithaaa rainbowatableawillaspotatheahashavalueacorrespondingatoa‘password’oaaTakingaintoaconsiderationaitatakesadaysaoraweeksa toacomputeaaarainbowatableatoavaluesaupatoaaroundayaorarqacharactersmatheaeffortatoaproduceathisatableaisaworthaitawhena anaapplicationaisanotausingaanyasaltso Nowatakeaaascenarioawhereaanaapplicationaaddsaaasaltaofa‘WindowCleaner’atoaallapasswordsaenteredoaaNowatheahashaofa ‘password’abecomesatheahashaofa‘passwordWindowCleaner’mawhichaisashownainarowasaofatable 20oaaThisaisaunlikelyatoabea inatheaattackersarainbowatablemahoweveratheaattackeracananowaspendatheanextarqadaysaiforaexamplejacomputingaaanewa rainbowatableawitha‘WindowCleaner’aonatheaendaofaeveryayatoarqacharacterastringaandatheyaagainacananowadecodeaoura hashedadatabaseaofapasswordso AtaaalastastepmaanaapplicationacanacreateaaarandomasaltaforaeachaentrymaandastoreathatasaltainatheaDBawithatheahasheda passwordoaaNowaforauserrmathearandomasaltaisa‘aqwyhsdfasylsvyxuasyx’mameaningatheapasswordatoabeahashedaisa‘passn wordaqwyhsdfasylsvyxuasyx’mashownainarowataofatable 20maandaforausersmathearandomasaltaisa‘yashyxrstklnf“dydqtw’ma meaningatheapasswordatoabeahashedaisa‘passwordyashyxrstklnf“dydqtw’mashownainarowauaofatableaXmaandarepeatafora allausersoa Nowaanaattackerawouldaneedaaarainbowatableaforaeachausers’apasswordatheyameanatoadecrypta–awhereasabeforeaitatooka rqadaysatoadecryptaallaofatheaDBapasswordsausingatheasameasaltmanowaitatakesarqadaysatoacreateaaarainbowatableafora userr’sapasswordmaandaanotherarqadaysaforausers’sapasswordmaetcoaaIfathereawerearqqmqqqausersmathat’sanowarqqmqqqaxarqa daysa…armqqqmqqqadaysaorasxtyayearsmatoacreatearainbowatablesaforaallatheauserso Asacanabeaseenmatheasaltadoesanotaneedatoabeasecretmaasaitaisatheafactathatauniqueasaltsaareausedaforaeachauserathata slowsadownaanaattackero FingerprintMethod to hash ‘password’ No salt Brq“FtBBBCsuuEBysuur“rxEDqwDwryB“qqyDDq“Bt BEFDrBvEqxt“uCxqwAyBB“yqBrDxxyvEv“xwECqu“B uwDFvFrtswAFvAsEAwDrqtFDqxC“vtyvFFABqCACBCyw Salt = ‘WindowCleaner’ Salt = ‘a0w8hsdfas8ls587uas87’ Salt = ‘8ash87123klnf9d8dq3w’ EwF“DCBrDqxEvursrtvrsqCqsvxBAArAsxwv“DurDCx xFEsDEuCtuvEstCB“xturvFyDFDFFFwAAxFqAEqBDD wrvwqFBqsyEFEDFsBvussBuqEvEEquqAqsstDrwFqwF vAAxwsExCytCFFsstBvAqqADA“t“FBDrywCuAsCDqr rBqAxFExAFywByCAvusqCxAuxBvsAFDsFAwB“BBrxs ssACFtsBtErtFyCutwuuxCtwtwuAvEsBE““yurwArqtA yqvyDutr“vBrCFsx“uDqrsAywACyq“BFExtsvuAysCyC EwCrqsvwDrCuwB“FuvxqqDquqAwACws“qxuwqvyAwtEv qAAFyCyxABCDvCtAAqqCDBDBtrCrqBAwDrsArAx Table 20: Saltausagesaandaassociatedafingerprints A6 - Sensitive Data Exposure 129 Oneawayatoagenerateaaasaltavalueaisausingaaapseudonrandomanumberageneratormaasashownainasample 12.4abelowo Noteathataaasaltavalueadoesanotaneedatoapossessatheaqualityaofaaacryptographicallyasecurearandomnesso Bestapracticesaisatoauseaaacryptographicallyafunctionatoacreateatheasaltmacreateaaasaltavalueaforaeachahashavaluema andaaaminimumavalueaofarsyabitsairwacharactersjoaTheabitsaareanotacostlyasoadon’tasaveaaafewabitsathinkingayoua gainasomethingabackainaperformanceainsteadauseaaavalueaofasvwnbitasaltavalueoaItaisahighlyarecommendedoa Best Practices IndustryaleadingaCryptographer’saareaadvisingathataMDvaandaSHAnrashouldanotabeausedaforaanyaapplicationsoa TheaUnitedaStateaFEDERALaINFORMATIONaPROCESSINGaSTANDARDSaPUBLICATIONaiFIPSjaspecifiesasevenacrypn tographicahashaalgorithmsa—aSHAnrmaSHAnssumaSHAnsvwmaSHAntyumaSHAnvrsmaSHAnvrspssumaandaSHAnvrspsvwa areaapprovedaforafederalauseo aTheacodeareviewerashouldaconsiderathisastandardabecauseatheaFIPSaisaalsoawidelyaadoptedabyatheainformationa technologyaindustryoa TheacodeareviewerashouldaraiseaaaredaflagaifaMDvaandaSHAnraareausedaandaaariskaassessmentabeadoneatoaundern standawhyatheseafunctionsawouldabeausedainsteadaofaotherabetternsuitedahashafunctionsoaFIPSadoesaallowathata MDvacanabeausedaonlyawhenausedaasapartaofaanaapprovedakeyatransportaschemeawhereanoasecurityaisaprovideda byatheaalgorithmo sample 12.5abelowashowsaanaexampleafunctionawhichacouldaimplementaaagenericahashafeatureaforaanaapplican tionoa aaaprivateaintaminSaltSizea…ay• aaaaprivateaintamaxSaltSizea…asu• aaaaprivateaintasaltSize•a aa aaaaprivateabyte[]aGetSaltistringainputja{ aaaaaaaaaaaabyte[]adata• aaaaaaaaaaaabyte[]asaltBytes• aaaaaaaaaaaaRNGCryptoServiceProviderarnga…anewaRNGCryptoServiceProviderij• aaaaaaaaaaaasaltBytesa…anewabyte[saltSize]• aaaaaaaaaaaarngoGetNonZeroBytesisaltBytesj• aaaaaaaaaaaadataa…aEncodingoUTFyoGetBytesiinputj• aaaaaaaaaaaabyte[]adataWithSaltBytesa… aaaaaaaaaaaaaaaanewabyte[dataoLengthalasaltBytesoLength]• aaaaaaaaaaaaforaiintaia…aq•aia”adataoLength•aillj aaaaaaaaaaaaaaaadataWithSaltBytes[i]a…adata[i]• aaaaaaaaaaaaforaiintaia…aq•aia”asaltBytesoLength•aillj aaaaaaaaaaaaaaaadataWithSaltBytes[dataoLengthalai]a…asaltBytes[i]• aaaaaaaaaaaareturnadataWithSaltBytes• }a Sample 12.4 A6 - Sensitive Data Exposure130 Line 1 letsausagetaourahashingaalgorithmaweaareagoingatoauseafromatheaconfigafileoaIfaweauseatheamachineaconfiga fileaouraimplementationawouldabeaserverawideainsteadaofaapplicationaspecificoa Line 3 allowsausatoauseatheaconfigavalueaandasetaitaaccordingaasaourachoiceaofahashingafunctionoaComputHasha couldabeaSHAnsvwaoraSHAnvrso References http://valerieaurora.org/hash.html (Lifetimes of cryptographic hash functions) http://docs.oracle.com/javase/6/docs/api/java/security/SecureRandom.html http://msdn.microsoft.com/en-us/library/system.security.cryptography.rngcryptoserviceprovider.aspx http://csrc.nist.gov/publications/fips/fips180-4/fips-180-4.pdf Ferguson and Schneier (2003) Practical Cryptography (see Chapter 6; section 6.2 Real Hash Functions) 12.6 Reducing the attack surface TheaAttackaSurfaceaofaanaapplicationaisaaadescriptionaofatheaentrypexitapointsmathearolespentitlementsaofatheausersmaanda theasensitivityaofatheadataaheldawithinatheaapplicationoaaForaexamplemaentryapointsasuchaasaloginascreensmaHTMLaformsma fileauploadascreensmaallaintroduceaaalevelaofariskatoatheaapplicationoaaNoteathatatheacodeastructureaalsoaformsapartaofa theaAttackaSurfacemainathatatheacodeacheckingaauthenticationmaoracryptomaetcomaisaexercisedabyacriticalafunctionsaonathea applicationo Description Theaattackasurfaceaofaaasoftwareaenvironmentaisaaadescriptionaofatheaentryapointsawhereaanaattackeracanatryatoamanipun lateaanaapplicationmaitatypicallyatakesatheaformaofaaasystemsadiagramawhereaallaentryapointsaiinterfacesjaareapointedaoutoa AppaCodeaFile– ”addakey…”HashMethod”avalue…”SHAvrs”p— CdaCode– aaar–aapreferredHasha…aHashAlgorithmoCreateiistringjConfigurationManageroAppSettings[“HashMethod”]j• aaas–aaa aaat–aahasha…acomputeHashipreferredHashmatestStringj• aaau–aaa aaav–aaprivateastringacomputeHashiHashAlgorithmamyHashmastringainputja{ aaaw–aaaaaaabyte[]adata• aaax–aaaaaaadataa…amyHashoComputeHashiEncodingoUTFyoGetBytesiinputjj• aaay–aaaaaaasba…anewaStringBuilderij• aaa“–aaaaaaaforaiintaia…aq•aia”adataoLength•aillja{ aarq–aaaaaaaaaaasboAppendidata[i]oToStringi“xs”jj• aarr–aaaaaaa} aars–aaaaaareturnasboToStringij• aart–aa} Sample 12.5 A6 - Sensitive Data Exposure 131 MichaelaHowardaiataMicrosoftjaandaotheraresearchersahaveadevelopedaaamethodaforameasuringatheaAttackaSurfaceaofa anaapplicationmaandatoatrackachangesatoatheaAttackaSurfaceaoveratimemacalledatheaRelativeaAttackaSurfaceaQuotientaiRSQjo ItaisaassumedathatatheaapplicationaAttackaSurfaceaisaalreadyaknownmaprobablyathroughasomeapreviousathreatamodelinga exercisemaoraArchitecturalaRiskaAnalysisoaaThereforatheaentryaandaexitapointsaareaknownmatheasensitivityaofatheadataawithina theaapplicationaisaunderstoodmaandatheavariousausersaofatheasystemmaandatheiraentitlementsmahaveabeenamappedaina relationatoatheafunctionsaandadatao Fromaaacodeareviewapointaofaviewmatheaaimawouldabeatoaensureatheachangeabeingareviewedaisanotaunnecessarilyainn creasingatheaAttackaSurfaceoaaForaexamplemaisatheacodeachangeasuddenlyausingaHTTPawhereaonlyaHTTPSawasauseda beforeﬄaaIsatheacoderadecidingatoawriteatheiraownahashafunctionainsteadaofausingatheaprenexistingaiandawellaexercisedp testedjacentralarepositoryaofacryptoafunctionsﬄaaInasomeadevelopmentaenvironmentsatheaAttackaSurfaceachangesacana beacheckedaduringatheadesignaphaseaifasuchadetailaisacapturedmahoweveraatacodeareviewatheaactualaimplementationaisa reflectedainatheacodeaandasuchaAttackaSurfaceaexposuresacanabeaidentifiedo YouacanaalsoabuildaupaaapictureaofatheaAttackaSurfaceabyascanningatheaapplicationoaForawebaappsayouacanauseaaatoolalikea theaOWASPaZedaAttackaProxyaProjectaiZAPjmaArachnimaSkipfishmawtafaoraoneaofatheamanyacommercialadynamicatestinga andavulnerabilityascanningatoolsaoraservicesatoacrawlayouraappaandamapatheapartsaofatheaapplicationathataareaaccessiblea overatheaweboaaOnceayouahaveaaamapaofatheaAttackaSurfacemaidentifyatheahighariskaareasmathenaunderstandawhatacomn pensatingacontrolsayouahaveainaplaceo Noteathatabackupsaofacodeaandadataaionlinemaandaonaofflineamediajaareaanaimportantabutaoftenaignoredapartaofaaasysn tem’saAttackaSurfaceoaProtectingayouradataaandaIPabyawritingasecureasoftwareaandahardeningatheainfrastructureawillaalla beawastedaifayouahandaeverythingaoveratoabadaguysabyanotaprotectingayourabackupso What to Review WhenareviewingacodeamodulesafromaanaAttackaSurfaceapointaofaviewmasomeacommonaissuesatoalookaoutaforainclude– • DoesatheacodeachangeamodifyatheaattackasurfaceﬄaaByaapplyingatheachangeatoatheacurrentaAttackaSurfaceaofatheaaapn plicationadoesaitaopenanewaportsaoraacceptanewainputsﬄaaIfaitadoesacouldatheachangeabeadoneainaaawayathatadoesanota increaseatheaattackasurfaceﬄaaIfaaabetteraimplementationaexistsathenathatashouldabearecommendedmahoweveraifathereaisa noawayatoaimplementatheacodeawithoutaincreasingatheaAttackaSurfacemamakeasureatheabusinessaknowsaofatheaincreaseda risko • IsatheafeatureaunnecessarilyausingaHTTPainsteadaofaHTTPSﬄ • IsatheafunctionagoingatoabeaavailableatoanonnauthenticatedausersﬄaaIfanoaauthenticationaisanecessaryaforatheafunctiona toabeainvokedmathenatheariskaofaattackersausingatheainterfaceaisaincreasedoaDoesatheafunctionainvokeaaabackendataskathata couldabeausedatoadenyaservicesatoaotheralegitimateausersﬄ o EogoaifatheafunctionawritesatoaaafilemaorasendsaanaSMSmaoracausesaaaCPUaintensiveacalculationmacouldaanaattackerawriteaa scriptatoacallatheafunctionamanyatimesaperasecondaandapreventalegitimateausersaaccessatoathatataskﬄ • AreasearchesacontrolledﬄaaSearchaisaaariskyaoperationaasaitatypicallyaqueriesatheadatabaseaforasomeacriteriaaandareturnsa thearesultsmaifaattackeracanainjectaSQLaintoaqueryathenatheyacouldaaccessamoreadataathanaintendedo • IsaimportantadataastoredaseparatelyafromatrivialadataaiinaDBmafileastoragemaetcjoaaIsatheachangeagoingatoaallowaunauthenn ticatedausersatoasearchaforapubliclyaavailableastorealocationsainaaadatabaseatableainatheasameapartitionaasatheausernamep passwordatableﬄaaShouldathisastorealocationadataabeaputaintoaaadifferentadatabasemaoradifferentapartitionmatoareduceathea riskatoatheadatabaseainformationﬄ A6 - Sensitive Data Exposure132 • IfafileauploadsaareaallowedmaareatheyabeaauthenticatedﬄaaIsatherearatealimitingﬄaaIsathereaaamaximumafileasizeaforaeach uploadaoraaggregateaforaeachauserﬄaDoesatheaapplicationarestrictatheafileauploadsatoacertainatypesaofafileaibyacheckinga MIMEadataaorafileasuffixjoaaIsatheaapplicationaisagoingatoarunavirusacheckingﬄ • Ifayouahaveaadministrationausersawithahighaprivilegemaareatheiraactionsaloggedptrackedainasuchaaawayathatatheyaajacan’t erasepmodifyathealogaandabjacan’tadenyatheiraactionsﬄ o Areathereaanyaalarmsaoramonitoringatoaspotaifatheyaareaaccessingasensitiveadataathatatheyashouldn’tabeﬄaaThisacould aapplyatoaallatypesaofausersmanotaonlyaadministratorso • Willachangesabeacompatibleawithaexistingacountermeasuresmaorasecurityacodemaorawillanewacodepcountermeasures needatoabeadevelopedﬄ • Isatheachangeaattemptingatoaintroduceasomeanonncentralizedasecurityacodeamodulemainsteadaofarenusingaoraextending anaexistingasecurityamoduleﬄ • Isatheachangeaaddingaunnecessaryauseralevelsaoraentitlementsathatawillacomplicateatheaattackasurfaceo • IfatheachangeaisastoringaPIIaoraconfidentialadatamaisaallaofatheanewainformationaabsolutelyanecessaryﬄaaThereaisalittleavalue inaincreasingatheariskatoaanaapplicationabyastoringatheasocialasecurityanumbersaofamillionsaofapeoplemaifatheadataaisanevera usedo • Doesaapplicationaconfigurationacauseatheaattackasurfaceatoavaryagreatlyadependingaonaconfigurationasettingsmaandais thataconfigurationasimpleatoauseaandaalertatheaadministratorawhenatheaattackasurfaceaisabeingaexpandedﬄ • Couldatheachangeabeadoneainaaadifferentawayathatawouldareduceatheaattackasurfacemaioeainsteadaofamakingahelpaitems searchableaandastoringahelpaitematextainaaadatabaseatableabesideatheamainausernameppasswordastoremaprovidingastatica helpatextaonaHTMLapagesareducesatheariskathroughathea‘help’ainterfaceo • Isainformationastoredaonatheaclientathatashouldabeastoredaonatheaserverﬄ 1.2.3 References https://www.owasp.org/index.php/Attack_Surface_Analysis_Cheat_Sheet https://www.owasp.org/index.php/OWASP_Zed_Attack_Proxy_Project http://www.cs.cmu.edu/~wing/publications/Howard-Wing03.pdf A6 - Sensitive Data Exposure 133 A7 134 A7 - Missing Function Level Access Control MostawebaapplicationsaverifyafunctionalevelaaccessarightsabeforeamakingathatafunctionalityavisibleainatheaUIoaHoweverma applicationsaneedatoaperformatheasameaaccessacontrolachecksaonatheaserverawhenaeachafunctionaisaaccessedoaIfarequestsa areanotaverifiedmaattackersawillabeaableatoaforgearequestsainaorderatoaaccessafunctionalityawithoutaproperaauthorizationo 13.1 Authorization AuthorizationaisaasaimportantaasaauthenticationoaAccessatoaapplicationafunctionalityaandaaccessatoaalladataashouldabea authorizedoaForadataaaccessaauthorizationmaapplicationalogicashouldacheckaifatheadataabelongsatoatheaauthenticateda usermaoraifatheauserashouldabeaableatoaaccessathatadatao PlacementaofasecurityachecksaisaaavitalaareaaofareviewainaanaapplicationadesignoaIncorrectaplacementacanarenderathea appliedasecurityacontrolsauselessmathusaitaisaimportantatoareviewatheaapplicationadesignaandadetermineatheacorrectnessa ofasuchachecksoaManyawebaapplicationadesignsaareabasedaonatheaconceptaofaModelnViewnControlleraiMVCjathatahaveaaa centralacontrollerawhichalistensatoaallaincomingarequestaandadelegatesacontrolatoaappropriateaformpbusinessaprocessn ingalogicoaaUltimatelyatheauseraisarenderedawithaaaviewoaInasuchaaalayeredadesignmawhenathereaareamanyaentitiesainvolveda inaprocessingaaarequestmadevelopersacanagoawrongainaplacingatheasecurityacontrolsainatheaincorrectaplacemaforaexamplea someaapplicationadevelopersafeela“view”aisathearightaplaceatoahaveatheaauthorizationachecksoa Authorizationaissuesacoveraaawideaarrayaofalayersainaaawebaapplication•afromatheafunctionalaauthorizationaofaaauseratoa gainaaccessatoaaaparticularafunctionaofatheaapplicationaatatheaapplicationalayermatoatheaDatabaseaaccessaauthorizationa andaleastaprivilegeaissuesaatatheapersistencealayero InamostaofatheaapplicationsathearequestaparametersaoratheaURL’saserveaasasoleafactorsatoadetermineatheaprocessingalogicoa Inasuchaaascenarioatheaelementsainathearequestmawhichaareausedaforasuchaidentificationsmamayabeasubjectatoamanipulan tionaattacksatoaobtainaaccessatoarestrictedaresourcesaorapagesainatheaapplicationo Thereaareatwoamainadesignamethodsatoaimplementsaauthorization–aRoleaBaseaAccessaControlaiRBACjaandaAccessaConn trolaListsaiACLsjoaRBACaisausedawhenaassigningausersatoarolesmaandathenarolesatoapermissionsoaThisaisaaamorealogicala modelingaofaactualasystemaauthorizationoaItaalsoaallowsaadministratorsatoafinengrainaandarencheckarolenpermissionaasn signmentsmawhileamakingasureathataeveryaroleahasatheapermissionsaitaisasupposedatoahaveaiandanothingamoreaoralessjoa ThusaassigningausersatoarolesashouldareduceatheachanceaofahumannerroroaaManyawebaframeworksaallowarolesatoabea assignedatoaloggedainausersmaandacustomacodeacanacheckatheasessionainformationatoaauthorizeafunctionalityabasedaona theacurrentausersaroleo 13.2 Description Itaseemsalogicalatoarestrictatheausersaatatheapagepviewalevelatheyawon’tabeaableatoaperformaanyaoperationainatheaapplin cationoaButawhataifainsteadaofarequestingaforaaapagepviewaanaunauthorizedauseratriesatoarequestaforaanainternalaactiona suchaasatoaaddpmodifyaanyadataainatheaapplicationﬄaItawillabeaprocessedabutathearesultantaviewawillabeadeniedatoathea user•abecauseatheaflawaliesainajustahavingaaaviewabasedaaccessacontrolainatheaapplicationsoaMuchaofatheabusinessalogica processingaiforaaarequestjaisadoneabeforeathea“view”aisaexecutedoaSoathearequestatoaprocessaanyaactionawouldagetapron cessedasuccessfullyawithoutaauthorizationo InaanaMVCabasedasystemagivenathisaissueaisashownainafigure 11abelowmawhereatheaauthenticationacheckaisapresn entainatheaviewaactiono MISSING FUNCTION LEVEL ACCESS CONTROLA7 135A7 - Missing Function Level Access Control Inathisaexampleaneitheratheacontrolleraservletaicentralaprocessingaentityjanoratheaactionaclassesahaveaanyaaccessa controlachecksoaIfatheauserarequestsaanainternalaactionasuchaasaaddauseradetailsmawithoutaauthenticationmaitawilla getaprocessedmabutatheaonlyadifferenceaisathatatheauserawillabeashownaanaerrorapageaasaresultantaviewawillabea disallowedatoatheauseroaAasimilaraflawaisaobservedainaASPoNETaapplicationsawhereatheadevelopersatendatoamixathea codeaforahandlingaPOSTBACK’saandaauthenticationachecksoaUsuallyaitaisaobservedathatatheaauthenticationachecka inatheaASPoNETapagesaareanotaappliedaforaPOSTBACKsmaasaindicatedabelowoaHeremaifaanaattackeratriesatoaaccessathea pageawithoutaauthenticationaanaerrorapageawillabearenderedoaInsteadmaifatheaattackeratriesatoasendaanainternala POSTBACKarequestadirectlyawithoutaauthenticationaitawouldasucceedoa UnusedaoraundeclaredaactionsaorafunctionalityacanapresentainatheaconfigurationafilesoaSuchaconfigurationsathata areanotaexposedaioratestedjaasavalidafeaturesainatheaapplicationaexpandatheaattackasurfaceaandaraiseatheariskatoa theaapplicationoaAnaunusedaconfigurationapresentainaaaconfigurationafileaisashownainasample 13.1mawhereathea ‘TestAction’aatatheaendaofatheafileahasabeenaleftaoverafromatheatestingacycleaandawillabeaexposedatoaexternalausersoaa Itaisalikelyathisaactionawouldanotabeacheckedaonaeveryareleaseaandacouldaexposeaaavulnerabilityo CONTROLLER SERVIET ACTION CLASS EXECUTE{} 1. REQUEST 7. RESPONSE Config.xml 2 READ CONFIG FILE 3 RETURN ACTION MAPPING URL = ACTION Authentication check built inside the view 4 INTANTIATE ACTION CLASS AND CALLS EXECUTE METHOD 5 RETURN DATA TO BE VIEWED/ EDITED 6 RENDER VIEW AND DATA AUTH CHECK VIEW Figure 11: MVCaAccessaControl ”mapping— aa”url—pInsecureDesignpactionpAddUserDetails”purl— aa”action—ActionoUserAction”paction— Sample 13.1 136 Anothera populara featurea seena ina mosta ofa thea designa frameworksa todaya isa dataa bindingma wherea thea requesta parametersagetadirectlyaboundatoatheavariablesaofatheacorrespondingabusinesspcommandaobjectoaBindingaherea meansathatatheainstanceavariablesaofasuchaclassesagetaautomaticallyainitializedawithathearequestaparameteravaln uesabasedaonatheiranamesoaTheaissueawithathisadesignaisathatatheabusinessaobjectsamayahaveavariablesathataarea notadependentaonathearequestaparametersoaSuchavariablesacouldabeakeyavariablesalikeapricemamaxalimitmaroleaetcoa havingastaticavaluesaoradependentaonasomeaserverasideaprocessingalogicoaAathreatainasuchascenariosaisathataanaatn tackeramayasupplyaadditionalaparametersainarequestaandatryatoabindavaluesaforaunexposedavariableaofabusinessa objectaclassoaInathisacaseatheaattackeracanasendaanaadditionala“price”aparameterainathearequestawhichabindsawitha theaunexposedavariablea“price”ainabusinessaobjectmatherebyamanipulatingabusinessalogico What to Review ItaisaimperativeatoaplaceaallavalidationachecksabeforeaprocessingaanyabusinessalogicaandainacaseaofaASPoNETaapplicationsa independentaofatheaPOSTBACKsoaaTheasecurityacontrolsalikeaauthenticationacheckamustabeaplaceabeforeaprocessingaanya requesto TheauseaofafiltersaisarecommendedawhenaauthorizationaisabeingaimplementedainaMVCataandaaboveaasaoNETaMVCata introducedaaamethodainaglobaloasaxacalledaRegisterGlobalFiltersawhichacanabeausedatoadefaultadenyaaccessatoaURL’saina theaapplicationo ItaisarecommendedawhenareviewingaMVCtpuaoNETatoatakeaaalookaatahowaauthorizationaisabeingaimplementedoaaThealinea abovema“filtersoAddinewaSystemoWeboMvcoAuthorizeAttributeijj•”adefaultadeniesaaccessatoaanyarequestawithoutaaavalida aa”success—JSP_WithDesignpSuccessojsp”psuccess— ”pmapping— ”mapping— aa”url—pInsecureDesignpactionpChangePassword”purl— aa”action—ActionoChangePasswordAction”paction— aa”success—JSP_WithDesignpSuccessojsp”psuccess— ”pmapping— ”mapping— aa”url—pInsecureDesignpactionptest”purl— aa”action—ActionoTestAction”paction— aa”success—JSP_WithDesignpSuccessojsp”psuccess— ”pmapping— publicastaticavoidaRegisterGlobalFiltersiGlobalFilterCollectionafiltersj { aaafiltersoAddinewaHandleErrorAttributeijj• aaafiltersoAddinewaSystemoWeboMvcoAuthorizeAttributeijj• } Sample 13.2 A7 - Missing Function Level Access Control 137 sessionoaaIfathisaisaimplementedaweamayaneedatoaprovideaunauthorizedaaccessatoacertainapagesasuchaasaaaregistrationa pagemapublicawelcomeapageaoraaaloginapageoa Theadirectivea“AllowAnonymous”aisausedatoaprovideaaccessatoapublicapagesawithanoavalidasessionarequiredoaaTheacodea mayalookalikeathis– When reviewing code for authorization, the following considerations can be checked for: • EveryaentryapointashouldabeaauthorizedoaEveryafunctionashouldabeaauthorizedoa • Authorizationachecksashouldabeaefficientmaandaimplementedainaaacentralacodeabaseasuchathataitacanabeaapplieda consistentlyoa • InacasesawhereaauthorizationafailsmaaaHTTPauqtanotaauthorizedapageashouldabeareturnedoa • WhenausingaRBACmathereamustabeasomeawayaforatheaapplicationatoareportaonatheacurrentlyaprovisionedausersaofathea systemaandatheiraassociatedarolesoaaThisaallowsatheabusinessatoaperiodicallyaauditatheauseraaccessatoatheasystemaanda ensureaitaisaaccurateoaaForaexamplemaifaaauseraisaprovisionedaasaanaadminaonatheasystemmathenathatauserachangesajobatoa anotheradepartmentmaitacouldabeatheacaseathatatheaadminaroleaisanoalongeraappropriateo • Thereashouldabeaanaeasyamethodatoachangeaoraremoveaaauser’saroleaiinaRBACasystemsjoaaAddingmamodifyingaoraremovn ingaaauserafromaaaroleashouldaresultainaauditalogso • Forarolesathataareahigherariskmaadditionmamodificationaandadeletionaofathosearolesashouldainvolveamultiplealevelsaofaa authorizationaieogoamakerpcheckerjmathisamayabeatrackedawithinatheaapplicationaitselfmaorathroughasomeacentralizeda roleaapplicationoaaBothatheafunctionalityaandacodeaofatheasystemacontrollingarolesashouldabeapartaofatheareviewascopeo • AtaaadesignalevelaattemptatoakeepathearangeaofarolesasimpleoaApplicationsawithamultipleapermissionalevelsprolesaoften increasesatheapossibilityaofaconflictingapermissionasetsaresultingainaunanticipatedaprivilegeso • InaapplicationaarchitecturesawithathickaclientsaiioeoamobileaappsaorabinariesarunningaonaaaPCjadoanotaattemptatoa performaanyaauthorizationainatheaclientacodemaasathisacouldabeabypassedabyaanaattackeroaaInabrowserabasedaapplicationsa doanotaperformaanyaauthorizationadecisionsainaJavaScripto • NeverabaseaauthorizationadecisionsaonauntrustedadataoaaForaexampleadoanotauseaaaheadermaorahiddenafieldmafromathe clientarequestatoadetermineathealevelaofaauthorizationaaauserawillahavemaagainathisacanabeamanipulatedabyaanaattackero • Followatheaprincipleaofa‘completeamediation’mawhereaauthorizationaisacheckedaataeveryastageaofaaafunctionoaaForaexamn plemaifaanaapplicationahasafourapagesatoabrowseathroughatoapurchaseaanaitemaibrowseohtmlmabasketohtmlmainputPayn mentohtmlmamakePaymentohtmljathenacheckauseraauthorizationaataeveryapagemaandastageawithinapagesmainsteadaofaonlya performingaaacheckainatheafirstapageo [AllowAnonymous] aaaapublicaActionResultaLogMeInistringareturnUrlj Sample 13.3 A7 - Missing Function Level Access Control138 • Byadefaultadenyaaccessatoaanyapagemaandathenauseaauthorizationalogicatoaexplicitlyaallowaaccessabasedaonarolesp ACLaruleso • WhereatoaholdaauthorizationadatamaDBaorasessionﬄ • Removeaallaredundantptestpunexposedabusinessalogicaconfigurationsafromatheafile • Theabusinesspformpcommandaobjectsamustahaveaonlyathoseainstanceavariablesathataareadependentaonathe userainputso A7 - Missing Function Level Access Control 139 A8 140 A8 - Cross-Site Request Forgery (CSRF) AaCSRFaattackaforcesaaaloggednonavictim’sabrowseratoasendaaaforgedaHTTParequestmaincludingatheavictim’sasessiona cookieaandaanyaotheraautomaticallyaincludedaauthenticationainformationmatoaaavulnerableawebaapplicationoaThisa allowsatheaattackeratoaforceatheavictim’sabrowseratoageneratearequestsatheavulnerableaapplicationathinksaarea legitimatearequestsafromatheavictimo 14.1 Description CSRFaisaanaattackawhichaforcesaanaendauseratoaexecuteaunwantedaactionsaonaaawebaapplicationainawhichatheyaarea currentlyaauthenticatedoaWithaaalittleahelpaofasocialaengineeringailikeasendingaaalinkaviaaemailpchatjmaanaattackera mayaforceatheausersaofaaawebaapplicationatoaexecuteaactionsaofatheaattacker’sachoosingoaAasuccessfulaCSRFaexn ploitacanacompromiseaendauseradatamaandaprotectedafunctionalitymainatheacaseaofaaanormalaprivilegedauseroaIfathea targetedaendauseraisatheaadministratoraaccountmathisacanacompromiseatheaentireawebaapplicationo Theaimpactaofaaasuccessfulacrossnsitearequestaforgeryaattackaisalimitedatoatheacapabilitiesaexposedabyatheavuln nerableaapplicationoaForaexamplemathisaattackacouldaresultainaaatransferaofafundsmachangingaaapasswordmaorapurn chasingaanaitemainatheauser’sacontextoaInaeffectmaCSRFaattacksaareausedabyaanaattackeratoamakeaaatargetasystema performaaafunctionaifundsaTransfermaformasubmissionaetcojaviaatheatarget’sabrowserawithoutaknowledgeaofathea targetausermaataleastauntilatheaunauthorizedafunctionahasabeenacommittedo CSRFaisanotatheasameaasaXSSaiCrossaSiteaScriptingjmawhichaforcesamaliciousacontentatoabeaservedabyaaatrusteda websiteatoaanaunsuspectingavictimoaCrossnSiteaRequestaForgeryaiCSRFmaaokoaaCnSURFaoraConfusednDeputyjaatn tacksaareaconsideredausefulaifatheaattackeraknowsatheatargetaisaauthenticatedatoaaawebabasedasystemoaTheyaonlya workaifatheatargetaisaloggedaintoatheasystemmaandathereforeahaveaaasmallaattackafootprintoaOtheralogicalaweakn nessesaalsoaneedatoabeapresentasuchaasanoatransactionaauthorizationarequiredabyatheauseroaInaeffectaCSRFaattacksa areausedabyaanaattackeratoamakeaaatargetasystemaperformaaafunctionaiFundsaTransfermaFormasubmissionaetcoojaviaa theatarget’sabrowserawithoutatheaknowledgeaofatheatargetausermaataleastauntilatheaunauthorizedafunctionahasa beenacommittedoaAaprimaryatargetaisatheaexploitationaofa“easeaofause”afeaturesaonawebaapplicationsaiOnenclicka purchasejo ImpactsaofasuccessfulaCSRFaexploitsavaryagreatlyabasedaonathearoleaofatheavictimoaWhenatargetingaaanormalauserma aasuccessfulaCSRFaattackacanacompromiseaendnuseradataaandatheiraassociatedafunctionsoaIfatheatargetedaenda useraisaanaadministratoraaccountmaaaCSRFaattackacanacompromiseatheaentireaWebaapplicationoaTheasitesathataarea morealikelyatoabeaattackedaareacommunityaWebsitesaisocialanetworkingmaemailjaorasitesathatahaveahighadollara valueaaccountsaassociatedawithathemaibanksmastockabrokeragesmabillapayaservicesjoaThisaattackacanahappenaevena ifatheauseraisaloggedaintoaaaWebasiteausingastrongaencryptionaiHTTPSjoaUtilizingasocialaengineeringmaanaattackera willaembedamaliciousaHTMLaoraJavaScriptacodeaintoaanaemailaoraWebsiteatoarequestaaaspecifica‘taskaurl’oaTheataska thenaexecutesawithaorawithoutatheauser’saknowledgemaeitheradirectlyaorabyautilizingaaaCrossnsiteaScriptingaflawa iex–aSamyaMySpaceaWormjo How They Work CSRFaattacksaworkabyasendingaaarogueaHTTParequestafromaanaauthenticatedauser’sabrowseratoatheaapplicationma whichathenacommitsaaatransactionawithoutaauthorizationagivenabyatheatargetauseroaAsalongaasatheauseraisaaun thenticatedaandaaameaningfulaHTTParequestaisasentabyatheauser’sabrowseratoaaatargetaapplicationmatheaapplican tionadoesanotaknowaifatheaoriginaofathearequestaisaaavalidatransactionaoraaalinkaclickedabyatheauseraithatawasmasayma inaanaemailjawhileatheauseraisaauthenticatedatoatheaapplicationoaThearequestawillabeaauthenticatedaasathearequesta fromatheausersabrowserawillaautomaticallyaincludeathea‘Cookie’aheadermawhichaisatheabasisaforaauthenticationoaaSoa CROSS-SITE REQUEST FORGERY (CSRF)A8 141A8 - Cross-Site Request Forgery (CSRF) anaattackeramakesatheavictimaperformaactionsathatatheyadidn’taintendatomasuchaasapurchaseaanaitemoaSample 14.1ashowsaanaexampleaanaHTTPaPOSTatoaaaticketavendoratoapurchaseaaanumberaofaticketso What to Review Thisaissueaisasimpleatoadetectmabutathereamayabeacompensatingacontrolsaaroundatheafunctionalityaofatheaapplicationa whichamayaalertatheauseratoaaaCSRFaattemptoaAsalongaasatheaapplicationaacceptsaaawellaformedaHTTParequestaandathea requestaadheresatoasomeabusinessalogicaofatheaapplicationaCSRFashallaworko Byacheckingatheapagearenderingaweaneedatoaseeaifaanyauniqueaidentifiersaareaappendedatoathealinksarenderedabyathea applicationainatheauser’sabrowseroaIfathereaisanoauniqueaidentifierarelatingatoaeachaHTTParequestatoatieaaaHTTParequestatoa theausermaweaareavulnerableoaSessionaIDaisanotaenoughmaasatheasessionaIDashallabeasentaautomaticallyaifaaauseraclicksaonaaa roguealinkmaasatheauseraisaalreadyaauthenticatedo Prevention Measures That Do NOT Work ExamplesaofaattemptedaCSRFapreventatechniquesawhichaattackersacanabypassaarealistedainatable 21matheseameasuresa shouldanotabeausedainasensitiveaapplicationsaandashouldafailacodeareviewo POSTahttp–ppTicketMeisterocompBuy_ticketohtmaHTTPpror Host–aticketmeister UsernAgent–aMozillapvoqaiMacintosh•aU•aPPCaMacaOSaXaMachnO•jaFirefoxprouor Cookie–aJSPSESSIONID…tuJHURHDy“uLOPqu“vxHRu“ItJEtyt“uqrstK ticketId…ATHXrrtygto…POaBOXarr“yaDUBLINasgamount…rqgdate…rrqusqqy Thearesponseaofatheavendoraisatoaacknowledgeatheapurchaseaofatheatickets– HTTPproqasqqaOK Date–aFrimaqsaMayasqqyarq–qr–sqaGMT Server–aIBM_HTTP_Server ContentnType–atextpxml•charset…ISOnyyv“nr ContentnLanguage–aennUS XnCache–aMISSafromaappnproxynsoproxyoie Connection–aclose ”ﬄxmlaversion…”roq”aencoding…”ISOnyyv“nr”ﬄ— ”pge_data—aTicketaPurchasedmaThankayouaforayouracustomo ”ppge_data— Sample 14.1 Measure Description Using a Secret Cookie RememberathataallacookiesmaevenatheasecretaonesmawillabeasubmittedawithaeveryarequestoaAllaauthenticationatokensa willabeasubmittedaregardlessaofawhetheraoranotatheaendnuserawasatrickedaintoasubmittingathearequestoaFurthern moremasessionaidentifiersaareasimplyausedabyatheaapplicationacontaineratoaassociateathearequestawithaaaspecifica sessionaobjectoaTheasessionaidentifieradoesanotaverifyathatatheaendnuseraintendedatoasubmitathearequesto Table 21: UnsuccessfulaCountermeasuresaForaCsrfaAttacks 142 Passwordmatransferringafundsmapurchasingmatheaapplicationamayanotasimplyaexecuteathearequestmabutashouldaren spondatoathearequestawithaanotherarequestaforatheauser’sapasswordmaoraanaoutnofnbandaiioeoatwonfactorjaauthenn ticationaitemo Preventing CSRF Checkingaifathearequestahasaaavalidasessionacookieaisanotaenoughmatheaapplicationaneedsatoahaveaaauniqueaidenn tifieraassocaitedawithaeveryaHTTParequestasentatoatheaapplicationoaCSRFarequestsaifromaanaattackersaenmailjawilla notahaveathisavalidauniqueaidentifieroaTheareasonaCSRFarequestsawon’tahaveathisauniquearequestaidentifieraisathea uniqueaIDaisarenderedaasaaahiddenafieldmaorawithinatheaURLmaandaisaappendedatoatheaHTTParequestaonceaaalinkp buttonapressaisaselectedoaTheaattackerawillahaveanoaknowledgeaofathisauniqueaIDmaasaitaisarandomaandarendereda dynamicallyaperalinkmaperapageo Application logic to prevent CSRF then include: 1.aAalistaofauniqueaIDsaisacompiledaprioratoadeliveringatheapageatoatheauseroaThealistacontainsaallavalidauniqueaIDs generatedaforaallalinksaonaaagivenapageoaTheauniqueaIDacouldabeaderivedafromaaasecurearandomageneratorasucha asaSecureRandomaforaJsEEaandacouldabeastoredainatheasessionaoraanotheracentralizedacacheo 2. AauniqueaIDaisaappendedatoaeachalinkpformaonathearequestedapageaprioratoabeingadisplayedatoatheausero 3. TheaapplicationachecksaifatheauniqueaIDapassedawithatheaHTTParequestaisavalidaforaaagivenarequestoaIfathe uniqueaIDapassedawithatheaHTTParequestaisavalidaforaaagivenarequesto 4. IfatheauniqueaIDaisanotapresentmaterminateatheauserasessionaandadisplayaanaerroratoatheausero General Recommendation: Synchronizer Token Pattern Inaorderatoafacilitateaaa“transparentabutavisible”aCSRFasolutionmadevelopersaareaencouragedatoaadoptatheaSynn chronizera Tokena Patterna http://www.corej2eepatterns.com/Design/PresoDesign.htmoa Thea synchronizera tokenapatternarequiresatheageneratingaofarandoma“challenge”atokensathataareaassociatedawithatheauser’sacurrenta sessionoaTheseachallengeatokensaareathenainsertedawithinatheaHTMLaformsaandalinksaassociatedawithasensitivea servernsideaoperationsoaWhenatheauserawishesatoainvokeatheseasensitiveaoperationsmatheaHTTParequestashoulda includeathisachallengeatokenoaItaisathenathearesponsibilityaofatheaserveraapplicationatoaverifyatheaexistenceaanda correctnessaofathisatokenoaByaincludingaaachallengeatokenawithaeacharequestmatheadeveloperahasaaastrongacontrola toaverifyathatatheauseraactuallyaintendedatoasubmitatheadesiredarequestsoaInclusionaofaaarequiredasecurityatokenaina HTTParequestsaassociatedawithasensitiveabusinessafunctionsahelpsamitigateaCSRFaattacksaasasuccessfulaexploitan tionaassumesatheaattackeraknowsathearandomlyageneratedatokenaforatheatargetavictim’sasessionoaThisaisaanalon gousatoatheaattackerabeingaableatoaguessatheatargetavictim’sasessionaidentifieroaTheafollowingasynopsisadescribesaaa generalaapproachatoaincorporateachallengeatokensawithinathearequesto WhenaaaWebaapplicationaformulatesaaarequestaibyageneratingaaalinkaoraformathatacausesaaarequestawhenasubmittedaora A8 - Cross-Site Request Forgery (CSRF) ApplicationsacanabeadevelopedatoaonlyaacceptaPOSTarequestsaforatheaexecutionaofabusinessalogicoaTheamisconcepn tionaisathatasinceatheaattackeracannotaconstructaaamaliciousalinkmaaaCSRFaattackacannotabeaexecutedoaUnfortunaten lymathisalogicaisaincorrectoaThereaareanumerousamethodsainawhichaanaattackeracanatrickaaavictimaintoasubmittingaaa forgedaPOSTarequestmasuchaasaaasimpleaformahostedainaanaattacker’sawebsiteawithahiddenavaluesoaThisaformacanabea triggeredaautomaticallyabyaJavaScriptaoracanabeatriggeredabyatheavictimawhoathinksatheaformawilladoasomethinga elseo Salt = ‘a0w8hsdfas8ls587uas87’ URL Rewriting MultinStepatransactionsaareanotaanaadequateapreventionaofaCSRFoaAsalongaasaanaattackeracanapredictaoradeducea eachastepaofatheacompletedatransactionmathenaCSRFaisapossibleo ThisamightabeaseenaasaaausefulaCSRFapreventionatechniqueaasatheaattackeracannotaguessatheavictim’sasessionaIDoa Howevermatheauser’sacredentialaisaexposedaoveratheaURLo Only Accepting POST Requests 143 clickedabyatheauserjmatheaapplicationashouldaincludeaaahiddenainputaparameterawithaaacommonanameasuchaasa“CSRFTon ken”oaTheavalueaofathisatokenamustabearandomlyageneratedasuchathataitacannotabeaguessedabyaanaattackeroaConsidera leveragingatheajavaosecurityoSecureRandomaclassaforaJavaaapplicationsatoagenerateaaasufficientlyalongarandomatokenoa AlternativeagenerationaalgorithmsaincludeatheauseaofasvwnbitaBASEwuaencodedahashesoaDevelopersathatachooseathisa generationaalgorithmamustamakeasureathatathereaisarandomnessaandauniquenessautilizedainatheadataathataisahashedatoa generateathearandomatokeno DependingaonatheariskalevelaofatheaproductmaitamayaonlyagenerateathisatokenaonceaforatheacurrentasessionoaAfterainitiala generationaofathisatokenmatheavalueaisastoredainatheasessionaandaisautilizedaforaeachasubsequentarequestauntilatheasessiona expiresoaWhenaaarequestaisaissuedabyatheaendnusermatheaservernsideacomponentamustaverifyatheaexistenceaandavalidityaofa theatokenainathearequestaasacomparedatoatheatokenafoundainatheasessionoaIfatheatokenawasanotafoundawithinathearequesta oratheavalueaprovidedadoesanotamatchatheavalueawithinatheasessionmathenathearequestashouldabeaabortedmatokenashoulda bearesetaandatheaeventaloggedaasaaapotentialaCSRFaattackainaprogresso ToafurtheraenhanceatheasecurityaofathisaproposedadesignmaconsiderarandomizingatheaCSRFatokenaparameteranameaanda oravalueaforaeacharequestoaImplementingathisaapproacharesultsainatheagenerationaofapernrequestatokensaasaopposedatoa pernsessionatokensoaNotemahowevermathatathisamayaresultainausabilityaconcernsoaForaexamplemathea“Back”abuttonabrowsera capabilityaisaoftenahinderedaasatheapreviousapageamayacontainaaatokenathataisanoalongeravalidoaInteractionawithathisa previousapageawillaresultainaaaCSRFafalseapositiveasecurityaeventaatatheaserveroaRegardlessaofatheaapproachatakenmadeveln opersaareaencouragedatoaprotectatheaCSRFatokenatheasameawayatheyaprotectaauthenticatedasessionaidentifiersmasucha asatheauseaofaSSLvtpTLSo Disclosure of Token in URL ManyaimplementationsaofathisacontrolaincludeatheachallengeatokenainaGETaiURLjarequestsaasawellaasaPOSTarequestsoa Thisaisaoftenaimplementedaasaaaresultaofasensitiveaservernsideaoperationsabeingainvokedaasaaaresultaofaembeddedalinksa inatheapageaoraotherageneraladesignapatternsoaTheseapatternsaareaoftenaimplementedawithoutaknowledgeaofaCSRFaanda anaunderstandingaofaCSRFapreventionadesignastrategiesoaWhileathisacontroladoesahelpamitigateatheariskaofaCSRFaattacksma theauniqueapernsessionatokenaisabeingaexposedaforaGETarequestsoaCSRFatokensainaGETarequestsaareapotentiallyaleakedaata severalalocations–abrowserahistorymaHTTPalogafilesmanetworkaappliancesathatamakeaaapointatoalogatheafirstalineaofaanaHTTPa requestmaandaRefereraheadersaifatheaprotectedasitealinksatoaanaexternalasiteo InathealatteracaseaileakedaCSRFatokenadueatoatheaRefereraheaderabeingaparsedabyaaalinkedasitejmaitaisatriviallyaeasyaforathea linkedasiteatoalaunchaaaCSRFaattackaonatheaprotectedasitemaandatheyawillabeaableatoatargetathisaattackaveryaeffectivelyma sinceatheaRefereraheaderatellsathematheasiteaasawellaasatheaCSRFatokenoaTheaattackacouldabearunaentirelyafromajavascriptma soathataaasimpleaadditionaofaaascriptatagatoatheaHTMLaofaaasiteacanalaunchaanaattackaiwhetheraonaanaoriginallyamaliciousa siteaoraonaaahackedasitejoaThisaattackascenarioaisaeasyatoapreventmathearefererawillabeaomittedaifatheaoriginaofathearequesta ”formaaction…”ptransferodo”amethod…”post”— ”inputatype…”hidden”aname…”CSRFToken”a value…”OWYuNmQwODEuODRjNsQsNTlhMmZlYWEooo wYzUrYWQwMTVhMsJmNGYxYjJiMGIuMjJjZDErZDZooo MGYwMGEwOA……”— … ”pform— Sample 14.2 A8 - Cross-Site Request Forgery (CSRF)144 isaHTTPSoaThereforeathisaattackadoesanotaaffectawebaapplicationsathataareaHTTPSaonlyo TheaidealasolutionaisatoaonlyaincludeatheaCSRFatokenainaPOSTarequestsaandamodifyaservernsideaactionsathatahaveastatea changingaaffectatoaonlyarespondatoaPOSTarequestsoaThisaisainafactawhatatheaRFCaswrwarequiresaforaGETarequestsoaIfasenn sitiveaservernsideaactionsaareaguaranteedatoaonlyaeverarespondatoaPOSTarequestsmathenathereaisanoaneedatoaincludeathea tokenainaGETarequestso Viewstate (ASP.NET) ASPoNETahasaanaoptionatoamaintainayouraViewStateoaTheaViewStateaindicatesatheastatusaofaaapageawhenasubmittedatoa theaserveroaTheastatusaisadefinedathroughaaahiddenafieldaplacedaonaeachapageawithaaa”formarunat…”server”—acontroloa ViewstateacanabeausedaasaaaCSRFadefensemaasaitaisadifficultaforaanaattackeratoaforgeaaavalidaViewstateoaItaisanotaimpossiblea toaforgeaaavalidaViewstateasinceaitaisafeasibleathataparameteravaluesacouldabeaobtainedaoraguessedabyatheaattackeroa HowevermaifatheacurrentasessionaIDaisaaddedatoatheaViewStatemaitathenamakesaeachaViewstateauniquemaandathusaimmunea toaCSRFo ToauseatheaViewStateUserKeyapropertyawithinatheaViewstateatoaprotectaagainstaspoofedapostabacksaaddatheafollowinga inatheaOnInitavirtualamethodaofatheapagenderivedaclassaiThisapropertyamustabeasetainatheaPageoInitaeventj ToakeyatheaViewstateatoaanaindividualausingaaauniqueavalueaofayourachoiceausea“iPageoViewStateUserKeyj”oaaThisamusta beaappliedainaPage_InitabecauseatheakeyahasatoabeaprovidedatoaASPoNETabeforeaViewstateaisaloadedoaThisaoptionahasa beenaavailableasinceaASPoNETaroroaaHowevermathereaarealimitationsaonathisamechanismoaSuchaasmaViewStateaMACsaareaonlya checkedaonaPOSTbackmasoaanyaotheraapplicationarequestsanotausingapostbacksawillahappilyaallowaCSRFo Double Submit Cookies Doubleasubmittingacookiesaisadefinedaasasendingaaarandomavalueainabothaaacookieaandaasaaarequestaparametermawitha theaserveraverifyingaifatheacookieavalueaandarequestavalueaareaequalo Whenaaauseraauthenticatesatoaaasitematheasiteashouldagenerateaaaicryptographicallyastrongjapseudorandomavalueaanda setaitaasaaacookieaonatheauser’samachineaseparateafromatheasessionaidoaTheasiteadoesanotahaveatoasaveathisavalueainaanya wayoaTheasiteashouldathenarequireaeveryasensitiveasubmissionatoaincludeathisarandomavalueaasaaahiddenaformavalueaiora otherarequestaparameterjaandaalsoaasaaacookieavalueoaAnaattackeracannotareadaanyadataasentafromatheaserveraoramodifya cookieavaluesmaperatheasamenoriginapolicyoaThisameansathatawhileaanaattackeracanasendaanyavalueaheawantsawithaaamalin ciousaCSRFarequestmatheaattackerawillabeaunableatoamodifyaorareadatheavalueastoredainatheacookieoaSinceatheacookieavaluea andathearequestaparameteraoraformavalueamustabeatheasamematheaattackerawillabeaunableatoasuccessfullyasubmitaaaforma unlessaheaisaableatoaguessathearandomaCSRFavalueo DirectaWebaRemotingaiDWRjaJavaalibraryaversionasoqahasaCSRFaprotectionabuiltainaasaitaimplementsatheadoubleacookiea submissionatransparentlyo TheaaboveaCSRFapreventsarelyaonatheauseaofaaauniqueatokenaandatheaSamenOriginaPolicyatoapreventaCSRFabyamaintainn ingaaasecretatokenatoaauthenticatearequestsoaTheafollowingamethodsacanapreventaCSRFabyarelyingauponasimilararulesa protectedaoverrideaOnInitiEventArgsaeja{ aaaaabaseoOnInitiej•a aaaaaifaiUseroIdentityoIsAuthenticatedj aaaaaViewStateUserKeya…aSessionoSessionID•a} Sample 14.3 A8 - Cross-Site Request Forgery (CSRF) 145 thataCSRFaexploitsacananeverabreako a Checking The Referer Header AlthoughaitaisatrivialatoaspoofathearefereraheaderaonayouraownabrowsermaitaisaimpossibleatoadoasoainaaaCSRFaattackoaCheckn ingathearefereraisaaacommonlyausedamethodaofapreventingaCSRFaonaembeddedanetworkadevicesabecauseaitadoesa notarequireaaapernuserastateoaThisamakesaaarefereraaausefulamethodaofaCSRFapreventionawhenamemoryaisascarceoaThisa methodaofaCSRFamitigationaisaalsoacommonlyausedawithaunauthenticatedarequestsmasuchaasarequestsamadeaprioratoa establishingaaasessionastateawhichaisarequiredatoakeepatrackaofaaasynchronizationatokeno HowevermacheckingathearefereraisaconsideredatoabeaaaweakerafromaofaCSRFaprotectionoaForaexamplemaopenaredirecta vulnerabilitiesacanabeausedatoaexploitaGETnbasedarequestsathataareaprotectedawithaaarefereracheckaandasomeaorganizan tionsaorabrowseratoolsaremoveareferreraheadersaasaaaformaofadataaprotectionoaThereaareaalsoacommonaimplementationa mistakesawitharefererachecksoaForaexampleaifatheaCSRFaattackaoriginatesafromaanaHTTPSadomainathenathearefererawillabea omittedoaInathisacaseathealackaofaaarefererashouldabeaconsideredatoabeaanaattackawhenathearequestaisaperformingaaastatea changeoaAlsoanoteathatatheaattackerahasalimitedainfluenceaoverathearefereroaForaexamplemaifatheavictim’sadomainaisa“siteo com”athenaanaattackerahaveatheaCSRFaexploitaoriginateafroma“siteocomoattackerocom”awhichamayafoolaaabrokenareferera checkaimplementationoaXSSacanabeausedatoabypassaaarefererachecko InashortmarefereracheckingaisaaareasonableaformaofaCSRFaintrusionadetectionaandapreventionaevenathoughaitaisanotaaa completeaprotectionoaRefereracheckingacanadetectasomeaattacksabutanotastopaallaattacksoaForaexamplemaifatheaHTTPa referreraisafromaaadifferentadomainaandayouaareaexpectingarequestsafromayouradomainaonlymayouacanasafelyablockathata requesto Checking The Origin Header TheaOriginaHTTPaHeaderastandardawasaintroducedaasaaamethodaofadefendingaagainstaCSRFaandaotheraCrossnDomaina attacksoaUnlikeatheareferermatheaoriginawillabeapresentainaHTTParequestathataoriginatesafromaanaHTTPSaURLoaIfatheaorigina headeraisapresentmathenaitashouldabeacheckedaforaconsistencyo Challenge-Response ChallengenResponseaisaanotheradefenseaoptionaforaCSRFoaAsamentionedabeforeaitaisatypicallyausedawhenatheafuncn tionalityabeingainvokedaisahighariskoaaWhileachallengenresponseaisaaaveryastrongadefenseatoaCSRFaiassumingapropera implementationjmaitadoesaimpactauseraexperienceoaForaapplicationsainaneedaofahighasecuritymatokensaitransparentjaanda challengenresponseashouldabeausedaonahighariskafunctionso The following are some examples of challenge-response options: • CAPTCHA • RenAuthenticationaipasswordj • OnentimeaToken No Cross-Site Scripting (XSS) Vulnerabilities CrossnSiteaScriptingaisanotanecessaryaforaCSRFatoaworkoaHowevermaanyacrossnsiteascriptingavulnerabilityacanabeausedatoa defeatatokenmaDoublenSubmitacookiemarefereraandaoriginabasedaCSRFadefensesoaThisaisabecauseaanaXSSapayloadacana simplyareadaanyapageaonatheasiteausingaaaXMLHttpRequestaandaobtainatheageneratedatokenafromathearesponsemaandainn cludeathatatokenawithaaaforgedarequestoaThisatechniqueaisaexactlyahowatheaMySpaceaiSamyjawormadefeatedaMySpace’sa antiaCSRFadefensesainasqqvmawhichaenabledatheawormatoapropagateoaXSSacannotadefeatachallengenresponseadefensesa suchaasaCaptchamarenauthenticationaoraonentimeapasswordsoaItaisaimperativeathatanoaXSSavulnerabilitiesaareapresentatoa ensureathataCSRFadefensesacan’tabeacircumventedo A8 - Cross-Site Request Forgery (CSRF)146 A9 147A9 - Using Components with Known Vulnerabilities Componentsmasuchaasalibrariesmaframeworksmaandaotherasoftwareamodulesmaalmostaalwaysarunawithafullaprivilegn esoaIfaaavulnerableacomponentaisaexploitedmasuchaanaattackacanafacilitateaseriousadataalossaoraserveratakeoveroa Applicationsausingacomponentsawithaknownavulnerabilitiesamayaundermineaapplicationadefensesaandaenablea aarangeaofapossibleaattacksaandaimpactso 15.1 Description Todayaitawouldabearareaforaanaapplicationaorasoftwareacomponentatoabeadevelopedawithoutathearenuseaofasomea openasourceaorapaidnforalibraryaoraframeworkoaaThisamakesaaalotaofasenseaasatheseaframeworksaandalibrariesaarea alreadyadevelopedaandaworkingmaandahaveahadaaagoodadegreeaofatestingaappliedoaaHoweveratheseathirdapartya componentsacanaalsoabeaaasourceaofasecurityavulnerabilitiesawhenaanaattackerafindsaaaflawainatheacomponentsa codemainafactathisaflawahasaaddedaattractionasinceatheaattackeraknowsatheaexploitawillaworkaonaeveryoneawhoaisa usingatheacomponento Thisaissueahasamaturedatoasuchaaastateathataflawspexploitsaforapopularaframeworksmalibrariesaandaoperatingasysn temsaareasoldaonaundergroundamarketsaforalargeasumsaofamoneyo What to Review Thereaisareallyanoacodeatoareviewaforathisatopicmaunlessayouraorganizationahasatakenaitauponaitselfatoareviewatheacodeaofa theacomponentaiassumingaitsaopenasourceaandanotaaaclosedasourceathirdapartyalibraryjmainawhichacaseatheacodeareviewa wouldabeasimilaratoaanyaotheraauditareviewoaaHoweveracodeareviewacanabeausedawithinathealargeracompanynwideatrackn ingaoraauditamechanismsathataletsatheaorganizationaknowawhatathirdapartyacodeaitaisausingo Regardlessaofatheasizeaofacompanymatheauseaofathirdapartyacomponentsmaandatheiraversionsmashouldabeatrackedatoaenn sureatheaorganizationacanabeaalertedawhenaanyasecurityavulnerabilitiesaareaflaggedoaaForasmalleracompaniesawitharaora saproductsathisatrackingacouldabeaasaeasyaasaaaspreadsheetaorawikiapagemahoweveraforalargeracompaniesawitharqqsaofa applicationsaoraproductsmatheataskaofatrackingadeveloperauseaofathirdapartyaframeworksaandalibrariesaisaequallyaasalargea asatheariskaposedabyathosealibrarieso IfaaacompanyahasasqaproductsaandaeachaofathoseaproductsauseavaorawathirdapartyacomponentsaieogoaApacheawebaserversma OpenSSLacryptoalibrariesmaJavaalibrariesaforaregexaandaDBainteractionsmaetcojathataleavesatheacompanyawithaoverarqqa externalasourcesawhereasecurityavulnerabilitiesacanacomeafromoaaIfatheacompanyasuddenlyahearsaofaaaheartbleedatypea vulnerabilitymaitahasatoabeaableatoareactaandaupgradeathoseaaffectedaapplicationsmaoratakeaotheracountermeasuresmatoa protectaitselfaandaitsacustomerso Controlling the Ingredients Oneamethodausedabyalargeracompaniesatoalimitatheiraexposureatoathirdapartyavulnerabilitiesaisatoacontrolawhichalibrarn iesacanabeausedabyatheiradevelopersoaaForaexampleatheyacouldaspecifyathatadevelopersashouldauseaaacertainaversionaofa OpenSSLaasatheacryptoalibraryainsteadaofaotheraoptionsoaa Thisaallowsamanagementaandariskacontrollersatoaknowatheirariskaprofileatoavulnerabilitiesaonatheamarketmaifaaabugaapn pearsainabouncycastlematheyaknowatheyaareanotaexposedaiioeoasomeadeveloperadidn’tauseabouncycastleaonaoneaofathea productsmabecauseait’sanotaonathealistaofacryptoalibrariesatoausejoaaOnatheaotherahandmaifathereaisaaabugainaOpenSSLmaallatheira eggsaareainathatabasketaandatheyaneedatoaupgradeaimmediatelyo USING COMPONENTS WITH KNOWN VULNERABILITIESA9 148 A9 - Using Components With Known Vulnerabilities Thereawillaobviouslyabeatechnicalachallengesatoalimitingatheachoicesaofathirdapartyacomponentsmaandasuchaaapolicya couldabeaunpopularawithadevelopersawho’llawantatoauseathealatestaandagreatestaframeworkmabutatheafirstastepatoasecurn ingaaaproductaisaknowingawhataingredientsayou’veamadeaitawitho HowacanasuchaaapolicyabeatrackedaoraenforcedﬄaaAtasomeapointathealibraryaoraframeworkmainatheaformaofaodllposoaoraasa sourceacodemawillabeaintegratedaintoatheacodelineo Such integrations should be subject to code review, and as a task of this code review the reviewer can check: 1. Thealibraryaisaoneathatacanabeausedainatheaproductasuiteaioramaybeaisaalreadyausedaandatheadeveloperaisasimplya unawaremainawhichacaseatheareviewashouldabearejectedaandatheaoriginalaintegrationausedj 2.aAnyatrackingaoraauditingasoftwareaievenaaabasicaspreadasheetjaisaupdatedatoareflectathatatheaproductaisausingathea thirdapartyalibraryoaaThisaallowsaforarapidaremediationaifaaavulnerabilityaappearsmameaningatheaproductawillabeapatchedoa SledgeHammer to Crack a Nut Onealastaresponsibilityaofatheareviewerawillabeatoaensureatheacorrectathirdapartyalibraryaisabeingausedaforatheafunctionn alityaneededoaaManyalibrariesacomeawithavastaamountsaofafunctionalityawhichamayanotabeausedoaaForaexamplemaisathea developeraincludingaaalibraryatoaperformatheiraregex’smabutawhichaalsoawillaincludeaotherafunctionalityanotausedpneededa byatheaapplicationﬄaaThisaincreasesatheaattackasurfaceaofatheaapplicationaandacanacauseaunexpectedabehaviorawhena thataextraacodeaopensaaaportaandacommunicatesatoatheainterneto Ifatheareviewerathinksatooamuchafunctionalitypcodeaisabeingaintroducedatheyacanaadviseatoaturnaoffanonnusedafunctionn alitymaorabetterastillafindaaawayatoanotaincludeathatafunctionalityainatheaproductaieogoabyastrippingaoutacodemaorahardcodinga branchesasoaunusedafunctionsaareaneverausedjo TheaOWASPaprojecta“OWASPaDependencyaCheck”acanaprovideaaameasureaofaautomationaforalibraryacheckinga ihttps–ppwwwoowaspoorgpindexophppOWASP_Dependency_Checkj 149 A10 150 Webaapplicationsafrequentlyaredirectaandaforwardausersatoaotherapagesaandawebsitesmaandauseauntrustedadataatoaden termineatheadestinationapagesoaWithoutaproperavalidationmaattackersacanaredirectavictimsatoaphishingaoramalwareasitesma orauseaforwardsatoaaccessaunauthorizedapageso 16.1 Description Unvalidatedaredirectsaandaforwardsaareapossibleawhenaaawebaapplicationaacceptsauntrustedainputathatacouldacausea theawebaapplicationatoaredirectathearequestatoaaaURLacontainedawithinauntrustedainputoaByamodifyingauntrustedaURLa inputatoaaasitemaanaattackeramayasuccessfullyalaunchaaaphishingascamaandastealauseracredentialso Asatheaserveranameainatheamodifiedalinkaisaidenticalatoatheaoriginalasitemaphishingaattemptsamayahaveaaamoreatrustn worthyaappearanceoaInvalidatedaredirectaandaforwardaattacksacanaalsoabeausedatoamaliciouslyacraftaaaURLathatawoulda passatheaapplication’saaccessacontrolacheckaandathenaforwardatheaattackeratoaprivilegedafunctionsathatatheyawoulda normallyanotabeaableatoaaccesso Redirects Redirectafunctionalityaonaaawebasiteaallowsaaauser’sabrowseratoabeatoldatoagoatoaaadifferentapageaonatheasiteoaaThisacanabea doneatoaimproveauserainterfaceaoratrackahowausersaareanavigatingatheasiteoa ToaprovideathearedirectafunctionalityaaasiteamayahaveaaaspecificaURLatoaperformathearedirect– • http://www.example.com/utility/redirect.cgi ThisapageawillatakeaaaparameteraifromaURLaoraPOSTabodyjaofa‘URL’aandawillasendabackaaamessageatoatheauser’sabrowsera toagoatoathatapagemaforaexample– • http://www.example.com/utility/redirect.cgi?URL=http://www.example.com/viewtxn.html Howeverathisacanabeaabusedaasaanaattackeracanaattemptatoamakeaaavalidauseraclickaonaaalinkathataappearsatoabeafora wwwoexampleocomabutawhichawillainvokeathearedirectafunctionalityaonaexampleocomatoacauseatheausersabrowseratoagoa toaaamaliciousasiteaioneathatacouldalookalikeaexampleocomaandatrickatheauseraintoaenteringasensitiveaoraauthenticationa information– • http://www.example.com/utiltiy/redirect cgi?URL=http://attacker.com/fakelogin.html Forwards Forwardsaareasimilaratoaredirectsahoweveratheanewapageaisanotaretrievedabyatheausersabrowseraiasaoccurredawithathea redirectjabutainsteadatheaserveraframeworkawillaobtainatheaforwardedapageaandareturnaitatoatheausersabrowseroaaThisaisa achievedabya‘forward’acommandsawithinaJavaaframeworksaieogoaStrutsjaora‘ServeroTransfer’ainaoNetoaaAsatheaforwardaisapern formedabyatheaserveraframeworkaitselfmaitalimitsathearangeaofaURLsatheaattackeracanaexploitatoatheacurrentawebasiteaiioeoa attackeracannota‘forward’atoaattackerocomjmahoweverathisaattackacanabeausedatoabypassaaccessacontrolsoaaForaexamplema whereaaasiteasendsatheaforwardedapageainathearesponse– • Ifapurchasingmaforwardatoa‘purchaseodo’ • Ifacancellingmaforwardatoa‘cancelledodo’ Thisawillathenabeapassedaasaaaparameteratoatheawebasite– • http://www.example.com/txn/acceptpayment.html?FWD=purchase UNVALIDATED REDIRECTS AND FORWARDSA10 A10 - Unvalidated Redirects And Forwards 151A10 - Unvalidated Redirects And Forwards Ifainsteadaanaattackerausedatheaforwardatoaattemptatoaaccessatoaaadifferentapageawithinatheawebasitemaeogoaadminodomathena theyamayaaccessapagesathatatheyaareanotaauthorizedatoaviewmabecauseaauthorizationaisabeingaappliedaonathea‘acceptn payment’apagemainsteadaofatheaforwardedapageo What to Review IfaanyapartaofatheaURLabeingaforwardedmaoraredirectedmatoaisabasedaonauserainputmathenatheasiteacouldabeaatariskoaEnsure– • Allaredirectspforwardsaareaconstructedabasedaonaaawhitelistmaor • Allaredirtectspforwardsauseareletiveapathsatoaensureatheyastayaonatheatrustedasiteaa Redirects TheafollowingaexamplesademonstrateaunsafearedirectaandaforwardacodeoaTheafollowingaJavaacodeareceivesatheaURLa fromathea‘url’aparameteraandaredirectsatoathataURLo TheafollowingaPHPacodeaobtainsaaaURLafromatheaqueryastringaandathenaredirectsatheauseratoathataURLo AasimilaraexampleaofaCdaoNETaVulnerableaCode– Theaaboveacodeaisavulnerableatoaanaattackaifanoavalidationaoraextraamethodacontrolsaareaappliedatoaverifyathea certaintyaofatheaURLoaThisavulnerabilityacouldabeausedaasapartaofaaaphishingascamabyaredirectingausersatoaaaman liciousasiteoaIfauserainputahasatoabeausedaasapartaofatheaURLatoabeausedmathenaapplyastrictavalidationatoatheainputma ensuringaitacannotabeausedaforapurposesaotherathanaintendedo Noteathatavulnerableacodeadoesanotaneedatoaexplicitlyacallaaa‘redirect’afunctionmabutainsteadacouldadirectlyamodin fyathearesponseatoacauseatheaclientabrowseratoagoatoathearedirectedapageoaCodeatoalookaforaisashownain table 22o responseosendRedirectirequestogetParameteri“url”jj• Sample 16.1 eredirect_urla…ae_GET[‘url’]• aheaderi“Location–a“aoaeredirect_urlj• Sample 16.2 stringaurla…arequestoQueryString[“url”]• aResponseoRedirectiurlj• Sample 16.3 152 WhereaanaattackerahasapostedaaaredirectingaURLaonaaaforummaorasendsainaanaenmailmatheawebasiteacanacheckathea refereraheaderatoaensureatheauseraisacomingafromaaapageawithinatheasitemaalthoughathisacountermeasureawillanota applyaifatheamaliciousaURLaisacontainedawithinatheasiteaitselfo ConsideracreatingaaawhitelistaofaURLsaoraoptionsathataaaredirectaisaallowedatoagoatomaoradenyatheaabilityaforathea userainputatoadetermineatheaschemeaorahostnameaofathearedirectoaaAasiteacouldaalsoaencodeaioraencryptjathea URLavalueatoabearedirectedatoasuchathataanaattackeracannotaeasilyacreateaaamaliciousaURLaparameterathatmawhena unencodedaioraunencyptedjmawillabeaconsideredavalido Forwards Theacountermeasureaforaforwardsaisatoaeitherawhitelistathearangeaofapagesathatacanabeaforwardedatoaisimilaratoa redirectsjaandatoaenforceaauthenticationaonatheaforwardedapageaasawellaasatheaforwardingapageoaaThisameansa thataevenaifaanaattackeramanagesatoaforceaaaforwardatoaaapageatheyashouldanotahaveaaccessatomatheaauthentican tionacheckaonatheaforwardedapageawilladenyathemaaccesso Note on J2EE Thereaisaaanotedaflawarelatedatoathea“sendRedirect”amethodainaJsEEaapplicationsoaForaexample– • responseosendRedirecti“homeohtml”j• Thisamethodaisausedatoasendaaaredirectionaresponseatoatheauserawhoathenagetsaredirectedatoatheadesiredaweba componentawhoseaURLaisapassedaanaargumentatoatheamethodoaOneasuchamisconceptionaisathataexecutionaflowa inatheaServletpJSPapageathataisaredirectingatheauserastopsaafteraaacallatoathisamethodoaNoteathataifathereaisacodea presentaafterathea‘If’aconditionaitawillabeaexecutedo TheafactathataexecutionaofaaaservletaoraJSPacontinuesaevenaafterasendRedirectijamethodmaalsoaappliesatoaForwarda methodaofatheaRequestDispatcheraClassoaHoweverma”jsp–forward—atagaisaanaexceptionmaitaisaobservedathatathea executionaflowastopsaafteratheauseaofa”jsp–forward—atago Afteraissueaaaredirectaoraforwardmaterminateacodeaflowausingaaa“return”astatemento References • OWASPaArticleaonaOpenaRedirectsahttps://www.owasp.org/index.php/Open_redirect Method of Redirection Description Redirect Response (note 301 and 307 responses will also cause a redirect) HTTPproratqsaFound Location–ahttp–ppwwwoattackerocomppageohtml Meta Tag ”html—”head— ”metaahttpnequiv…”Refresh” content…”q•url…http–ppattackerocomppageohtml”— JavaScript Refresh Header ”scriptatype…”textpjavascript”— ”b— windowolocation…”http–ppattackerocomppageohtml” ppnn— HTTPprorasqqaOK Refresh…q•aurl…http–ppattackerocomppageohtml Table 22: RedirectaRisks A10 - Unvalidated Redirects And Forwards 153 • CWEaEntryawqraonaOpenaRedirectsahttp://cwe.mitre.org/data/definitions/601.html • WASCa Articlea ona URLa Redirectora Abusea http://projects.webappsec.org/w/page/13246981/URL%20Redi- rector%20Abuse • Googleablogaarticleaonatheadangersaofaopenaredirectsahttp://googlewebmastercentral.blogspot. com/2009/01/open-redirect-urls-is-your-site-being.html • PreventingaOpenaRedirectionaAttacksaiCdjahttp://www.asp.net/mvc/tutorials/security/preventing-open-re- direction-attacks A10 - Unvalidated Redirects And Forwards154 HTML 5 HTMLvawasacreatedatoareplaceaHTLMLumaXHTMLaandatheaHTMLaDOMaLevelasoaTheamainapurposeaofathisanewastann dardaisatoaprovideadynamicacontentawithoutatheauseaofaextraaproprietaryaclientasideapluginsoaThisaallowsadesignersa andadevelopersatoacreateaexceptionalasitesaprovidingaaagreatauseraexperienceawithoutahavingatoainstallaanyaaddin tionalaplugninsaintoatheabrowsero 17.1 Description Ideallyausersashouldahaveathealatestawebabrowserainstalledabutathisadoesanotahappensaasaregularlyaasasecurityaexn pertsaadvicemathereforeatheawebsiteashouldaimplementasalayeracontrolsmaonealayeraindependentafromabrowseratypema secondmaasaanaadditionalacontrolo What to Review: Web Messaging WebaMessagingaialsoaknownaasaCrossaDomainaMessagingjaprovidesaaameansaofamessagingabetweenadocumentsa fromadifferentaoriginsainaaawayathataisagenerallyasaferathanatheamultipleahacksausedainatheapastatoaaccomplishathisa taskoaaTheacommunicationaAPIaisaasafollows– However, there are still some recommendations to keep in mind: • Whenapostingaaamessagemaexplicitlyastateatheaexpectedaoriginaasatheasecondaargumentatoa‘postMessage’arathera thana‘k’ainaorderatoapreventasendingatheamessageatoaanaunknownaoriginaafteraaaredirectaorasomeaotherameansaofathea targetawindow’saoriginachangingo • Theareceivingapageashouldaalways– o Checkathea‘origin’aattributeaofatheasenderatoaverifyatheadataaisaoriginatingafromatheaexpectedalocationo o Performainputavalidationaonathea‘data’aattributeaofatheaeventatoaensureathatait’sainatheadesiredaformato • Don’taassumeayouahaveacontrolaoverathea‘data’aattributeoaAasingleaCrossaSiteaScriptingaflawainatheasendingapagea allowsaanaattackeratoasendamessagesaofaanyagivenaformato • Bothapagesashouldaonlyainterpretatheaexchangedamessagesaasa‘data’oaNeveraevaluateapassedamessagesaasacodeaieogoa viaa‘evalij’jaorainsertaitatoaaapageaDOMaieogoaviaa‘innerHTML’jmaasathatawouldacreateaaaDOMnbasedaXSSavulnerabilityo • Toaassignatheadataavalueatoaanaelementmainsteadaofausingaanainsecureamethodalikea‘elementoinnerHTMLa…adata’mausea theasaferaoption–a‘elementotextContenta…adata•’ • CheckatheaoriginaproperlyaexactlyatoamatchatheaFQDNisjayouaexpectoaNoteathatatheafollowingacode–a‘aifimessageo orginoindexOfi“oowaspoorg”jb…nrja{apkaoooakpa}’aisaveryainsecureaandawillanotahaveatheadesiredabehavioraasa‘wwwoowaspo orgoattackerocom’awillamatcho • Ifayouaneedatoaembedaexternalacontentpuntrustedagadgetsaandaallowauserncontrolledascriptsaiwhichaisahighlya discouragedjmaconsiderausingaaaJavaScriptarewritingaframeworkasuchaasaGoogle’saCajaaoracheckatheainformationa onasandboxedaframeso HTML5 155HTML 5 What to Review: Cross Origin Resource Sharing CrossaOriginaResourceaSharingaoraCORSaisaaamechanismathataenablesaaawebabrowseratoaperforma“crossndomain”a requestsausingatheaXMLHttpRequestaLsaAPIainaaacontrolledamanneroaInatheapastmatheaXMLHttpRequestaLraAPIa onlyaallowedarequestsatoabeasentawithinatheasameaoriginaasaitawasarestrictedabyatheasameaoriginapolicyo CrossnOriginarequestsahaveaanaOriginaheaderathataidentifiesatheadomainainitiatingathearequestaandaisaautomatn icallyaincludedabyatheabrowserainathearequestasentatoatheaserveroaCORSadefinesatheaprotocolabetweenaaaweba browseraandaaaserverathatawilladetermineawhetheraaacrossnoriginarequestaisaallowedoaInaorderatoaaccomplisha thisagoalmathereaareaHTTPaheadersathataprovideainformationaonatheamessagingacontextaincluding–aOriginmaAcn cessnControlnRequestnMethodma AccessnControlnRequestnHeadersma AccessnControlnAllownOriginma AccessnConn trolnAllownCredentialsmaAccessnControlnAllownMethodsmaAccessnControlnAllownHeaderso TheaCORSaspecificationamandatesathataforanonasimplearequestsmasuchaasarequestsaotherathanaGETaoraPOSTaorarequestsa thatausesacredentialsmaaaprenflightaOPTIONSarequestamustabeasentainaadvanceatoacheckaifatheatypeaofarequestawillahavea aanegativeaimpactaonatheadataoaTheaprenflightarequestachecksatheamethodsmaheadersaallowedabyatheaservermaandaifa credentialsaareapermittedmabasedaonathearesultaofatheaOPTIONSarequestmatheabrowseradecidesawhetherathearequestaisa allowedaoranotoa Items to note when reviewing code related to CORS includes: • EnsureathataURLsarespondingawitha‘AccessnControlnAllownOrigin–ak’adoanotaincludeaanyasensitiveacontentaorainforman tionathatamightaaidaattackerainafurtheraattacksoaUseathea‘AccessnControlnAllownOrigin’aheaderaonlyaonachosenaURLsathata needatoabeaaccessedacrossndomainoaDon’tauseatheaheaderaforatheawholeadomaino • Allowaonlyaselectedmatrustedadomainsainathea‘AccessnControlnAllownOrigin’aheaderoaPreferawhitelistingadomainsaovera blacklistingaoraallowingaanyadomainaidoanotausea‘k’awildcardanorablindlyareturnathea‘Origin’aheaderacontentawithoutaanya checksjo • KeepainamindathataCORSadoesanotapreventathearequestedadataafromagoingatoaanaunauthenticatedalocationoaIt’sastilla importantaforatheaserveratoaperformausualaCrossnSiteaRequestaForgeryapreventiono • WhileatheaRFCarecommendsaaaprenflightarequestawithathea‘OPTIONS’averbmacurrentaimplementationsamightanotapern formathisarequestmasoait’saimportantathata“ordinary”ai‘GET’aanda‘POST’jarequestsaperformaanyaaccessacontrolanecessaryo • DiscardarequestsareceivedaoveraplainaHTTPawithaHTTPSaoriginsatoapreventamixedacontentabugso • Don’tarelyaonlyaonatheaOriginaheaderaforaAccessaControlachecksoaBrowseraalwaysasendsathisaheaderainaCORSarequestsma butamayabeaspoofedaoutsideatheabrowseroaApplicationnlevelaprotocolsashouldabeausedatoaprotectasensitiveadatao What to Review: WebSockets TraditionallyatheaHTTPaprotocolaonlyaallowsaonearequestpresponseaperaTCPaconnectionoaAsynchronousaJavaSn criptaandaXMLaiAJAXjaallowsaclientsatoasendaandareceiveadataaasynchronouslyaiinatheabackgroundawithoutaaa pagearefreshjatoatheaservermahowevermaAJAXarequiresatheaclientatoainitiateathearequestsaandawaitaforatheaservera responsesaihalfnduplexjoaHTMLvaWebSocketsaallowatheaclientpserveratoacreateaaa‘fullnduplex’aitwonwayjacommun nicationachannelsmaallowingatheaclientaandaserveratoatrulyacommunicateaasynchronouslyoaWebSocketsaconducta theirainitiala‘upgrade’ahandshakeaoveraHTTPaandafromathenaonaallacommunicationaisacarriedaoutaoveraTCPachann nelso The following is sample code of an application using Web Sockets: 156 When reviewing code implementing websockets, the following items should be taken into consideration: • DropabackwardacompatibilityainaimplementedaclientpserversaandauseaonlyaprotocolaversionsaaboveahybinqqoaPopular Hixienxwaversionaihibynqqjaandaolderaareaoutdatedaandainsecureoa • ThearecommendedaversionasupportedainalatestaversionsaofaallacurrentabrowsersaisarfcwuvvaRFCawuvvaaisupportedaby FirefoxarrlmaChromearwlmaSafariawmaOperaarsovqmaandaIErqjo • Whileait’sarelativelyaeasyatoatunnelaTCPaservicesathroughaWebSocketsaieogoaVNCmaFTPjmadoingasoaenablesaaccessatoathese tunneledaservicesaforatheainnbrowseraattackerainacaseaofaaaCrossaSiteaScriptingaattackoaTheseaservicesamightaalsoabea calledadirectlyafromaaamaliciousapageaoraprogramoa • Theaprotocoladoesn’tahandleaauthorizationaandporaauthenticationoaApplicationnlevelaprotocolsashouldahandleathat separatelyainacaseasensitiveadataaisabeingatransferredo • ProcessatheamessagesareceivedabyatheawebsocketaasadataoaDon’tatryatoaassignaitadirectlyatoatheaDOManoraevaluateaas codeoaIfathearesponseaisaJSONmaneverauseatheainsecureaevalijafunction•auseatheasafeaoptionaJSONoparseijainsteado • Endpointsaexposedathroughathea‘ws–pp’aprotocolaareaeasilyareversibleatoaplainatextoaOnlya‘wss–pp’aiWebSocketsaoveraSSLp TLSjashouldabeausedaforaprotectionaagainstaMannInnThenMiddleaattackso • SpoofingatheaclientaisapossibleaoutsideaaabrowsermasoatheaWebSocketsaserverashouldabeaableatoahandleaincorrectp maliciousainputoaAlwaysavalidateainputacomingafromathearemoteasitemaasaitamightahaveabeenaalteredoa • Whenaimplementingaserversmacheckathea‘Origin–’aheaderainatheaWebsocketsahandshakeoaThoughaitamightabeaspoofeda [ConstructoriinaDOMStringaurlmaoptionalainaDOMStringaprotocolj]a ainterfaceaWebSocketa a{areadonlyaattributeaDOMStringaURL•a appareadyastateaconstaunsignedashortaCONNECTINGa…aq•a aconstaunsignedashortaOPENa…ar•a aconstaunsignedashortaCLOSEDa…as•a areadonlyaattributeaunsignedashortareadyState•a areadonlyaattributeaunsignedalongabufferedAmount•aa appanetworkinga aattributeaFunctionaonopen•a aattributeaFunctionaonmessage•a aattributeaFunctionaonclose•a abooleanasendiinaDOMStringadataj•a avoidacloseij•a a}•a aWebSocketaimplementsaEventTarget• avaramyWebSocketa…anewaWebSocketi“ws–ppwwwowebsocketsoorg”j• amyWebSocketoonopena…afunctionievtja{aalerti“Connectionaopenaooo”j•a}•a amyWebSocketoonmessagea…afunctionievtja{aalertia“ReceivedaMessage–a“alaevtodataj•a}•a amyWebSocketoonclosea…afunctionievtja{aalerti“Connectionaclosedo”j•a}• Sample 17.1 HTML 5 157 outsideaaabrowsermabrowsersaalwaysaaddatheaOriginaofatheapageathatainitiatedatheaWebsocketsaconnectiono • AsaaaWebSocketsaclientainaaabrowseraisaaccessibleathroughaJavaScriptacallsmaallaWebsocketsacommunicationacanabe spoofedaorahijackedathroughaCrossaSiteaScriptingoaAlwaysavalidateadataacomingathroughaaaWebSocketsaconnectiono 5.1.5 What to Review: Server-Sent Events ServerasentaeventsaseemasimilaratoaWebSocketsmahoweveratheyadoanotauseaaaspecialaprotocolaitheyarenusedaHTTPjaanda theyaallowatheaclientabrowseratoasolelyalistenaforaupdatesaimessagesjafromatheaservermatherebyaremovingatheaneedafora theaclientatoasendaanyapollingaoraotheramessagesaupatoatheaserveroaa When reviewing code that is handling server sent events, items to keep in mind are: • ValidateaURLsapassedatoathea‘EventSource’aconstructormaevenathoughaonlyasamenoriginaURLsaareaallowedo • Asamentionedabeforemaprocessatheamessagesai‘eventodata’jaasadataaandaneveraevaluateatheacontentaasaHTMLaorascript codeo • Alwaysacheckatheaoriginaattributeaofatheamessageai‘eventoorigin’jatoaensureatheamessageaisacomingafromaaa trustedadomainoaUseaaawhitelisto HTML 5158 SameaOriginaPolicyaiSOPjmaalsoacalledaSingleaOriginaPolicyaisaaapartaofawebaapplicationasecurityamodeloaaSameaOrigina PolicyahasavulnerabilitiesathatatheacodearevieweraneedsatoatakeaintoaconsiderationoaSOPacoversathreeamainaareasaofa webadevelopmentmaTrustmaAuthoritymaandaPolicyoaSameaOriginaPolicyaisamadeaofatheacombinationaofathreeacomponentsa iSchememaHostnameaandaPortjo 18.1 Description Internet Explorer has two major exceptions when it comes to same origin policy: 1. TrustaZones–aifabothadomainsaareainahighlyatrustedazoneaeogmacorporateadomainsmathenatheasameaoriginalimitan tionsaareanotaappliedo 2. Port–aIEadoesn’taincludeaportaintoaSameaOriginacomponentsmathereforeahttp–ppyourcompanyocom–yrpindexo htmlaaandahttp–ppyourcompanyocompindexohtmlaareaconsideredafromasameaoriginaandanoarestrictionsaareaappliedoa Theseaexceptionsaareanonnstandardaandanotasupportedainaanyaofaotherabrowserabutawouldabeahelpfulaifadevelopingaana appaforaWindowsaRTaiorjaIEabasedawebaapplicationo The following figure displays the various parts of the URL: SAME ORIGIN POLICY foo://username:password@example.com:8042/over/there/index.dtb?type=animal&name=narwhal#nose userinfo pathauthority hierarchical part interpretable as keys interpretable as values scheme name hostname queryport interpretable as filenamepath interpretable as filename fragment Figure 12 Same Origin Policy 159 • foo://username:password@example.com:8042/over/there/index.dtb?type=animal&name =narwhal#nose 18.2 What to Review • IfaapplicationaallowsausernsuppliedadataainatheaURLathenatheacodearevieweraneedsatoamakeasureatheapathma queryaoraFragmentaIdaCodeadataaisavalidatedoa • MakeasureausernsuppliedaschemeanameaoraauthorityasectionahasagoodainputavalidationoaThisaisaaamajoracodea injectionaandaphishingariskoaOnlyapermitaprefixesaneededabyatheaapplicationoaDoanotauseablacklistingoaCodearen viewerashouldamakeasureaonlyawhitelistingaisausedaforavalidationo • Makeasureaauthorityasectionashouldaonlyacontainaalphanumericsma“n“maanda“o”aAndabeafollowedabya“p”ma“ﬄ”m”d”oaThea riskahereaanaIDNahomographaattacko • Codearevieweraneedsatoamakeasureatheaprogrammeraisanotaassumingadefaultabehaviorabecauseatheaprogramn mersabrowseraproperlyaescapesaaaparticularacharacteraorabrowserastandardasaysatheacharacterawillabeaescapeda properlyabeforeaallowingaanyaURLnderivedavaluesaareaputainsideaaadatabaseaqueryaoratheaURLaisaechoedabacka toatheausero • ResourcesawithaaaMIMEatypeaofaimageppngaareatreatedaasaimagesaandaresourcesawithaMIMEatypeaofatextphtmla areatreatedaasaHTMLadocumentsoaWebaapplicationsacanalimitathatacontent’saauthorityabyarestrictingaitsaMIMEa typeoaaForaexamplemaservingauserngeneratedacontentaasaimageppngaisalessariskyathanaservingauserngenerateda contentaasatextphtmlo • Privilegesa ona documenta anda resourcesa shoulda granta ora withholda privilegesa froma originsa asa aa wholea irathn erathanadiscriminatingabetweenaindividualadocumentsawithinaanaoriginjoaWithholdingaprivilegesaisaineffectivea becauseatheadocumentawithoutatheaprivilegeacanausuallyaobtainatheaprivilegeaanywayabecauseaSOPadoesanota isolateadocumentsawithinaanaorigino Same Origin Policy160 Reviewing Logging Code ApplicationsalogamessagesaofavaryingaintensityaandatoavaryingasinksoaaManyaloggingaAPIsaallowayouatoasetathea granularityaofalogamessageafromaaastateaofalogginganearlyaallamessagesaatalevela‘trace’aora‘debug’atoaonlyalogginga theamostaimportantamessagesaatalevela‘critical’oaaWhereathealogamessageaisawrittenatoaisaalsoaaaconsiderationma sometimesaitacanabeawrittenatoaaalocalafilemaotheratimesatoaaadatabasealogatablemaoraitacouldabeawrittenaoveraaa networkalinkatoaaacentralaloggingaservero TheavolumeaofaloggingahasatoabeacontrolledasinceatheaactaofawritingamessagesatoathealogausesaCPUacyclesmathusa writingaeveryasmalladetailatoaaalogawillauseaupamorearesourcesaiCPUmanetworkabandwidthmadiskaspacejoaaCouplea thatawithatheafactathatathealogsahaveatoabeaparsedaorainterpretedabyaaatoolaorahumanainaorderaforathematoabeausen fulmatheaconsumeraofathealogacouldahaveatoaparseathroughathousandsaofalinesatoafindaaamessageaofaconsequenceo 19.1 Description Logsacanavaryabyatype•aforaexampleaaalogamayasimplyacontainaapplicationastateaoraprocessadatamaallowingasupn portaoradevelopmentatrackawhatatheasystemaisadoingawhenaaabugahasaoccurredoaaOtheralogsamayabeaspecificatoa securitymaonlyaloggingaimportantainformationathataaacentralasecurityasystemawillahaveainterestainoaaFurtheralogsa couldabeausedaforabusinessapurposesmasuchaasabillingo Applicationalogsacanabeapowerfulaasatheaapplicationabusinessalogicahasatheamostainformationaaboutatheausera ieogoaidentitymarolesmapermissionsjaandatheacontextaofatheaeventaitargetmaactionmaoutcomesjmaandaoftenathisadataa isanotaavailableatoaeitherainfrastructureadevicesmaoraevenacloselynrelatedaapplicationsoaaApplicationaloggingaisaana importantafeatureaofaaaproductionasystemmaespeciallyatoasupportapersonnelaandaauditorsmahoweveraitaisaoftena forgottenaandaisararelyadescribedainasufficientadetailainadesignprequirementadocumentationoaaThealevelaandaconn tentaofasecurityamonitoringmaalertingaandareportinganeedsatoabeasetaduringathearequirementsaandadesignastagea ofaprojectsmaandashouldabeaproportionateatoatheainformationasecurityarisksoaApplicationaloggingashouldaalsoabea consistentawithinatheaapplicationmaconsistentaacrossaanaorganization’saapplicationaportfolioaandauseaindustrya standardsawherearelevantmasoathealoggedaeventadataacanabeaconsumedmacorrelatedmaanalyzedaandamanagedabya aawideavarietyaofasystemso Allatypesaofaapplicationsamayasendaeventadataatoaremoteasystemsmaeitheradirectlyaoveraaanetworkaconnectionmaoraasynn chronouslyathoughaaadailypweeklypmonthlyasecureacopyaofathealogatoasomeacentralizedalogacollectionaandamanagen mentasystemaieogoaSIEMaoraSEMjaoraanotheraapplicationaelsewhereo Ifatheainformationainathealogaisaimportantmaandacouldapossiblyabeausedaforalegalamattersmaconsiderahowatheasourceailogja canabeaverifiedmaandahowaintegrityaandanonnrepudiationacanabeaenforcedoaaLogadatamatemporaryadebugalogsmaandabackn upspcopiespextractionsmamustanotabeadestroyedabeforeatheadurationaofathearequiredadataaretentionaperiodmaandamusta notabeakeptabeyondathisatimeoaLegalmaregulatoryaandacontractualaobligationsamayaimpactaonatheseaperiodso ServeraapplicationsacommonlyawriteaeventalogadataatoatheafileasystemaoraaadatabaseaiSQLaoraNoSQLjmahoweveralogginga couldabearequiredaonaclientadevicesasuchaasaapplicationsainstalledaonadesktopsaandaonamobileadevicesamayausealocala storageaandalocaladatabasesoaaConsiderahowathisaclientaloggingadataaisatransferredatoatheaserveroaa What to Review Whenareviewingacodeamodulesafromaaaloggingapointaofaviewmasomeacommonaissuesatoalookaoutaforainclude– REVIEWING LOGGING CODE 161 Reviewing Logging Code • Whenausingatheafileasystemmaitaisapreferableatoauseaaaseparateapartitionathanathoseausedabyatheaoperatingasystemma otheraapplicationafilesaandauserageneratedacontent • Forafilenbasedalogsmaapplyastrictapermissionsaconcerningawhichausersacanaaccessatheadirectoriesmaandatheapermissionsa ofafilesawithinatheadirectories • Inawebaapplicationsmathealogsashouldanotabeaexposedainawebnaccessiblealocationsmaandaifadoneasomashouldahavea restrictedaaccessaandabeaconfiguredawithaaaplainatextaMIMEatypeainotaHTMLj • Whenausingaaadatabasemaitaisapreferableatoautilizeaaaseparateadatabaseaaccountathataisaonlyausedaforawritingaloga dataaandawhichahasaveryarestrictiveadatabasematablemafunctionaandacommandapermissions • Considerawhatatypesaofamessagesashouldabealogged– o Inputavalidationafailuresaeogoaprotocolaviolationsmaunacceptableaencodingsmainvalidaparameteranamesaandavalues o Outputavalidationafailuresaeogoadatabasearecordasetamismatchmainvalidadataaencoding o Authenticationasuccessesaandafailures o Authorizationaiaccessacontroljafailures o Sessionamanagementafailuresaeogoacookieasessionaidentificationavalueamodification o Connectionatimings • Considerawhataeachalogamessageashouldacontain– oaDateaandatimemainasomeacommonaformataialsoamakesasenseatoaensureaallanodesaofaanaapplicationaareasynceda throughasomethingalikeaNTP o Useraperformingatheaaction o Actionabeingaperformedpattempted o InformationaonatheaclientmaeogoaIPaaddressmasourceaportmausernagent o ExternalaclassificationsaeogoaNISTaSecurityaContentaAutomationaProtocolaiSCAPjmaMitreaCommonaAttackaPatn ternaEnumerationaandaClassificationaiCAPECj o PerformasanitizationaonaallaeventadataatoapreventalogainjectionaattacksaeogoacarriageareturnaiCRjmalineafeedaiLFja andadelimiteracharactersaiandaoptionallyatoaremoveasensitiveadataj • IfawritingatoadatabasesmareadmaunderstandaandaapplyatheaSQLainjectionacheatasheet • Ensurealoggingaisaimplementedaandaenabledaduringaapplicationasecuritymafuzzmapenetrationaandaperformanceatesting 162 • Ensurealoggingacannotabeausedatoadepleteasystemaresourcesmaforaexampleabyafillingaupadiskaspaceaoraexceedinga databaseatransactionalogaspacemaleadingatoadenialaofaservice • Thealoggingamechanismsaandacollectedaeventadataamustabeaprotectedafromamisnuseasuchaasatamperingaina transitmaandaunauthorizedaaccessmamodificationaandadeletionaonceastored • Storeaoracopyalogadataatoareadnonlyamediaaasasoonaasapossible • Considerawhatashouldanotabealogged–a o Sessionaidentificationavaluesaiconsiderareplacingawithaaahashedavalueaifaneededatoatrackasessionaspecificaeventsj o SensitiveapersonaladataaandasomeaformsaofapersonallyaidentifiableainformationaiPIIj o Authenticationapasswordsaisuccessfulaoraunsuccessfulj o Databaseaconnectionastrings o Keys o Dataaofaaahigherasecurityaclassificationathanathealoggingasystemaisaallowedatoastore References • SeeaNISTaSPayqqn“saGuideatoaComputeraSecurityaLogaManagementaforamoreaguidanceo • MitreaCommonaEventaExpressionaiCEEj • PCISSCaPCIaDSSavsoqaRequirementarqaandaPAnDSSavsoqaRequirementau • OtheraCommonaLogaFileaSystemaiCLFSjmaMicrosoft Reviewing Logging Code 163Error Handling Proper error handling is important in two ways: 1. ItamayaaffectatheastateaofatheaapplicationoaTheainitialafailureatoapreventatheaerroramayacauseatheaapplicationatoatraversea intoaanainsecureastateoaaThisacoversatheakeyapremiseaofa‘failingasecurely’maerrorsainducedashouldanotaleaveatheaapplicationa inaanainsecureastateoaResourcesashouldabealockedadownaandareleasedmasessionsaterminatedaiifarequiredjmaandacalculationsa orabusinessalogicashouldabeahaltedaidependingaonatheatypeaofaerrormaofacoursejo 2. ItamayaleakasystemainformationatoaaauseroaAnaimportantaaspectaofasecureaapplicationadevelopmentaisatoapreventa informationaleakageoaErroramessagesagiveaanaattackeragreatainsightaintoatheainneraworkingsaofaanaapplicationoaWeaka errorahandlingaalsoaaidsatheaattackermaasatheaerrorsareturnedamayaassistathemainaconstructingacorrectaattackavectorso Aagenericaerrorapageaforamostaerrorsaisarecommendedmathisaapproachamakesaitamoreadifficultaforaattackersatoaidentifya signaturesa ofa potentiallya successfula attacksa sucha asa blinda SQLa injectiona usinga booleanizationa‘’”shoulda includea reference—’’aoraanalysisaofaresponseatimeacharacteristicsoa 20.1 Description TheapurposeaofareviewingatheaErroraHandlingacodeaisatoaassureathatatheaapplicationafailsasafelyaunderaallapossiblea erroraconditionsmaexpectedaandaunexpectedoaNoasensitiveainformationaisapresentedatoatheauserawhenaanaerroraoccursoaa AacompanyacodingaguidelinesashouldaincludeasectionsaonaErroraHandlingaandahowaitashouldabeacontrolledabyaana applicationasuitemathisawillaallowadevelopersatoacodeaagainstathisaguidelinesaasawellaasareviewaagainstathemoAacompanya codingaguidelinesashouldaincludeasectionsaonaErroraHandlingaandahowaitashouldabeacontrolledabyaanaapplicationasuitema thisawillaallowadevelopersatoacodeaagainstathisaguidelinesaasawellaasareviewaagainstathemo ForaexamplemaSQLainjectionaisamuchatougheratoasuccessfullyaexecuteawithoutasomeahealthyaerroramessagesoaItalessensa theaattackafootprintmaandaanaattackerawouldahaveatoaresortatoausinga“blindaSQLainjection”awhichaisamoreadifficultaanda timeaconsumingoa A well-planned error/exception handling guideline is important in a company for three reasons: 1. Goodaerrorahandlingadoesanotagiveaanaattackeraanyainformationawhichaisaaameansatoaanaendmaattackingatheaapplication 2. Aaproperacentralisedaerrorastrategyaisaeasieratoamaintainaandareducesatheachanceaofaanyauncaughtaerrorsa“bubblinga up”atoatheafrontaendaofaanaapplicationo 3. Informationa leakagea coulda leada toa sociala engineeringa exploitsma fora examplea ifa thea hostinga companiesa namea isa returnedmaorasomeaemployeesanameacanabeaseeno Regardless of whether the development language provide checked exceptions or not, reviewers should remember: • NotaallaerrorsaareaexceptionsoaaDon’tarelyaonaexceptionahandlingatoabeayouraonlyawayaofahandlingaerrorsmahandleaalla caseastatementa‘default’asectionsmaensureaalla‘if’astatementsahaveatheira‘else’aclausesacoveredmaensureathataallaexitsafroma aafunctionaieogoareturnastatementsmaexceptionsmaetcojaareacoveredoaaRAIIaconceptsaieogoaautoapointersaandathealikejaarea anaadvantageahereoaaInalanguagesalikeaJavaaandaCdmarememberathataerrorsaareadifferentafromaexceptionsaidifferenta hierarchyjaandashouldabeahandledo ERROR HANDLING 164 Error Handling • CatchingaanaexceptionaisanotaautomaticallyahandlingaitoaaYou’veacaughtayouraexceptionmasoahowadoayouahandlea itﬄaaForamanyacasesathisashouldabeaobviousaenoughmabasedaonayourabusinessalogicmabutaforasomeaieogoaoutaofa memorymaarrayaindexaoutaofaboundsmaetcojatheahandlingamanyanotabeasoasimpleo • Don’tacatchamoreathatayouacanahandleoaCatchaallaclausesaieogoa‘catchiExceptionaej’ainaJavaagaCdaora‘catchioooja inaClljaashouldabeaavoidedaasayouawillanotaknowawhatatypeaofaexceptionayouaareahandlingmaandaifayouadon’ta knowa thea exceptiona typema howa doa youa accuratelya handlea itﬄa Ita coulda bea thata thea downstreama servera isa nota respondingmaoraaauseramayahaveaexceededatheiraquotamaorayouamayabeaoutaofamemorymatheseaissuesashouldabea handledainadifferentawaysaandathusashouldabeacaughtainaexceptionaclausesathataareaspecifico Whena ana exceptiona ora errora isa thrownma wea alsoa needa toa loga thisa occurrenceoa Sometimesa thisa isa duea toa bada developmentmabutaitacanabeathearesultaofaanaattackaorasomeaotheraserviceayouraapplicationareliesaonafailingoaaThisa hasatoabeaimaginedainatheaproductionascenariomaifayouraapplicationahandlesa‘failingasecurely’abyareturningaana erroraresponseatoatheaclientmaandasinceaweadon’tawantatoaleakainformationathataerrorawillabeagenericmaweaneedatoa haveasomeawayaofaidentifyingawhyatheafailureaoccurredoaaIfayouracustomerareportsarqqq’saofaerrorsaoccurredalasta nightmayouaknowathatacustomeraisagoingatoawantatoaknowawhyoaaIfayouadon’tahaveaproperaloggingaandatraceabilitya codedaintoayouraapplicationathenayouawillanotabeaableatoaestablishaifathoseaerrorsawereadueatoasomeaattempteda hackmaoraanaerrorainayourabusinessalogicawhenahandlingaaaparticularatypeaofaerroroa Allacodeapathsathatacanacauseaanaexceptionatoabeathrownashouldacheckaforasuccessainaorderaforatheaexceptiona notatoabeathrownoaThisacouldabeahardatoaimpossibleaforaaamanualacodeareviewatoacovermaespeciallyaforalargea bodiesaofacodeoaaHoweveraifathereaisaaadebugaversionaofatheacodemathenamodulespfunctionsacouldathrowarelevanta exceptionsperrorsa anda ana automateda toola cana ensurea thea statea anda errora responsesa froma thea modulea isa asa expectedoaaThisathenameansatheacodeareviewerahasatheajobaofaensuringaallarelevantaexceptionsperrorsaareatesteda inatheadebugacodeo What to Review Whenareviewingacodeaitaisarecommendedathatayouaassessatheacommonalityawithinatheaapplicationafromaana errorpexceptionahandlingaperspectiveoaFrameworksahaveaerrorahandlingaresourcesawhichacanabeaexploitedatoa assistainasecureaprogrammingmaandasucharesourcesawithinatheaframeworkashouldabeareviewedatoaassessaifathea errorahandlingaisa“wirednup”acorrectlyoaAagenericaerrorapageashouldabeausedaforaallaexceptionsaifapossibleaasathisa preventsatheaattackerafromaidentifyingainternalaresponsesatoaerrorastatesoaThisaalsoamakesaitamoreadifficultafora automatedatoolsatoaidentifyasuccessfulaattackso ForaJSPastrutsathisacouldabeacontrolledainatheastrutsnconfigoxmlafilemaaakeyafileawhenareviewingatheawirednupastrutsa environment– Specificationa cana bea donea fora JSPa ina weboxmla ina ordera toa handlea unhandleda exceptionsoaWhena unhandleda exceptionsaoccurmabutaareanotacaughtainacodematheauseraisaforwardedatoaaagenericaerrorapage– ”exceptionakey…”bankoerroronowonga”a aaaaaaaaaaaaaaaaaaaapath…”pNoWongaojsp”a aaaaaaaaaaaaaaaaaaaatype…”mybankoaccountoNoCashException”p— Sample 20.1 165 AlsoainatheacaseaofaHTTPauquaoraHTTPavqqaerrorsaduringatheareviewayouamayafind– ForaIISadevelopmentathea‘Application_Errorij’ahandlerawillaallowatheaapplicationatoacatchaallauncaughtaexceptionsaanda handleathemainaaaconsistentawayoaaNoteathisaisaimportantaoraelseathereaisaaachanceayouraexceptionainformaitonacouldabea sentabackatoatheaclientainathearesponseo ForaApacheadevelopmentmareturningafailuresafromahandlersaoramodulesacanapreventaanafurtheraprocessingabyathea ApacheaengineaandaresultainaanaerroraresponseafromatheaserveroaaResponseaheadersmabodymaetcacanabeasetabyabyathea handlerpmoduleaoracanabeaconfiguredausingathea“ErrorDocument”aconfigurationoaWeashouldauseaaalocalizedadescriptiona stringainaeveryaexceptionmaaafriendlyaerrorareasonasuchaasa“SystemaErrora–aPleaseatryaagainalater”oaWhenatheauseraseesaana erroramessagemaitawillabeaderivedafromathisadescriptionastringaofatheaexceptionathatawasathrownmaandaneverafromathea exceptionaclassawhichamayacontainaaastackatracemalineanumberawhereatheaerroraoccurredmaclassanamemaoramethodanameoa DoanotaexposeasensitiveainformationalikeaexceptionamessagesoaInformationasuchaasapathsaonathealocalafileasystemaisa consideredaprivilegedainformation•aanyainternalasystemainformationashouldabeahiddenafromatheauseroaAsamentioneda beforemaanaattackeracouldauseathisainformationatoagatheraprivateauserainformationafromatheaapplicationaoracomponentsa thatamakeaupatheaappoa Don’taputapeople’sanamesaoraanyainternalacontactainformationainaerroramessagesoaDon’taputaanya“human”ainformationma whichawouldaleadatoaaalevelaofafamiliarityaandaaasocialaengineeringaexploito What to Review: Failing Securely There can be many different reasons why an application may fail, for example: • Thearesultaofabusinessalogicaconditionsanotabeingameto • Thearesultaofatheaenvironmentawhereinatheabusinessalogicaresidesafailso • Thearesultaofaupstreamaoradownstreamasystemsauponawhichatheaapplicationadependsafailo • Technicalahardwareapaphysicalafailureo Error Handling ”errornpage— aaaaaaa”exceptionntype—UnhandledException”pexceptionntype— aaaaaaa”location—GenericErrorojsp”plocation— a”perrornpage— Sample 20.2 ”errornpage— aa”errorncode—vqq”perrorncode— aa”location—GenericErrorojsp”plocation— a”perrornpage— Sample 20.3 166 FailuresaarealikeatheaSpanishaInquisition•apopularlyanobodyaexpectedatheaSpanishaInquisitionaiseeaMontyaPythonjabutaina realalifeatheaSpanishaknewawhenaanainquisitionawasagoingatoaoccuraandawereapreparedaforaitmasimilarlyainaanaapplicationma thoughayouadon’taexpectaerrorsatoaoccurayouracodeashouldabeapreparedaforathematoahappenoaaInatheaeventaofaaafailurema itaisaimportantanotatoaleaveathea“doors”aofatheaapplicationaopenaandatheakeysatoaothera“rooms”awithinatheaapplicationa sittingaonatheatableoaInatheacourseaofaaalogicalaworkflowmawhichaisadesignedabasedauponarequirementsmaerrorsamayaoccura whichacanabeaprogrammaticallyahandledmasuchaasaaaconnectionapoolanotabeingaavailablemaoraaadownstreamaservera returningaaafailureoa SuchaareasaofafailureashouldabeaexaminedaduringatheacourseaofatheacodeareviewoaItashouldabeaexaminedaifaresourcesa shouldabeareleasedasuchaasamemorymaconnectionapoolsmafileahandlesaetcoa Theareviewaofacodeashouldaalsoaincludeapinpointingaareasawhereatheauserasessionashouldabeaterminatedaorainvalidatedoa Sometimesaerrorsamayaoccurawhichadoanotamakeaanyalogicalasenseafromaaabusinessalogicaperspectiveaoraaatechnicala standpointmaforaexampleaaaloggedainauseralookingatoaaccessaanaaccountawhichaisanotaregisteredatoathatauseroaSucha conditionsareflectapossibleamaliciousaactivityoaHereaweashouldareviewaifatheacodeaisainaanyawayadefensiveaandakillsa theauser’sasessionaobjectaandaforwardsatheauseratoathealoginapageoaiKeepainamindathatatheasessionaobjectashouldabea examinedauponaeveryaHTTParequestjo What to Review: Potentially Vulnerable Code Java InaJavaaweahaveatheaconceptaofaanaerroraobject•atheaExceptionaobjectoaThisalivesainatheaJavaapackageajavaolangaandaisa derivedafromatheaThrowableaobjectoaExceptionsaareathrownawhenaanaabnormalaoccurrenceahasaoccurredoaAnothera objectaderivedafromaThrowableaisatheaErroraobjectmawhichaisathrownawhenasomethingamoreaseriousaoccursoaTheaErrora objectacanabeacaughtainaaacatchaclausemabutacannotabeahandledmatheabestayouacanadoaisalogasomeainformationaabouta theaErroraandathenarenthrowaito Informationaleakageacanaoccurawhenadevelopersauseasomeaexceptionamethodsmawhicha‘bubble’atoatheauseraUIadueatoaaa pooraerrorahandlingastrategyoaThe methods are as follows– • printStackTraceij • getStackTraceij AlsoaimportantatoaknowaisathatatheaoutputaofatheseamethodsaisaprintedainaSystemaconsolematheasameaasaSystemoouto printlnieja wherea therea isa ana Exceptionoa Bea surea toa nota redirecta thea outputStreama toa PrintWritera objecta ofa JSPma bya conventionacalleda“out”maforaexample– • printStackTraceioutj•a NoteaitaisapossibleatoachangeawhereasystemoerraandasystemooutawriteatoailikeamodifyingafdaragasainabashaoraCpClljma usingatheajavaolangosystemapackage– • setErrijaforatheaSystemoerrafieldmaand • setOutijaforatheaSystemooutafieldo Thisacouldabeausedaonaaaprocessawideabasisatoaensureanoaoutputagetsawrittenatoastandardaerroraorastandardaoutaiwhicha canabeareflectedabackatoatheaclientjabutainsteadawriteatoaaaconfiguredalogafileo C#.NET InaoNETaaaSystemoExceptionaobjectaexistsaandahasacommonlyausedachildaobjectsasuchaasaApplicationExceptionaanda SystemExceptionaareausedoaItaisanotarecommendedathatayouathrowaoracatchaaaSystemExceptionathisaisathrownabya runtimeoa Error Handling 167 Whenaanaerroraoccursmaeitheratheasystemaoratheacurrentlyaexecutingaapplicationareportsaitabyathrowingaanaexceptiona containingainformationaaboutatheaerrormasimilaratoaJavaoaOnceathrownmaanaexceptionaisahandledabyatheaapplicationaora byatheadefaultaexceptionahandleroaThisaExceptionaobjectacontainsasimilaramethodsatoatheaJavaaimplementationasuchaas–a • StackTrace • Source • Message • HelpLink InaoNETaweaneedatoalookaatatheaerrorahandlingastrategyafromatheapointaofaviewaofaglobalaerrorahandlingaandatheahandlinga ofaunexpectedaerrorsoaThisacanabeadoneainamanyawaysaandathisaarticleaisanotaanaexhaustivealistoaFirstlymaanaErroraEventaisa thrownawhenaanaunhandledaexceptionaisathrownoa This is part of the TemplateControl class, see reference: • http://msdn.microsoft.com/library/default.asp?url=/library/enus/cpref/html/ frlrfSystemWebUITemplateControlClassErrorTopic.asp Error handling can be done in three ways in .NET, executed in the following order: • OnatheaaspxaoraassociatedacodebehindapageainatheaPage_Erroro • Inatheaglobaloasaxafile’saApplication_Erroraiasamentionedabeforejoa • Inatheaweboconfigafile’sacustomErrorsasectiono Itaisarecommendedatoalookainatheseaareasatoaunderstandatheaerrorastrategyaofatheaapplicationo Classic ASP UnlikeaJavaaandaoNETmaclassicaASPapagesadoanotahaveastructuredaerrorahandlingainatryncatchablocksoaInsteadatheyahaveaaa specificaobjectacalleda“err”oaThisamakesaerrorahandlingainaaaclassicaASPapagesahardatoadoaandaproneatoadesignaerrorsaona errorahandlersmacausingaraceaconditionsaandainformationaleakageoaAlsomaasaASPausesaVBScriptaiaasubtractaofaVisualaBasicjma sentencesalikea“OnaErroraGoToalabel”aareanotaavailableoaInaclassicaASPathereaareatwoawaysatoadoaerrorahandlingmatheafirsta isausingatheaerraobjectawithaaa“OnaErroraResumeaNext”aanda“OnaErroraGoToaq”o Theasecondaisausingaanaerrorahandleraonaanaerrorapageaihttp://support.microsoft.com/kb/299981jo PublicaFunctionaIsIntegeraiByValaNumberja a aaaDimaResmatNumber aaaNumbera…aTrimiNumberj aaatNumber…Numberaa aaaOnaErroraResumeaNexta aaaaaaaaaaaaaaaaaaaaa‘Ifaanaerroraoccursacontinueaexecution aaaNumbera…aCIntiNumberjaa aaaaaaaaaaaaa‘ifaNumberaisaaaalphanumericastringaaaTypeaMismatchaerrorawillaoccur aaaResa…aierronumbera…aqjaa aaaaaaaaaaaaa‘Ifathereaareanoaerrorsathenareturnatrue aaaOnaErroraGoToaqaa a aaaaa‘Ifaanaerroraoccursastopaexecutionaandadisplayaerror aaareoPatterna…a“^[\\l\\n]ﬄak\\dle”a aaaaa‘onlyaonealpnaandadigitsaareaallowed aaaIsIntegera…areoTestitNumberjaAndaRes aEndaFunction Sample 20.4 Error Handling168 C++ InatheaCllalanguagemaanyaobjectaorabuiltainatypeacanabeathrownoaaHoweverathereaisaaaSTLatypeastd––exceptiona whichaisasupposedatoabeausedaasatheaparentaofaanyauseradefinedaexceptionmaindeedathisatypeaisausedainathea STLaandamanyalibrariesaasatheaparentatypeaofaallaexceptionsoaaHavingastd––exceptionaencouragesadevelopersatoa createaaahierarchyaofaexceptionsawhichamatchatheaexceptionausageaandameansaallaexceptionsacanabeacaughtabya catchingaaastd––exceptionaobjectaiinsteadaofaaa‘catchaioooj’ablockjo UnlikeaJavamaevenaerrorsathatayouacan’tarecoverafromaieogoastd––bad_allocawhichameansayouraoutaofamemoryja deriveafromastd––exceptionmasoaaa‘catchiastd––exceptiongaej’aisasimilaratoa‘catchaioooj’aexceptathataitaallowsayouaaccessa toatheaexceptionasoayouacanaknowawhataoccurredaandapossiblyaprintasomeaerrorainformationausingaeowhatijo ThereaareamanyaloggingalibrariesaforaCllmasoaifayouracodebaseausesaaaparticularaloggingaclassalookaforausagesaofa thataloggeraforaanywhereasensitiveainformationacanabeawrittenatoathealogso What to Review: Error Handling in IIS Page_ErroraisapagealevelahandlingawhichaisarunaonatheaserverasideainaoNEToaaBelowaisaanaexampleabutatheaerrora informationaisaaalittleatooainformativeaandahenceabadapracticeo TheatextainatheaexampleaaboveahasaaanumberaofaissuesoaaFirstlymaitadisplaysatheaHTTParequestatoatheauserainathea formaofaRequestoUrloToStringijoa Assumingathereahasabeenanoadataavalidationaprioratoathisapointmaweaareavulnerableatoacrossasiteascriptingaattacksoaa Secondlyma thea errora messagea anda stacka tracea isa displayeda toa thea usera usinga ServeroGetLastErrorijoToStringija whichadivulgesainternalainformationaregardingatheaapplicationoa AfteratheaPage_ErroraisacalledmatheaApplication_Errorasubaisacalledo WhenaanaerroraoccursmatheaApplication_ErrorafunctionaisacalledoaInathisamethodaweacanalogatheaerroraandaredirecta toaanotherapageoaInafactacatchingaerrorsainaApplication_ErrorainsteadaofaPage_Errorawouldabeaanaexampleaofa centralizingaerrorsaasadescribedaearliero DimaErrObj setaErrObja…aServeroGetLastErrorij ‘NowauseaErrObjaasathearegularaerraobject Sample 20.5 ”scriptalanguage…”Cd”arunat…”server”— aSubaPage_ErroriSourceaAsaObjectmaEaAsaEventArgsj aDimamessageaAsaStringa…aRequestoUrloToStringijgaServeroGetLastErrorijoToStringij aResponseoWriteimessagejappadisplayamessagea aEndaSub a”pscript— Sample 20.6 Error Handling 169 AboveaisaanaexampleaofacodeainaGlobaloasaxaandatheaApplication_ErroramethodoaTheaerroraisaloggedaandathenatheausera isaredirectedoaNonnvalidatedaparametersaareabeingaloggedahereainatheaformaofaRequestoPathoaCareamustabeatakena notatoalogaoradisplayanonnvalidatedainputafromaanyaexternalasourceoa‘’”linkatoaXSS—’’ WeboconfigahasacustomaerroratagsawhichacanabeausedatoahandleaerrorsoaThisaisacalledalastaandaifaPage_erroraora Application_erroraisacalledaandahasafunctionalitymathatafunctionalityashallabeaexecutedafirstoaIfatheapreviousatwoa handlingamechanismsadoanotaredirectaoraclearaiResponseoRedirectaoraaaServeroClearErrorjmathisawillabeacalledaanda youashallabeaforwardedatoatheapageadefinedainaweboconfigainatheacustomErrorsasectionmawhichaisaconfiguredaasa follows–a Thea“mode”aattributeavalueaofa“On”ameansathatacustomaerrorsaareaenabledawhilstathea“Off”avalueameansathata customaerrorsaareadisabledoaaThea“mode”aattributeacanaalsoabeasetatoa“RemoteOnly”awhichaspecifiesathatacustoma errorsaareashownaonlyatoaremoteaclientsaandaASPoNETaerrorsaareashownatoarequestsacomingafromatheathealocala hostoaaIfathea“mode”aattributeaisanotasetathenaitadefaultsatoa“RemoteOnly”o Whenaanaerroraoccursmaifatheastatusacodeaofathearesponseamatchesaoneaofatheaerroraelementsmathenatheareleventa ‘redirect’avalueaisareturnedaasatheaerrorapageoaaIfatheastatusacodeadoesanotamatchathenatheaerrorapageafromathea ‘defaultRedirect’aattributeawillabeadisplayedoaaIfanoavalueaisasetafora‘defaultRedirect’athenaaagenericaIISaerrorapagea isareturnedo AnaexampleaofatheacustomErrorsasectionacompletedaforaanaapplicationaisaasafollows– ”f@aImportaNamespace…”SystemoDiagnostics”af— a”scriptalanguage…”Cd”arunat…”server”— avoidaApplication_ErroriObjectasendermaEventArgsaeja{ aaaStringaMessagea…a“\\n\\nURL–ahttp–pplocalhostp”alaRequestoPath aaaaaaaaaaaaaaaaaaaaaaaaaaala“\\n\\nMESSAGE–\\na“alaServeroGetLastErrorijoMessage aaaaaaaaaaaaaaaaaaaaaaaaaaala“\\n\\nSTACKaTRACE–\\n”alaServeroGetLastErrorijoStackTrace• aaappaInsertaintoaEventaLog aaaEventLogaLoga…anewaEventLogij• aaaLogoSourcea…aLogName• aaaLogoWriteEntryiMessagemaEventLogEntryTypeoErrorj• aaaServeroRedirectiErrorohtmjappathisashallaalsoaclearatheaerror a} a”pscript— Sample 20.7 ”customErrorsamode…””On|Off|RemoteOnly—”adefaultRedirect…””defaultaredirectapage—”— aa”errorastatusCode…””HTTPastatusacode—”aredirect…””specificaredirectapageaforalistedastatusacode—”p— a”pcustomErrors— Sample 20.8 Error Handling170 What to Review: Error Handling in Apache In Apache you have two choices in how to return error messages to the client: 1. Youacanawriteatheaerrorastatusacodeaintoatheareqaobjectaandawriteathearesponseatoaappearatheawayayouawantma thenahaveayouahandlerareturna‘DONE’aiwhichameansatheaApacheaframeworkawillanotaallowaanyafurtherahandlersp filtersatoaprocessathearequestaandawillasendathearesponseatoatheacliento 2. YourahandleraorafilteracodeacanareturnaprendefinedavaluesawhichawillatellatheaApacheaframeworkathearesultaofa youracodesaprocesssingaiessentiallyatheaHTTPastatusacodejoaaYouacanathenaconfigureawhataerrorapagesashouldabea returnedaforaeachaerroracodeo InatheainterestaofacentralizingaallaerroracodeahandlingmaoptionasacanamakeamoreasenseoaaToareturnaaaspecificapren definedavalueafromayourahandlermareferatoatheaApacheadocumentationaforathealistaofavaluesatoausemaandathena returnafromatheahandlerafunctionaasashownainatheafollowingaexample– Ina thea httpdoconfa filea youa cana thena specifya whicha pagea shoulda bea returneda fora eacha errora codea usinga thea ‘ErrorDocument’adirectiveoaaTheaformataofathisadirectiveaisaasafollows– • ErrorDocumenta”tndigitncode—a”action— oooawhereatheatadigitacodeaisatheaHTTParesponseacodeasetabyatheahandlermaandatheaactionaisaaalocalaoraexternalaURLa toabeareturnedmaoraspecificatextatoadisplayoaaTheafollowingaexamplesaareatakenafromatheaApacheaErrorDocumenta documentationa ihttps://httpd.apache.org/docs/2.4/custom-error.htmlja whicha containsa morea informationa andaoptionsaonaErrorDocumentadirectives– ”customErrorsamode…”On”adefaultRedirect…”errorohtml”— aaaaa”errorastatusCode…”vqq”aredirect…”errvqqoaspx”p— aaaaa”errorastatusCode…”uqu”aredirect…”notHereoaspx”p— aaaaa”errorastatusCode…”uqt”aredirect…”notAuthzoaspx”p— a”pcustomErrors— Sample 20.9 staticaintamy_handlerirequest_recakrj a{ aaaaaifaiaproblem_processingijaj aaaaa{a aaaaaaareturnaHTTP_INTERNAL_SERVER_ERROR• aaaaa} aaaaaaoooacontinueaprocessingarequestaooo a} Sample 20.10 Error Handling 171 What to Review: Leading Practice for Error Handling Codeathatamightathrowaexceptionsashouldabeainaaatryablockaandacodeathatahandlesaexceptionsainaaacatchablockoa Theacatchablockaisaaaseriesaofastatementsabeginningawithatheakeywordacatchmafollowedabyaanaexceptionatypeaanda anaactionatoabeatakenoa Example: Java Try-Catch: .NET Try–Catch ErrorDocumentavqqa“SorrymaourascriptacrashedoaOhadear” aErrorDocumentavqqapcginbinpcrashnrecover aErrorDocumentavqqahttp–pperroroexampleocompserver_errorohtml aErrorDocumentauquaperrorspnot_foundohtmla aErrorDocumentauqrapsubscriptionphow_to_subscribeohtml Sample 20.11 publicaclassaDoStuffa{ aaaaapublicastaticavoidaMainija{ aaaaaaaaatrya{ aaaaaaaaaaaaaStreamReaderasra…aFileoOpenTexti“stuffotxt”j• aaaaaaaaaaaaaConsoleoWriteLinei“Readingalinea{q}”masroReadLineijj•aaaa aaaaaaaaa} aaaaaaaaacatchiMyClassExtendedFromExceptionaeja{ aaaaaaaaaaaaaConsoleoWriteLinei“AnaerroraoccurredoaPleasealeaveatoaroom”j• aa aaaaalogerrori“Error–a“maej• aaaaaaaaa} aaaaa} a} Sample 20.12 publicavoidarunija{ aaaaaaaaaaaaawhileaibstopja{ aaaaaaaaaaaaaaaaatrya{ aaaaaaaaaaaaaaaaaaaaappaPerformaworkahere aaaaaaaaaaaaaaaaa}acatchaiThrowableatja{ aaaaaaaaaaaaaaaaaaaaappaLogatheaexceptionaandacontinue aaa aaaaaWriteToUseri“AnaErrorahasaoccurredmaputatheakettleaon”j• aaaaaaaaaaaaaaaaaaaaaloggerologiLeveloSEVEREma“Unexceptionaexception”matj• Sample 20.13 Error Handling172 C++ Try–Catch Ina generalma ita isa besta practicea toa catcha aa specifica typea ofa exceptiona rathera thana usea thea basica catchiExceptionja ora catchiThrowablejastatementainatheacaseaofaJavaoa What to Review: The Order of Catching Exceptions Keepainamindathatamanyalanguagesawillaattemptatoamatchatheathrownaexceptionatoatheacatchaclauseaevenaifaitameansa matchingatheathrownaexceptionatoaaaparentaclassoaaAlsoarememberathatacatchaclausesaareacheckedainatheaorderatheyaarea codedaonatheapageoaaThisacouldaleaveayouainatheasituationawhereaaacertainatypeaofaexceptionamightaneverabeahandleda correctlymatakeatheafollowingaexampleawherea‘non_even_argument’aisaaasubclassaofa‘std––invalid_argument’– aaaaaaaaaaaaaaaaa} aaaaaaaaaaaaa} aaaaaaaaa} voidaperform_fnija{ aaatrya{ aaaaaappaPerformaworkahere a aaa}acatchaiaconstaMyClassExtendedFromStdExceptiongaeja{ aaaaaappaLogatheaexceptionaandacontinue aaaaaaWriteToUseri“AnaErrorahasaoccurredmaputatheakettleaon”j• aaaaaaloggerologiLeveloSEVEREma“Unexceptionaexception”maej• aaa} a} Sample 20.14 classanon_even_argumenta–apublicastd––invalid_argumenta{ apublic– aaexplicitanon_even_argumentaiconstastringgawhat_argj• a}• a avoidado_fnij a{ aaaatry aaaa{ aaaaaaappaPerformaworkathatacouldathrowa aaaa} aaaacatchaiaconstastd––invalid_argumentgaeaj aaaa{ Sample 20.15 Error Handling 173 Thea problema witha thisa codea isa thata whena aa ‘non_even_argumenta isa thrownma thea catcha brancha handlinga ‘std––invalid_argument’awillaalwaysabeaexecutedaasaitaisaaaparentaofa‘non_even_argument’aandathusathearuntimea systemawillaconsideraitaaamatchaithisacouldaalsoaleadatoaslicingjoaaThusayouaneedatoabeaawareaofatheahierarchyaofa youraexceptionaobjectsaandaensureathatayoualistatheacatchaforatheamoreaspecificaexceptionsafirstainayouracodeo IfathealanguageainaquestionahasaaafinallyamethodmauseaitoaTheafinallyamethodaisaguaranteedatoaalwaysabeacalledoa TheafinallyamethodacanabeausedatoareleasearesourcesareferencedabyatheamethodathatathrewatheaexceptionoaThisaisa veryaimportantoaAnaexampleawouldabeaifaaamethodagainedaaadatabaseaconnectionafromaaapoolaofaconnectionsma andaanaexceptionaoccurredawithoutafinallymatheaconnectionaobjectashallanotabeareturnedatoatheapoolaforasomea timeaiuntilatheatimeoutjoaThisacanaleadatoapoolaexhaustionoafinallyijaisacalledaevenaifanoaexceptionaisathrownoa AaJavaaexampleashowingafinallyijabeingausedatoareleaseasystemaresourceso What to Review: Releasing resources and good housekeeping RAIIaisaResourceaAcquisitionaIsaInitializationmawhichaisaaawayaofasayingathatawhenayouafirstacreateaanainstanceaofa aatypemaitashouldabeafullyasetupaioraasamuchaasapossiblejasoathatait’sainaaagoodastateoaaAnotheraadvantageaofaRAIIa isahowaobjectsaareadisposedaofmaeffectivelyawhenaanaobjectainstanceaisanoalongeraneededathenaitaresourcesaarea automaticallyareturnedawhenatheaobjectagoesaoutaofascopeaiClljaorawhenait’sa‘using’ablockaisafinishedaiCda‘using’a directiveawhichacallsatheaDisposeamethodmaoraJavaax’satrynwithnresourcesafeatureja RAIIahasatheaadvantageathataprogrammersaiandausersatoalibrariesjadon’taneedatoaexplicitlyadeleteaobjectsmathea objectsawillabearemovedathemselvesmaandainatheaprocessaofaremovingathemselvesaidestructoraoraDisposeja ForaClassicaASPapagesaitaisarecommendedatoaencloseaallacleaningainaaafunctionaandacallaitaintoaanaerrorahandlinga aaaaaaappaPerformagenericainvalidaargumentaprocessingaandareturnafailure aaaa} aaaacatchaiaconstanon_even_argumentgaeaj aaaa{ aaaaaaappaPerformaspecificaprocessingatoamakeaargumentaevenaandacontinueaprocessing aaaa} a} voidaperform_fnija{ aaatrya{ aaaaaappaPerformaworkahere a aaa}acatchaiaconstaMyClassExtendedFromStdExceptiongaeja{ aaaaaappaLogatheaexceptionaandacontinue aaaaaaWriteToUseri“AnaErrorahasaoccurredmaputatheakettleaon”j• aaaaaaloggerologiLeveloSEVEREma“Unexceptionaexception”maej• aaa} a} Sample 20.16 Error Handling174 statementaafteraana“OnaErroraResumeaNext”o Buildinga ana infrastructurea fora consistenta errora reportinga provesa morea difficulta thana errora handlingoa Strutsa providesatheaActionMessagesaandaActionErrorsaclassesaforamaintainingaaastackaofaerroramessagesatoabeareportedma whichacanabeausedawithaJSPatagsalikea”html–aerror—atoadisplayatheseaerroramessagesatoatheauseroa Toa reporta aa differenta severitya ofa aa messagea ina aa differenta mannera ilikea errorma warningma ora informationja thea followingatasksaarearequired–a 1. Registermainstantiateatheaerrorsaunderatheaappropriateaseverity 2. Identifyatheseamessagesaandashowathemainaaaconsistentamannero StrutsaActionErrorsaclassamakesaerrorahandlingaquiteaeasy– NowathataweahaveaaddedatheaerrorsmaweadisplayathemabyausingatagsainatheaHTMLapageo References • ForaclassicaASPapagesayouaneedatoadoasomeaIISaconfigurationmafollowahttp://support.microsoft.com/ kb/299981 for more information. • ForadefaultaHTTPaerrorapageahandlingainastrutsaiweboxmljaseeahttps–ppsoftwarensecurityosansoorgp blogpsqrqpqyprrpsecuritynmisconfigurationsnjavanwebxmlnfiles ActionErrorsaerrorsa…anewaActionErrorsij aerrorsoaddi“fatal”manewaActionErrori“oooo”jj•a aerrorsoaddi“error”manewaActionErrori“oooo”jj•a aerrorsoaddi“warning”manewaActionErrori“oooo”jj• aerrorsoaddi“information”manewaActionErrori“oooo”jj•a asaveErrorsirequestmerrorsj•appaImportantatoadoathis Sample 20.17 ”logic–messagePresentaproperty…”error”—a a”html–messagesaproperty…”error”aid…”errMsg”a— aaaaa”bean–writeaname…”errMsg”p— a”phtml–messages— a”plogic–messagePresenta— Sample 20.18 Error Handling 175 HowawillayouracodeaandaapplicationsareactawhenasomethingahasagoneawrongﬄaaManyacompaniesathatafollowa securea designa anda codinga principalsa doa soa toa preventa attackersa froma gettinga intoa theira networkma howevera manyacompaniesadoanotaconsideradesigningaandacodingaforatheascenarioawhereaanaattackeramayahaveafounda aavulnerabilitymaorahasaalreadyaexploitedaitatoarunacodeawithinaaacompaniesafirewallsaiioeoawithinatheaIntranetjo ManyacompaniesaemployaSIEMaloggingatechnologiesatoamonitoranetworkaandaOSalogsaforapatternsathatadetecta suspicionsaactivitymathisasectionaaimsatoafurtheraencourageaapplicationalayersaandainterfacesatoadoatheasameo 21.1 Description Thisasectionaconcentratesaon– 1. Designaandacodeathataallowsatheauseratoareactawhenaaasystemaisabeingaattackedo 2. Conceptsaallowingaapplicationsatoaflagawhenatheyahaveabeenabreachedo Whenaaacompanyaimplementsasecureadesignaandacodingmaitawillahaveatheaaimaofapreventingaattackersafroma misusingatheasoftwareaandaaccessingainformationatheyashouldanotahaveaaccessatooaaInputavalidationachecksafora SQLainjectionsmaXSSmaCSRFmaetcoashouldapreventaattackersafromabeingaableatoaexploitatheseatypesaofavulnerabilitiesa againsta thea softwareoa a Howevera howa shoulda softwarea reacta whena ana attackera isa attemptinga toa breacha thea defensesmaoratheaprotectionsahaveabeenabreachedﬄ Fora ana applicationa toa alerta toa securitya issuesma ita needsa contexta ona whata isa‘normal’a anda whata constitutesa aa securityaissueoaaThisawilladifferabasedaonatheaapplicationaandatheacontextawithinawhichaitaisarunningoaaInagenerala applicationsashouldanotaattemptatoalogaeveryaitemathataoccursaasatheaexcessivealoggingawillaslowadownathea systemmafillaupadiskaoraDBaspacemaandamakeaitaveryahardatoafilterathroughaallatheainformationatoafindatheasecuritya issueo Atatheasameatimemaifanotaenoughainformationaisamonitoredaoraloggedmathenasecurityaalertingawillabeaveryahardatoa doabasedaonatheaavailableainformationoaaToaachieveathisabalanceaanaapplicationacouldauseaitsaownariskascoringa systemmamonitoringaataaasystemalevelawhatariskatriggersahaveabeenaspottedaiioeoainvalidainputsmafailedapasswordsma etcojaandauseadifferentamodesaofaloggingoaaTakeaanaexampleaofanormalausagemainathisascenarioaonlyacriticalaitemsa area loggedoa a Howevera ifa thea securitya riska isa perceiveda toa havea increasedma thena majora ora securitya levela itemsa canabealoggedaandaactedauponoaaThisahigherasecurityariskacouldaalsoainvokeafurtherasecurityafunctionalityaasa describedalaterainathisasectionoa TakeaanaexampleawhereaanaonlineaformaipostaauthenticationjaallowsaaauseratoaenteraaamonthaofatheayearoaaHerea theaUIaisadesignedatoagiveatheauseraaadropadownalistaofatheamonthsaiJanuaryathroughatoaDecemberjoaaInathisacasea thealoggedainauserashouldaonlyaeveraenteraoneaofarsavaluesmasinceatheyatypicallyashouldanotabeaenteringaanyatextma insteadatheyaareasimplyaselectingaoneaofatheaprendefinedadropadownavalueso Ifatheaserverareceivingathisaformahasafollowedasecureacodingapracticesmaitawillatypicallyacheckathatatheaformafielda matchesaoneaofathearsaallowedavaluesmaandathenaconsidersaitavalidoaaIfatheaformafieldadoesanotamatchmaitareturnsa anaerrormaandamayalogaaamessageainatheaserveroaaThisapreventsatheaattackerafromaexploitingathisaparticularafieldma howeverathisaisaunlikelyatoadeteraanaattackeraandatheyawouldamoveaontoaotheraformafieldso REVIEWING SECURITY ALERTS Reviewing Security Alerts176 Reviewing Security Alerts InathisascenarioaweahaveamoreainformationaavailableatoausathanaweahavearecordedoaaWeahaveareturnedaanaerrora backatoatheausermaandamaybealoggedaanaerroraonatheaserveroaaInafactaweaknowaaalotamore•aanaauthenticatedausera hasaenteredaanainvalidavalueawhichatheyashouldaneverahaveabeenaableatoadoaiasait’saaadropadownalistjainanormala usageoa a This could be due to a few reasons: • There’saaabugainatheasoftwareaandatheauseraisanotamaliciouso • Anaattackerahasastolenatheausersaloginacredentialsaandaisaattemptingatoaattackatheasystemo • Aauserahasaloggedainabutahasaaavirusptrojanawhichaisaattemptingatoaattackatheasystemo • Aauserahasaloggedainabutaisaexperiencingaaamanninnthenmiddleaattacko • Aauseraisanotaintendingatoabeamaliciousabutahasasomehowachangedatheavalueawithasomeabrowserapluginmaetco Ifait’satheafirstacaseaabovemathenatheacompanyashouldaknowaaboutaitatoafixatheirasystemoaaIfait’sacaseasmataoratathenathea applicationashouldatakeasomeaactionatoaprotectaitselfaandatheausermasuchaasareducingatheafunctionalityaavailablea toatheauseraiioeoanoaPIIaviewablemacan’tachangeapasswordsmacan’taperformafinancialatransactionsjaoraforcingafurthera authenticationasuchaasasecurityaquestionsaoraoutnofnbandaauthenticationoaaTheasystemacouldaalsoaalertatheausera toatheafactathatatheaunexpectedainputawasaspottedaandaadviseathematoarunaantivirusmaetcomathusastoppingaana attackawhenaitaisaunderwayo Obviouslyacareamustabeatakenainalimitingauserafunctionalityaoraalertingausersaencaseait’saanahonestamistakemasoa usingaaariskascoreaoranotingasessionaalertsashouldabeausedoaaForaexamplemaifaeverythingahasabeenanormalainathea browsingasessionaandaracharacteraisaoutaofaplacemathenashowingaaaredapopnupaboxastatingatheauserahasabeena hackedaisanotareasonablemahoweveraifathisaisanotatheausualaIPaaddressaforatheausermatheyahavealoggedainaataana unusualatimemaandathisaisatheavthamalformedaentryawithawhatalooksalikeaanaSQLainjectionastringmathenaitawouldabea reasonableaforatheaapplicationatoareactoaaThisapossibleareactionawouldaneedatoabeastatedainalegaladocumentationo Inaanotherascenariomaifaanaattackerahasagotathroughatheaapplicationadefensesaextractedapartaofatheaapplicationsa customera databasema woulda thea companya knowﬄa a Splittinga informationa ina thea databasea intoa separatea tablesa makesa sensea froma ana efficiencya pointa ofa viewma buta alsoa froma aa securitya viewma evena puttinga confidentiala informationa intoa aa separatea partitiona cana makea ita hardera fora thea attackeroa a Howevera ifa thea attackera hasa thea informationaitacanabeahardatoadetectaandaapplicationsashouldamakeastepsatoaaidaalertingasoftwareaieogoaSIEMa systemsjoaaManyafinancialainstitutionsauseariskascoringasystemsatoalookaataelementsaofatheauser’sasessionatoagivea aariskascoremaifaJohnnyaalwaysalogsainaatawpmaonaaaThursdayafromatheasameaIPmathenaweahaveaaatrustedapatternoaa Ifa suddenlya Johnnya logsa ina ata s–rvama froma ana IPa addressa ona thea othera sidea ofa thea worldma aftera gettinga thea passwordawrongaxatimesmathenamaybeahe’sajetlaggedaafteraaalongatripmaoraperhapsahisaaccountahasabeenahackedoaa EitherawaymaaskingahimaforaoutnofnbandaauthenticationawouldabeareasonableatoaallowaJohnnyatoalogainmaoratoa blockaanaattackerafromausingaJohnny’saaccounto Ifatheaapplicationatakesathisatoaaalargeraviewmaitacanadetermineathataonaaanormaladayatfaofatheausersalogaona inawhatawouldabeaconsideredaaariskierawaymaioeoadifferentaIPaaddressmadifferentatimemaetcoaaIfaonaThursdayaitaseesa thisanumberariseatoastfathenahasasomethingastrangeahappenedatoatheauserabasemaorahasatheadatabaseabeena hackedﬄaaThisatypeaofainformationacanabeausedatoaenforceaaablanketaoutnofnbandaauthenticationaiandainternala investigationaofathealogsjaforatheastfaofa‘riskier’ausersmatherebyacombiningatheariskascoreaforatheauserawithathea overallariskascoreaforatheaapplicationo 177 Anothera gooda optiona isa‘honeya accounts’a whicha area usernamesa anda passwordsa thata area nevera givena outa toa usersoaaTheseaaccountsaareaaddedajustalikeaanyaotherausermaandastoredainatheaDBmahoweveratheyaareaalsoarecordeda inaaaspecialacacheaandacheckedaonaloginoaaSinceatheyaareaneveragivenatoaanyausermanoauserashouldaeveralogonawitha themmahoweveraifaoneaofathoseaaccountsaareausedmathenatheaonlyawayathatausernameapasswordacombinationa couldabeaknownaisaifaanaattackeragotatheadatabasemaandathisainformationaallowsatheaapplicationatoamoveatoaaa moreasecureastateaandaalertatheacompanyathatatheaDBahasabeenahackedo What to Review Whenareviewingacodeamodulesafromaaasecurityaalertingapointaofaviewmasomeacommonaissuesatoalookaoutafora include– • Willatheaapplicationaknowaifait’sabeingaattackedﬄaaDoesaitaignoreainvalidainputsmaloginsmaetcoaoradoesaitalogathema andamonitorathisastateatoacaptureaaacumulativeaperceptionaofatheacurrentariskatoatheasystemﬄ • CanatheaapplicationaautomaticallyachangeaitsaloggingalevelatoareactatoasecurityathreatsﬄaaIsachangingasecuritya levelsadynamicaoradoesaitarequireaaarestartﬄ • DoesatheaSDLCarequirementsaoradesignadocumentationacaptureawhatawouldaconstituteaaasecurityaalertﬄaaHasa thisadeterminationabeenapeerareviewedﬄaaDoesatheatestingacyclearunathroughatheseascenariosﬄ • Doesatheasystemaemploya‘honeyaaccounts’asuchathatatheaapplicationawillaknowaifatheaDBahasabeenacompromisedﬄ • Isathereaaariskabasedascoringasystemathatarecordsatheanormalausageaofausersaandaallowsaforadeterminationaora reactionaifatheariskaincreasesﬄ • IfaaaSIEMasystemaisabeingausedmahaveaappropriateatriggersabeenaidentifiedﬄaaHasaautomatedatestsabeenacreateda toaensureathoseatriggeralogamessagesaareanotaaccidentallyamodifiedabyafutureaenhancementsaorabugafixesﬄ • DoesatheasystematrackahowamanyafailedaloginaattemptsaaauserahasaexperiencedﬄaaDoesatheasystemareactatoathisﬄ • Doesa certaina functionalitya iioeoa transactiona initiationma changinga passwordma etcja havea differenta modesa ofa operationabasedaonatheacurrentariskascoreatheaapplicationaisacurrentlyaoperatingawithinﬄ • aCanatheaapplicationarevertabackatoa‘normal’aoperationawhenatheasecurityariskascoreadropsatoanormalalevelsﬄ • HowaareaadministratorsaalertedawhenasecurityariskascorearisesﬄaOrawhenaaabreachahasabeenaassumedﬄaaAtaana operationalalevelmaisathisatestedaregularlyﬄaaHowaareachangesaofapersonnelahandledﬄ Reviewing Security Alerts178 Attacka detectiona undertakena ata thea applicationa layera hasa accessa toa thea completea contexta ofa ana interactiona anda enhanceda informationa abouta thea useroa Ifa logica isa applieda withina thea codea toa detecta suspiciousa activitya isimilaratoaanaapplicationalevelaIPSjathenatheaapplicationawillaknowawhataisaaahighnvalueaissueaandawhataisanoiseoa Inputadataaareaalreadyadecryptedaandacanonicalizedawithinatheaapplicationaandathereforeaapplicationnspecifica intrusionadetectionaisalessasusceptibleatoaadvancedaevasionatechniquesoaThisaleadsatoaaaveryalowalevelaofaattacka identificationafalseapositivesmaprovidingaappropriateadetectionapointsaareaselectedo Theafundamentalarequirementsaareatheaabilityatoaperformafouratasks– 1. Detectionaofaaaselectionaofasuspiciousaandamaliciousaeventso 2. Useaofathisaknowledgeacentrallyatoaidentifyaattackso 3. Selectionaofaaapredefinedaresponseo 4. Executionaofathearesponseo 22.1 Description Applicationsacanaundertakeaaarangeaofaresponsesathatamayaincludeahighariskafunctionalityasuchaasachangesatoa aauser’saaccountaoraotherachangesatoatheaapplication’sadefensiveapostureoaItacanabeadifficultatoadetectaactivea defenseainadynamicaanalysisasinceathearesponsesamayabeainvisibleatoatheatesteroaCodeareviewaisatheabestamethoda toadetermineatheaexistenceaofathisadefenseo Otheraapplicationafunctionalityalikeaauthenticationafailureacountsaandalocknoutmaoralimitsaonarateaofafileauploadsa area ‘localized’a protectiona mechanismsoa Thisa sorta ofa standalonea logica isa ‘not’a activea defensea equivalentsa ina thea contexta ofa thisa reviewma unlessa theya area riggeda togethera intoa ana applicationnwidea sensorya networka anda centralizedaanalyticalaengineo Itaisanotaaaboltnonatoolaoracodealibrarymabutainsteadaoffersainsightatoaanaapproachaforaorganizationsatoaspecifya oradevelopatheiraownaimplementationsa–aspecificatoatheiraownabusinessmaapplicationsmaenvironmentsmaandariska profilea–abuildingauponaexistingastandardasecurityacontrolso What to Review Inatheacaseawhereaaacodeareviewaisabeingausedatoadetectatheapresenceaofaaadefensemaitsaabsenceashouldabeanoteda asa aa weaknessoa Notea thata activea defensea cannota defenda ana applicationa thata hasa knowna vulnerabilitiesma anda thereforeatheaotherapartsaofathisaguideaareaextremelyaimportantoaTheacodeareviewerashouldanoteatheaabsencea ofaactiveadefenseaasaaavulnerabilityo Theapurposeaofacodeareviewaisanotanecessarilyatoadetermineatheaefficacyaofatheaactiveadefensemabutacouldasimplya beatoadetermineaifasuchacapabilityaexistso DetectionapointsacanabeaintegratedaintoapresentationmabusinessaandadataalayersaofatheaapplicationoaaApplicationn specificaintrusionadetectionadoesanotaneedatoaidentifyaallainvalidausagematoabeaableatoadetermineaanaattackoaTherea isanoaneedafora“infiniteadata”aora“bigadata”aandathereforeathealocationaofa“detectionapoints”amayabeaveryasparsea withinasourceacodeo REVIEW FOR ACTIVE DEFENSE Reviewing for Active Defense 179 Aausefulaapproachaforaidentifyingasuchacodeaisatoafindatheanameaofaaadedicatedamoduleaforadetectingasuspiciousa activityaisuchaasaOWASPaAppSensorjoaAdditionallyaaacompanyacanaimplementaaapolicyaofataggingaactiveadefensea detectiona pointsa baseda ona Mitre’sa Commona Attacka Patterna Enumerationa anda Classifcationa iCAPECjma stringsa suchaasaCAPECnsrsmaCAPECnsrtmaetco Thea OWASPa a AppSensora detectiona pointa typea identifiersa anda CAPECa codesa willa oftena havea beena useda ina configurationa valuesa ieogoa [https–ppcodeogoogleocompppappsensorpsourcepbrowseptrunkpAppSensorpsrcptestp resourcespoesapipESAPIopropertiesﬄr…vtainaESAPIaforaJava]jmaparameteranamesaandasecurityaeventaclassificationoa Alsomaexamineaerroraloggingaandasecurityaeventaloggingamechanismsaasatheseamayabeabeingausedatoacollecta dataathatacanathenabeausedaforaattackadetectionoaIdentifyatheacodeaoraservicesacalledathataperformathisalogginga andaexamineatheaeventapropertiesarecordedpsentoaThenaidentifyaallaplacesawhereatheseaareacalledafromo Ana examinationa ofa errora handlinga codea relatinga toa inputa anda outputa validationa isa verya likelya toa reveala thea presenceaofadetectionapointsoaaForaexamplemainaaawhitelistatypeaofadetectionapointmaadditionalacodeamayahavea beenaaddedaadjacentmaorawithinaerrorahandlingacodeaflow– Inasomeasituationsaattackadetectionapointsaarealookingaforablacklistedainputmaandatheatestamayanotaexistaotherwisema soabrandanewacodeaisaneededoaaIdentificationaofadetectionapointsashouldaalsoahaveafoundathealocationsawherea eventsaarearecordedaithea“eventastore”joaIfadetectionapointsacannotabeafoundmacontinueatoareviewatheacodeafora executionaofaresponsemaasathisamayaprovideainsightaintoatheaexistenceaofaactiveadefenseo Thea eventa storea hasa toa bea analyseda ina reala timea ora verya frequentlyma ina ordera toa identifya attacksa baseda ona predefinedacriteriaoaTheacriteriaashouldabeadefinedainaconfigurationasettingsaieogoainaconfigurationafilesmaorareada fromaanotherasourceasuchaasaaadatabasejoaaAaprocessawillaexamineatheaeventastoreatoadetermineaifaanaattackaisaina progressmatypicallyathisawillabeaattemptingatoaidentifyaanaauthenticatedausermabutaitamayaalsoaconsideraaasinglea IPaaddressmarangeaofaIPaaddressesmaoragroupsaofausersasuchaasaoneaoramorearolesmausersawithaaaparticularaprivilegea oraevenaallausersoa Oncea ana attacka hasa beena identifiedma thea responsea willa bea selecteda baseda ona predefineda criteriaoa Againa ana examinationa ofa configurationa dataa shoulda reveala thea thresholdsa relateda toa eacha detectiona pointma groupsa ofa detectionapointsaoraoverallathresholdso Theamostacommonaresponseaactionsaareauserawarningamessagesmalogaoutmaaccountalockoutaandaadministratora notificationoaHowevermaasathisaapproachaisaconnectedaintoatheaapplicationmatheapossibilitiesaofaresponseaactionsa arealimitedaonlyabyatheacodedacapabilitiesaofatheaapplicationo SearchacodeaforaanyaglobalaincludesathatapollaattackaidentificationpresponseaidentifiedaaboveoaResponseaactionsa iagainaaausermaIPaaddressmagroupaofausersmaetcjawillausuallyabeainitiatedabyatheaapplicationmabutainasomeacasesaothera applicationsaieogoaalteraaafraudasettingjaorainfrastructureacomponentsaieogoablockaanaIPaaddressarangejamayaalsoa beainvolvedo Examineaconfigurationafilesaandaanyaexternalacommunicationatheaapplicationaperformsoa aaifaiavarabMatchathisaja{ aaaaaaErrorahandling aaaaaaRecordaeventaforaattackadetection aa} Reviewing for Active Defense180 The following types of responses may have been coded: • Loggingaincreased • Administratoranotification • Otheranotificationaieogoaotherasystemj • Proxy • Userastatusachange • Useranotification • Timingachange • Processaterminatedaisameaasatraditionaladefensesj • Functionadisabled • Accountalogaout • Accountalockaout • Collectadataafromausero Othera capabilitiesa ofa thea applicationa anda relateda systema componentsa cana bea repurposeda ora extendedma toa providea thea selecteda responsea actionsoa Thereforea reviewa thea codea associateda witha anya localiseda securitya measuresasuchaasaaccountalockaouto References • TheaguidanceaforaaddingaactivearesponseatoaapplicationsagivenainatheOWASP_AppSensor_Project • Category–aOWASPaEnterpriseaSecurityaAPI • https://code.google.com/p/appsensor/ AppSensor demonstration code Reviewing for Active Defense 181 RaceaConditionsaoccurawhenaaapieceaofacodeadoesanotaworkaasaitaisasupposedatoailikeamanyasecurityaissuesjoaTheya areathearesultaofaanaunexpectedaorderingaofaeventsmawhichacanaresultainatheafiniteastateamachineaofatheacodeatoa transitionatoaaaundefinedastatemaandaalsoagiveariseatoacontentionaofamoreathanaoneathreadaofaexecutionaoverathea samearesourceoaMultipleathreadsaofaexecutionaactingaoramanipulatingatheasameaareaainamemoryaorapersisteda dataawhichagivesariseatoaintegrityaissueso 23.1 Description Withacompetingatasksamanipulatingatheasamearesourcemaweacanaeasilyagetaaaraceaconditionaasathearesourceaisa notainastepnlockaorautilisesaaatokenabasedasystemasuchaasasemaphoresoaForaexampleaifathereaareatwoaprocessesa iThreadarmaTrjaandaiThreadasmaTsjoaTheacodeainaquestionaaddsarqatoaanaintegeraXoaTheainitialavalueaofaXaisavoa X = X + 10 Witha noa controlsa surroundinga thisa codea ina aa multithreadeda environmentma thea codea coulda experiencea thea followingaproblem–a T1 places X into a register in thread 1 T2 places X into a register in thread 2 T1 adds 10 to the value in T1’s register resulting in 15 T2 adds 10 to the value in T2’s register resulting in 15 T1 saves the register value (15) into X. T1 saves the register value (15) into X. TheavalueashouldaactuallyabeasvmaasaeachathreadaaddedarqatoatheainitialavalueaofavoaButatheaactualavalueaisarvaduea toaTsanotalettingaTrasaveaintoaXabeforeaitatakesaaavalueaofaXaforaitsaadditiono Thisaleadsatoaundefinedabehaviormawhereatheaapplicationaisainaanaunsureastateaandathereforeasecurityacannotabea accuratelyaenforcedo What to Review • InaCdoNETalookaforacodeawhichausedamultithreadedaenvironments– o Thread o SystemoThreading o ThreadPool o SystemoThreadingoInterlocked • InaJavaacodealookafor o javaolangoThread o startij o stopij o destroyij o initij o synchronizeda RACE CONDITIONS Race Conditions182 Race Conditions o waitij o notifyij o notifyAllij • ForaclassicaASPamultithreadingaisanotaaadirectlyasupportedafeaturemasoathisakindaofaraceaconditionacouldabea present only when using COM objects. • Staticamethodsaandavariablesaioneaperaclassmanotaoneaperaobjectjaareaanaissueaparticularlyaifathereaisaaashareda statea amonga multiplea threadsoa Fora examplema ina Apachema strutsa statica membersa shoulda nota bea useda toa storea informationarelatingatoaaaparticulararequestoaTheasameainstanceaofaaaclassacanabeausedabyamultipleathreadsmaanda theavalueaofatheastaticamemberacannotabeaguaranteedoa • InstancesaofaclassesadoanotaneedatoabeathreadasafeaasaoneaisamadeaperaoperationprequestoaStaticastatesamusta beathreadasafeoa o Referencesatoastaticavariablesmatheseamustabeathreadalockedo o Releasingaaalockainaplacesaotherathenafinally{}amayacauseaissueso o Staticamethodsathataalterastaticastateo References • http://msdn2.microsoft.com/en-us/library/f857xew0(vs.71).aspx 183 AabufferaisaanaamountaofacontiguousamemoryasetaasideaforastoringainformationoaForaexampleaifaaaprograma hasatoarememberacertainathingsmasuchaasawhatayourashoppingacartacontainsaorawhatadataawasainputtedapriora toatheacurrentaoperationoaThisainformationaisastoredainamemoryainaaabufferoaLanguagesalikeaCmaCllaiwhicha manyaoperatingasystemsaareawrittenainjmaandaObjectivenCaareaextremelyaefficientmahoweveratheyaallowacodeatoa accessaprocessamemoryadirectlyaithroughamemoryaallocationaandapointersjaandaintermingleadataaandacontrola informationaieogoainatheaprocessastackjoaaIfaaaprogrammeramakesaaamistakeawithaaabufferaandaallowsauserainputa toarunapastatheaallocatedamemorymatheauserainputacanaoverwriteaprogramacontrolainformationaandaallowathea useratoamodifyatheaexecutionaofatheacodeo NoteathataJavamaCdoNETmaPythonaandaRubyaareanotavulnerableatoabufferaoverflowsadueatoatheawayatheyastoreatheira stringsainacharaarraysmaofawhichatheaboundsaareaautomaticallyacheckedabyatheaframeworksmaandatheafactathata theyadoanotaallowatheaprogrammeradirectaaccessatoatheamemoryaitheavirtualamachinealayerahandlesamemorya insteadjoaaThereforeathisasectionadoesanotaapplyatoathosealanguagesoaaNoteahoweverathatanativeacodeacalleda withinathosealanguagesaieogoaassemblymaCmaClljathroughainterfacesasuchaasaJNIaora‘unsafe’aCdasectionsacanabea susceptibleatoabufferaoverflowso 24.1 Description To allocate a buffer the code declares a variable of a particular size: • charamyBuffer[rqq]•appalargeaenoughatoaholdarqqacharavariables • intamyIntBuf[v]•appalargeaenoughatoaholdavaintegers • WidgetamyWidgetArray[rx]•appalargeaenoughatoaholdarxaWidgetaobjects AsathereaisanoaautomaticaboundsacheckingacodeacanaattemptatoaaddaaaWidgetaataarrayalocationastaiwhichadoesa notaexistjoaaWhenatheacodeadoesathismatheacomplierawillacalculateawhereatheastrdaWidgetashouldabeaplacedaina memoryaibyamultiplyingastaxasizeofiWidgetjaandaaddingathisatoathealocationaofathea‘myWidgetArray’apointerjoaa Anyaotheraobjectmaoraprogramacontrolavariablepregistermathataexistedaatathisalocationawillabeaoverwritteno Arraysmavectorsmaetcoaareaindexedastartingafromaqmameaningatheafirstaelementainatheacontaineraisaata‘myBuffer[q]’ma thisameansathealastaelementainatheacontaineraisanotaataarrayaindexarqqmabutaataarrayaindexa““oaaThisacanaoftenaleada toamistakesaandathea‘offabyaone’aerrormawhenaloopsaoraprogrammingalogicaassumeaobjectsacanabeawrittenatoathea lastaindexawithoutacorruptingamemoryo In C, and before the C++ STL became popular, strings were held as arrays of characters: • charanameString[rq]• Thisameansathatathea‘nameString’aarrayaofacharactersaisavulnerableatoaarrayaindexingaproblemsadescribedaabovema anda whena manya ofa thea stringa manipulationa functionsa isucha asa strcpyma strcatma describeda laterja area usedma thea possibilityaofawritingabeyondathearqthaelementaallowsaaabufferaoverrunaandathusamemoryacorruptiono Asa ana examplema aa programa mighta wanta toa keepa tracka ofa thea daysa ofa thea weekoa Thea programmera tellsa thea computeratoastoreaaaspaceaforaxanumbersoaThisaisaanaexampleaofaaabufferoaButawhatahappensaifaanaattemptatoaadda BUFFER OVERRUNS Buffer Overruns184 Buffer Overruns yanumbersaisaperformedﬄaLanguagesasuchaasaCaandaClladoanotaperformaboundsacheckingmaandathereforeaifathea programaisawrittenainasuchaaalanguagematheaythapieceaofadataawouldaoverwriteatheaprogramaspaceaofatheanexta programainamemorymaandawouldaresultainadataacorruptionoaThisacanacauseatheaprogramatoacrashaataaaminimuma oraaacarefullyacraftedaoverflowacanacauseamaliciousacodeatoabeaexecutedmaasatheaoverflowapayloadaisaactualacodeo a What to Review: Buffer Overruns Calibraryafunctionsasuchaasastrcpyaijmastrcataijmasprintfaijaandavsprintfaijaoperateaonanullaterminatedastringsaandaperforma noaboundsacheckingoagetsijaisaanotherafunctionathatareadsainputaiintoaaabufferjafromastdinauntilaaaterminatinganewlinea oraEOFaiEndaofaFilejaisafoundoaTheascanfaijafamilyaofafunctionsaalsoamayaresultainabufferaoverflowso Usingastrncpyijmastrncatijaandasnprintfijafunctionsaallowsaaathirda‘length’aparameteratoabeapassedawhichadeterminesathea maximumalengthaofadataathatawillabeacopiedpetcoaintoatheadestinationabufferoaIfathisaisacorrectlyasetatoatheasizeaofathea bufferabeingawrittenatomaitawillapreventatheatargetabufferabeingaoverflowedoaaAlsoanoteafgetsijaisaaareplacementaforagetsijoaa AlwaysacheckatheaboundsaofaanaarrayabeforeawritingaitatoaaabufferoaaTheaMicrosoftaCaruntimeaalsoaprovidesaadditionala versionsaofamanyafunctionsawithaana‘_s’asuffixaistrcpy_smastrcat_smasprintf_sjoaTheseafunctionsaperformaadditionalachecksa foraerroraconditionsaandacallaanaerrorahandleraonafailureo TheaCacodeabelowaisanotavulnerableatoabufferaoverflowaasatheacopyafunctionalityaisaperformedabya‘strncpy’awhicha specifiesatheathirdaargumentaofathealengthaofatheacharacteraarrayatoabeacopiedmarqoa voidacopyDataicharakuserIdja{aa aaaaacharaasmallBuffer[rq]•appasizeaofarqaa aaaaastrcpyaismallBuffermauserIdj• aa}aa aaintamainiintaargcmacharakargv[]ja{aa aaaacharakuserIda…a“qrstuvwxy“q”•appaPayloadaofarsawhenayouaincludeathea‘\\n’astringaterminationa aaa aaaaaappaautomaticallyaaddedabyathea“qrstuvwxy“q”aliteral aaaacopyDataaiuserIdj•appathisashallacauseaaabufferaoverload aa} Sample 24.1 voidacopyDataicharakuserIdja{ aaaacharaasmallBuffer[rq]•appasizeaofarq aaaastrncpyismallBuffermauserIdmasizeofismallBufferjj•appaonlyacopyafirstarqaelements aaaasmallBuffer[rq]a…aq•appaMakeasureaitaisaterminatedo a} a aintamainiintaargcmacharakargv[]ja{ aaaacharakuserIda…a“qrstuvwxy“q”•appaPayloadaofarr aaaacopyDataaiuserIdj•a a} Sample 24.2 185 ModernadayaCllaiCllrrjaprogramsahaveaaccessatoamanyaSTLaobjectsaandatemplatesathatahelpapreventasecuritya vulnerabilitiesoaaTheastd––stringaobjectadoesanotarequireatheacallingacodeahaveaanyaaccessatoaunderlyingapointersma andaautomaticallyagrowsatheaunderlyingastringarepresentationaicharacterabufferaonatheaheapjatoaaccommodatea theaoperationsabeingaperformedoaaThereforeacodeaisaunableatoacauseaaabufferaoverflowaonaaastd––stringaobjecto RegardingapointersaiwhichacanabeausedainaotherawaysatoacauseaoverflowsjmaCllrrahasasmartapointersawhicha againa takea awaya anya necessitya fora thea callinga codea toa usera thea underlyinga pointerma thesea typesa ofa pointersa area automaticallyaallocatedaandadestroyedawhenatheavariableagoesaoutaofascopeoaaThisahelpsatoapreventamemoryaleaksaanda doubleadeleteaerrorsoaAlsoatheaSTLacontainersasuchaasastd––vectormastd––listmaetcomaallaallocateatheiramemoryadynamicallya meaninganormalausageawillanotaresultainabufferaoverflowsoaaNoteathataitaisastillapossibleatoaaccessatheseacontainersa underlyingarawapointersmaorareinterpret_castatheaobjectsmathusabufferaoverflowsaareapossiblemahoweveratheyaareamorea difficultatoacauseo Compliersaalsoahelpawithamemoryaissuesmainamodernacompilersathereaarea‘stackacanaries’awhichaareasubtleaelementsa placedainatheacompliedacodeawhichacheckaforaoutnofnboundamemoryaaccessesoaaTheseacanabeaenabledawhenacompilinga theacodemaoratheyacouldabeaenabledaautomaticallyoaaThereaareamanyaexamplesaofatheseastackacanariesmaandaforasomea systemamanyachoicesaofastackacanariesadependingaonaanaorganizationsaappetiteaforasecurityaversusaperformanceoaa AppleaalsoahaveastackacanariesaforaiOSacodeaasaObjectivenCaisaalsoasusceptibleatoabufferaoverflowso Inageneralmathereaareaobviousaexamplesaofacodeawhereaaamanualacodearevieweracanaspotatheapotentialaforaoverflowsa andaoffnbynoneaerrorsmahoweveraotheramemoryaleaksaioraissuesjacanabeaharderatoaspotoaaThereforeamanualacodeareviewa shouldabeabackedaupabyamemoryacheckingaprogramsaavailableaonatheamarketo What to Review: Format Function Overruns AaformatafunctionaisaaafunctionawithinatheaANSIaCaspecificationathatacanabeausedatoatailoraprimitiveaCadataatypesatoa humanareadableaformoaTheyaareausedainanearlyaallaCaprogramsatoaoutputainformationmaprintaerroramessagesmaoraprocessa stringsoa Some format parameters: Theafsainathisacaseaensuresathatavalueapointedatoabyatheaparametera‘abc’aisaprintedaasaanaarrayaofacharactersoa For example: Format String Relevant Input %x Hexadecimal values (unsigned int) %d %u Decimal Unsigned decimal (unsigned int) %n Integer %s Strings ((const) (unsigned) char*) Table 23: FormataFunctionaOverruns charkamyStringa…a“abc”• printfai“Hello–afs\\n”maabcj• Buffer Overruns186 Througha supplyinga thea formata stringa toa thea formata functiona wea area ablea toa controla thea behavioura ofa itoa Soa supplyingainputaasaaaformatastringamakesaouraapplicationadoathingsait’sanotameantatooaWhataexactlyaareaweaablea toamakeatheaapplicationadoﬄa Ifaweasupplyafxaihexaunsignedaintjaasatheainputmathea‘printf’afunctionashallaexpectatoafindaanaintegerarelatingatoa thataformatastringmabutanoaargumentaexistsoaThisacannotabeadetectedaatacompileatimeoaAtaruntimeathisaissueashalla surfaceo Foraeveryafainatheaargumentatheaprintfafunctionafindsaitaassumesathatathereaisaanaassociatedavalueaonatheastackoa Ina thisa waya thea functiona walksa thea stacka downwardsa readinga thea correspondinga valuesa froma thea stacka anda printingathematoatheausero Usingaformatastringsaweacanaexecuteasomeainvalidapointeraaccessabyausingaaaformatastringasuchaas– •aprintfai“fsfsfsfsfsfsfsfsfsfsfsfs”j• Worseaagainaisausingathea‘fn’adirectiveaina‘printfij’oaThisadirectiveatakesaana‘intk’aanda‘writes’atheanumberaofabytesa soafaratoathatalocationo Wherea toa looka fora thisa potentiala vulnerabilityoa Thisa issuea isa prevalenta witha thea‘printfij’a familya ofa functionsma ‘’printfijmfprintfijmasprintfijmasnprintfijo’aAlsoa‘syslogij’aiwritesasystemalogainformationjaandasetproctitleiconstachara kfmtmaoooj•aiwhichasetsatheastringausedatoadisplayaprocessaidentifierainformationjo What to Review: Integer Overflows Dataarepresentationaforaintegersawillahaveaaafiniteaamountaofaspacemaforaexampleaaashortainamanyalanguagesaisa rwabitsatwosacomplementanumbermawhichameansaitacanaholdaaamaximumanumberaofatsmxwxaandaaaminimuma numberaofantsmxwyoaaTwosacomplementameansathatatheaveryafirstabitaiofathearwjaisaaarepresentationaofawhethera theanumberaofapositiveaoranegativeoaaIfatheafirstabitaisa‘r’mathenaitaisaaanegativeanumbero Thearepresentationaofasomeaboundaryanumbersaareagivenainatable 24. Ifa youa adda ra toa tsmxwwma ita addsa ra toa thea representationa givinga thea representationa fora tsmxwxa showna aboveoaa Howeveraifayouaaddaoneamoreaagainmaitasetsatheafirstabitaiaokoaoamostasignificantabitjmawhichaisathenainterpretedabya theasystemaasantsmxwyo Ifayouahaveaaaloopaioraotheralogicjawhichaisaaddingaoracountingavaluesainaaashortmathenatheaapplicationacoulda experienceathisaoverflowoaaNoteaalsoathatasubtractingavaluesabelowantsmxwyaalsoameansatheanumberawillawrapa aroundatoaaahighapositivemawhichaisacalledaunderflowo Number Representation 32,766 0111111111111110 32,767 0111111111111111 -32,768 -1 1000000000000000 1111111111111111 Table 24: IntegeraOverflows Buffer Overruns 187 Theabinaryarepresentationaofaqxxfffffffaisarrrrrrrrrrrrrrrrrrrrrrrrrrrrrrr•athisaintegeraisainitializedawitha theahighestapositiveavalueaaasignedalongaintegeracanaholdoa Hereawhenaweaaddaratoatheahexavalueaofaqxxfffffffatheavalueaofatheaintegeraoverflowsaandagoesatoaaanegativea numberaiqxxfffffffalara…ayqqqqqqqjaInadecimalathisaisainsruxuytwuyjoaThinkaofatheaproblemsathisamayacauseoa Compilersawillanotadetectathisaandatheaapplicationawillanotanoticeathisaissueoa Weagetatheseaissuesawhenaweauseasignedaintegersainacomparisonsaorainaarithmeticaandaalsoawhenacomparinga signedaintegersawithaunsignedaintegersoa Hereaifavsaisaaamassiveanegativeanumberathea“if”aconditionashallapassoaThisaconditionachecksatoaseeaifavsaisabiggera thanatheaarrayasizeo Ifatheaboundsacheckawasanotaperformedathealinea“myArray[vs]aa…avr”acouldahaveaassignedatheavalueavratoaaa locationaoutaofatheaboundsaofatheaarrayacausingaunexpectedaresultso References • SeeatheaOWASPaarticleaonabufferaoverflowaattackso dincludea”stdiooh— intamainivoidj{ aaaaaaaaaaaaintaval• aaaaaaaaaaaavala…aqxxfffffff•aa pkasruxuytwuxkp aaaaaaaaaaaaprintfi“vala…afdaiqxfxj\\n”mavalmavalj• aaaaaaaaaaaaprintfi“valalara…afdaiqxfxj\\n”mavalalaramavalalarj•apkOverflowatheaintkp aaaaaaaaaaaareturnaq• } Sample 24.3 intamyArray[rqq]• aaaaintafillArrayiintavrmaintavsj{ aaaaaaaaifivsa—asizeofimyArrayjapasizeofiintjanraj{ aaaaaaaaaaaareturnanr•apkaTooaBigakp aaaaaaaa} aaaaaaaamyArraya[vs]a…avr• aaaaaaaareturnaq• aaaa} Sample 24.4 Buffer Overruns188 • SeeatheaOWASPaTestingaGuideaonahowatoatestaforabufferaoverflowavulnerabilitieso • SeeaSecurityaEnhancementsainatheaCRT–ahttp–ppmsdnsomicrosoftocompennusplibrarypyefqsvkhiVSoyqjoaspx JavaScriptahasaseveralaknownasecurityavulnerabilitiesmawithaHTMLvaandaJavaScriptabecomingamoreaprevalentaina webasitesatodayaandawithamoreawebasitesamovingatoaresponsiveawebadesignawithaitsadependenceaonaJavaScripta theacodearevieweraneedsatoaunderstandawhatavulnerabilitiesatoalookaforoaJavaScriptaisafastabecomingaaasignifn icantapointaofaentryaofahackersatoawebaapplicationoaForathatareasonaweahaveaincludedainatheaAraInjectionasuba sectionoa TheamostasignificantavulnerabilitiesainaJavaScriptaareacrossnsiteascriptingaiXSSjaandaDocumentaObjectaModelma DOMnbasedaXSSo DetectionaofaDOMnbasedaXSSacanabeachallengingoaThisaisacausedabyatheafollowingareasonso • JavaScriptaisaoftenaobfuscatedatoaprotectaintellectualapropertyo • JavaScriptaisaoftenacompressedaoutaofaconcernedaforabandwidtho InabothaofatheseacasesaitaisastronglyarecommendedatheacodeareviewabeaableatoareviewatheaJavaScriptabeforeaita hasabeenaobfuscatedaandaoracompressedoaThisaisaaahugeapointaofacontentionawithaQAasoftwareaprofessionalsa becauseayouaareareviewingacodeathataisanotainaitsaproductionastateo AnotheraaspectathatamakesacodeareviewaofaJavaScriptachallengingaisaitsarelianceaofalargeaframeworksasuchaasa MicrosoftaoNETaandaJavaaServeraFacesaandatheauseaofaJavaScriptaframeworksmasuchaasaJQuerymaKnockoutmaAngularma BackboneoaTheseaframeworksaaggravateatheaproblemabecauseatheacodeacanaonlyabeafullyaanalyzedagivenathea sourceacodeaofatheaframeworkaitselfoaTheseaframeworksaareausuallyaseveralaordersaofamagnitudealargerathenathea codeatheacodearevieweraneedsatoareviewoa Becauseaofatimeaandamoneyamostacompaniesasimpleaacceptathatatheseaframeworksaareasecureaorathearisksaarea lowaandaacceptableatoatheaorganizationo BecauseaofatheseachallengesawearecommendaaahybridaanalysisaforaJavaScriptoaManualasourceatoasinkavalidationa whenanecessarymastaticaanalysisawithablacknboxatestingaandataintatestingo FirstauseaaastaticaanalysisoaCodeaRevieweraandatheaorganizationaneedsatoaunderstandathatabecauseaofaeventndrivn enabehaviorsmacomplexadependenciesabetweenaHTMLaDOMaandaJavaScriptacodemaandaasynchronousacommun nicationawithatheaserverasideastaticaanalysisawillaalwaysafallashortaandamayashowabothapositivemafalsemafalsea–posn itivemaandapositivenfalseafindingso BlacknboxatraditionalamethodsadetectionaofareflectedaorastoredaXSSaneedsatoabeapreformedoaHoweverathisaapn proachawillanotaworkaforaDOMnbasedaXSSavulnerabilitieso TaintaanalysisaneedsatoabeaincorporatedaintoastaticaanalysisaengineoaTaintaAnalysisaattemptsatoaidentifyavariablesa thatahaveabeena‘tainted’awithauseracontrollableainputaandatracesathematoapossibleavulnerableafunctionsaalsoaknowna Buffer Overruns CLIENT SIDE JavaScript 189 asaaa‘sink’oaIfatheataintedavariableagetsapassedatoaaasinkawithoutafirstabeingasanitizedaitaisaflaggedaasavulnerabilityo SecondatheacodearevieweraneedsatoabeacertainatheacodeawasatestedawithaJavaScriptawasaturnedaoffatoamakeasurea allaclientasidedadataavalidationawasaalsoavalidatedaonatheaserverasideo CodeaexamplesaofaJavaScriptavulnerabilitieso Explanation–aAnaattackeracanasendaaalinkasuchaasa“http://hostname/welcome.html#name=<script>alert(1)</ script>”atoatheavictimaresultingainatheavictim’sabrowseraexecutingatheainjectedaclientnsideacodeo Lineavamayabeaaafalsenpositiveaandaproveatoabeasafeacodeaoraitamayabeaopenatoa“Openaredirectaattack”awithatainta analysisa thea statica analysisa shoulda bea ablea toa correctlya identifieda ifa thisa vulnerabilitya existsoa Ifa statica analysisa reliesaonlyaonablacknboxacomponentathisacodeawillahaveaflaggedaasavulnerablearequiringatheacodearevieweratoa doaaacompleteasourceatoasinkareviewo Additional examples and potential security risks Source: documentourl Sink:adocumentowriteij Results:aResults–documentowritei“”script—maliciousacode”pscript—”j• CybercriminalamayacontrolledatheafollowingaDOMaelementsaincludingaa document.url,document.location,document.referrer,window.location Source: documentolocation Sink: windonolocationohref Results: windonolocationohrefa…ahttp–ppwwwoBadGuysSite•anaClientacodeaopenaredirecto Source:adocumentourl Storage: windowsolocalstorageoname ”html— ”scriptatype…”textpjavascript”— varapos…documentoURLoindexOfi“name…”jlv• documentowriteiadocumentoURLosubstringiposmdocumentoURLolengthjj• ”pscript— ”html— Sample 25.1 varaurla…adocumentolocationourl• varaloginIdxa…aurloindexOfi‘login’j• varaloginSuffixa…aurlosubstringiloginIdxj• urla…a‘http–ppmySitephtmlpssop’alaloginSuffix• documentolocationourla…aurl• Sample 25.2 Buffer Overruns190 Sink:aelemoinnerHTML Results:aelemoinnerHTMLa…a”value—a…StoredaDOMnbasedaCrossnsiteaScripting evalijaisaproneatoasecurityathreatsmaandathusanotarecommendedatoabeausedo Consider these points: 1. CodeapassedatoatheaevalaisaexecutedawithatheaprivilegesaofatheaexecuteroaSomaifatheacodeapassedacanabeaaffectn edabyasomeamaliciousaintentionsmaitaleadsatoarunningamaliciousacodeainaaauser’samachineawithayourawebsite’sa privilegeso 2. Aamaliciousacodeacanaunderstandatheascopeawithawhichatheacodeapassedatoatheaevalawasacalledo 3. Youaalsoashouldn’tauseaevalijaoranewaFunctionijatoaparseaJSONadatao TheaaboveaifausedamayaraiseasecurityathreatsoaJavaScriptawhenausedatoadynamicallyaevaluateacodeawillacreateaaa potentialasecurityarisko eval(‘alert(“Query String ‘ + unescape(document.location.search) + ‘”);’); eval(untrusted string); Can lead to code injection or client-side open redirect. JavaScripts “new function” also may create a potential security risk. Three points of validity are required for JavaScript 1. HaveaallathealogicaservernsidemaJavaScriptavalidationabeaturnedaoffaonatheaclient 2. CheckaforaallasortsaofaXSSaDOMaAttacksmaneveratrustauseradatamaknowayourasourceaandasinksaiioeoalookaataalla variablesathatacontainauserasuppliedainputjo 3. CheckaforainsecureaJavaScriptalibrariesaandaupdateathemafrequentlyo References: • http://docstore.mik.ua/orelly/web/jscript/ch20_04.html • https://www.owasp.org/index.php/Static_Code_Analysis • http://www.cs.tau.ac.il/~omertrip/fse11/paper.pdf • http://www.jshint.com Buffer Overruns 191 APENDIX 192 Code Review Do’s And Dont’s AtaworkaweaareaprofessionsoaButaweaneedatoamakeasureathataevenaasaprofessionalsathatawhenaweadoacodeareviewsa besidesatheatechnicalaaspectsaofatheacodeareviewsaweaneedatoamakeasureaweaconsideratheahumanasideaofacodea reviewsoaHereaisaaalistaofadiscussionapointsathatacodeareviewers•apeeradevelopersaneedatoatakeaintoaconsiderationoa Thisalistaisanotacomprehensiveabutaaasuggestionastartingapointaforaanaenterpriseatoamakeasureacodeareviewsaarea effectiveaandanotadisruptiveaandaaasourceaofadiscourseoaIfacodeareviewsabecomeaaasourceaofadiscourseawithina anaorganizationatheaeffectivesaofafindingasecuritymafunctionalabugsawilladeclineaandadevelopersawillafindaaawaya aroundatheaprocessoaaBeingaaagoodacodeareviewerarequiresagoodasocialaskillsmaandaisaaaskillathatarequiresapracticea justalikealearningatoacodeoa • Youadon’tahaveatoafindafaultainatheacodeatoadoaaacodeareviewoaIfayouaalwaysafineasomethingatoacriticizeayoura comments willalooseacredibilityo • DoanotarushaaacodeareviewoaFindingasecurityaandafunctionalityabugsaisaimportantabutaotheradevelopersaorateama memn bersaareawaitingaonayouasoayouaneedatoatemperayouradoanotarushawithatheaproperaamountaurgencyoa • WhenareviewingacodeayouaneedatoaknowawhataisaexpectedoaAreayouareviewingaforasecuritymafunctionalitymamainn tainn abilitymaandporastyleﬄaDoesayouraorganizationahaveatoolsaandadocumentsaonacodeastyleaoraareayouausingayoura ownacodingastyleﬄaDoesayouraorganizationagiveatoolsatoadevelopersatoamarkaunacceptableacodingastandardsa peratheaorganizationsaownacodingastandardsﬄ • Beforeabeginningaaacodeareviewadoesayouraorganizationahaveaaadefinedawayatoaresolveaanyaconflictsathatamaya comea upainatheacodeareviewabyatheadeveloperaandacodeareviewerﬄ • Doesatheacodeareviewerahaveaaadefineasetaofaartifactsathataneedatoabeaproduceaasathearesultaofatheacodeareviewﬄ • Whataisatheaprocessaofatheacodeareviewawhenacodeaduringatheacodeareviewaneedsatoabeachangedﬄ • IsatheacodearevieweraknowledgeableaaboutatheadomainaknowledgeaofatheacodeathataisabeingareviewedﬄaAmplea evidenceaaboundsathatacodeareviewsaareamostaeffectiveaifatheacodearevieweraisaknowledgeableaaboutatheadon mainaofatheacodeaIoeoaCompliancearegularizationsaforaindustryaandagovernmentmabusinessafunctionalitymarisksmaetco Agile Software Development Lifecycle CODE REVIEW DO’S AND DONT’S 193 AGILE SOFTWARE DEVELOPMENT LIFECYCLE DESIGN CODE TEST DEPLOY INTERACTION FASE INTERACTION FASE INTERACTION FASE INTERACTION FASE 1 3 24 DESIGN CODE TEST DEPLOY DESIGN CODE TEST DEPLOY DESIGN CODE TEST DEPLOY Code Review Do’s And Dont’s194 IntegratingasecurityaintoatheaagileasdlcaprocessaflowaisadifficultoaTheaorganizationawillaneedaconstantainvolven mentafromasecurityateamaandaoraaadedicationatoasecurityawithawellntrainedacodersaonaeveryateamo Continuous Integration and Test Driven Development Theaterma‘ContinuousaIntegration’aoriginatedawithatheaExtremeaProgrammingadevelopmentaprocessoaTodayaitaisa oneaofatheabestapracticesaofaSDLCaAgileoaCIarequiresadevelopersatoacheckacodeaintoasourceacontrolamanagementa START FINISH/ SIGNED OFF CHECK-IN CODE SAST - AdHoc Static Analysis - Developer Initiated CHECKMARX / SAST SECURITY DEVELOPMENT RECORD METRICS CHECK-IN DEV 6 7 1 5 YES: FIX CODE YES: FAIL NO/FALSE POSITIVE SAST SAST PASS OR FAIL? FALSE POSITIVE SIGNOFF INVOKE SAST ADJUST RULEBASE YES SIGN/OFF? ISR NO: REQUEST FIX/ ESCALATE PASS/FAIL NO PASS TUNED RULES CONTROLLED BY APPSEC YES NO 2 11 3 4 8 SAST PASS OR FAIL? Code Review Do’s And Dont’s 195 applicationaiscmjaseveralatimesaaadayoaAnaautomatedabuildaserveraandaapplicationaverifyaeachacheckninoaThea advantageaisateamamembersacanaquicklyadetectabuildaproblemsaearlyainatheasoftwareadevelopmentaprocessoa TheadisadvantageaofaCIaforatheaCodeaRevieweraisawhileacodeamayabuildaproperly•asoftwareasecurityavulnerabiln itiesamayastillaexistoaCodeareviewamayabeapartaofatheacheckninaprocessabutareviewamayaonlyatoamakeasureathea codeaonlyameetsatheaminimumastandardsaofatheaorganizationoaCodeareviewaisanotaaasecureacodeareviewawithariska assessmentaapproachaonawhataneedsatoahaveaadditionalatimeaspentadoingaaacodeareviewo TheasecondadisadvantageaforatheacodeareviewaisabecauseatheaorganizationaisamovingaquicklyawithaAgileaprocessa aadesignaflawamayabeaintroducedaallowingaaasecurityavulnerabilitiesaandatheavulnerabilitiesamayagetadeployedo A red flag for the code reviewer is… 1. Noauserastoriesatalkaaboutasecurityavulnerabilitiesabasedaonarisko 2. Userastoriesadoanotaopenlyadescribeasourceaandasinkso 3. Noariskaassessmentaforatheaapplicationahasabeenadoneoa Breaking Down Process Areas Theaterma‘TestaDrivenaDevelopment’alikeaCIaoriginatedawithaExtremeaProgrammingadevelopmentaprocessoaTon dayalikeaCIaitaisaoneaofatheabestapracticesaofaSDLCaAgileoaTDDarequiresadevelopersatoarelyaonarepetitionaofaaaverya shortadevelopmentacycleoaFirstatheastepaisatheadeveloperawritesaanaautomatedatestacaseathatadefinesaaaneededa improvementaoranewafunctionalityoaaThisafirstastepaTDDainitialafailsatheatestoaaSubsequentastepsatheadevelopersa createaaaminimumaamountaofacodeatoapassoaFinallyatheadeveloperarefactorsatheanewacodeatoatheaorganizationa acceptableacodingastandardo BREAKING DOWN PROCESS AREAS AGILE1 CONTINUOUS INTEGRATION2 TEST DRIVEN DEVELOPMENT3 STORY SPRINT BACKLOG 1 TDD: CREATE TEST FIRST CODE UNTIL IT PASSES INTEGRATION: AUTOMATED BUILD AND TESTS IMMEDIATE FEEDBACK ON ISSUES FUNCTIONING PRODUCT PRODUCT BACKLOG STORY 1 STORY 2 SPRINT DAY (MAX) 30 CONTINOUS INTEGRATION PERIOD HOUR (MAX) 24 Code Review Do’s And Dont’s196 CATEGORY DESCRIPTION PASS FAIL Are there backdoor/unexposed business logic classes?General Is the placement of authentication and authorization check correct?Authorization Are the checks correct implemented? Is there any backdoor parameter?Authorization Is the check applied on all the required files and folder within web root directory?Authorization Are security checks placed before processing inputs?Authorization Incase of container-managed authentication - Is the authentication based on web methods only?Authorization Incase of container-managed authentication - Is the authentication based on web methods only?Authorization Is Password Complexity Check enforced on the password?Authorization Is password stored in an encrypted format?Cryptography Is password disclosed to user/written to a file/logs/console?Authorization Are there unused configurations related to business logic?Business Logic and Design If request parameters are used to identify business logic methods, is there a proper mapping of user privileges and methods/actions allowed to them? Business Logic and Design Check if unexposed instance variables are present in form objects that get bound to user inputs. If present, check if they have default values. Business Logic and Design Check if unexposed instance variables present in form objects that get bound to user inputs. If present, check if they get initialized before form binding. Business Logic and Design Is there execution stopped/terminated after for invalid request? I.e. when authentication/autho- rization check fails? Authorization Check if unexposed instance variables are present in form objects that get bound to user inputs. If present, check if they have default values. Business Logic and Design Check if unexposed instance variables present in form objects that get bound to user inputs. If present, check if they get initialized before form binding. Business Logic and Design Is there execution stopped/terminated after for invalid request? I.e. when authentication/autho- rization check fails? Authorization Are the checks correct implemented? Is there any backdoor parameter?Business Logic and Design Is the check applied on all the required files and folder within web root directory?Business Logic and Design Is there any default configuration like Access- ALL?Business Logic and Design Does the configuration get applied to all files and users?Business Logic and Design Incase of container-managed authentication - Does the authentication get applied on all resources? Authorization Does the design handle sessions securely?Session Management CODE REVIEW CHECKLIST Code Review Checklist 197 CATEGORY DESCRIPTION PASS FAIL Are database credentials stored in an encrypted formatCryptography Does the design support weak data stores like flat filesBusiness Logic and Design Does the centralized validation get applied to all requests and all the inputs?Business Logic and Design Does the centralized validation check block all the special characters?Business Logic and Design Does are there any special kind of request skipped from validation?Business Logic and Design Does the design maintain any exclusion list for parameters or features from being validated?Business Logic and Design Are all the untrusted inputs validated? Input data is constrained and validated for type, length, format, and range. Imput Validation Is the data sent on encrypted channel? Does the application use HTTPClient for making external connections? Cryptography Is the data sent on encrypted channel? Does the application use HTTPClient for making external connections? Cryptography Does the design involve session sharing between components/modules? Is session validated correctly on both ends? Session Management Does the design use any elevated OS/system privileges for external connections/commands?Business Logic and Design Is there any known flaw(s) in API’s/Technology used? For eg: DWRBusiness Logic and Design Does the design framework provide any inbuilt security control? Like <%: %> in ASP.NET MVC? Is the application taking advantage of these controls? Business Logic and Design Are privileges reduce whenever possible?Business Logic and Design Is the program designed to fail gracefully?Business Logic and Design Are logs logging personal information, passwords or other sensitive information?Logging and Auditing Do audit logs log connection attempts (both successful and failures)?Logging and Auditing Is there a process(s) in place to read audit logs for unintended/malicious behaviors?Logging and Auditing Is all PI and sensitive information being sent over the network encrypted form.Cryptography Does application design call for server authentication (anti-spoofing measure)?Authorization Does application support password expiration?Authorization Does application use custom schemes for hashing and or cryptographic?Cryptography Code Review Checklist198 Classes that contain security secrets (like passwords) are only accessible through protected API’sGeneral Classes that contain security secrets (like passwords) are only accessible through protected API’sGeneral Keys are not held in code.Cryptography Plain text secrets are not stored in memory for extended periods of time.General Array bounds are checked.General All sensitive information used by application has been identifiedGeneral CATEGORY DESCRIPTION PASS FAIL Are cryptographic functions used by the application the most recent version of these protocols, patched and process in place to keep them updated? Cryptography Are external libraries, tools, plugins used by the application functions the most recent version of these protocols, patched and process in place to keep them updated? General Does are there any special kind of request skipped from validation?Cryptography User and role based privileges are documentedUser Management and Authentication Authentication cookies are not persistedUser Management and Authentication Authentication cookies are encryptedUser Management and Authentication Authentication credentials are not passed by HTTP GETUser Management and Authentication Authorization checks are granular (page and directory level)User Management and Authentication Authorization based on clearly defined rolesUser Management and Authentication Authorization works properly and cannot be circumvented by parameter manipulationUser Management and Authentication Authorization cannot be bypassed by cookie manipulationUser Management and Authentication No session parameters are passed in URLsSession Management Session cookies expire in a reasonable short timeSession Management Session cookies are encryptedSession Management Session data is validatedSession Management Session id is complexSession Management Session storage is secureSession Management Code Review Checklist 199 CATEGORY DESCRIPTION PASS FAIL Session inactivity timeouts are enforcedSession Management Data is validated on server sideData Management Is all XML input data validated against an agreed schema?Data Management Web service endpoints address in Web Services Description Language (WSDL) is checked for validityWeb Services Web service protocols that are unnecessary are disable (HTTP GET and HTTP POSTWeb Services Has the correct encoding been applied to all data being output by the applicationData Management HTTP headers are validated for each requestData Management Are all of the entry points and trust boundaries identified by the design and are in risk analysis report? Business Logic and Design Is output that contains untrusted data supplied input have the correct type of encoding (URL encoding, HTML encoding)? Data Management Web service has documentation protocol is disable if the application does not need dynamic generation of WSDL. Web Services Code Review Checklist200 THREAT MODELING EXAMPLE Step 1 Decompose the Application Theagoalaofadecomposingatheaapplicationaisatoagainaanaunderstandingaofatheaapplicationaandahowaitainteractsa withaexternalaentitiesoaInformationagatheringaandadocumentationaachieveathisagoaloaTheainformationagatheringa processaisacarriedaoutausingaaaclearlyadefinedastructuremawhichaensuresatheacorrectainformationaisacollectedoaThisa structureaalsoadefinesahowatheainformationashouldabeadocumentedatoaproduceatheathreatamodelo Description Theacollegealibraryawebsiteaisatheafirstaimplementationaofaaawebsiteatoaprovidealibrariansaandalibraryapatronsa istudentsaandacollegeastaff jawithaonlineaservicesoaAsathisaisatheafirstaimplementationaofatheawebsitematheafunctionn alityawillabealimitedoaThereawillabeathreeausersaofatheaapplication– 1. Students 2. Staff TheafirstaitemainatheathreatamodelaisatheageneralainformationarelatingatoatheathreatamodeloaThisamustaincludea theafollowing–a 1. Application Name: Theanameaofatheaapplication 2. Application Version: Theaversionaofatheaapplication 3. Description: Aahighaleveladescriptionaofatheaapplication 4. Document Owner: Theaowneraofatheathreatamodelingadocument 5. Participants: Theaparticipantsainvolvedainatheathreatamodelingaprocessaforathisaapplication 6. Reviewer: Theareviewerisjaofatheathreatamodel General Information Figure 13 THREAT MODEL INFORMATION V2.0 OWNERanaDAVIDaLOWRYaa PARTICIPANTSanaDAVIDaROOK REVIEWERanaEOINaKEARY Figure 14 Threat Modeling Example 201 3. LibrariansaStaffaandastudentsawillabeaableatoalogainaandasearchaforabooksmaandastaffamembersacanarequesta booksoaLibrariansawillabeaableatoalogainmaaddabooksmaaddausersmaandasearchaforabookso Entry points should be documented as follows: 1. ID AauniqueaIDaassignedatoatheaentryapointoaThisawillabeausedatoacrossareferenceatheaentryapointawithaanyathreatsaora vulnerabilitiesathataareaidentifiedoaInatheacaseaofalayeraentryapointsmaaamajormaminoranotationashouldabeausedo 2. Name Aadescriptiveanameaidentifyingatheaentryapointaandaitsapurposeo 3. Description Aatextualadescriptionadetailingatheainteractionaoraprocessingathataoccursaatatheaentryapointo 4. Trust Levels ThealevelaofaaccessarequiredaatatheaentryapointaisadocumentedahereoaTheseawillabeacrossnreferencedawithatheatrustsa levelsadefinedalaterainatheadocumento Entry Points Figure 15 Assets are documented in the threat model as follows: 1. ID AauniqueaIDaisaassignedatoaidentifyaeachaassetoaThisawillabeausedatoacrossareferenceatheaassetawithaanyathreatsaora vulnerabilitiesathataareaidentifiedo 2. Name Aadescriptiveanameathataclearlyaidentifiesatheaasseto 3. Description Aatextualadescriptionaofawhatatheaassetaisaandawhyaitaneedsatoabeaprotectedo 4. Trust Levels ThealevelaofaaccessarequiredatoaaccessatheaentryapointaisadocumentedahereoaTheseawillabeacrossnreferencedawithathea trustalevelsadefinedainatheanextastepo Assets Figure 16 Threat Modeling Example202 Trustalevelsaareadocumentedainatheathreatamodelaasafollows– 1. ID AauniqueanumberaisaassignedatoaeachatrustaleveloaThisaisausedatoacrossareferenceatheatrustalevelawithatheaentryapointsa andaassetso 2. Name Aadescriptiveanameathataallowsaidentificationaofatheaexternalaentitiesathatahaveabeenagrantedathisatrustalevelo 3. Description Aatextualadescriptionaofatheatrustaleveladetailingatheaexternalaentityawhoahasabeenagrantedatheatrustalevelo Trust Levels Byausingatheaunderstandingalearnedaonatheacollegealibraryawebsiteaarchitectureaandadesignmatheadataaflowadian gramacanabeacreatedaasashownainafigureaXo Figure 17 LIBRARIANSUSERS WEB PAGES ON DISK DATABASE FILES WEB SERVER / DATABASE BOUNDARY USER / WEBSERVER BOUNDARY REQUEST REQUEST RESPONSES RESPONSES COLEGE LIBRARY DATABASE COLEGE LIBRARY DATABASE SQL QUERY CALLS PAGES DATA DATA DATA Figure 18 Threat Modeling Example 203 Specificallyatheauseraloginadataaflowadiagramawillaappearaasain^figure 19. Aathreatalistaofagenericathreatsaorganizedainatheseacategoriesawithaexamplesaandatheaaffectedasecurityaconn trolsaisaprovidedainatheafollowingatable– Stride Threat Modeling Example: Step 2a Threat Categorization TheafirstastepainatheadeterminationaofathreatsaisaadoptingaaathreatacategorizationoaAathreatacategorizationapron videsaaasetaofathreatacategoriesawithacorrespondingaexamplesasoathatathreatsacanabeasystematicallyaidentifiedaina theaapplicationainaaastructuredaandarepeatableamannero LOGIN PROCESS USERS WEB PAGES DATABASE FILES AUTHENTICATE USER SQL QUERY RESULT AUTHENTICATE USER SQL QUERY RESULT PAGES WEB SERVER COLEGE LIBRARY DATABASE LOGIN REQUEST LOGIN RESPONSE AUTHENTICATE USER () AUTHENTICATE USER RESULT DATA DATA USER / WEBSERVER BOUNDARY WEB SERVER / DATABASE BOUNDARY Example application threat model of the user login Figure 19 Threat Modeling Example204 Byareferringatoatheacollegealibraryawebsiteaitaisapossibleatoadocumentasampleathreatsarelatedatoatheauseacasesasucha as– Threat: Malicious user views confidential information of students, faculty members and librarians. 1. Damage potential Threatatoareputationaasawellaasafinancialaandalegalaliability–y 2. Reproducibility Fullyareproducible–rq toaExploitability Requireatoabeaonatheasameasubnetaorahaveacompromisedaaarouter–x 4. Affected users Affectsaallausers–rq 5. Discoverability Canabeafoundaoutaeasily–rq OverallaDREADascore–aiylrqlxlrqlrqjapava…a“ Inathisacaseahavinga“aonaaarqapointascaleaisacertainlyaanahighariskathreato Microsoft DREAD threat-risk ranking model Threat Modeling Example: Step 2b Ranking of Threats ThreatsatendatoabearankedafromatheaperspectiveaofariskafactorsoaByadeterminingatheariskafactoraposedabyathea variousaidentifiedathreatsmaitaisapossibleatoacreateaaaprioritizedalistaofathreatsatoasupportaaariskamitigationastrategyma suchaasadecidingaonawhichathreatsahaveatoabeamitigatedafirstoaDifferentariskafactorsacanabeausedatoadeterminea whichathreatsacanabearankedaasaHighmaMediummaoraLowariskoaInageneralmathreatariskamodelsauseadifferentafactorsa toamodelarisksoa Threat Modeling Example 205 Thisaappendixagivesapracticalaexamplesaofahowatoacarryaoutacodeacrawlingainatheafollowingaprogrammingalanguages– • oNet • Java • ASP • CllpApache Searching for Code in .NET Firstlyaoneaneedsatoabeafamiliarawithatheatoolsaoneacanauseainaorderatoaperformatextasearchingmafollowingathisaoneaneedsatoaknowa whatatoalookaforo Oneacouldascanathroughatheacodealookingaforacommonapatternsaorakeywordsasuchaasa“User”ma“Password”ma“Pswd”ma“Key”ma“Http”ma etcoooaThisacanabeaperformedausingathea“FindainaFiles”atoolainaVSaorausingafindstringaasafollows–afindstrapsapmapiapd–c–\\projects\\coden base\\seca“http”akok HTTP Request Strings RequestsafromaexternalasourcesaareaobviouslyaaakeyaareaaofaaasecurityacodeareviewoaWeaneedatoaensureathataalla HTTParequestsareceivedaareadataavalidatedaforacompositionmamaxaandaminalengthmaandaifatheadataafallsawithinathea realmsaofatheaparameterawhitelistoaBottomnlineaisathisaisaaakeyaareaatoalookaataandaensureasecurityaisaenabledo STRING TO SEARCH request.accesstypes request.httpmethod request.cookies request.url request.browser request.querystring request.certificate request.urlreferrer request.TotalBytes request.BinaryRead request.headers request.form request.servervariables request.userlanguages request.files request.item request.rawurl request.useragent STRING TO SEARCH response.write HttpUtility HtmlEncode UrlEncode innerText innerHTML <%= HTML Output HereaweaarealookingaforaresponsesatoatheaclientoaResponsesawhichagoaunvalidatedaorawhichaechoaexternalainputa withoutadataavalidationaareakeyaareasatoaexamineoaManyaclientasideaattacksaresultafromapooraresponseavalidationo OUTPUT CODE CRAWLING Code Crawling206 Code Crawling SQL & Database LocatingawhereaaadatabaseamayabeainvolvedainatheacodeaisaanaimportantaaspectaofatheacodeareviewoaLookingaata theadatabaseacodeawillahelpadetermineaifatheaapplicationaisavulnerableatoaSQLainjectionoaOneaaspectaofathisaisa toaverifyathatatheacodeausesaeitheraSqlParametermaOleDbParametermaoraOdbcParameteriSystemoDataoSqlClientjoa Theseaareatypedaandatreataparametersaasathealiteralavalueaandanotaexecutableacodeainatheadatabaseo STRING TO SEARCH exec sp_ select from insert update delete from where delete execute sp_ exec xp_ .Provider System.Data.sql ADODB.recordset New OleDbConnection ExecuteReader DataSource SqlCommand Microsoft.Jet SqlDataReader ExecuteReader SqlDataAdapter StoredProcedure sqloledb sql server driver Server.CreateObject exec @ execute @ executestatement executeSQL setfilter executeQuery GetQueryResultInXML adodb Cookies Cookieamanipulationacanabeakeyatoavariousaapplicationasecurityaexploitsmasuchaasasessionahijackingpfixationaanda parameteramanipulationoaOneashouldaexamineaanyacodearelatingatoacookieafunctionalitymaasathisawouldahaveaaa bearingaonasessionasecurityo STRING TO SEARCH System.Net.Cookie HTTPOnly document.cookie HTML Tags ManyaofatheaHTMLatagsabelowacanabeausedaforaclientasideaattacksasuchaasacrossasiteascriptingoaItaisaimportantatoa examineatheacontextainawhichatheseatagsaareausedaandatoaexamineaanyarelevantadataavalidationaassociatedawitha theadisplayaandauseaofasuchatagsawithinaaawebaapplicationo TAGS <meta> <object> <frame security <iframe security <img> <style> <layer> <ilayer> STRING TO SEARCH HtmlEncode URLEncode <applet> <frameset> <embed> <frame> <html> <iframe> 207Code Crawling Input Controls TheainputacontrolsabelowaareaserveraclassesausedatoaproduceaandadisplayawebaapplicationaformafieldsoaLookingafora suchareferencesahelpsalocateaentryapointsaintoatheaapplicationo webcontrols.dropdownlist STRING TO SEARCH htmlcontrols.htmlinputhidden webcontrols.hiddenfield webcontrols.hyperlink webcontrols.textbox webcontrols.label webcontrols.linkbutton webcontrols.listbox webcontrols.checkboxlist WEB.config TheaoNETaFrameworkareliesaonaoconfigafilesatoadefineaconfigurationasettingsoaTheaoconfigafilesaareatextnbasedaXMLa filesoaManyaoconfigafilesacanmaandatypicallyadomaexistaonaaasingleasystemoaWebaapplicationsareferatoaaaweboconfiga filealocatedainatheaapplication’sarootadirectoryoaForaASPoNETaapplicationsmaweboconfigacontainsainformationaabouta mostaaspectsaofatheaapplication’saoperationo httpRuntime sessionState maxRequestLength Debug Credentials identity impersonate timeout remote connectionStrings authentication mode Allow Deny forms protection appSettings ConfigurationSettings appSettings webcontrols.dropdownlist CustomErrors httpCookies httpHandlers STRING TO SEARCH requestEncoding responseEncoding Trace authorization compilation webcontrols.linkbutton webcontrols.listbox webcontrols.checkboxlist global.asax EachaapplicationahasaitsaownaglobaloasaxafileaifaoneaisarequiredoaGlobaloasaxasetsatheaeventacodeaandavaluesafora anaapplicationausingascriptsoaOneamustaensureathataapplicationavariablesadoanotacontainasensitiveainformationma asatheyaareaaccessibleatoatheawholeaapplicationaandatoaallausersawithinaito STRING TO SEARCH Application_OnAuthenticateRequest Application_OnAuthorizeRequest Session_OnStart Session_OnEnd 208 Logging LoggingacanabeaaasourceaofainformationaleakageoaItaisaimportantatoaexamineaallacallsatoathealoggingasubsystemaandatoa determineaifaanyasensitiveainformationaisabeingaloggedoaCommonamistakesaarealoggingauserIDainaconjunctionawitha passwordsawithinatheaauthenticationafunctionalityaoraloggingadatabasearequestsawhichamayacontainasensitiveadatao STRING TO SEARCH log4net Console.WriteLine System.Diagnostics.Debug System.Diagnostics.Trace machine.config Itaisaimportantathatamanyavariablesainamachineoconfigacanabeaoverriddenainatheaweboconfigafileaforaaaparticulara applicationo Threads and Concurrency Locatinga codea thata containsa multithreadeda functionsa asa concurrencya issuesa cana resulta ina racea conditionsma whichamayaresultainasecurityavulnerabilitiesoaTheaThreadakeywordaisawhereanewathreadsaobjectsaareacreatedoa CodeathatausesastaticaglobalavariablesathataholdasensitiveasecurityainformationamayacauseasessionaissuesoaCodea thatausesastaticaconstructorsamayaalsoacauseaissuesabetweenathreadsoaNotasynchronizingatheaDisposeamethoda mayacauseaissuesaifaaanumberaofathreadsacallaDisposeaatatheasameatimemathisamayacausearesourceareleaseaissueso STRING TO SEARCH validateRequest enableViewState enableViewStateMac STRING TO SEARCH Thread Dispose Class Design PublicaandaSealedarelateatoatheadesignaataclassaleveloaClassesathataareanotaintendedatoabeaderivedafromashoulda beasealedoaMakeasureaallaclassafieldsaareaPublicaforaaareasonoaDon’taexposeaanythingathataisanotanecessaryo STRING TO SEARCH Public Sealed Code Crawling 209Code Crawling Reflection, Serialization CodeamayabeageneratedadynamicallyaataruntimeoaCodeathataisageneratedadynamicallyaasaaafunctionaofaexternala inputamayagiveariseatoaissuesoaIfacodeacontainsasensitiveadatamadoesaitaneedatoabeaserializedﬄ MyClass STRING TO SEARCH Serializable AllowPartiallyTrustedCallersAttribute GetObjectData System.Reflection STRING TO SEARCH catch finally trace enabled customErrors mode StrongNameIdentity StrongNameIdentityPermission Exceptions & Errors EnsureathatatheacatchablocksadoanotaleakainformationatoatheauserainatheacaseaofaanaexceptionoaEnsureawhena dealingawitharesourcesathatatheafinallyablockaisausedoaHavingatraceaenabledaisanotagreatafromaanainformationa leakageaperspectiveoaEnsureacustomizedaerrorsaareaproperlyaimplemented Cryptography IfacryptographyaisausedathenaisaaastrongaenoughacipherausedmaioeoaAESaoratDESﬄaWhatasizeakeyaisausedﬄaThealargera theabetteroaWhereaisahashingaperformedﬄaAreapasswordsathataareabeingapersistedahashedﬄaTheyashouldabeoaHowa arearandomanumbersageneratedﬄaIsatheaPRNGa“randomaenough”ﬄ xor STRING TO SEARCH RNGCryptoServiceProvider SHA MD5 base64 DES RC2 System.Security.Cryptography System.Random Random Storage Ifastoringasensitiveadataainamemorymaitaisarecommendatoausemyatheafollowingo STRING TO SEARCH SecureString ProtectedMemory 210 Authorization, Assert & Revert BypassingatheaoNetacodeaaccessasecurityapermissionﬄaNotaaagoodaideaoaBelowaisaaalistaofapotentiallyadangerousa permissionsasuchaasacallingaunmanagedacodemaoutsideatheaCLRo Legacy Methods Someastandardafunctionsathatashouldabeacheckedainaanyacontextaincludeatheafollowingo Searching for Code in Java Input and Output Streams Theseaareausedatoareadadataaintoaone’saapplicationoaTheyamayabeapotentialaentryapointsaintoaanaapplicationoa TheaentryapointsamayabeafromaanaexternalasourceaandamustabeainvestigatedoaTheseamayaalsoabeausedainapatha traversalaattacksaoraDoSaattackso STRING TO SEARCH printf strcpy ControlDomainPolicy ControlPolicy SkipVerification ControlEvidence SerializationFormatter ControlPrincipal STRING TO SEARCH RequestMinimum RequestOptional Assert Debug.Assert CodeAccessPermission MemberAccess ControlAppDomain UnmanagedCode java.io.FileOutputStream File ObjectInputStream PipedInputStream STRING TO SEARCH FileInputStream ObjectInputStream FilterInputStream PipedInputStream SequenceInputStream StringBufferInputStream BufferedReader ByteArrayInputStream StreamTokenizer getResourceAsStream java.io.FileReader java.io.FileWriter java.io.RandomAccessFile java.io.File renameTo Mkdir Code Crawling 211Code Crawling Servlets TheseaAPIacallsamayabeaavenuesaforaparameterpheaderpURLpcookieatamperingmaHTTPaResponseaSplittingaanda informationaleakageoaTheyashouldabeaexaminedacloselyaasamanyaofasuchaAPIsaobtainatheaparametersadirectlya fromaHTTParequestso STRING TO SEARCH javax.servlet.* getParameterNames getParameterValues getParameter getLocalName getAttribute getAttributeNames getLocalAddr getPrincipal getUserPrincipal isUserInRole getInputStream HttpServletRequest getQueryString getHeaderNames getHeaders getAuthType getRemoteUser getCookies isSecure getServerName getRemoteAddr getRemoteHost getRealPath getParameterMap getScheme getProtocol getContentType getName getPath getDomain getComment getValueNames getRequestedSessionId getRequestURI getRequestURL getServerName getValue getMethod getPath getReader getRealPath setHeader setAttribute putValue javax.servlet.http.Cookie getOutputStream getWriter addCookie addHeader Cross Site Scripting TheseaAPIacallsashouldabeacheckedainacodeareviewaasatheyacouldabeaaasourceaofaCrossaSiteaScriptingavulnerabilitieso STRING TO SEARCH javax.servlet.ServletOutputStream.print strcpy Response Splitting ResponseasplittingaallowsaanaattackeratoatakeacontrolaofathearesponseabodyabyaaddingaextraaCRLFsaintoaheadersoa InaHTTPatheaheadersaandabodiesaareaseparatedabyasaCRLFacharactersmaandathusaifaanaattackersainputaisausedaina aaresponseaheadermaandathatainputacontainedasaCRLFsmathenaanythingaafteratheaCRLFsawouldabeainterpretedaasa thearesponseabodyoaInacodeareviewaensureafunctionalityaisasanitizingaanyainformationabeingaputaintoaheaderso STRING TO SEARCH javax.servlet.http.HttpServletResponse.sendRedirect strcpy setHeader 212 Redirection Anyatimeaanaapplicationaisasendingaaaredirectaresponsemaensureathatathealogicainvolvedacannotabeamanipulateda byaanaattackersainputoaEspeciallyawhenainputaisausedatoadetermineawhereathearedirectagoesatoo SQL & Database SearchingaforaJavaadatabasearelatedacodeashouldahelpapinpointaclassespmethodsawhichaareainvolvedainathea persistencealayeraofatheaapplicationabeingareviewedo SSL Lookinga fora codea whicha utilisesa SSLa asa aa mediuma fora pointa toa pointa encryptionoaThea followinga fragmentsa shouldaindicateawhereaSSLafunctionalityahasabeenadevelopedo STRING TO SEARCH sendRedirect setStatus addHeader etHeader STRING TO SEARCH java.sql.Connection.prepareStatement java.sql.ResultSet.getObject select insert java.sql.Statement.executeQuery java.sql.Statement.execute delete update java.sql.Connection.prepareCall createStatement java.sql.ResultSet.getString executeQuery jdbc java.sql.Statement.executeUpdate java.sql.Statement.addBatch execute executestatement STRING TO SEARCH com.sun.net.ssl SSLContext SSLSocketFactory TrustManagerFactory HttpsURLConnection KeyManagerFactory Session Management TheafollowingaAPIsashouldabeacheckedainacodeareviewawhenatheyacontrolasessionamanagemento STRING TO SEARCH getSession invalidate getId Code Crawling 213Code Crawling Logging Weamayacomeaacrossasomeainformationaleakageabyaexaminingacodeabelowacontainedainaone’saapplicationo Legacy Interaction HereaweamayabeavulnerableatoacommandainjectionaattacksaoraOSainjectionaattacksoaJavaalinkingatoatheanativea OSacanacauseaseriousaissuesaandapotentiallyagiveariseatoatotalaserveracompromiseo STRING TO SEARCH java.lang.Runtime.exec java.lang.Runtime.getRuntime getId STRING TO SEARCH java.io.PrintStream.write log4j jLo Lumberjack JDLabAgent MonoLog qflog just4log log4Ant Ajax and JavaScript LookaforaAjaxausagemaandapossibleaJavaScriptaissues– STRING TO SEARCH document.write eval document.cookie window.location document.URL document.URL Searching for Code in Classic ASP InputaAPIsainaASPaareacommonlyausedatoaretrieveatheainputafromathearequestmathereforeacodeareviewashouldaensurea thesearequestsaiandadependentalogicjacannotabeamanipulatedabyaanaattackeroaOutputaAPIsaareausedabyaASPatoawritea thearesponseabodyathatawillabeasentatoatheaendausermahenceacodeareviewashouldacheckathesearequestsaareausedainaaa properamanneraandanoasensitiveainformationacanabeareturnedoaaCookiesacanaalsoabeaaasourceaofainformationaleakageo STRING TO SEARCH Request Request.QueryString Request.Form Request.ServerVariables Response.Write Response.BinaryWrite <%= .cookies Query_String hidden include .inc 214 STRING TO SEARCH err. Server.GetLastError On Error Resume Next On Error GoTo 0 STRING TO SEARCH location.href location.replace method=”GET” On Error GoTo 0 Error Handling Ensurea errorsa ina ana applicationa area handleda properlyma otherwisea ana attackera coulda usea errora conditionsa toa manipulateatheaapplicationo Information in URL TheseaAPIsaareausedatoaextractainformationafromatheaURLaobjectainathearequestoaCodeareviewashouldacheckathata theainformationaextractedafromatheaURLaisasanitizedo Database TheseaAPIsacanabeausedatoainteractawithaaadatabasemawhichacanaleadatoaSQLaattacksoaCodeareviewacanachecka theseaAPIacallsauseasanitizedainputo STRING TO SEARCH commandText select from update insert into .open ADODB. Commandtype ICommand delete from where IRowSet execute .execute Session TheseaAPIacallsacanacontrolasessionawithinaASPaapplicationso STRING TO SEARCH session.timeout session.abandon session.removeall Code Crawling 215Code Crawling DOS Prevention & Logging TheafollowingaASPaAPIsacanahelpapreventaDOSaattacksaagainstatheaapplicationoaLeakingainformationatoaaaloga canabeaofauseatoaanaattackermahenceatheafollowingaAPIacallacanabeacheckedainacodeareviewatoaensureanoasensitivea informationaisabeingawrittenatoalogso Redirection Doanotaallowaattackerainputatoacontrolawhenaandawherearejectionaoccurso STRING TO SEARCH server.ScriptTimeout IsClientConnected WriteEntry STRING TO SEARCH Response.AddHeader Response.AppendHeader Response.Redirect Response.Status Response.StatusCode Server.Transfer Server.Execute Searching for Code in Javascript and AJAX AjaxaandaJavaScriptahaveabroughtafunctionalityabackatoatheaclientasidemawhichahasabroughtaaanumberaofaoldasecuritya issuesabackatoatheaforefrontoaTheafollowingakeywordsarelateatoaAPIacallsausedatoamanipulateauserastateaoratheacontrola theabrowseroaTheaadventaofaAJAXaandaotheraWebasoqaparadigmsahasapushedasecurityaconcernsabackatoatheaclientasidema butanotaexcludingatraditionalaserverasideasecurityaconcernsoaLook for Ajax usage, and possible JavaScript issues. STRING TO SEARCH eval document.cookie document.referrer document.attachEvent document.open document.URL document.URLUnencoded document.write document.create document.execCommand document.forms[0].action document.location document.body document.body.innerHtml document.body.innerText document.close document.writeln location.hash location.href location.search window.alert window.attachEvent window.createRequest window.execScript window.location window.open window.navigate window.setInterval window.setTimeout XMLHTTP 216 Searching for Code in C++ and Apache CommonlyawhenaaaClladeveloperaisabuildingaaawebaserviceatheyawillabuildaaaCGIaprogramatoabeainvokedabya aawebaserveraithoughathisaisanotaefficientjaoratheyawillauseatheaApacheahttpdaframeworkaandawriteaaahandlera orafilteratoaprocessaHTTParequestspresponsesoaToaaidatheseadevelopersmathisasectionadealsawithagenericaCpClla functionsausedawhenaprocessingaHTTPainputaandaoutputmaalongawithasomeaofatheacommonaApacheaAPIsathata areausedainahandlerso Legacy C/C++ Methods ForaanyaCpCllacodeainteractingawithawebarequestsmacodeathatahandlesastringsaandaoutputsashouldabeacheckeda toaensureathealogicadoesanotahaveaanyaflawso STRING TO SEARCH exec sprint document.referrer fprintf cerr System popen stringstream fstringstream Malloc free strncpy Strcat cout cin printf Stdio FILE strcpy Request Processing WhenacodingawithinaApachematheafollowingaAPIsacanabeausedatoaobtainadataafromatheaHTTParequestaobjecto STRING TO SEARCH headers_in ap_read_request post_read_request Response Processing DependingaonatheatypeaofaresponseatoabeasentatoatheaclientmatheafollowingaApacheaAPIsacanabeausedo STRING TO SEARCH headers_out ap_rprintf ap_send_error_response ap_send_fd ap_vprintf Code Crawling 217Code Crawling Logging Logamessagesacanabeaimplementedausingacustomaloggersaincludedainatheamoduleaieogoalogucxxmaetcjmabyausinga theaApacheaprovidedaloggingaAPImaorabyasimplyawritingatoastandardaoutaorastandardaerroro STRING TO SEARCH cout cerr ap_open_stderr_log ap_error_log2stderr ap_log_error ap_log_perror ap_log_rerror STRING TO SEARCH ap_unescape_all ap_unescape_url ap_unescape_url_keep2f ap_unescape_urlencoded ap_escape_path_segment Cookie Processing CookieacanabeaobtainedafromathealistaofarequestaheadersmaorafromaspecializedaApacheafunctionso STRING TO SEARCH headers_in headers_out headers_out ap_cookie_write2 ap_cookie_read ap_cookie_check_string HTML Encoding WhenatheateamahasagotaaahandleaforatheaHTMLainputaoraoutputainatheaCpCllahandlermatheafollowingamethodsa canabeausedatoaensurepcheckaHTMLaencodingo HTML 218 The icons below represent what other versions are available in print for this book title. ALPHA: “Alpha Quality” book content is a working draft. Content is very rough and in development until the next level of publish- ing. BETA: “Beta Quality” book content is the next highest level. Content is still in devel- opment until the next publishing. RELEASE: “Release Quality” book content is the highest level of quality in a book title’s lifecycle, and is a final product. Attribution You must attribute the work in the manner specified by the author or licensor (but not in any way that suggests that they endorse you or your use of the work). Share Alike If you alter, transform, or build upon this work, you may distrib- ute the resulting work only under the same, similar or a compatible license. To Share - To copy, distribute and trans- mit the work To Remix - to adapt the work YOU ARE FREE: UNDER THE FOLLOWING CONDITIONS: The Open Web Application Security Project (OWASP) is a worldwide free and open community focused on improving the security of application software. Our mission is to make application se- curity “visible”, so that people and organizations can make informed decisions about application security risks. Every one is free to participate in OWASP and all of our materials are available under a free and open software license.The OWASP Foundation is a 501c3 not-for-profit charitable organi- zation that ensures the ongo- ing availability and support for our work. Alpha Beta Release","libVersion":"0.5.0","langs":""}